<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.1"/>
    <title>tensorgrad.tensor API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../tensorgrad.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;tensorgrad</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#TensorMeta">TensorMeta</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#Tensor">Tensor</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Tensor.__init__">Tensor</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tensor.edges">edges</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tensor.shape">shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tensor.order">order</a>
                        </li>
                        <li>
                                <a class="function" href="#Tensor.grad">grad</a>
                        </li>
                        <li>
                                <a class="function" href="#Tensor.rename">rename</a>
                        </li>
                        <li>
                                <a class="function" href="#Tensor.simplify">simplify</a>
                        </li>
                        <li>
                                <a class="function" href="#Tensor.full_simplify">full_simplify</a>
                        </li>
                        <li>
                                <a class="function" href="#Tensor.substitute">substitute</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tensor.weisfeiler_lehman">weisfeiler_lehman</a>
                        </li>
                        <li>
                                <a class="function" href="#Tensor.depends_on">depends_on</a>
                        </li>
                        <li>
                                <a class="function" href="#Tensor.structural_graph">structural_graph</a>
                        </li>
                        <li>
                                <a class="function" href="#Tensor.edge_structural_graph">edge_structural_graph</a>
                        </li>
                        <li>
                                <a class="function" href="#Tensor.graph_to_string">graph_to_string</a>
                        </li>
                        <li>
                                <a class="function" href="#Tensor.is_isomorphic">is_isomorphic</a>
                        </li>
                        <li>
                                <a class="function" href="#Tensor.isomorphisms">isomorphisms</a>
                        </li>
                        <li>
                                <a class="variable" href="#Tensor.symmetries">symmetries</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Variable">Variable</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Variable.__init__">Variable</a>
                        </li>
                        <li>
                                <a class="variable" href="#Variable.name">name</a>
                        </li>
                        <li>
                                <a class="function" href="#Variable.with_symmetries">with_symmetries</a>
                        </li>
                        <li>
                                <a class="function" href="#Variable.structural_graph">structural_graph</a>
                        </li>
                        <li>
                                <a class="function" href="#Variable.depends_on">depends_on</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Rename">Rename</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Rename.__init__">Rename</a>
                        </li>
                        <li>
                                <a class="variable" href="#Rename.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#Rename.tensor">tensor</a>
                        </li>
                        <li>
                                <a class="variable" href="#Rename.mapping">mapping</a>
                        </li>
                        <li>
                                <a class="function" href="#Rename.depends_on">depends_on</a>
                        </li>
                        <li>
                                <a class="function" href="#Rename.merge_renames">merge_renames</a>
                        </li>
                        <li>
                                <a class="function" href="#Rename.structural_graph">structural_graph</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Constant">Constant</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Constant.__init__">Constant</a>
                        </li>
                        <li>
                                <a class="variable" href="#Constant.name">name</a>
                        </li>
                        <li>
                                <a class="function" href="#Constant.with_symmetries">with_symmetries</a>
                        </li>
                        <li>
                                <a class="function" href="#Constant.structural_graph">structural_graph</a>
                        </li>
                        <li>
                                <a class="function" href="#Constant.depends_on">depends_on</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Delta">Delta</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Delta.__init__">Delta</a>
                        </li>
                        <li>
                                <a class="variable" href="#Delta.size">size</a>
                        </li>
                        <li>
                                <a class="function" href="#Delta.simplify_outer">simplify_outer</a>
                        </li>
                        <li>
                                <a class="function" href="#Delta.structural_graph">structural_graph</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Zero">Zero</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="function" href="#Ones">Ones</a>
            </li>
            <li>
                    <a class="class" href="#FunctionSignature">FunctionSignature</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FunctionSignature.__init__">FunctionSignature</a>
                        </li>
                        <li>
                                <a class="variable" href="#FunctionSignature.name">name</a>
                        </li>
                        <li>
                                <a class="variable" href="#FunctionSignature.edges">edges</a>
                        </li>
                        <li>
                                <a class="variable" href="#FunctionSignature.inputs">inputs</a>
                        </li>
                        <li>
                                <a class="function" href="#FunctionSignature.derivative">derivative</a>
                        </li>
                        <li>
                                <a class="function" href="#FunctionSignature.simplify">simplify</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#function">function</a>
            </li>
            <li>
                    <a class="class" href="#Function">Function</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Function.__init__">Function</a>
                        </li>
                        <li>
                                <a class="variable" href="#Function.shape_out">shape_out</a>
                        </li>
                        <li>
                                <a class="variable" href="#Function.inputs">inputs</a>
                        </li>
                        <li>
                                <a class="variable" href="#Function.signature">signature</a>
                        </li>
                        <li>
                                <a class="function" href="#Function.structural_graph">structural_graph</a>
                        </li>
                        <li>
                                <a class="function" href="#Function.depends_on">depends_on</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Derivative">Derivative</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Derivative.__init__">Derivative</a>
                        </li>
                        <li>
                                <a class="variable" href="#Derivative.tensor">tensor</a>
                        </li>
                        <li>
                                <a class="variable" href="#Derivative.x">x</a>
                        </li>
                        <li>
                                <a class="variable" href="#Derivative.new_names">new_names</a>
                        </li>
                        <li>
                                <a class="function" href="#Derivative.structural_graph">structural_graph</a>
                        </li>
                        <li>
                                <a class="function" href="#Derivative.depends_on">depends_on</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Product">Product</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Product.__init__">Product</a>
                        </li>
                        <li>
                                <a class="variable" href="#Product.factors">factors</a>
                        </li>
                        <li>
                                <a class="function" href="#Product.merge">merge</a>
                        </li>
                        <li>
                                <a class="function" href="#Product.components">components</a>
                        </li>
                        <li>
                                <a class="function" href="#Product.structural_graph">structural_graph</a>
                        </li>
                        <li>
                                <a class="function" href="#Product.depends_on">depends_on</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Sum">Sum</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Sum.__init__">Sum</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sum.terms">terms</a>
                        </li>
                        <li>
                                <a class="variable" href="#Sum.weights">weights</a>
                        </li>
                        <li>
                                <a class="function" href="#Sum.structural_graph">structural_graph</a>
                        </li>
                        <li>
                                <a class="function" href="#Sum.depends_on">depends_on</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../tensorgrad.html">tensorgrad</a><wbr>.tensor    </h1>

                
                        <input id="mod-tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-tensor-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">string</span><span class="w"> </span><span class="kn">import</span> <span class="n">ascii_letters</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">final</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">ABCMeta</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">numbers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Rational</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Symbol</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">tensorgrad.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">_MatchEdgesKey</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="k">class</span><span class="w"> </span><span class="nc">TensorMeta</span><span class="p">(</span><span class="n">ABCMeta</span><span class="p">):</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calling Tensor(...) is a shortcut to wrapping the argument in a tensor.&quot;&quot;&quot;</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a>        <span class="c1"># Since we&#39;re hacking the metaclass, we need to check if we&#39;re being called on a subclass</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Tensor(...) expects exactly one argument, e.g. Tensor(1).&quot;</span><span class="p">)</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>        <span class="n">val</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>                <span class="k">return</span> <span class="n">Zero</span><span class="p">()</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>            <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>                <span class="k">return</span> <span class="n">Product</span><span class="p">([])</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>                <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="n">Product</span><span class="p">([])],</span> <span class="p">[</span><span class="n">val</span><span class="p">])</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">):</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>            <span class="k">return</span> <span class="n">Delta</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>            <span class="k">return</span> <span class="n">val</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid argument </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Tensor</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">TensorMeta</span><span class="p">):</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>    <span class="nd">@property</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">edges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an _ordered_ set of edge names&quot;&quot;&quot;</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>    <span class="nd">@property</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">]:</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_shape&quot;</span><span class="p">):</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>    <span class="nd">@property</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of edges the tensor has. Same as ndim in torch/numpy&quot;&quot;&quot;</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>    <span class="nd">@final</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">        Take the derivative of this tensor with respect to the variable x.</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">        Args:</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">            x: The variable to take the derivative with respect to.</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">            new_names: Optional list of names to use for the new edges created by the derivative.</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">                If not provided, new names will be generated based on the edges of x.</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">        Note:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">            Pushes the derivative one step through the tensor.</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">            If you want to push it all the way through, use .simplify().</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a><span class="sd">        Returns:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">            The tensor representing the derivative.</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="n">new_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_grad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="c1"># Check that the shape is preserved</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">|</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_names</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">]:</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="c1"># When taking a derivative with respect to a variable, we need some edge names for the derivative.</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="c1"># If new_names is not given, we generate names based on the edge names of x.</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="c1"># However, we need to make sure they don&#39;t clash with any names already present in the tensor.</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="c1"># If new_names is already given, we just check to make sure they are not already present in the tensor.</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>        <span class="k">if</span> <span class="n">new_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">edges</span> <span class="o">!=</span> <span class="n">new_names</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">new_names</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">=}</span><span class="s2"> must match </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>            <span class="c1"># Check that the new names don&#39;t clash with self.edges</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>            <span class="k">if</span> <span class="n">used</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">&amp;</span> <span class="n">new_names</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">used</span><span class="si">}</span><span class="s2"> are already present in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>            <span class="k">return</span> <span class="n">new_names</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="c1"># Make new names that are _based_ on x.edges and _avoid_ self.edges</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="k">return</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>        <span class="c1"># Override this method to implement differentiation</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Derivative not implemented for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>    <span class="nd">@final</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">        Rename free edges of this tensor.</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">        Args:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">            kwargs: A dictionary mapping old edge names to new edge names.</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="sd">                Only free edges can be renamed. Inner edges may get renamed</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">                if necessary to avoid clashes with the new free edge names.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">        Returns:</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a><span class="sd">            A new tensor with the edges renamed according to kwargs.</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>        <span class="c1"># Check that the renaming is valid, and return the renaming dictionary.</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">({</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">})</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renamed an edge to an existing edge name. </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">kwargs</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>        <span class="c1"># Restrict renaming to free edges</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">new</span><span class="p">:</span> <span class="n">old</span> <span class="k">for</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">new</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rename</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>        <span class="c1"># Check that the shape is preserved</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span> <span class="n">s</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>        <span class="c1"># Override this method to implement renaming</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>    <span class="nd">@final</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">        Apply simplification rules to this tensor.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">        This may rename inner edges but should never change the free edges.</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">        Args:</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd">            args: Optional dictionary of arguments controlling the simplification.</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">        Returns:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">            A simplified version of this tensor.</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>        <span class="c1"># args[&quot;grad_steps&quot;] allows us to control how far we propagate the derivative.</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;grad_steps&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;associative_products&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;associative_sums&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;sum_combine_terms&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;combine_products&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;factor_components&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;expand_functions&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;expand&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simplify</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>        <span class="c1"># Check that the shape is preserved</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>        <span class="c1"># Override this method to implement simplification</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">full_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies multiple simplification rules until the expression no longer changes&quot;&quot;&quot;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>        <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>        <span class="k">while</span> <span class="p">(</span><span class="n">new</span> <span class="o">:=</span> <span class="n">expr</span><span class="o">.</span><span class="n">simplify</span><span class="p">())</span> <span class="o">!=</span> <span class="n">expr</span><span class="p">:</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">new</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>        <span class="k">if</span> <span class="n">expand</span><span class="p">:</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">simplify</span><span class="p">({</span><span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>            <span class="k">while</span> <span class="p">(</span><span class="n">new</span> <span class="o">:=</span> <span class="n">expr</span><span class="o">.</span><span class="n">simplify</span><span class="p">({</span><span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}))</span> <span class="o">!=</span> <span class="n">expr</span><span class="p">:</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>                <span class="n">expr</span> <span class="o">=</span> <span class="n">new</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>        <span class="k">return</span> <span class="n">expr</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>    <span class="nd">@final</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Substitute a variable with a tensor&quot;&quot;&quot;</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>        <span class="c1"># Ideally we&#39;d like y to be able to have extra edges that are not in x</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>        <span class="c1"># but which will be broadcasted as new edges of the tensor. This will</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>        <span class="c1"># allow us to implement numerical expectation, and other situations where</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>        <span class="c1"># we originally didn&#39;t have broadcasting, but we want to add it.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>        <span class="c1"># Maybe we could even remove broadcasted edges of x as well.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>        <span class="c1"># The tricky thing is to ensure it doesn&#39;t clash with the existing edges.</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_substitute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Override this method to implement substitution&quot;&quot;&quot;</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weisfeiler_lehman</span><span class="p">)</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>    <span class="nd">@cached_property</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">weisfeiler_lehman</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Hexadecimal string for WL-hash of the input graph.&quot;&quot;&quot;</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>        <span class="k">return</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">weisfeiler_lehman_graph_hash</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">node_attr</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this tensor depends on the variable x.&quot;&quot;&quot;</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a graph representation of the tensor, which can be used for isomorphism testing.</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">        Returns:</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="sd">            A tuple with the following values:</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a><span class="sd">            - A NetworkX directed graph.</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="sd">                - Each node in the top tree is labeled with the producing tensor.</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="sd">                - Use name=hashable to label vertices</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="sd">            - &quot;edges&quot;, a dict of edge_name -&gt; node id</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a><span class="sd">            - Node 0 should be the root</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">edge_structural_graph</span><span class="p">(</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">match_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">edge_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a><span class="sd">        Build a structural graph of the tensor with dummy nodes for outer edges.</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a><span class="sd">        Args:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a><span class="sd">            match_edges: If True the names are used to match edges.</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a><span class="sd">            edge_names: An optional mapping of edge names.</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a><span class="sd">        Returns:</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a><span class="sd">            A tuple (G, edge_list) where G is the graph and edge_list is the list of edge names.</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="k">if</span> <span class="n">edge_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>            <span class="n">edge_names</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structural_graph</span><span class="p">()</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>            <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edge_names</span><span class="p">:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>                <span class="n">edge_names</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Outer Edge&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">if</span> <span class="n">match_edges</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>            <span class="n">n</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">edge_names</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">graph_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="sd">        Returns an ASCII tree-like representation of the structural graph.</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a><span class="sd">        Returns:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">            A string showing the graph structure.</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">generate_network_text</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>    <span class="c1"># Overloaded operators</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>            <span class="n">other</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">Product</span><span class="p">([]),</span> <span class="n">other</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>        <span class="k">return</span> <span class="bp">self</span> <span class="o">+</span> <span class="n">other</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="c1"># Handle `other - self`</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span> <span class="o">+</span> <span class="n">other</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="c1"># Handle `self - other`</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>            <span class="n">other</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">Product</span><span class="p">([]),</span> <span class="n">other</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">w</span><span class="p">])</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__matmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>            <span class="n">other</span> <span class="o">=</span> <span class="n">Sum</span><span class="p">([</span><span class="n">Product</span><span class="p">([])],</span> <span class="p">[</span><span class="n">other</span><span class="p">])</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>        <span class="k">return</span> <span class="n">Product</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">])</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__rmatmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>            <span class="k">return</span> <span class="bp">self</span> <span class="o">*</span> <span class="n">other</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>        <span class="k">return</span> <span class="bp">self</span> <span class="o">@</span> <span class="n">other</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>        <span class="k">return</span> <span class="bp">self</span> <span class="o">*</span> <span class="n">other</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="sd">        Contract self with other using tensor product and contraction rules.</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>            <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>                <span class="k">return</span> <span class="n">Zero</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>            <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>                <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>            <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="n">other</span><span class="p">])</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">tensorgrad.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">prod</span>  <span class="c1"># Avoid circular import</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>        <span class="k">return</span> <span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__rtruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>        <span class="c1"># Handle other / self</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">tensorgrad.functions</span><span class="w"> </span><span class="kn">import</span> <span class="nb">pow</span>  <span class="c1"># Avoid circular import</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>        <span class="k">return</span> <span class="n">other</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Rational</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>        <span class="c1"># Handle self / other</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">tensorgrad.functions</span><span class="w"> </span><span class="kn">import</span> <span class="nb">pow</span>  <span class="c1"># Avoid circular import</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>            <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">other</span><span class="p">)])</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>            <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="n">other</span><span class="p">])</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>        <span class="k">return</span> <span class="bp">self</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">tensorgrad.functions</span><span class="w"> </span><span class="kn">import</span> <span class="nb">pow</span>  <span class="c1"># Avoid circular import</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">)):</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only integer and fractional powers are supported.&quot;</span><span class="p">)</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>        <span class="k">return</span> <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_isomorphic</span><span class="p">(</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">,</span> <span class="n">match_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">edge_names</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a><span class="sd">        Test whether this tensor is isomorphic to another tensor.</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a><span class="sd">        Args:</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a><span class="sd">            other: The tensor to compare with.</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a><span class="sd">            match_edges: Whether to require a matching of edge names.</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a><span class="sd">            edge_names: Optional mapping to use for edge renaming.</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a><span class="sd">        Returns:</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="sd">            True if the tensors are isomorphic; False otherwise.</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weisfeiler_lehman</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">weisfeiler_lehman</span><span class="p">:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>        <span class="n">G1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="n">match_edges</span><span class="p">,</span> <span class="n">edge_names</span><span class="o">=</span><span class="n">edge_names</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>        <span class="n">G2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="n">match_edges</span><span class="p">,</span> <span class="n">edge_names</span><span class="o">=</span><span class="n">edge_names</span><span class="p">)</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>        <span class="k">return</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">G1</span><span class="p">,</span> <span class="n">G2</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">n2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>        <span class="c1"># return nx.vf2pp_is_isomorphic(G1, G2, node_label=&quot;name&quot;)</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">isomorphisms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">        Yield all isomorphisms (edge renamings) between self and other.</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">        Args:</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="sd">            other: The other tensor to compare.</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="sd">        Yields:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a><span class="sd">            Dictionaries mapping edge names in self to edge names in other.</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>        <span class="n">G1</span><span class="p">,</span> <span class="n">edges1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>        <span class="n">G2</span><span class="p">,</span> <span class="n">edges2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>        <span class="k">for</span> <span class="n">matching</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">isomorphism</span><span class="o">.</span><span class="n">MultiDiGraphMatcher</span><span class="p">(</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>            <span class="n">G1</span><span class="p">,</span> <span class="n">G2</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">n2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">isomorphisms_iter</span><span class="p">():</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>            <span class="c1"># Matching is a dict {i: j} where i is the node in G1 and j is the node in G2</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>            <span class="c1"># We are only interested in then `len(self.edges)` last nodes, which correspond to the outer edges</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>            <span class="n">start_i</span> <span class="o">=</span> <span class="n">G1</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>            <span class="n">start_j</span> <span class="o">=</span> <span class="n">G2</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>            <span class="k">yield</span> <span class="p">{</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>                <span class="n">edges1</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">start_i</span><span class="p">]:</span> <span class="n">edges2</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="n">start_j</span><span class="p">]</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">matching</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">start_i</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">start_j</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>            <span class="p">}</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>    <span class="nd">@cached_property</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">symmetries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the orbits of the automorphism group of the tensor.&quot;&quot;&quot;</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>        <span class="c1"># The orbits are the sets of edges that ever get mapped to each other.</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isomorphisms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>        <span class="n">symmetries</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">)))</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_symmetries&quot;</span><span class="p">):</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>            <span class="k">assert</span> <span class="n">symmetries</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symmetries</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="k">return</span> <span class="n">symmetries</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_edges</span><span class="p">(</span><span class="n">edges</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">        Validate and standardize an iterable of edge names.</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">        Args:</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">            edges: An iterable of edge names.</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="sd">        Returns:</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">            A list of edge names.</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">        Raises:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">            ValueError: If any edge is not a string.</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Edges must be an iterable of strings&quot;</span><span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">):</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Edges must be an iterable of strings&quot;</span><span class="p">)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        <span class="k">return</span> <span class="n">edges</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_shape</span><span class="p">(</span><span class="n">shape0</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Symbol</span><span class="p">],</span> <span class="n">shape1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">]:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a><span class="sd">        Check and merge a shape given as an iterable and a dict.</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a><span class="sd">        Args:</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a><span class="sd">            shape0: An iterable of Sympy symbols.</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a><span class="sd">            shape1: A dictionary mapping edge names to Sympy symbols.</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="sd">        Returns:</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="sd">            A dictionary merging the two representations.</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a><span class="sd">        Raises:</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a><span class="sd">            ValueError: If inputs are not of the expected types.</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>        <span class="n">shape0</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape0</span><span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape0</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape0</span><span class="p">):</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shape0 must be a tuple of sympy symbols&quot;</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape1</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shape1 must be a dict of sympy symbols&quot;</span><span class="p">)</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>        <span class="n">shape0</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape0</span><span class="p">}</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>        <span class="k">if</span> <span class="n">double_keys</span> <span class="o">:=</span> <span class="n">shape0</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">shape1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duplicate edge names: </span><span class="si">{</span><span class="n">double_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>        <span class="k">return</span> <span class="n">shape0</span> <span class="o">|</span> <span class="n">shape1</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_symmetries</span><span class="p">(</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>        <span class="n">shape</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">],</span> <span class="n">symmetries</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="sd">        Validate the symmetries for a tensor.</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="sd">        Args:</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">            shape: A dictionary mapping edge names to sizes.</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">            symmetries: Either a string (with groups separated by commas) or a set of frozensets.</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">        Returns:</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">            A set of frozensets representing the symmetry groups.</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="sd">        Raises:</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="sd">            ValueError: If the symmetries are inconsistent with the shape.</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="k">if</span> <span class="n">symmetries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="k">return</span> <span class="p">{</span><span class="nb">frozenset</span><span class="p">({</span><span class="n">e</span><span class="p">})</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">symmetries</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>            <span class="n">symmetries</span> <span class="o">=</span> <span class="p">{</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">symmetries</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)}</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="c1"># Check symmetries are sets of strings</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">symmetries</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">group</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symmetries</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">({</span><span class="n">e</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">symmetries</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">group</span><span class="p">})</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Symmetry groups must contain all edges&quot;</span><span class="p">)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>        <span class="c1"># Check symmetries are compatible with shape</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">symmetries</span><span class="p">:</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shape</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">group</span><span class="p">):</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symmetry group </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> contains edges not in shape&quot;</span><span class="p">)</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">({</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">group</span><span class="p">})</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symmetry group </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> must all have same dim size&quot;</span><span class="p">)</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>        <span class="k">return</span> <span class="n">symmetries</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="c1">################################################################################</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="c1"># Variable</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="c1">################################################################################</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Variable</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        <span class="o">*</span><span class="n">shape0</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>        <span class="n">_symmetries</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="o">**</span><span class="n">shape1</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>    <span class="p">):</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="sd">        A tensor holding a variable.</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a><span class="sd">        Args:</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a><span class="sd">            name: The name of the variable.</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a><span class="sd">            shape0: Positional Sympy symbols for dimensions.</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a><span class="sd">            _symmetries: Optional symmetries (as a string or set of frozensets).</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a><span class="sd">            shape1: Keyword arguments for dimensions.</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_shape</span><span class="p">(</span><span class="n">shape0</span><span class="p">,</span> <span class="n">shape1</span><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span> <span class="n">_symmetries</span><span class="p">)</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetries</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Variable&quot;</span><span class="p">:</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>        <span class="k">return</span> <span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_symmetries</span><span class="o">=</span><span class="n">symmetries</span><span class="p">)</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>            <span class="c1"># TODO: If X has symmetries, the derivative can actually be more complex than this.</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>            <span class="c1"># See See 2.8.2 Symmetric in the Cookbook: https://www2.imm.dtu.dk/pubdb/edoc/imm3274.pdf</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>            <span class="k">return</span> <span class="n">Product</span><span class="p">(</span><span class="n">Delta</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">new_names</span><span class="p">[</span><span class="n">e</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>        <span class="c1"># Note: We don&#39;t need to tell Zero the symmetries, since it&#39;s automatically</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>        <span class="c1"># symmetric in all dimensions that have compatible sizes.</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>        <span class="k">return</span> <span class="n">Zero</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">|</span> <span class="p">{</span><span class="n">new_names</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()}))</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">, </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>        <span class="n">symmetries</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span> <span class="o">!=</span> <span class="p">{</span><span class="nb">frozenset</span><span class="p">({</span><span class="n">e</span><span class="p">})</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">}:</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>            <span class="n">groups</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">group</span><span class="p">))</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="p">))</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>            <span class="n">symmetries</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;.with_symmetries(&quot;</span><span class="si">{</span><span class="n">groups</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Variable(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">symmetries</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        <span class="c1"># Symmetries are more fine-grained than shapes, since two dims can have</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="c1"># the same size, but not be symmetric. E.g. an assymetric square matrix.</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>        <span class="c1"># Example of variable with 2 sizes, 3 symmetri orbits and 4 edges:</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>        <span class="c1"># +-size 1-sym 1-e 1</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>        <span class="c1"># |  +-----sym 2-e 2</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>        <span class="c1"># +-size 2-sym 3-e 3</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>        <span class="c1">#           +----e 4</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>            <span class="c1"># Symbols are identified by name and assumptions. We might want to have edges</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>            <span class="c1"># with the same name but different assumptions, so add the id to the node name.</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">size_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;size=</span><span class="si">{</span><span class="n">size</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">size</span><span class="p">)))</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size_node</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>            <span class="c1"># Find each orbit with the given size (see note above about fine-grained-ness)</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>            <span class="k">for</span> <span class="n">orbit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="p">:</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>                <span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">orbit</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">!=</span> <span class="n">size</span><span class="p">:</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>                    <span class="k">continue</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>                <span class="c1"># Orbits are named after the variable edges. This ensures that variables are only</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>                <span class="c1"># isomoprhic with other variables with the same edge names.</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>                <span class="n">orbit_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">orbit</span><span class="p">))</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">orbit_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Orbit Node&quot;</span><span class="p">,</span> <span class="n">orbit_name</span><span class="p">))</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">size_node</span><span class="p">,</span> <span class="n">orbit_node</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>                <span class="c1"># All the free edges point to an orbit node</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">orbit</span><span class="p">:</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                    <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">orbit_node</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>            <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>        <span class="k">return</span> <span class="n">Rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>            <span class="k">return</span> <span class="n">y</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="c1">################################################################################</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="c1"># Constants</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="c1">################################################################################</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Rename</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">    A tensor that renames the edges of an inner tensor.</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a><span class="sd">    This is used to change free edge names (and sometimes inner edge names)</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">    without modifying the underlying contraction.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inner</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">rename</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">        Initialize a Rename tensor.</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a><span class="sd">        Args:</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a><span class="sd">            inner: The tensor to be renamed.</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a><span class="sd">            rename: A dictionary mapping old edge names to new names.</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Rename&quot;</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span> <span class="o">=</span> <span class="n">inner</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rename</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">v</span><span class="p">}</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">{</span><span class="n">rename</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span> <span class="n">s</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">inner</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="n">argstring</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="si">}</span><span class="s2">.rename(</span><span class="si">{</span><span class="n">argstring</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>        <span class="c1"># If the new names are used in inner, we need to rename them, and then add the</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>        <span class="c1"># new names to our own rename dict.</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>        <span class="n">middle</span> <span class="o">=</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">new_names</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>        <span class="n">middle_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">middle</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_names</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>        <span class="n">middle_to_new</span> <span class="o">=</span> <span class="p">{</span><span class="n">middle</span><span class="p">[</span><span class="n">n</span><span class="p">]:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_names</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>        <span class="k">return</span> <span class="n">Rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">middle_names</span><span class="p">),</span> <span class="n">middle_to_new</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">merge_renames</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">renames</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="sd">        Merge several renaming dictionaries into one.</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a><span class="sd">        Args:</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a><span class="sd">            *renames: Arbitrary number of renaming dictionaries.</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a><span class="sd">        Returns:</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a><span class="sd">            A single dictionary representing the merged renaming.</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>        <span class="n">merged</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>        <span class="k">for</span> <span class="n">rename</span> <span class="ow">in</span> <span class="n">renames</span><span class="p">:</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>            <span class="n">used</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">|</span> <span class="n">merged</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>            <span class="c1"># Apply the rename to the existing chains</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>            <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                <span class="n">merged</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">rename</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>            <span class="c1"># Add new renames</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>            <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">rename</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>                <span class="k">if</span> <span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                    <span class="n">merged</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>        <span class="k">return</span> <span class="n">merged</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>        <span class="n">inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inner</span><span class="p">,</span> <span class="n">Rename</span><span class="p">):</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>            <span class="n">merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_renames</span><span class="p">(</span><span class="n">inner</span><span class="o">.</span><span class="n">mapping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">merged</span><span class="p">)</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">Rename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">mapping</span><span class="p">:</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">tensor</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>        <span class="k">return</span> <span class="n">Rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_renames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>        <span class="k">return</span> <span class="n">Rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>        <span class="c1"># Rename is the only tensor that doesn&#39;t actually create its own node in the graph</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>        <span class="c1"># This allows Variable(i, j=i).with_symmetries(&quot;i j&quot;) to be isomorphic to</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="c1"># Rename(Variable(j, i=j).with_symmetries(&quot;i j&quot;), {&quot;i&quot;: &quot;j&quot;, &quot;j&quot;: &quot;i&quot;})</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">structural_graph</span><span class="p">()</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">t_edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>            <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Constant</span><span class="p">(</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">    An abstract tensor that represents a constant (non-variable) tensor.</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">shape0</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span> <span class="n">_symmetries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">shape1</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">):</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">        A constant tensor with the given edges.</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">        Args:</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">            shape0: Positional dimensions (as Sympy symbols).</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">            _symmetries: Optional symmetry groups.</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">            shape1: Keyword dimensions.</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;NotImplemented&quot;</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_shape</span><span class="p">(</span><span class="n">shape0</span><span class="p">,</span> <span class="n">shape1</span><span class="p">)</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span> <span class="n">_symmetries</span><span class="p">)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetries</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Constant&quot;</span><span class="p">:</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span> <span class="n">_symmetries</span><span class="o">=</span><span class="n">symmetries</span><span class="p">)</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>            <span class="c1"># All of this is more or less equal to Variable</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">size_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;size=</span><span class="si">{</span><span class="n">size</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size_node</span><span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>            <span class="c1"># Find each orbit with the given size (see note above about fine-grained-ness)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>            <span class="k">for</span> <span class="n">orbit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="p">:</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>                <span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">orbit</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">!=</span> <span class="n">size</span><span class="p">:</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>                    <span class="k">continue</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">orbit_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Orbit Node&quot;</span><span class="p">)</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">size_node</span><span class="p">,</span> <span class="n">orbit_node</span><span class="p">)</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">orbit</span><span class="p">:</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>                    <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">orbit_node</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="o">**</span><span class="p">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span> <span class="n">s</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="k">return</span> <span class="n">Zero</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">|</span> <span class="p">{</span><span class="n">new_names</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()}))</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Delta</span><span class="p">(</span><span class="n">Constant</span><span class="p">):</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The &quot;Delta&quot; tensor is defined by C_{i,j,k} = 1 if i == j == k, else 0</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a><span class="sd">    Or alternatively as Δₙ = ∑ₓ (eₓ)⊗ⁿ, where are e_i are basis vectors</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="sd">    For order 2, this is the identity matrix.</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a><span class="sd">        Note: For higher order, the identity tensor is the product of n identity matrices,</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a><span class="sd">        (order 2 Delta&#39;s), not the order-n Delta tensor.</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="sd">    For order 0, the Delta tensor is defined as |n|, where n is the size/dimension of the tensor.</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span> <span class="o">*</span><span class="n">edges</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">        Initialize a Delta tensor.</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a><span class="sd">        Args:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="sd">            size: The size (dimension) of the tensor.</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">            edges: The names of the tensor edges.</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_edges</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">size</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">})</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">Number</span><span class="p">)),</span> <span class="s2">&quot;Size must be a sympy symbol&quot;</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>    <span class="nd">@property</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbol</span><span class="p">:</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Delta(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Delta(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">, </span><span class="se">\&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">)&quot;</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="k">return</span> <span class="n">Delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">])</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simplify_outer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Simplifies a list of tensors assumed to be a product.&quot;&quot;&quot;</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>            <span class="n">tensors</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_simplify_step</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                <span class="k">break</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>        <span class="k">return</span> <span class="n">tensors</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">size_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size_node</span><span class="p">)</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">size_node</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>    <span class="c1">################################################################################</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>    <span class="c1"># There are many simplify rules for Delta. We split them into separate methods for clarity.</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify_step</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs one step of simplification. Returns a new list if changed, or the original if not.&quot;&quot;&quot;</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">_group_edges</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>                <span class="k">continue</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">ts</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>            <span class="k">assert</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">==</span> <span class="n">t2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="si">=}</span><span class="s2"> != </span><span class="si">{</span><span class="n">t2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">e</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            <span class="c1"># Remove t1 and t2 from tensors.  We use the &quot;is&quot; operator, since equality</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>            <span class="c1"># means isomorphic, so it might remove too many unintended tensors.</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>            <span class="n">other</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">t1</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">t2</span><span class="p">]</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>            <span class="k">for</span> <span class="n">simplification</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_merge_copy_tensors</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_remove_identity_matrix</span><span class="p">]:</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">:=</span> <span class="n">simplification</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>                    <span class="k">return</span> <span class="n">other</span> <span class="o">+</span> <span class="n">new</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>        <span class="k">return</span> <span class="n">tensors</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_copy_tensors</span><span class="p">(</span><span class="n">t1</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]:</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)):</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>        <span class="c1"># We can&#39;t merge order 0 copy tensors, since we now give them a value equal to their size.</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>        <span class="c1"># In principle we could create a new Delta(size1 * size2, []) tensor, but then we start having</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>        <span class="c1"># arbitrary expressions as sizes, which I&#39;m not sure we want yet.</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>        <span class="c1"># Also, merging an order 0 with and order &gt; 0 was never going to work, unless the size of the</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>        <span class="c1"># order 0 Delta was 1, which it probably never is.</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>        <span class="c1"># In either case, this method should only be called if the tensors share an edge, which they</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>        <span class="c1"># can&#39;t if one of them has order 0.</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>        <span class="k">assert</span> <span class="n">t1</span><span class="o">.</span><span class="n">order</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t2</span><span class="o">.</span><span class="n">order</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Can&#39;t merge order 0 Delta tensors&quot;</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>        <span class="c1"># Since the tensors are connected, we can assume they have the same size</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>        <span class="k">assert</span> <span class="n">t1</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">t2</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;Contracted Delta tensors must have same size&quot;</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>        <span class="n">size</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">size</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>        <span class="c1"># We don&#39;t just remove e, but remove all shared edges</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>        <span class="c1"># The amazing thing is that even in the case where all edges disappear, we</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>        <span class="c1"># still get to keep information on the &quot;size&quot; of the Delta tensor.</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">Delta</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">edges</span> <span class="o">^</span> <span class="n">t2</span><span class="o">.</span><span class="n">edges</span><span class="p">))]</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_identity_matrix</span><span class="p">(</span><span class="n">t1</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]:</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="c1"># If both are Delta&#39;s, we use the previous method</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">Delta</span><span class="p">):</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>        <span class="c1"># Make t1 the identity matrix</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t2</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t1</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>            <span class="c1"># Find the edge of t1 that&#39;s not e</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>            <span class="n">other_edge</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="n">e</span><span class="p">}))</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>            <span class="c1"># Don&#39;t create self loops. We never connect a tensor to itself.</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>            <span class="c1"># Unless it&#39;s another Delta, in which case we already handled it above.</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>            <span class="k">if</span> <span class="n">other_edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t2</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>                <span class="k">return</span> <span class="p">[</span><span class="n">t2</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">other_edge</span><span class="p">})]</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Zero</span><span class="p">(</span><span class="n">Constant</span><span class="p">):</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix such that Z_{i,j,k} = 0 for all i, j, k&quot;&quot;&quot;</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="k">def</span><span class="w"> </span><span class="nf">Ones</span><span class="p">(</span><span class="o">*</span><span class="n">shape0</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span> <span class="o">**</span><span class="n">shape1</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix such that O_{i,j,k} = 1 for all i, j, k&quot;&quot;&quot;</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>    <span class="c1"># Implemented in practice by a simple outer product of Delta&#39;s</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>    <span class="n">shape</span> <span class="o">=</span> <span class="n">Tensor</span><span class="o">.</span><span class="n">_check_shape</span><span class="p">(</span><span class="n">shape0</span><span class="p">,</span> <span class="n">shape1</span><span class="p">)</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>    <span class="k">return</span> <span class="n">Product</span><span class="p">([</span><span class="n">Delta</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a><span class="c1">################################################################################</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="c1"># Function</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a><span class="c1">################################################################################</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a><span class="nd">@dataclass</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a><span class="k">class</span><span class="w"> </span><span class="nc">FunctionSignature</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a><span class="sd">    An abstract base class representing a function that takes one or more tensors as input</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="sd">    and produces a new tensor as output.</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">    This class is designed to capture the symbolic structure of a tensor operation by</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">    listing its output edges (`edges`) and the input edges (`inputs`) each of its input</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="sd">    tensors must provide. Subclasses are required to implement the `eval` and `derivative`</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="sd">    methods, while `simplify` has a default no-op implementation that may be overridden.</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">    Parameters</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">    ----------</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a><span class="sd">    name : str</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="sd">        A descriptive name for the function (e.g., &quot;matmul&quot;, &quot;unfold&quot;, &quot;ce&quot;, &quot;attention&quot;).</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">    edges : Set[str]</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">        The output edges of this function. These are string identifiers that symbolically</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">        represent the dimensions of the output tensor.</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">    inputs : tuple[Set[str], ...]</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="sd">        A tuple where each element is a set of edges required from one input tensor.</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">        For example, if the first input tensor must share dimension edges {&quot;b&quot;, &quot;i&quot;} and</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a><span class="sd">        the second input tensor must share dimension edges {&quot;b&quot;, &quot;j&quot;}, then</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a><span class="sd">        `inputs = ({&quot;b&quot;, &quot;i&quot;}, {&quot;b&quot;, &quot;j&quot;})`.</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a><span class="sd">    Examples</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a><span class="sd">    --------</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a><span class="sd">    1) **Matrix multiplication**:</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="sd">       Suppose `x` has shape (b, i, j) and `y` has shape (b, j, k). We might define:</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a><span class="sd">       .. code-block:: python</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a><span class="sd">          f = MatmulSignature(</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a><span class="sd">              name=&quot;matmul&quot;,</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="sd">              edges={&quot;i&quot;, &quot;k&quot;},</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="sd">              inputs=({&quot;i&quot;, &quot;j&quot;}, {&quot;j&quot;, &quot;k&quot;})</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a><span class="sd">          )</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">       Here, the function consumes edges `i` and `j` from `x` and edges `j` and `k` from `y`.</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a><span class="sd">       The edge `b` is shared between the two inputs and broadcasted. The output tensor</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a><span class="sd">       eventually has shape (b, i, k).</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a><span class="sd">    2) **Unfold**:</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a><span class="sd">       Suppose we have a tensor `x` with shape (b, c, w, h) and we want to produce a series</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">       of patches. We might define:</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a><span class="sd">       .. code-block:: python</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">          f = UnfoldSignature(</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">              name=&quot;unfold&quot;,</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">              edges={&quot;patch&quot;, &quot;c_out&quot;, &quot;w_out&quot;, &quot;h_out&quot;},</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a><span class="sd">              inputs=({&quot;c_in&quot;, &quot;w_in&quot;, &quot;h_in&quot;},)</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a><span class="sd">          )</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a><span class="sd">       This function consumes edges ``c, w, h`` from `x` and introduces a new edge</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a><span class="sd">       named ``patch`` of size (w_in - w_out + 1)*(h_in - h_out + 1).</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a><span class="sd">    3) **Cross-entropy**:</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a><span class="sd">       This is an example of a function that takes two inputs, for example logits and</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a><span class="sd">       probabilities. Suppose:</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a><span class="sd">       - `x` has shape (b, logits)</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a><span class="sd">       - `y` has shape (b, probs)</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a><span class="sd">       We might define:</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="sd">       .. code-block:: python</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a><span class="sd">          f = CrossEntropySignature(</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">              name=&quot;ce&quot;,</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a><span class="sd">              edges={&quot;ce&quot;},</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a><span class="sd">              inputs=({&quot;logits&quot;}, {&quot;probs&quot;})</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="sd">          )</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="sd">       Both inputs share the batch edge ``b``. The new edge ``ce`` could represent the</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">       cross-entropy output dimension (often scalar per example, so shape (b, ce)).</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="sd">    4) **Multi-query Dot Product Attention**:</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="sd">       Suppose we have tensors:</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a><span class="sd">       - `q` with shape (b, n_q, d)</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a><span class="sd">       - `k` with shape (b, seq, d)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a><span class="sd">       - `v` with shape (b, seq, d_out)</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="sd">       Conceptually, to compute multi-query attention:</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">       - We form (b, n_q, seq) via a dot product of `q` and `k`.</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="sd">       - We apply a softmax to get (b, n_q, prob).</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">       - We multiply by `v` to get (b, n_q, d_out).</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">       A possible signature might be:</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">       .. code-block:: python</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">          f = AttentionSignature(</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">              name=&quot;attention&quot;,</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">              edges={&quot;n_q&quot;, &quot;d_out&quot;},</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="sd">              inputs=(</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">                  {&quot;n_q&quot;, &quot;d&quot;},</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">                  {&quot;seq&quot;, &quot;d&quot;},</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="sd">                  {&quot;seq&quot;, &quot;d_out&quot;},</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="sd">              )</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">          )</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">       The edge ``b`` is shared among all inputs (broadcast). The final output</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">       has shape (b, n_q, d_out).</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>    <span class="c1"># The output edges of the function. Note no Symbols here, since we don&#39;t know the sizes yet.</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>    <span class="n">edges</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>    <span class="c1"># Defines the number of input tensors the function takes, and what edges it needs from each</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>    <span class="n">inputs</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>    <span class="c1"># TODO: Functions should support symmetric outputs, just like Constant and Variable.</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>    <span class="c1"># Actually we could define symmetries for the inputs too, since the order doesn&#39;t always matter.</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">new_edges</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FunctionSignature&quot;</span><span class="p">:</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">        Returns a new FunctionSignature that represents the derivative</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">        with respect to the i-th input, and where edges are created</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">        according to `new_edges` a dict {old_name : new_name}.</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>        <span class="k">if</span> <span class="n">new_edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>            <span class="n">new_edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> but got </span><span class="si">{</span><span class="n">new_edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_edges</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New edges </span><span class="si">{</span><span class="n">new_edges</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="si">}</span><span class="s2"> clash with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>        <span class="k">return</span> <span class="n">FunctionSignature</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;D_</span><span class="si">{</span><span class="n">i</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_edges</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="s2">&quot;Function&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a><span class="sd">        Simplifies the Function tensor that uses this signature.</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a><span class="sd">        Default implementation returns `t` unchanged.</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a><span class="sd">        Subclasses can override this method for custom simplifications.</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>        <span class="k">return</span> <span class="n">t</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;FunctionSignature(&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="k">def</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>    <span class="n">output_shape</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">],</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>    <span class="o">*</span><span class="n">inputs</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Tensor</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Function&quot;</span><span class="p">:</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a><span class="sd">    Create a Function tensor from a name, output shape and inputs.</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="sd">    Args:</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a><span class="sd">        name: The function name.</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a><span class="sd">        output_shape: A dictionary mapping output edge names to sizes.</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a><span class="sd">        inputs: A sequence of tuples where each tuple starts with a tensor (or string)</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a><span class="sd">                followed by the required edge names.</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="sd">    Returns:</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="sd">        A Function tensor.</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>    <span class="k">return</span> <span class="n">Function</span><span class="p">(</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>        <span class="n">FunctionSignature</span><span class="p">(</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>            <span class="n">name</span><span class="p">,</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>            <span class="n">output_shape</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>            <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">es</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">],</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="p">),</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">],</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>        <span class="n">output_shape</span><span class="p">,</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>    <span class="p">)</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Function</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="sd">    A tensor that represents a function applied to one or more input tensors.</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">    Attributes:</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">        signature: The FunctionSignature for this function.</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">        inputs: A list of input tensors.</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">        shape_out: A dictionary mapping output edge names to sizes.</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>        <span class="n">signature</span><span class="p">:</span> <span class="n">FunctionSignature</span><span class="p">,</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>        <span class="n">shape_out</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">],</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>    <span class="p">):</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">        A function tensor that takes one or more input tensors and produces an output tensor.</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="sd">        Args:</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">            signature: The FunctionSignature defining this function, or a string giving the function name.</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a><span class="sd">            inputs: The input tensors and their input edge names. [(t0, e00, e01, ...), (t1, e10, ...), ...]</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a><span class="sd">            shape_out: The names of the output edges of this function.</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_shape</span><span class="p">([],</span> <span class="n">shape_out</span><span class="p">)</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>        <span class="c1"># Validation</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">!=</span> <span class="n">signature</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signature doesn&#39;t match shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">=}</span><span class="s2"> != </span><span class="si">{</span><span class="n">signature</span><span class="o">.</span><span class="n">edges</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2"> inputs, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">es</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>            <span class="k">if</span> <span class="n">es</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input edges </span><span class="si">{</span><span class="n">es</span><span class="si">}</span><span class="s2"> not subset of </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="c1"># Build final shape = union of output edges + broadcast edges from each input</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>        <span class="c1"># Note that this approach pushes all the broadcasted edges to the end of the shape.</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>        <span class="c1"># But we don&#39;t care about the order of the edges, so it&#39;s fine.</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">)</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>        <span class="c1"># We allow &quot;broadcasting&quot; for edges that are not in fn_sig.inputs[i].</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>        <span class="c1"># So if an input has edges that are not used, they&#39;re broadcasted.</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">es</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>            <span class="c1"># any edges in t.edges - es are &quot;broadcast&quot;</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>            <span class="n">broadcast_edges</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span> <span class="o">-</span> <span class="n">es</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>            <span class="k">if</span> <span class="n">broadcast_edges</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Broadcast edges must not be shared between inputs&quot;</span><span class="p">)</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">broadcast_edges</span><span class="p">:</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="n">renamed_inputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">es</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>            <span class="c1"># Only rename external edges of input tensors.</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>            <span class="n">rename</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">es</span><span class="p">}</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>            <span class="n">renamed_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">rename</span><span class="p">))</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>        <span class="n">output_rename</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">}</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>            <span class="n">renamed_inputs</span><span class="p">,</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">,</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>        <span class="p">)</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>        <span class="k">if</span> <span class="n">output_rename</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">output_rename</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">Rename</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">output_rename</span><span class="p">)</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>        <span class="n">new_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>        <span class="c1"># Broadcasting can be pulled out of the function.</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>        <span class="n">pulled_out</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>        <span class="n">new_inputs2</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">es</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Product</span><span class="p">):</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>                <span class="n">new_prod</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>                <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>                    <span class="k">if</span> <span class="p">(</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>                        <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>                        <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">edges</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>                        <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">edges</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">es</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>                    <span class="p">):</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>                        <span class="n">pulled_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>                        <span class="n">new_prod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>                <span class="n">new_inputs2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Product</span><span class="p">(</span><span class="n">new_prod</span><span class="p">))</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>                <span class="n">new_inputs2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>        <span class="n">new_inputs</span> <span class="o">=</span> <span class="n">new_inputs2</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="n">new_inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">)</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>        <span class="c1"># This results in an extra simplify call to all the children of the function.</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>        <span class="c1"># Maybe we can avoid this somehow?</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>        <span class="n">old_shape</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>        <span class="k">assert</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">old_shape</span><span class="p">,</span> <span class="s2">&quot;Function signature simplify should not change shape&quot;</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>        <span class="k">if</span> <span class="n">pulled_out</span><span class="p">:</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">Product</span><span class="p">([</span><span class="n">res</span><span class="p">]</span> <span class="o">+</span> <span class="n">pulled_out</span><span class="p">)</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>        <span class="c1"># We sum over each input function, just like the normal chain rule:</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>        <span class="c1"># d/dx f(g₁(x), …, gₖ(x)) = Σᵢ₌₁ᵏ (d/dx gᵢ(x)) Dᵢf(g₁(x), …, gₖ(x))</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>        <span class="c1"># D_i adds a new output edge to the function, which is contracted with</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>        <span class="c1"># the normal output edge of the tensor. So we need to make sure this doesn&#39;t</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>        <span class="c1"># clash with an existing output edge of f.</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">input_edges</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>            <span class="c1"># Take the derivative of the outer function</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>            <span class="c1"># We need &quot;connection&quot; edges for each edge in input_edges. Mostly we could just use the same name</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>            <span class="c1"># but they need to avoid clashing with &quot;new_names&quot; and the output edges of the tensor.</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>            <span class="n">connection_names</span> <span class="o">=</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">input_edges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">|</span> <span class="n">new_names</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>            <span class="c1"># Just like simple calculus, we need the derivative of the outside times the derivative of the inside</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>            <span class="n">outside</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">connection_names</span><span class="p">),</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span> <span class="o">|</span> <span class="p">{</span><span class="n">connection_names</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">input_edges</span><span class="p">},</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>            <span class="p">)</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>            <span class="k">assert</span> <span class="n">outside</span><span class="o">.</span><span class="n">edges</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">|</span> <span class="n">connection_names</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>            <span class="c1"># The the derivative of the inner function</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>            <span class="c1"># We rename the (former) input edges to the connection edges, but keep the remaining edges</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>            <span class="c1"># (which are part of self.edges) untouched.</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>            <span class="n">inner</span> <span class="o">=</span> <span class="n">Derivative</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">connection_names</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>            <span class="c1"># The two parts are then multiplied together on the connection names,</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>            <span class="c1"># while broadcasted on their remaining shared edges.</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">tensorgrad.functions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>  <span class="c1"># Import here to avoid circular import</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>            <span class="n">part</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">outside</span> <span class="o">*</span> <span class="n">inner</span><span class="p">,</span> <span class="n">connection_names</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>        <span class="c1"># (1) We add a node for the &quot;function&quot; tensor itself</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>        <span class="c1"># TODO: Why is this needed?</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>        <span class="c1"># (2) We add a node for each output edge</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>        <span class="c1"># TODO: We should group out-edges by the size-type, similarly to Variable/Constant</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>        <span class="c1"># And of course when we add symmetries to outputs, we need to add that too.</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">):</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Edge Out&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>            <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>        <span class="c1"># (3) And we add nodes for all the input tensors</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">input_edges</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>            <span class="c1"># Compute graph from input tensor, and ensure it uses distinct node numbers</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>            <span class="c1"># Tag the inputs with {i} since order matters for function inputs.</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>            <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>            <span class="c1"># Connect tensor to function. We don&#39;t need to label here, since</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>            <span class="c1"># the input tensor already has labeled its own edges as much as it needs to.</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">input_edges</span><span class="p">:</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">t_edges</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>            <span class="c1"># Finally register free edges</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>                <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_edges</span><span class="p">:</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>                    <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">))</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inputs=[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">))</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;shape_out=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Function(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>        <span class="k">return</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">)</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Derivative</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a><span class="sd">    A tensor representing the derivative of another tensor with respect to a variable.</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">wrt</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a><span class="sd">        A tensor representing the derivative of another tensor.</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a><span class="sd">        Args:</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a><span class="sd">            tensor: The tensor to differentiate.</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a><span class="sd">            x: The variable with respect to which to differentiate.</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a><span class="sd">            new_names: A mapping for renaming edges (if not provided, it will be generated).</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span> <span class="o">=</span> <span class="n">tensor</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">wrt</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>        <span class="c1"># If no edges were given, pick some names based on x, but avoid clashes with tensor.</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">_check_grad</span><span class="p">(</span><span class="n">wrt</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span> <span class="o">|</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span> <span class="n">wrt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">wrt</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>            <span class="k">return</span> <span class="n">Zero</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>        <span class="n">inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;grad_steps&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>            <span class="c1"># If grad_steps is 0, we pass the simplify through the derivative.</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">Derivative</span><span class="p">(</span><span class="n">inner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="p">)</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;grad_steps&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>            <span class="c1"># Have to call simplify twice to avoid an infinite loop when stacking multiple derivatives.</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="p">)</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>        <span class="c1"># To avoid an infinite loop, we let the grad pass through us, rather than creating a double derivative.</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>        <span class="k">return</span> <span class="n">Derivative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="p">)</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>        <span class="c1"># The free edges of Derivative are both the free edges of self.tensor and the new_names.</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>        <span class="c1"># This is the only place where we need to rename the &quot;internal edges&quot; of the tensor.</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>        <span class="k">return</span> <span class="n">Derivative</span><span class="p">(</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>            <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>        <span class="p">)</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Derivative&quot;</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>        <span class="c1"># We add a node for the &quot;wrt&quot; tensor</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>        <span class="c1"># and connect new_edges to point to the respective edges in self.x</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">x_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="o">=</span><span class="s2">&quot;self.x&quot;</span><span class="p">)</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>        <span class="n">edges</span> <span class="o">|=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">oe</span><span class="p">]</span> <span class="k">for</span> <span class="n">oe</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>        <span class="c1"># Then we add the differentiated tensor</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="o">=</span><span class="s2">&quot;self.tensor&quot;</span><span class="p">)</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>        <span class="n">edges</span> <span class="o">|=</span> <span class="n">t_edges</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Derivative(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a><span class="c1">################################################################################</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a><span class="c1"># Product</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a><span class="c1">################################################################################</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a><span class="sd">    A tensor representing the product (contraction) of several tensors.</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factors</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]):</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a><span class="sd">        Initialize a Product tensor.</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a><span class="sd">        Args:</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a><span class="sd">            factors: An iterable of tensors to be multiplied/contracted.</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>        <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">_group_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>                <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">]</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>                <span class="k">if</span> <span class="n">s1</span> <span class="o">!=</span> <span class="n">s2</span><span class="p">:</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edge </span><span class="si">{</span><span class="n">edge</span><span class="si">}</span><span class="s2"> has different sizes, </span><span class="si">{</span><span class="n">s1</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">s2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>                    <span class="sa">f</span><span class="s2">&quot;edge </span><span class="si">{</span><span class="n">edge</span><span class="si">}</span><span class="s2"> had multiplicity </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="si">}</span><span class="s2">. Use an identity tensor to combine multiple edges.&quot;</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>                <span class="p">)</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>        <span class="c1"># Rename the inner edges (contractions) to avoid the new names introduced</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>        <span class="c1"># by the renaming of the free edges.</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>        <span class="n">new_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>        <span class="n">contractions</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>        <span class="c1"># Note the `unused_edge_names` function avoids introducing new clashes</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>        <span class="c1"># between the edges being renamed.</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>        <span class="n">rename</span> <span class="o">=</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">contractions</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>        <span class="c1"># It&#39;s safe to add the kwargs to rename, since self._check_rename restricts kwargs to only</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>        <span class="c1"># contain keys that are in self.edges.</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>        <span class="n">rename</span> <span class="o">|=</span> <span class="n">kwargs</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>        <span class="k">return</span> <span class="n">Product</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">rename</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">])</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="n">products</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Product&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Product&quot;</span><span class="p">:</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a><span class="sd">        Merge several Product tensors into one, renaming inner edges so they are distinct.</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a><span class="sd">        Args:</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a><span class="sd">            products: A list of Product tensors.</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a><span class="sd">        Returns:</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a><span class="sd">            A new Product tensor merging the inputs.</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>        <span class="n">used_edges</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>            <span class="c1"># Maybe this could also be expressed in terms of avoid_internal_edges</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>            <span class="n">inner_edges</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">factors</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>            <span class="n">rename</span> <span class="o">=</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">inner_edges</span><span class="p">,</span> <span class="n">used_edges</span><span class="p">)</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">rename</span><span class="p">))</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>            <span class="n">used_edges</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rename</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>  <span class="c1"># Later renames should not clash with this one</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>        <span class="k">return</span> <span class="n">Product</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>        <span class="c1"># Since we are adding new edges to an internal tensor in the product, we need to make sure</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>        <span class="c1"># none of the other tensors in the product have edges that clash with these new edges.</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>        <span class="n">inner_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>        <span class="n">new_edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_names</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>        <span class="n">rename</span> <span class="o">=</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">inner_names</span><span class="p">,</span> <span class="n">new_edges</span><span class="p">)</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>        <span class="n">new_prod</span> <span class="o">=</span> <span class="n">Product</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">rename</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">])</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>        <span class="k">assert</span> <span class="n">new_prod</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;Renaming should not change the product&quot;</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>        <span class="c1"># The classic product rule of Calculus: d/dx (f * g) = f&#39; * g + f * g&#39;</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">(</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>            <span class="p">[</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>                <span class="n">Product</span><span class="p">(</span><span class="n">new_prod</span><span class="o">.</span><span class="n">factors</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">Derivative</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)]</span> <span class="o">+</span> <span class="n">new_prod</span><span class="o">.</span><span class="n">factors</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:])</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_prod</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>            <span class="p">]</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>        <span class="p">)</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>        <span class="k">return</span> <span class="n">Product</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">])</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Product(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>            <span class="n">inner</span> <span class="o">=</span> <span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Product([</span><span class="se">\n</span><span class="si">{</span><span class="n">inner</span><span class="si">}</span><span class="se">\n</span><span class="s2">])&quot;</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>        <span class="n">tensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">]</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>        <span class="c1"># If any tensor in a product is 0, so is the whole product</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Zero</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">):</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>            <span class="k">return</span> <span class="n">Zero</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>        <span class="c1"># Decide whether to push products through sums. This can be useful to simplify networks for</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>        <span class="c1"># presentation, but it can also blow up the number of terms. So we make it optional.</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distributed_products&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented yet&quot;</span><span class="p">)</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>        <span class="c1"># Combine nested products. Note that not combining products may be useful to keep the</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>        <span class="c1"># &quot;natural&quot; contraction order. This can speed up evaluation, since sub-tensors can be reused.</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;associative_products&quot;</span><span class="p">]:</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>            <span class="n">sub_products</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Product</span><span class="p">)</span> <span class="k">else</span> <span class="n">Product</span><span class="p">([</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">]</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>            <span class="n">tensors</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sub_products</span><span class="p">)</span><span class="o">.</span><span class="n">factors</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>        <span class="c1"># We can do a &quot;small&quot; kind of distributed products, which is handling children that are single sums</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>        <span class="c1"># Also, if a child is a sum with a single element, we can pull the weight up.</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>        <span class="c1"># In general, we can pull out the least common multiple of the weights of the children.</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>        <span class="k">if</span> <span class="n">single_sums</span> <span class="o">:=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Sum</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">terms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>            <span class="n">tensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">single_sums</span> <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">]</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>            <span class="n">res_weight</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">single_sums</span><span class="p">)</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>            <span class="n">res_weight</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">verify_edges</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>            <span class="n">cnt</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">e</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="n">cnt</span> <span class="ow">or</span> <span class="n">cnt</span><span class="o">.</span><span class="n">most_common</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">msg</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>        <span class="c1"># Simplify Delta Tensors</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>        <span class="n">verify_edges</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>        <span class="n">tensors</span> <span class="o">=</span> <span class="n">Delta</span><span class="o">.</span><span class="n">simplify_outer</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>        <span class="n">verify_edges</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>        <span class="c1"># Combine / Cancel Product Functions</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;combine_products&quot;</span><span class="p">]:</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">tensorgrad.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">_PowerFunction</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>            <span class="n">verify_edges</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>            <span class="n">before</span> <span class="o">=</span> <span class="n">tensors</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>            <span class="n">tensors</span> <span class="o">=</span> <span class="n">_PowerFunction</span><span class="o">.</span><span class="n">simplify_outer</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>            <span class="n">verify_edges</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tensors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>        <span class="c1"># Base cases</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;expand&quot;</span><span class="p">]:</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>            <span class="n">terms</span> <span class="o">=</span> <span class="p">[[]]</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>            <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">:</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Sum</span><span class="p">):</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>                    <span class="c1"># Create cartesian product</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>                    <span class="n">terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">term</span> <span class="o">+</span> <span class="p">[</span><span class="n">t0</span><span class="p">]</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span> <span class="k">for</span> <span class="n">t0</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">terms</span><span class="p">]</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>                    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">*</span> <span class="n">w0</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span> <span class="k">for</span> <span class="n">w0</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">weights</span><span class="p">]</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>                    <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>                        <span class="n">term</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>            <span class="c1"># Recurse with expand=False to avoid infinite descent</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">Sum</span><span class="p">([</span><span class="n">Product</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">],</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">Product</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>        <span class="k">if</span> <span class="n">res_weight</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">res_weight</span> <span class="o">*</span> <span class="n">res</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">components</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Product&quot;</span><span class="p">]:</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a><span class="sd">        Decompose the product into disjoint components (subgraphs).</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a><span class="sd">        Returns:</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a><span class="sd">            A list of Product tensors representing disjoint components.</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>        <span class="c1"># Create graph of tensor connections</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)))</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">):</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>                    <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>        <span class="c1"># Find connected components</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>        <span class="n">component_sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="n">Product</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">component_sets</span><span class="p">]</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>        <span class="k">assert</span> <span class="n">Product</span><span class="p">(</span><span class="n">components</span><span class="p">)</span><span class="o">.</span><span class="n">edges</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>        <span class="k">return</span> <span class="n">components</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>        <span class="n">inner_edges</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>            <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>            <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">t_edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>                <span class="n">inner_edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">inner_edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>                <span class="c1"># Note that inner edges are bidirectional, since tensor products</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>                <span class="c1"># are associative.</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>                <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">nodes</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">n1</span><span class="p">)</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>                <span class="c1"># If the edge is only present once, it&#39;s an outer edge</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>                <span class="k">assert</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>                <span class="p">(</span><span class="n">n1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">nodes</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>                <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">n1</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_to_einsum_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a><span class="sd">        Convert the product to an einsum equation.</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a><span class="sd">        The main utility is that Delta tensors are mostly removed in favor of hyper edges, which are more efficient to compute.</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a><span class="sd">        However, some Deltas are still needed, so we return the list of tensors that should be</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a><span class="sd">        used with the einsum equation.</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a><span class="sd">        Returns:</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a><span class="sd">            A tuple (factors, equation) where factors is a list of tensors and</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a><span class="sd">            equation is the corresponding einsum string.</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a><span class="sd">        Raises:</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a><span class="sd">            ValueError: If there are too many unique edges.</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>        <span class="n">unique_edges</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_edges</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">52</span><span class="p">:</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Too many unique edges (</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> &gt; 52) to convert to einsum equation&quot;</span><span class="p">)</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>        <span class="n">name_to_idx</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">ascii_letters</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">name_to_idx</span><span class="p">)])</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>        <span class="c1"># The main challenge is to convert Delta tensors to hyper edges</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>        <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>        <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ft</span><span class="o">.</span><span class="n">order</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>                <span class="n">output_edges</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">edges</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>                <span class="n">input_edges</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">edges</span> <span class="o">-</span> <span class="n">output_edges</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>                <span class="c1"># However, einsum doesn&#39;t support duplicated indices in the output, like i-&gt;ii,</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>                <span class="c1"># So we need to recreate some Delta tensors manually</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_edges</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>                    <span class="n">e0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_edges</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_edges</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ft</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>                            <span class="n">name_to_idx</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_to_idx</span><span class="p">[</span><span class="n">e0</span><span class="p">]</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_edges</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">input_edges</span><span class="p">:</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>                            <span class="n">name_to_idx</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_to_idx</span><span class="p">[</span><span class="n">e0</span><span class="p">]</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>                        <span class="n">compressed_delta</span> <span class="o">=</span> <span class="n">Delta</span><span class="p">(</span><span class="n">ft</span><span class="o">.</span><span class="n">_size</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="o">*</span><span class="n">output_edges</span><span class="p">)</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>                        <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compressed_delta</span><span class="p">)</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>                    <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>                <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>        <span class="n">equation</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_to_idx</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ft</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span> <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">)</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>        <span class="n">equation</span> <span class="o">+=</span> <span class="s2">&quot;-&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_to_idx</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>        <span class="k">return</span> <span class="n">factors</span><span class="p">,</span> <span class="n">equation</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a><span class="c1">################################################################################</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a><span class="c1"># Sum</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a><span class="c1">################################################################################</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Sum</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a><span class="sd">    A weighted sum of several tensors.</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a><span class="sd">        A weighted sum of multiple tensors.</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a><span class="sd">        Args:</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a><span class="sd">            terms: The tensors to add together.</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a><span class="sd">            weights: The weights of each tensor in the sum. If not provided, all weights are 1.</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>        <span class="n">terms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>        <span class="c1"># Broadcasting means we always upgrade to the super set of edges</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">_group_edges</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">):</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edge </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> had different sizes in tensors: </span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>        <span class="c1"># Any tensors that lacks an edge will be broadcasted to have that edge.</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>        <span class="n">all_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>            <span class="n">missing</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">all_edges</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>            <span class="c1"># Note: don&#39;t broadcast if the tensor is already full, since that would create new</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>            <span class="c1"># Ones([]) objects after simplification is supposed to have completed.</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span> <span class="o">@</span> <span class="n">Ones</span><span class="p">(</span><span class="o">**</span><span class="n">missing</span><span class="p">)</span> <span class="k">if</span> <span class="n">missing</span> <span class="k">else</span> <span class="n">t</span><span class="p">)</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="n">Derivative</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>        <span class="n">terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">]</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>        <span class="n">term_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>        <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">terms</span><span class="p">):</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;associative_sums&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Sum</span><span class="p">):</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>                <span class="k">for</span> <span class="n">w1</span><span class="p">,</span> <span class="n">t1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">terms</span><span class="p">):</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>                    <span class="n">term_counter</span><span class="p">[</span><span class="n">_MatchEdgesKey</span><span class="p">(</span><span class="n">t1</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">w1</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>                <span class="n">term_counter</span><span class="p">[</span><span class="n">_MatchEdgesKey</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">w</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;sum_combine_terms&quot;</span><span class="p">]:</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>            <span class="c1"># Identify tensors with multiplicity and combine them. We use tensor.canon_with_edges to identify tensors.</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>            <span class="c1"># It is important that isomorphic tensors with different outer edge labels don&#39;t get matched. For example</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>            <span class="c1"># (o-i o-&lt;jk) is isomorphic with (o-j o-&lt;ik), but they shouldn&#39;t be combined. This example comes up in the</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>            <span class="c1"># Hessian of softmax.</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>            <span class="n">ws_tensors</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>                <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">term_counter</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>                <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Zero</span><span class="p">)</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>            <span class="p">]</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>            <span class="n">ws_tensors</span> <span class="o">=</span> <span class="p">[(</span><span class="n">w</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">term_counter</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>        <span class="c1"># Remove zero tensors or zero weights.</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>        <span class="c1"># Note: This won&#39;t change the shape of the tensor, since all summands have been broadcasted.</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>        <span class="n">ws_tensors</span> <span class="o">=</span> <span class="p">[(</span><span class="n">w</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ws_tensors</span> <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Zero</span><span class="p">)]</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>        <span class="c1"># Base case. Here we can&#39;t just return Zero([]), since that would change the signature of the tensor.</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ws_tensors</span><span class="p">:</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>            <span class="k">return</span> <span class="n">Zero</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>        <span class="n">weights</span><span class="p">,</span> <span class="n">tensors</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ws_tensors</span><span class="p">)</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>        <span class="c1"># If there is just one tensor with weight 1, we don&#39;t need LinearComb</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>        <span class="k">if</span> <span class="n">weights</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,):</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>            <span class="k">return</span> <span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Sum(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>        <span class="c1"># Create special &quot;Plus nodes&quot; to collect common edges</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>            <span class="c1"># Note: No need to add the shape here. It&#39;s already in the sub-tensors</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Plus Node&quot;</span><span class="p">)</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>            <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">):</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>            <span class="c1"># The weights are a little akward. There a lot of options for how to handle them.</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>            <span class="c1"># E.g. the idea of just using a weighted Delta([]) somehow. But this works.</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>            <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Weight </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>            <span class="c1"># Connect tensor edges to the plus nodes</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>            <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">t_edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">)</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a><span class="c1">################################################################################</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a><span class="c1"># Some useful functions</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a><span class="c1">################################################################################</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_group_edges</span><span class="p">(</span><span class="n">tensors</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]:</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Group tensors by their edge names.&quot;&quot;&quot;</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>    <span class="n">groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">:</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>            <span class="n">groups</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>    <span class="k">return</span> <span class="n">groups</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_add_structural_graph</span><span class="p">(</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>    <span class="n">G</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a><span class="sd">    Compute the structural graph for a tensor and merge it with an existing graph G.</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a><span class="sd">    Args:</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a><span class="sd">        G: An existing MultiDiGraph.</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a><span class="sd">        tensor: The tensor whose graph is to be added.</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a><span class="sd">        root_edge_label: An optional label for the root edge.</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a><span class="sd">    Returns:</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a><span class="sd">        A tuple (G, t_edges) where G is the updated graph and t_edges maps edge names to node IDs.</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">())),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>    <span class="n">Gx</span><span class="p">,</span> <span class="n">x_edges</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">structural_graph</span><span class="p">()</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>    <span class="n">offset</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>    <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">Gx</span><span class="o">.</span><span class="n">nodes</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Gx</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">())),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Gx</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>    <span class="c1"># We also assume that 0 is the root</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>    <span class="n">Gx</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">relabel_nodes</span><span class="p">(</span><span class="n">Gx</span><span class="p">,</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">offset</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Gx</span><span class="o">.</span><span class="n">nodes</span><span class="p">()})</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>    <span class="n">x_root</span> <span class="o">=</span> <span class="n">offset</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>    <span class="n">x_edges</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">x_edges</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">Gx</span><span class="p">)</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>    <span class="c1"># Make sure to connect the root of Gx to the root of G, possibly with an &quot;edge label&quot;</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>    <span class="k">if</span> <span class="n">root_edge_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>        <span class="n">e</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">root_edge_label</span><span class="p">)</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">x_root</span><span class="p">)</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_root</span><span class="p">)</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>    <span class="k">assert</span> <span class="n">x_edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">tensor</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">tensor</span><span class="o">.</span><span class="n">edges</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>    <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">x_edges</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a><span class="k">def</span><span class="w"> </span><span class="nf">_unused_edge_names</span><span class="p">(</span><span class="n">edges</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">used_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a><span class="sd">    Generate a mapping from each edge in &#39;edges&#39; to a new name that is not in used_names.</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a><span class="sd">    Args:</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a><span class="sd">        edges: An iterable of original edge names.</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a><span class="sd">        used_names: A collection of names that must be avoided.</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a><span class="sd">        suffix: A suffix to append to new names.</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a><span class="sd">    Returns:</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a><span class="sd">        A dictionary mapping original edge names to fresh names.</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>    <span class="n">used_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">used_names</span><span class="p">)</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>    <span class="n">rename</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>        <span class="n">candidate</span> <span class="o">=</span> <span class="n">e</span> <span class="o">+</span> <span class="n">suffix</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>        <span class="k">while</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">used_names</span><span class="p">:</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>            <span class="n">candidate</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>        <span class="n">rename</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidate</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>        <span class="n">used_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>    <span class="k">return</span> <span class="n">rename</span>
</span></pre></div>


            </section>
                <section id="TensorMeta">
                            <input id="TensorMeta-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TensorMeta</span><wbr>(<span class="base">abc.ABCMeta</span>):

                <label class="view-source-button" for="TensorMeta-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TensorMeta"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TensorMeta-18"><a href="#TensorMeta-18"><span class="linenos">18</span></a><span class="k">class</span><span class="w"> </span><span class="nc">TensorMeta</span><span class="p">(</span><span class="n">ABCMeta</span><span class="p">):</span>
</span><span id="TensorMeta-19"><a href="#TensorMeta-19"><span class="linenos">19</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="TensorMeta-20"><a href="#TensorMeta-20"><span class="linenos">20</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calling Tensor(...) is a shortcut to wrapping the argument in a tensor.&quot;&quot;&quot;</span>
</span><span id="TensorMeta-21"><a href="#TensorMeta-21"><span class="linenos">21</span></a>
</span><span id="TensorMeta-22"><a href="#TensorMeta-22"><span class="linenos">22</span></a>        <span class="c1"># Since we&#39;re hacking the metaclass, we need to check if we&#39;re being called on a subclass</span>
</span><span id="TensorMeta-23"><a href="#TensorMeta-23"><span class="linenos">23</span></a>        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="TensorMeta-24"><a href="#TensorMeta-24"><span class="linenos">24</span></a>            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="TensorMeta-25"><a href="#TensorMeta-25"><span class="linenos">25</span></a>
</span><span id="TensorMeta-26"><a href="#TensorMeta-26"><span class="linenos">26</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="TensorMeta-27"><a href="#TensorMeta-27"><span class="linenos">27</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Tensor(...) expects exactly one argument, e.g. Tensor(1).&quot;</span><span class="p">)</span>
</span><span id="TensorMeta-28"><a href="#TensorMeta-28"><span class="linenos">28</span></a>        <span class="n">val</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="TensorMeta-29"><a href="#TensorMeta-29"><span class="linenos">29</span></a>
</span><span id="TensorMeta-30"><a href="#TensorMeta-30"><span class="linenos">30</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="TensorMeta-31"><a href="#TensorMeta-31"><span class="linenos">31</span></a>            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="TensorMeta-32"><a href="#TensorMeta-32"><span class="linenos">32</span></a>                <span class="k">return</span> <span class="n">Zero</span><span class="p">()</span>
</span><span id="TensorMeta-33"><a href="#TensorMeta-33"><span class="linenos">33</span></a>            <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="TensorMeta-34"><a href="#TensorMeta-34"><span class="linenos">34</span></a>                <span class="k">return</span> <span class="n">Product</span><span class="p">([])</span>
</span><span id="TensorMeta-35"><a href="#TensorMeta-35"><span class="linenos">35</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TensorMeta-36"><a href="#TensorMeta-36"><span class="linenos">36</span></a>                <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="n">Product</span><span class="p">([])],</span> <span class="p">[</span><span class="n">val</span><span class="p">])</span>
</span><span id="TensorMeta-37"><a href="#TensorMeta-37"><span class="linenos">37</span></a>
</span><span id="TensorMeta-38"><a href="#TensorMeta-38"><span class="linenos">38</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">):</span>
</span><span id="TensorMeta-39"><a href="#TensorMeta-39"><span class="linenos">39</span></a>            <span class="k">return</span> <span class="n">Delta</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="TensorMeta-40"><a href="#TensorMeta-40"><span class="linenos">40</span></a>
</span><span id="TensorMeta-41"><a href="#TensorMeta-41"><span class="linenos">41</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="TensorMeta-42"><a href="#TensorMeta-42"><span class="linenos">42</span></a>            <span class="k">return</span> <span class="n">val</span>
</span><span id="TensorMeta-43"><a href="#TensorMeta-43"><span class="linenos">43</span></a>
</span><span id="TensorMeta-44"><a href="#TensorMeta-44"><span class="linenos">44</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid argument </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Metaclass for defining Abstract Base Classes (ABCs).</p>

<p>Use this metaclass to create an ABC.  An ABC can be subclassed
directly, and then acts as a mix-in class.  You can also register
unrelated concrete classes (even built-in classes) and unrelated
ABCs as 'virtual subclasses' -- these and their descendants will
be considered subclasses of the registering ABC by the built-in
issubclass() function, but the registering ABC won't show up in
their MRO (Method Resolution Order) nor will method
implementations defined by the registering ABC be callable (not
even via super()).</p>
</div>


                </section>
                <section id="Tensor">
                            <input id="Tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Tensor</span>:

                <label class="view-source-button" for="Tensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor-47"><a href="#Tensor-47"><span class="linenos"> 47</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Tensor</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">TensorMeta</span><span class="p">):</span>
</span><span id="Tensor-48"><a href="#Tensor-48"><span class="linenos"> 48</span></a>    <span class="nd">@property</span>
</span><span id="Tensor-49"><a href="#Tensor-49"><span class="linenos"> 49</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">edges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Tensor-50"><a href="#Tensor-50"><span class="linenos"> 50</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an _ordered_ set of edge names&quot;&quot;&quot;</span>
</span><span id="Tensor-51"><a href="#Tensor-51"><span class="linenos"> 51</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="Tensor-52"><a href="#Tensor-52"><span class="linenos"> 52</span></a>
</span><span id="Tensor-53"><a href="#Tensor-53"><span class="linenos"> 53</span></a>    <span class="nd">@property</span>
</span><span id="Tensor-54"><a href="#Tensor-54"><span class="linenos"> 54</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">]:</span>
</span><span id="Tensor-55"><a href="#Tensor-55"><span class="linenos"> 55</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_shape&quot;</span><span class="p">):</span>
</span><span id="Tensor-56"><a href="#Tensor-56"><span class="linenos"> 56</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="Tensor-57"><a href="#Tensor-57"><span class="linenos"> 57</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Tensor-58"><a href="#Tensor-58"><span class="linenos"> 58</span></a>
</span><span id="Tensor-59"><a href="#Tensor-59"><span class="linenos"> 59</span></a>    <span class="nd">@property</span>
</span><span id="Tensor-60"><a href="#Tensor-60"><span class="linenos"> 60</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Tensor-61"><a href="#Tensor-61"><span class="linenos"> 61</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of edges the tensor has. Same as ndim in torch/numpy&quot;&quot;&quot;</span>
</span><span id="Tensor-62"><a href="#Tensor-62"><span class="linenos"> 62</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Tensor-63"><a href="#Tensor-63"><span class="linenos"> 63</span></a>
</span><span id="Tensor-64"><a href="#Tensor-64"><span class="linenos"> 64</span></a>    <span class="nd">@final</span>
</span><span id="Tensor-65"><a href="#Tensor-65"><span class="linenos"> 65</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-66"><a href="#Tensor-66"><span class="linenos"> 66</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor-67"><a href="#Tensor-67"><span class="linenos"> 67</span></a><span class="sd">        Take the derivative of this tensor with respect to the variable x.</span>
</span><span id="Tensor-68"><a href="#Tensor-68"><span class="linenos"> 68</span></a>
</span><span id="Tensor-69"><a href="#Tensor-69"><span class="linenos"> 69</span></a><span class="sd">        Args:</span>
</span><span id="Tensor-70"><a href="#Tensor-70"><span class="linenos"> 70</span></a><span class="sd">            x: The variable to take the derivative with respect to.</span>
</span><span id="Tensor-71"><a href="#Tensor-71"><span class="linenos"> 71</span></a><span class="sd">            new_names: Optional list of names to use for the new edges created by the derivative.</span>
</span><span id="Tensor-72"><a href="#Tensor-72"><span class="linenos"> 72</span></a><span class="sd">                If not provided, new names will be generated based on the edges of x.</span>
</span><span id="Tensor-73"><a href="#Tensor-73"><span class="linenos"> 73</span></a>
</span><span id="Tensor-74"><a href="#Tensor-74"><span class="linenos"> 74</span></a><span class="sd">        Note:</span>
</span><span id="Tensor-75"><a href="#Tensor-75"><span class="linenos"> 75</span></a><span class="sd">            Pushes the derivative one step through the tensor.</span>
</span><span id="Tensor-76"><a href="#Tensor-76"><span class="linenos"> 76</span></a><span class="sd">            If you want to push it all the way through, use .simplify().</span>
</span><span id="Tensor-77"><a href="#Tensor-77"><span class="linenos"> 77</span></a>
</span><span id="Tensor-78"><a href="#Tensor-78"><span class="linenos"> 78</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor-79"><a href="#Tensor-79"><span class="linenos"> 79</span></a><span class="sd">            The tensor representing the derivative.</span>
</span><span id="Tensor-80"><a href="#Tensor-80"><span class="linenos"> 80</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor-81"><a href="#Tensor-81"><span class="linenos"> 81</span></a>
</span><span id="Tensor-82"><a href="#Tensor-82"><span class="linenos"> 82</span></a>        <span class="n">new_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_grad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="Tensor-83"><a href="#Tensor-83"><span class="linenos"> 83</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="Tensor-84"><a href="#Tensor-84"><span class="linenos"> 84</span></a>
</span><span id="Tensor-85"><a href="#Tensor-85"><span class="linenos"> 85</span></a>        <span class="c1"># Check that the shape is preserved</span>
</span><span id="Tensor-86"><a href="#Tensor-86"><span class="linenos"> 86</span></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">|</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_names</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Tensor-87"><a href="#Tensor-87"><span class="linenos"> 87</span></a>
</span><span id="Tensor-88"><a href="#Tensor-88"><span class="linenos"> 88</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="Tensor-89"><a href="#Tensor-89"><span class="linenos"> 89</span></a>
</span><span id="Tensor-90"><a href="#Tensor-90"><span class="linenos"> 90</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">]:</span>
</span><span id="Tensor-91"><a href="#Tensor-91"><span class="linenos"> 91</span></a>        <span class="c1"># When taking a derivative with respect to a variable, we need some edge names for the derivative.</span>
</span><span id="Tensor-92"><a href="#Tensor-92"><span class="linenos"> 92</span></a>        <span class="c1"># If new_names is not given, we generate names based on the edge names of x.</span>
</span><span id="Tensor-93"><a href="#Tensor-93"><span class="linenos"> 93</span></a>        <span class="c1"># However, we need to make sure they don&#39;t clash with any names already present in the tensor.</span>
</span><span id="Tensor-94"><a href="#Tensor-94"><span class="linenos"> 94</span></a>        <span class="c1"># If new_names is already given, we just check to make sure they are not already present in the tensor.</span>
</span><span id="Tensor-95"><a href="#Tensor-95"><span class="linenos"> 95</span></a>        <span class="k">if</span> <span class="n">new_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Tensor-96"><a href="#Tensor-96"><span class="linenos"> 96</span></a>            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">edges</span> <span class="o">!=</span> <span class="n">new_names</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="Tensor-97"><a href="#Tensor-97"><span class="linenos"> 97</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">new_names</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">=}</span><span class="s2"> must match </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Tensor-98"><a href="#Tensor-98"><span class="linenos"> 98</span></a>            <span class="c1"># Check that the new names don&#39;t clash with self.edges</span>
</span><span id="Tensor-99"><a href="#Tensor-99"><span class="linenos"> 99</span></a>            <span class="k">if</span> <span class="n">used</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">&amp;</span> <span class="n">new_names</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="Tensor-100"><a href="#Tensor-100"><span class="linenos">100</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">used</span><span class="si">}</span><span class="s2"> are already present in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Tensor-101"><a href="#Tensor-101"><span class="linenos">101</span></a>            <span class="k">return</span> <span class="n">new_names</span>
</span><span id="Tensor-102"><a href="#Tensor-102"><span class="linenos">102</span></a>
</span><span id="Tensor-103"><a href="#Tensor-103"><span class="linenos">103</span></a>        <span class="c1"># Make new names that are _based_ on x.edges and _avoid_ self.edges</span>
</span><span id="Tensor-104"><a href="#Tensor-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="Tensor-105"><a href="#Tensor-105"><span class="linenos">105</span></a>
</span><span id="Tensor-106"><a href="#Tensor-106"><span class="linenos">106</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-107"><a href="#Tensor-107"><span class="linenos">107</span></a>        <span class="c1"># Override this method to implement differentiation</span>
</span><span id="Tensor-108"><a href="#Tensor-108"><span class="linenos">108</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Derivative not implemented for </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Tensor-109"><a href="#Tensor-109"><span class="linenos">109</span></a>
</span><span id="Tensor-110"><a href="#Tensor-110"><span class="linenos">110</span></a>    <span class="nd">@final</span>
</span><span id="Tensor-111"><a href="#Tensor-111"><span class="linenos">111</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-112"><a href="#Tensor-112"><span class="linenos">112</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor-113"><a href="#Tensor-113"><span class="linenos">113</span></a><span class="sd">        Rename free edges of this tensor.</span>
</span><span id="Tensor-114"><a href="#Tensor-114"><span class="linenos">114</span></a>
</span><span id="Tensor-115"><a href="#Tensor-115"><span class="linenos">115</span></a><span class="sd">        Args:</span>
</span><span id="Tensor-116"><a href="#Tensor-116"><span class="linenos">116</span></a><span class="sd">            kwargs: A dictionary mapping old edge names to new edge names.</span>
</span><span id="Tensor-117"><a href="#Tensor-117"><span class="linenos">117</span></a><span class="sd">                Only free edges can be renamed. Inner edges may get renamed</span>
</span><span id="Tensor-118"><a href="#Tensor-118"><span class="linenos">118</span></a><span class="sd">                if necessary to avoid clashes with the new free edge names.</span>
</span><span id="Tensor-119"><a href="#Tensor-119"><span class="linenos">119</span></a>
</span><span id="Tensor-120"><a href="#Tensor-120"><span class="linenos">120</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor-121"><a href="#Tensor-121"><span class="linenos">121</span></a><span class="sd">            A new tensor with the edges renamed according to kwargs.</span>
</span><span id="Tensor-122"><a href="#Tensor-122"><span class="linenos">122</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor-123"><a href="#Tensor-123"><span class="linenos">123</span></a>
</span><span id="Tensor-124"><a href="#Tensor-124"><span class="linenos">124</span></a>        <span class="c1"># Check that the renaming is valid, and return the renaming dictionary.</span>
</span><span id="Tensor-125"><a href="#Tensor-125"><span class="linenos">125</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">({</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">})</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
</span><span id="Tensor-126"><a href="#Tensor-126"><span class="linenos">126</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renamed an edge to an existing edge name. </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">kwargs</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Tensor-127"><a href="#Tensor-127"><span class="linenos">127</span></a>
</span><span id="Tensor-128"><a href="#Tensor-128"><span class="linenos">128</span></a>        <span class="c1"># Restrict renaming to free edges</span>
</span><span id="Tensor-129"><a href="#Tensor-129"><span class="linenos">129</span></a>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">new</span><span class="p">:</span> <span class="n">old</span> <span class="k">for</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">new</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Tensor-130"><a href="#Tensor-130"><span class="linenos">130</span></a>
</span><span id="Tensor-131"><a href="#Tensor-131"><span class="linenos">131</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rename</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Tensor-132"><a href="#Tensor-132"><span class="linenos">132</span></a>
</span><span id="Tensor-133"><a href="#Tensor-133"><span class="linenos">133</span></a>        <span class="c1"># Check that the shape is preserved</span>
</span><span id="Tensor-134"><a href="#Tensor-134"><span class="linenos">134</span></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span> <span class="n">s</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Tensor-135"><a href="#Tensor-135"><span class="linenos">135</span></a>
</span><span id="Tensor-136"><a href="#Tensor-136"><span class="linenos">136</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="Tensor-137"><a href="#Tensor-137"><span class="linenos">137</span></a>
</span><span id="Tensor-138"><a href="#Tensor-138"><span class="linenos">138</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-139"><a href="#Tensor-139"><span class="linenos">139</span></a>        <span class="c1"># Override this method to implement renaming</span>
</span><span id="Tensor-140"><a href="#Tensor-140"><span class="linenos">140</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="Tensor-141"><a href="#Tensor-141"><span class="linenos">141</span></a>
</span><span id="Tensor-142"><a href="#Tensor-142"><span class="linenos">142</span></a>    <span class="nd">@final</span>
</span><span id="Tensor-143"><a href="#Tensor-143"><span class="linenos">143</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-144"><a href="#Tensor-144"><span class="linenos">144</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor-145"><a href="#Tensor-145"><span class="linenos">145</span></a><span class="sd">        Apply simplification rules to this tensor.</span>
</span><span id="Tensor-146"><a href="#Tensor-146"><span class="linenos">146</span></a>
</span><span id="Tensor-147"><a href="#Tensor-147"><span class="linenos">147</span></a><span class="sd">        This may rename inner edges but should never change the free edges.</span>
</span><span id="Tensor-148"><a href="#Tensor-148"><span class="linenos">148</span></a>
</span><span id="Tensor-149"><a href="#Tensor-149"><span class="linenos">149</span></a><span class="sd">        Args:</span>
</span><span id="Tensor-150"><a href="#Tensor-150"><span class="linenos">150</span></a><span class="sd">            args: Optional dictionary of arguments controlling the simplification.</span>
</span><span id="Tensor-151"><a href="#Tensor-151"><span class="linenos">151</span></a>
</span><span id="Tensor-152"><a href="#Tensor-152"><span class="linenos">152</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor-153"><a href="#Tensor-153"><span class="linenos">153</span></a><span class="sd">            A simplified version of this tensor.</span>
</span><span id="Tensor-154"><a href="#Tensor-154"><span class="linenos">154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor-155"><a href="#Tensor-155"><span class="linenos">155</span></a>
</span><span id="Tensor-156"><a href="#Tensor-156"><span class="linenos">156</span></a>        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Tensor-157"><a href="#Tensor-157"><span class="linenos">157</span></a>            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Tensor-158"><a href="#Tensor-158"><span class="linenos">158</span></a>        <span class="c1"># args[&quot;grad_steps&quot;] allows us to control how far we propagate the derivative.</span>
</span><span id="Tensor-159"><a href="#Tensor-159"><span class="linenos">159</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;grad_steps&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
</span><span id="Tensor-160"><a href="#Tensor-160"><span class="linenos">160</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;associative_products&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor-161"><a href="#Tensor-161"><span class="linenos">161</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;associative_sums&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor-162"><a href="#Tensor-162"><span class="linenos">162</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;sum_combine_terms&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor-163"><a href="#Tensor-163"><span class="linenos">163</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;combine_products&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor-164"><a href="#Tensor-164"><span class="linenos">164</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;factor_components&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor-165"><a href="#Tensor-165"><span class="linenos">165</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;expand_functions&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor-166"><a href="#Tensor-166"><span class="linenos">166</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;expand&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Tensor-167"><a href="#Tensor-167"><span class="linenos">167</span></a>
</span><span id="Tensor-168"><a href="#Tensor-168"><span class="linenos">168</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simplify</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="Tensor-169"><a href="#Tensor-169"><span class="linenos">169</span></a>
</span><span id="Tensor-170"><a href="#Tensor-170"><span class="linenos">170</span></a>        <span class="c1"># Check that the shape is preserved</span>
</span><span id="Tensor-171"><a href="#Tensor-171"><span class="linenos">171</span></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Tensor-172"><a href="#Tensor-172"><span class="linenos">172</span></a>
</span><span id="Tensor-173"><a href="#Tensor-173"><span class="linenos">173</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="Tensor-174"><a href="#Tensor-174"><span class="linenos">174</span></a>
</span><span id="Tensor-175"><a href="#Tensor-175"><span class="linenos">175</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-176"><a href="#Tensor-176"><span class="linenos">176</span></a>        <span class="c1"># Override this method to implement simplification</span>
</span><span id="Tensor-177"><a href="#Tensor-177"><span class="linenos">177</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Tensor-178"><a href="#Tensor-178"><span class="linenos">178</span></a>
</span><span id="Tensor-179"><a href="#Tensor-179"><span class="linenos">179</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">full_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-180"><a href="#Tensor-180"><span class="linenos">180</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies multiple simplification rules until the expression no longer changes&quot;&quot;&quot;</span>
</span><span id="Tensor-181"><a href="#Tensor-181"><span class="linenos">181</span></a>        <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="Tensor-182"><a href="#Tensor-182"><span class="linenos">182</span></a>        <span class="k">while</span> <span class="p">(</span><span class="n">new</span> <span class="o">:=</span> <span class="n">expr</span><span class="o">.</span><span class="n">simplify</span><span class="p">())</span> <span class="o">!=</span> <span class="n">expr</span><span class="p">:</span>
</span><span id="Tensor-183"><a href="#Tensor-183"><span class="linenos">183</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">new</span>
</span><span id="Tensor-184"><a href="#Tensor-184"><span class="linenos">184</span></a>        <span class="k">if</span> <span class="n">expand</span><span class="p">:</span>
</span><span id="Tensor-185"><a href="#Tensor-185"><span class="linenos">185</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">simplify</span><span class="p">({</span><span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span id="Tensor-186"><a href="#Tensor-186"><span class="linenos">186</span></a>            <span class="k">while</span> <span class="p">(</span><span class="n">new</span> <span class="o">:=</span> <span class="n">expr</span><span class="o">.</span><span class="n">simplify</span><span class="p">({</span><span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}))</span> <span class="o">!=</span> <span class="n">expr</span><span class="p">:</span>
</span><span id="Tensor-187"><a href="#Tensor-187"><span class="linenos">187</span></a>                <span class="n">expr</span> <span class="o">=</span> <span class="n">new</span>
</span><span id="Tensor-188"><a href="#Tensor-188"><span class="linenos">188</span></a>        <span class="k">return</span> <span class="n">expr</span>
</span><span id="Tensor-189"><a href="#Tensor-189"><span class="linenos">189</span></a>
</span><span id="Tensor-190"><a href="#Tensor-190"><span class="linenos">190</span></a>    <span class="nd">@final</span>
</span><span id="Tensor-191"><a href="#Tensor-191"><span class="linenos">191</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-192"><a href="#Tensor-192"><span class="linenos">192</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Substitute a variable with a tensor&quot;&quot;&quot;</span>
</span><span id="Tensor-193"><a href="#Tensor-193"><span class="linenos">193</span></a>        <span class="c1"># Ideally we&#39;d like y to be able to have extra edges that are not in x</span>
</span><span id="Tensor-194"><a href="#Tensor-194"><span class="linenos">194</span></a>        <span class="c1"># but which will be broadcasted as new edges of the tensor. This will</span>
</span><span id="Tensor-195"><a href="#Tensor-195"><span class="linenos">195</span></a>        <span class="c1"># allow us to implement numerical expectation, and other situations where</span>
</span><span id="Tensor-196"><a href="#Tensor-196"><span class="linenos">196</span></a>        <span class="c1"># we originally didn&#39;t have broadcasting, but we want to add it.</span>
</span><span id="Tensor-197"><a href="#Tensor-197"><span class="linenos">197</span></a>        <span class="c1"># Maybe we could even remove broadcasted edges of x as well.</span>
</span><span id="Tensor-198"><a href="#Tensor-198"><span class="linenos">198</span></a>        <span class="c1"># The tricky thing is to ensure it doesn&#39;t clash with the existing edges.</span>
</span><span id="Tensor-199"><a href="#Tensor-199"><span class="linenos">199</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_substitute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span id="Tensor-200"><a href="#Tensor-200"><span class="linenos">200</span></a>
</span><span id="Tensor-201"><a href="#Tensor-201"><span class="linenos">201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-202"><a href="#Tensor-202"><span class="linenos">202</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Override this method to implement substitution&quot;&quot;&quot;</span>
</span><span id="Tensor-203"><a href="#Tensor-203"><span class="linenos">203</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="Tensor-204"><a href="#Tensor-204"><span class="linenos">204</span></a>
</span><span id="Tensor-205"><a href="#Tensor-205"><span class="linenos">205</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Tensor-206"><a href="#Tensor-206"><span class="linenos">206</span></a>        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weisfeiler_lehman</span><span class="p">)</span>
</span><span id="Tensor-207"><a href="#Tensor-207"><span class="linenos">207</span></a>
</span><span id="Tensor-208"><a href="#Tensor-208"><span class="linenos">208</span></a>    <span class="nd">@cached_property</span>
</span><span id="Tensor-209"><a href="#Tensor-209"><span class="linenos">209</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">weisfeiler_lehman</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Tensor-210"><a href="#Tensor-210"><span class="linenos">210</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Hexadecimal string for WL-hash of the input graph.&quot;&quot;&quot;</span>
</span><span id="Tensor-211"><a href="#Tensor-211"><span class="linenos">211</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Tensor-212"><a href="#Tensor-212"><span class="linenos">212</span></a>        <span class="k">return</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">weisfeiler_lehman_graph_hash</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">node_attr</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
</span><span id="Tensor-213"><a href="#Tensor-213"><span class="linenos">213</span></a>
</span><span id="Tensor-214"><a href="#Tensor-214"><span class="linenos">214</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Tensor-215"><a href="#Tensor-215"><span class="linenos">215</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="Tensor-216"><a href="#Tensor-216"><span class="linenos">216</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="Tensor-217"><a href="#Tensor-217"><span class="linenos">217</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="Tensor-218"><a href="#Tensor-218"><span class="linenos">218</span></a>
</span><span id="Tensor-219"><a href="#Tensor-219"><span class="linenos">219</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Tensor-220"><a href="#Tensor-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this tensor depends on the variable x.&quot;&quot;&quot;</span>
</span><span id="Tensor-221"><a href="#Tensor-221"><span class="linenos">221</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="Tensor-222"><a href="#Tensor-222"><span class="linenos">222</span></a>
</span><span id="Tensor-223"><a href="#Tensor-223"><span class="linenos">223</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Tensor-224"><a href="#Tensor-224"><span class="linenos">224</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a graph representation of the tensor, which can be used for isomorphism testing.</span>
</span><span id="Tensor-225"><a href="#Tensor-225"><span class="linenos">225</span></a>
</span><span id="Tensor-226"><a href="#Tensor-226"><span class="linenos">226</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor-227"><a href="#Tensor-227"><span class="linenos">227</span></a><span class="sd">            A tuple with the following values:</span>
</span><span id="Tensor-228"><a href="#Tensor-228"><span class="linenos">228</span></a><span class="sd">            - A NetworkX directed graph.</span>
</span><span id="Tensor-229"><a href="#Tensor-229"><span class="linenos">229</span></a><span class="sd">                - Each node in the top tree is labeled with the producing tensor.</span>
</span><span id="Tensor-230"><a href="#Tensor-230"><span class="linenos">230</span></a><span class="sd">                - Use name=hashable to label vertices</span>
</span><span id="Tensor-231"><a href="#Tensor-231"><span class="linenos">231</span></a><span class="sd">            - &quot;edges&quot;, a dict of edge_name -&gt; node id</span>
</span><span id="Tensor-232"><a href="#Tensor-232"><span class="linenos">232</span></a><span class="sd">            - Node 0 should be the root</span>
</span><span id="Tensor-233"><a href="#Tensor-233"><span class="linenos">233</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor-234"><a href="#Tensor-234"><span class="linenos">234</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="Tensor-235"><a href="#Tensor-235"><span class="linenos">235</span></a>
</span><span id="Tensor-236"><a href="#Tensor-236"><span class="linenos">236</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">edge_structural_graph</span><span class="p">(</span>
</span><span id="Tensor-237"><a href="#Tensor-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">match_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">edge_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Tensor-238"><a href="#Tensor-238"><span class="linenos">238</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="Tensor-239"><a href="#Tensor-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor-240"><a href="#Tensor-240"><span class="linenos">240</span></a><span class="sd">        Build a structural graph of the tensor with dummy nodes for outer edges.</span>
</span><span id="Tensor-241"><a href="#Tensor-241"><span class="linenos">241</span></a>
</span><span id="Tensor-242"><a href="#Tensor-242"><span class="linenos">242</span></a><span class="sd">        Args:</span>
</span><span id="Tensor-243"><a href="#Tensor-243"><span class="linenos">243</span></a><span class="sd">            match_edges: If True the names are used to match edges.</span>
</span><span id="Tensor-244"><a href="#Tensor-244"><span class="linenos">244</span></a><span class="sd">            edge_names: An optional mapping of edge names.</span>
</span><span id="Tensor-245"><a href="#Tensor-245"><span class="linenos">245</span></a>
</span><span id="Tensor-246"><a href="#Tensor-246"><span class="linenos">246</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor-247"><a href="#Tensor-247"><span class="linenos">247</span></a><span class="sd">            A tuple (G, edge_list) where G is the graph and edge_list is the list of edge names.</span>
</span><span id="Tensor-248"><a href="#Tensor-248"><span class="linenos">248</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor-249"><a href="#Tensor-249"><span class="linenos">249</span></a>        <span class="k">if</span> <span class="n">edge_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Tensor-250"><a href="#Tensor-250"><span class="linenos">250</span></a>            <span class="n">edge_names</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Tensor-251"><a href="#Tensor-251"><span class="linenos">251</span></a>
</span><span id="Tensor-252"><a href="#Tensor-252"><span class="linenos">252</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structural_graph</span><span class="p">()</span>
</span><span id="Tensor-253"><a href="#Tensor-253"><span class="linenos">253</span></a>
</span><span id="Tensor-254"><a href="#Tensor-254"><span class="linenos">254</span></a>        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="Tensor-255"><a href="#Tensor-255"><span class="linenos">255</span></a>            <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edge_names</span><span class="p">:</span>
</span><span id="Tensor-256"><a href="#Tensor-256"><span class="linenos">256</span></a>                <span class="n">edge_names</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Outer Edge&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">if</span> <span class="n">match_edges</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="Tensor-257"><a href="#Tensor-257"><span class="linenos">257</span></a>
</span><span id="Tensor-258"><a href="#Tensor-258"><span class="linenos">258</span></a>        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Tensor-259"><a href="#Tensor-259"><span class="linenos">259</span></a>            <span class="n">n</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span>
</span><span id="Tensor-260"><a href="#Tensor-260"><span class="linenos">260</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">edge_names</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
</span><span id="Tensor-261"><a href="#Tensor-261"><span class="linenos">261</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="Tensor-262"><a href="#Tensor-262"><span class="linenos">262</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Tensor-263"><a href="#Tensor-263"><span class="linenos">263</span></a>
</span><span id="Tensor-264"><a href="#Tensor-264"><span class="linenos">264</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">graph_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Tensor-265"><a href="#Tensor-265"><span class="linenos">265</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor-266"><a href="#Tensor-266"><span class="linenos">266</span></a><span class="sd">        Returns an ASCII tree-like representation of the structural graph.</span>
</span><span id="Tensor-267"><a href="#Tensor-267"><span class="linenos">267</span></a>
</span><span id="Tensor-268"><a href="#Tensor-268"><span class="linenos">268</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor-269"><a href="#Tensor-269"><span class="linenos">269</span></a><span class="sd">            A string showing the graph structure.</span>
</span><span id="Tensor-270"><a href="#Tensor-270"><span class="linenos">270</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor-271"><a href="#Tensor-271"><span class="linenos">271</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor-272"><a href="#Tensor-272"><span class="linenos">272</span></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">generate_network_text</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="Tensor-273"><a href="#Tensor-273"><span class="linenos">273</span></a>
</span><span id="Tensor-274"><a href="#Tensor-274"><span class="linenos">274</span></a>    <span class="c1"># Overloaded operators</span>
</span><span id="Tensor-275"><a href="#Tensor-275"><span class="linenos">275</span></a>
</span><span id="Tensor-276"><a href="#Tensor-276"><span class="linenos">276</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-277"><a href="#Tensor-277"><span class="linenos">277</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Tensor-278"><a href="#Tensor-278"><span class="linenos">278</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="Tensor-279"><a href="#Tensor-279"><span class="linenos">279</span></a>            <span class="n">other</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">Product</span><span class="p">([]),</span> <span class="n">other</span>
</span><span id="Tensor-280"><a href="#Tensor-280"><span class="linenos">280</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span>
</span><span id="Tensor-281"><a href="#Tensor-281"><span class="linenos">281</span></a>
</span><span id="Tensor-282"><a href="#Tensor-282"><span class="linenos">282</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-283"><a href="#Tensor-283"><span class="linenos">283</span></a>        <span class="k">return</span> <span class="bp">self</span> <span class="o">+</span> <span class="n">other</span>
</span><span id="Tensor-284"><a href="#Tensor-284"><span class="linenos">284</span></a>
</span><span id="Tensor-285"><a href="#Tensor-285"><span class="linenos">285</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-286"><a href="#Tensor-286"><span class="linenos">286</span></a>        <span class="c1"># Handle `other - self`</span>
</span><span id="Tensor-287"><a href="#Tensor-287"><span class="linenos">287</span></a>        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span> <span class="o">+</span> <span class="n">other</span>
</span><span id="Tensor-288"><a href="#Tensor-288"><span class="linenos">288</span></a>
</span><span id="Tensor-289"><a href="#Tensor-289"><span class="linenos">289</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-290"><a href="#Tensor-290"><span class="linenos">290</span></a>        <span class="c1"># Handle `self - other`</span>
</span><span id="Tensor-291"><a href="#Tensor-291"><span class="linenos">291</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Tensor-292"><a href="#Tensor-292"><span class="linenos">292</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="Tensor-293"><a href="#Tensor-293"><span class="linenos">293</span></a>            <span class="n">other</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">Product</span><span class="p">([]),</span> <span class="n">other</span>
</span><span id="Tensor-294"><a href="#Tensor-294"><span class="linenos">294</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">w</span><span class="p">])</span>
</span><span id="Tensor-295"><a href="#Tensor-295"><span class="linenos">295</span></a>
</span><span id="Tensor-296"><a href="#Tensor-296"><span class="linenos">296</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-297"><a href="#Tensor-297"><span class="linenos">297</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Tensor-298"><a href="#Tensor-298"><span class="linenos">298</span></a>
</span><span id="Tensor-299"><a href="#Tensor-299"><span class="linenos">299</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__matmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-300"><a href="#Tensor-300"><span class="linenos">300</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="Tensor-301"><a href="#Tensor-301"><span class="linenos">301</span></a>            <span class="n">other</span> <span class="o">=</span> <span class="n">Sum</span><span class="p">([</span><span class="n">Product</span><span class="p">([])],</span> <span class="p">[</span><span class="n">other</span><span class="p">])</span>
</span><span id="Tensor-302"><a href="#Tensor-302"><span class="linenos">302</span></a>        <span class="k">return</span> <span class="n">Product</span><span class="p">([</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">])</span>
</span><span id="Tensor-303"><a href="#Tensor-303"><span class="linenos">303</span></a>
</span><span id="Tensor-304"><a href="#Tensor-304"><span class="linenos">304</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__rmatmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-305"><a href="#Tensor-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="Tensor-306"><a href="#Tensor-306"><span class="linenos">306</span></a>            <span class="k">return</span> <span class="bp">self</span> <span class="o">*</span> <span class="n">other</span>
</span><span id="Tensor-307"><a href="#Tensor-307"><span class="linenos">307</span></a>        <span class="k">return</span> <span class="bp">self</span> <span class="o">@</span> <span class="n">other</span>
</span><span id="Tensor-308"><a href="#Tensor-308"><span class="linenos">308</span></a>
</span><span id="Tensor-309"><a href="#Tensor-309"><span class="linenos">309</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-310"><a href="#Tensor-310"><span class="linenos">310</span></a>        <span class="k">return</span> <span class="bp">self</span> <span class="o">*</span> <span class="n">other</span>
</span><span id="Tensor-311"><a href="#Tensor-311"><span class="linenos">311</span></a>
</span><span id="Tensor-312"><a href="#Tensor-312"><span class="linenos">312</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-313"><a href="#Tensor-313"><span class="linenos">313</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor-314"><a href="#Tensor-314"><span class="linenos">314</span></a><span class="sd">        Contract self with other using tensor product and contraction rules.</span>
</span><span id="Tensor-315"><a href="#Tensor-315"><span class="linenos">315</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor-316"><a href="#Tensor-316"><span class="linenos">316</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="Tensor-317"><a href="#Tensor-317"><span class="linenos">317</span></a>            <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Tensor-318"><a href="#Tensor-318"><span class="linenos">318</span></a>                <span class="k">return</span> <span class="n">Zero</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Tensor-319"><a href="#Tensor-319"><span class="linenos">319</span></a>            <span class="k">if</span> <span class="n">other</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Tensor-320"><a href="#Tensor-320"><span class="linenos">320</span></a>                <span class="k">return</span> <span class="bp">self</span>
</span><span id="Tensor-321"><a href="#Tensor-321"><span class="linenos">321</span></a>            <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="n">other</span><span class="p">])</span>
</span><span id="Tensor-322"><a href="#Tensor-322"><span class="linenos">322</span></a>
</span><span id="Tensor-323"><a href="#Tensor-323"><span class="linenos">323</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">tensorgrad.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">prod</span>  <span class="c1"># Avoid circular import</span>
</span><span id="Tensor-324"><a href="#Tensor-324"><span class="linenos">324</span></a>
</span><span id="Tensor-325"><a href="#Tensor-325"><span class="linenos">325</span></a>        <span class="k">return</span> <span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
</span><span id="Tensor-326"><a href="#Tensor-326"><span class="linenos">326</span></a>
</span><span id="Tensor-327"><a href="#Tensor-327"><span class="linenos">327</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__rtruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-328"><a href="#Tensor-328"><span class="linenos">328</span></a>        <span class="c1"># Handle other / self</span>
</span><span id="Tensor-329"><a href="#Tensor-329"><span class="linenos">329</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">tensorgrad.functions</span><span class="w"> </span><span class="kn">import</span> <span class="nb">pow</span>  <span class="c1"># Avoid circular import</span>
</span><span id="Tensor-330"><a href="#Tensor-330"><span class="linenos">330</span></a>
</span><span id="Tensor-331"><a href="#Tensor-331"><span class="linenos">331</span></a>        <span class="k">return</span> <span class="n">other</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Tensor-332"><a href="#Tensor-332"><span class="linenos">332</span></a>
</span><span id="Tensor-333"><a href="#Tensor-333"><span class="linenos">333</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Rational</span><span class="p">,</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-334"><a href="#Tensor-334"><span class="linenos">334</span></a>        <span class="c1"># Handle self / other</span>
</span><span id="Tensor-335"><a href="#Tensor-335"><span class="linenos">335</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">tensorgrad.functions</span><span class="w"> </span><span class="kn">import</span> <span class="nb">pow</span>  <span class="c1"># Avoid circular import</span>
</span><span id="Tensor-336"><a href="#Tensor-336"><span class="linenos">336</span></a>
</span><span id="Tensor-337"><a href="#Tensor-337"><span class="linenos">337</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="Tensor-338"><a href="#Tensor-338"><span class="linenos">338</span></a>            <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">other</span><span class="p">)])</span>
</span><span id="Tensor-339"><a href="#Tensor-339"><span class="linenos">339</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="Tensor-340"><a href="#Tensor-340"><span class="linenos">340</span></a>            <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="bp">self</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="n">other</span><span class="p">])</span>
</span><span id="Tensor-341"><a href="#Tensor-341"><span class="linenos">341</span></a>        <span class="k">return</span> <span class="bp">self</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Tensor-342"><a href="#Tensor-342"><span class="linenos">342</span></a>
</span><span id="Tensor-343"><a href="#Tensor-343"><span class="linenos">343</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor-344"><a href="#Tensor-344"><span class="linenos">344</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">tensorgrad.functions</span><span class="w"> </span><span class="kn">import</span> <span class="nb">pow</span>  <span class="c1"># Avoid circular import</span>
</span><span id="Tensor-345"><a href="#Tensor-345"><span class="linenos">345</span></a>
</span><span id="Tensor-346"><a href="#Tensor-346"><span class="linenos">346</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Fraction</span><span class="p">)):</span>
</span><span id="Tensor-347"><a href="#Tensor-347"><span class="linenos">347</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only integer and fractional powers are supported.&quot;</span><span class="p">)</span>
</span><span id="Tensor-348"><a href="#Tensor-348"><span class="linenos">348</span></a>        <span class="k">return</span> <span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
</span><span id="Tensor-349"><a href="#Tensor-349"><span class="linenos">349</span></a>
</span><span id="Tensor-350"><a href="#Tensor-350"><span class="linenos">350</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_isomorphic</span><span class="p">(</span>
</span><span id="Tensor-351"><a href="#Tensor-351"><span class="linenos">351</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">,</span> <span class="n">match_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">edge_names</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Tensor-352"><a href="#Tensor-352"><span class="linenos">352</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Tensor-353"><a href="#Tensor-353"><span class="linenos">353</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor-354"><a href="#Tensor-354"><span class="linenos">354</span></a><span class="sd">        Test whether this tensor is isomorphic to another tensor.</span>
</span><span id="Tensor-355"><a href="#Tensor-355"><span class="linenos">355</span></a>
</span><span id="Tensor-356"><a href="#Tensor-356"><span class="linenos">356</span></a><span class="sd">        Args:</span>
</span><span id="Tensor-357"><a href="#Tensor-357"><span class="linenos">357</span></a><span class="sd">            other: The tensor to compare with.</span>
</span><span id="Tensor-358"><a href="#Tensor-358"><span class="linenos">358</span></a><span class="sd">            match_edges: Whether to require a matching of edge names.</span>
</span><span id="Tensor-359"><a href="#Tensor-359"><span class="linenos">359</span></a><span class="sd">            edge_names: Optional mapping to use for edge renaming.</span>
</span><span id="Tensor-360"><a href="#Tensor-360"><span class="linenos">360</span></a>
</span><span id="Tensor-361"><a href="#Tensor-361"><span class="linenos">361</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor-362"><a href="#Tensor-362"><span class="linenos">362</span></a><span class="sd">            True if the tensors are isomorphic; False otherwise.</span>
</span><span id="Tensor-363"><a href="#Tensor-363"><span class="linenos">363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor-364"><a href="#Tensor-364"><span class="linenos">364</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weisfeiler_lehman</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">weisfeiler_lehman</span><span class="p">:</span>
</span><span id="Tensor-365"><a href="#Tensor-365"><span class="linenos">365</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="Tensor-366"><a href="#Tensor-366"><span class="linenos">366</span></a>        <span class="n">G1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="n">match_edges</span><span class="p">,</span> <span class="n">edge_names</span><span class="o">=</span><span class="n">edge_names</span><span class="p">)</span>
</span><span id="Tensor-367"><a href="#Tensor-367"><span class="linenos">367</span></a>        <span class="n">G2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="n">match_edges</span><span class="p">,</span> <span class="n">edge_names</span><span class="o">=</span><span class="n">edge_names</span><span class="p">)</span>
</span><span id="Tensor-368"><a href="#Tensor-368"><span class="linenos">368</span></a>        <span class="k">return</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">G1</span><span class="p">,</span> <span class="n">G2</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">n2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
</span><span id="Tensor-369"><a href="#Tensor-369"><span class="linenos">369</span></a>        <span class="c1"># return nx.vf2pp_is_isomorphic(G1, G2, node_label=&quot;name&quot;)</span>
</span><span id="Tensor-370"><a href="#Tensor-370"><span class="linenos">370</span></a>
</span><span id="Tensor-371"><a href="#Tensor-371"><span class="linenos">371</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">isomorphisms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="Tensor-372"><a href="#Tensor-372"><span class="linenos">372</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor-373"><a href="#Tensor-373"><span class="linenos">373</span></a><span class="sd">        Yield all isomorphisms (edge renamings) between self and other.</span>
</span><span id="Tensor-374"><a href="#Tensor-374"><span class="linenos">374</span></a>
</span><span id="Tensor-375"><a href="#Tensor-375"><span class="linenos">375</span></a><span class="sd">        Args:</span>
</span><span id="Tensor-376"><a href="#Tensor-376"><span class="linenos">376</span></a><span class="sd">            other: The other tensor to compare.</span>
</span><span id="Tensor-377"><a href="#Tensor-377"><span class="linenos">377</span></a>
</span><span id="Tensor-378"><a href="#Tensor-378"><span class="linenos">378</span></a><span class="sd">        Yields:</span>
</span><span id="Tensor-379"><a href="#Tensor-379"><span class="linenos">379</span></a><span class="sd">            Dictionaries mapping edge names in self to edge names in other.</span>
</span><span id="Tensor-380"><a href="#Tensor-380"><span class="linenos">380</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor-381"><a href="#Tensor-381"><span class="linenos">381</span></a>        <span class="n">G1</span><span class="p">,</span> <span class="n">edges1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Tensor-382"><a href="#Tensor-382"><span class="linenos">382</span></a>        <span class="n">G2</span><span class="p">,</span> <span class="n">edges2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Tensor-383"><a href="#Tensor-383"><span class="linenos">383</span></a>        <span class="k">for</span> <span class="n">matching</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">isomorphism</span><span class="o">.</span><span class="n">MultiDiGraphMatcher</span><span class="p">(</span>
</span><span id="Tensor-384"><a href="#Tensor-384"><span class="linenos">384</span></a>            <span class="n">G1</span><span class="p">,</span> <span class="n">G2</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">n2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
</span><span id="Tensor-385"><a href="#Tensor-385"><span class="linenos">385</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">isomorphisms_iter</span><span class="p">():</span>
</span><span id="Tensor-386"><a href="#Tensor-386"><span class="linenos">386</span></a>            <span class="c1"># Matching is a dict {i: j} where i is the node in G1 and j is the node in G2</span>
</span><span id="Tensor-387"><a href="#Tensor-387"><span class="linenos">387</span></a>            <span class="c1"># We are only interested in then `len(self.edges)` last nodes, which correspond to the outer edges</span>
</span><span id="Tensor-388"><a href="#Tensor-388"><span class="linenos">388</span></a>            <span class="n">start_i</span> <span class="o">=</span> <span class="n">G1</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="Tensor-389"><a href="#Tensor-389"><span class="linenos">389</span></a>            <span class="n">start_j</span> <span class="o">=</span> <span class="n">G2</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="Tensor-390"><a href="#Tensor-390"><span class="linenos">390</span></a>            <span class="k">yield</span> <span class="p">{</span>
</span><span id="Tensor-391"><a href="#Tensor-391"><span class="linenos">391</span></a>                <span class="n">edges1</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">start_i</span><span class="p">]:</span> <span class="n">edges2</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="n">start_j</span><span class="p">]</span>
</span><span id="Tensor-392"><a href="#Tensor-392"><span class="linenos">392</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">matching</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Tensor-393"><a href="#Tensor-393"><span class="linenos">393</span></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">start_i</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">start_j</span>
</span><span id="Tensor-394"><a href="#Tensor-394"><span class="linenos">394</span></a>            <span class="p">}</span>
</span><span id="Tensor-395"><a href="#Tensor-395"><span class="linenos">395</span></a>
</span><span id="Tensor-396"><a href="#Tensor-396"><span class="linenos">396</span></a>    <span class="nd">@cached_property</span>
</span><span id="Tensor-397"><a href="#Tensor-397"><span class="linenos">397</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">symmetries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="Tensor-398"><a href="#Tensor-398"><span class="linenos">398</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the orbits of the automorphism group of the tensor.&quot;&quot;&quot;</span>
</span><span id="Tensor-399"><a href="#Tensor-399"><span class="linenos">399</span></a>        <span class="c1"># The orbits are the sets of edges that ever get mapped to each other.</span>
</span><span id="Tensor-400"><a href="#Tensor-400"><span class="linenos">400</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isomorphisms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
</span><span id="Tensor-401"><a href="#Tensor-401"><span class="linenos">401</span></a>        <span class="n">symmetries</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">)))</span>
</span><span id="Tensor-402"><a href="#Tensor-402"><span class="linenos">402</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_symmetries&quot;</span><span class="p">):</span>
</span><span id="Tensor-403"><a href="#Tensor-403"><span class="linenos">403</span></a>            <span class="k">assert</span> <span class="n">symmetries</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symmetries</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="Tensor-404"><a href="#Tensor-404"><span class="linenos">404</span></a>        <span class="k">return</span> <span class="n">symmetries</span>
</span><span id="Tensor-405"><a href="#Tensor-405"><span class="linenos">405</span></a>
</span><span id="Tensor-406"><a href="#Tensor-406"><span class="linenos">406</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Tensor-407"><a href="#Tensor-407"><span class="linenos">407</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_edges</span><span class="p">(</span><span class="n">edges</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Tensor-408"><a href="#Tensor-408"><span class="linenos">408</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor-409"><a href="#Tensor-409"><span class="linenos">409</span></a><span class="sd">        Validate and standardize an iterable of edge names.</span>
</span><span id="Tensor-410"><a href="#Tensor-410"><span class="linenos">410</span></a>
</span><span id="Tensor-411"><a href="#Tensor-411"><span class="linenos">411</span></a><span class="sd">        Args:</span>
</span><span id="Tensor-412"><a href="#Tensor-412"><span class="linenos">412</span></a><span class="sd">            edges: An iterable of edge names.</span>
</span><span id="Tensor-413"><a href="#Tensor-413"><span class="linenos">413</span></a>
</span><span id="Tensor-414"><a href="#Tensor-414"><span class="linenos">414</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor-415"><a href="#Tensor-415"><span class="linenos">415</span></a><span class="sd">            A list of edge names.</span>
</span><span id="Tensor-416"><a href="#Tensor-416"><span class="linenos">416</span></a>
</span><span id="Tensor-417"><a href="#Tensor-417"><span class="linenos">417</span></a><span class="sd">        Raises:</span>
</span><span id="Tensor-418"><a href="#Tensor-418"><span class="linenos">418</span></a><span class="sd">            ValueError: If any edge is not a string.</span>
</span><span id="Tensor-419"><a href="#Tensor-419"><span class="linenos">419</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor-420"><a href="#Tensor-420"><span class="linenos">420</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
</span><span id="Tensor-421"><a href="#Tensor-421"><span class="linenos">421</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Edges must be an iterable of strings&quot;</span><span class="p">)</span>
</span><span id="Tensor-422"><a href="#Tensor-422"><span class="linenos">422</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
</span><span id="Tensor-423"><a href="#Tensor-423"><span class="linenos">423</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">):</span>
</span><span id="Tensor-424"><a href="#Tensor-424"><span class="linenos">424</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Edges must be an iterable of strings&quot;</span><span class="p">)</span>
</span><span id="Tensor-425"><a href="#Tensor-425"><span class="linenos">425</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Tensor-426"><a href="#Tensor-426"><span class="linenos">426</span></a>            <span class="n">edges</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="Tensor-427"><a href="#Tensor-427"><span class="linenos">427</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>
</span><span id="Tensor-428"><a href="#Tensor-428"><span class="linenos">428</span></a>        <span class="k">return</span> <span class="n">edges</span>
</span><span id="Tensor-429"><a href="#Tensor-429"><span class="linenos">429</span></a>
</span><span id="Tensor-430"><a href="#Tensor-430"><span class="linenos">430</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Tensor-431"><a href="#Tensor-431"><span class="linenos">431</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_shape</span><span class="p">(</span><span class="n">shape0</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Symbol</span><span class="p">],</span> <span class="n">shape1</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">]:</span>
</span><span id="Tensor-432"><a href="#Tensor-432"><span class="linenos">432</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor-433"><a href="#Tensor-433"><span class="linenos">433</span></a><span class="sd">        Check and merge a shape given as an iterable and a dict.</span>
</span><span id="Tensor-434"><a href="#Tensor-434"><span class="linenos">434</span></a>
</span><span id="Tensor-435"><a href="#Tensor-435"><span class="linenos">435</span></a><span class="sd">        Args:</span>
</span><span id="Tensor-436"><a href="#Tensor-436"><span class="linenos">436</span></a><span class="sd">            shape0: An iterable of Sympy symbols.</span>
</span><span id="Tensor-437"><a href="#Tensor-437"><span class="linenos">437</span></a><span class="sd">            shape1: A dictionary mapping edge names to Sympy symbols.</span>
</span><span id="Tensor-438"><a href="#Tensor-438"><span class="linenos">438</span></a>
</span><span id="Tensor-439"><a href="#Tensor-439"><span class="linenos">439</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor-440"><a href="#Tensor-440"><span class="linenos">440</span></a><span class="sd">            A dictionary merging the two representations.</span>
</span><span id="Tensor-441"><a href="#Tensor-441"><span class="linenos">441</span></a>
</span><span id="Tensor-442"><a href="#Tensor-442"><span class="linenos">442</span></a><span class="sd">        Raises:</span>
</span><span id="Tensor-443"><a href="#Tensor-443"><span class="linenos">443</span></a><span class="sd">            ValueError: If inputs are not of the expected types.</span>
</span><span id="Tensor-444"><a href="#Tensor-444"><span class="linenos">444</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor-445"><a href="#Tensor-445"><span class="linenos">445</span></a>        <span class="n">shape0</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape0</span><span class="p">)</span>
</span><span id="Tensor-446"><a href="#Tensor-446"><span class="linenos">446</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape0</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape0</span><span class="p">):</span>
</span><span id="Tensor-447"><a href="#Tensor-447"><span class="linenos">447</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shape0 must be a tuple of sympy symbols&quot;</span><span class="p">)</span>
</span><span id="Tensor-448"><a href="#Tensor-448"><span class="linenos">448</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape1</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="Tensor-449"><a href="#Tensor-449"><span class="linenos">449</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shape1 must be a dict of sympy symbols&quot;</span><span class="p">)</span>
</span><span id="Tensor-450"><a href="#Tensor-450"><span class="linenos">450</span></a>        <span class="n">shape0</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape0</span><span class="p">}</span>
</span><span id="Tensor-451"><a href="#Tensor-451"><span class="linenos">451</span></a>        <span class="k">if</span> <span class="n">double_keys</span> <span class="o">:=</span> <span class="n">shape0</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">shape1</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="Tensor-452"><a href="#Tensor-452"><span class="linenos">452</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Duplicate edge names: </span><span class="si">{</span><span class="n">double_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Tensor-453"><a href="#Tensor-453"><span class="linenos">453</span></a>        <span class="k">return</span> <span class="n">shape0</span> <span class="o">|</span> <span class="n">shape1</span>
</span><span id="Tensor-454"><a href="#Tensor-454"><span class="linenos">454</span></a>
</span><span id="Tensor-455"><a href="#Tensor-455"><span class="linenos">455</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Tensor-456"><a href="#Tensor-456"><span class="linenos">456</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_symmetries</span><span class="p">(</span>
</span><span id="Tensor-457"><a href="#Tensor-457"><span class="linenos">457</span></a>        <span class="n">shape</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">],</span> <span class="n">symmetries</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Tensor-458"><a href="#Tensor-458"><span class="linenos">458</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="Tensor-459"><a href="#Tensor-459"><span class="linenos">459</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor-460"><a href="#Tensor-460"><span class="linenos">460</span></a><span class="sd">        Validate the symmetries for a tensor.</span>
</span><span id="Tensor-461"><a href="#Tensor-461"><span class="linenos">461</span></a>
</span><span id="Tensor-462"><a href="#Tensor-462"><span class="linenos">462</span></a><span class="sd">        Args:</span>
</span><span id="Tensor-463"><a href="#Tensor-463"><span class="linenos">463</span></a><span class="sd">            shape: A dictionary mapping edge names to sizes.</span>
</span><span id="Tensor-464"><a href="#Tensor-464"><span class="linenos">464</span></a><span class="sd">            symmetries: Either a string (with groups separated by commas) or a set of frozensets.</span>
</span><span id="Tensor-465"><a href="#Tensor-465"><span class="linenos">465</span></a>
</span><span id="Tensor-466"><a href="#Tensor-466"><span class="linenos">466</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor-467"><a href="#Tensor-467"><span class="linenos">467</span></a><span class="sd">            A set of frozensets representing the symmetry groups.</span>
</span><span id="Tensor-468"><a href="#Tensor-468"><span class="linenos">468</span></a>
</span><span id="Tensor-469"><a href="#Tensor-469"><span class="linenos">469</span></a><span class="sd">        Raises:</span>
</span><span id="Tensor-470"><a href="#Tensor-470"><span class="linenos">470</span></a><span class="sd">            ValueError: If the symmetries are inconsistent with the shape.</span>
</span><span id="Tensor-471"><a href="#Tensor-471"><span class="linenos">471</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor-472"><a href="#Tensor-472"><span class="linenos">472</span></a>        <span class="k">if</span> <span class="n">symmetries</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Tensor-473"><a href="#Tensor-473"><span class="linenos">473</span></a>            <span class="k">return</span> <span class="p">{</span><span class="nb">frozenset</span><span class="p">({</span><span class="n">e</span><span class="p">})</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
</span><span id="Tensor-474"><a href="#Tensor-474"><span class="linenos">474</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">symmetries</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Tensor-475"><a href="#Tensor-475"><span class="linenos">475</span></a>            <span class="n">symmetries</span> <span class="o">=</span> <span class="p">{</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">symmetries</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)}</span>
</span><span id="Tensor-476"><a href="#Tensor-476"><span class="linenos">476</span></a>        <span class="c1"># Check symmetries are sets of strings</span>
</span><span id="Tensor-477"><a href="#Tensor-477"><span class="linenos">477</span></a>        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">symmetries</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">group</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symmetries</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="Tensor-478"><a href="#Tensor-478"><span class="linenos">478</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">({</span><span class="n">e</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">symmetries</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">group</span><span class="p">})</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
</span><span id="Tensor-479"><a href="#Tensor-479"><span class="linenos">479</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Symmetry groups must contain all edges&quot;</span><span class="p">)</span>
</span><span id="Tensor-480"><a href="#Tensor-480"><span class="linenos">480</span></a>        <span class="c1"># Check symmetries are compatible with shape</span>
</span><span id="Tensor-481"><a href="#Tensor-481"><span class="linenos">481</span></a>        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">symmetries</span><span class="p">:</span>
</span><span id="Tensor-482"><a href="#Tensor-482"><span class="linenos">482</span></a>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shape</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">group</span><span class="p">):</span>
</span><span id="Tensor-483"><a href="#Tensor-483"><span class="linenos">483</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symmetry group </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> contains edges not in shape&quot;</span><span class="p">)</span>
</span><span id="Tensor-484"><a href="#Tensor-484"><span class="linenos">484</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">({</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">group</span><span class="p">})</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Tensor-485"><a href="#Tensor-485"><span class="linenos">485</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symmetry group </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> must all have same dim size&quot;</span><span class="p">)</span>
</span><span id="Tensor-486"><a href="#Tensor-486"><span class="linenos">486</span></a>        <span class="k">return</span> <span class="n">symmetries</span>
</span></pre></div>


    

                            <div id="Tensor.__init__" class="classattr">
                                        <input id="Tensor.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Tensor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="Tensor.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.__init__-19"><a href="#Tensor.__init__-19"><span class="linenos">19</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Tensor.__init__-20"><a href="#Tensor.__init__-20"><span class="linenos">20</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calling Tensor(...) is a shortcut to wrapping the argument in a tensor.&quot;&quot;&quot;</span>
</span><span id="Tensor.__init__-21"><a href="#Tensor.__init__-21"><span class="linenos">21</span></a>
</span><span id="Tensor.__init__-22"><a href="#Tensor.__init__-22"><span class="linenos">22</span></a>        <span class="c1"># Since we&#39;re hacking the metaclass, we need to check if we&#39;re being called on a subclass</span>
</span><span id="Tensor.__init__-23"><a href="#Tensor.__init__-23"><span class="linenos">23</span></a>        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Tensor.__init__-24"><a href="#Tensor.__init__-24"><span class="linenos">24</span></a>            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Tensor.__init__-25"><a href="#Tensor.__init__-25"><span class="linenos">25</span></a>
</span><span id="Tensor.__init__-26"><a href="#Tensor.__init__-26"><span class="linenos">26</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="Tensor.__init__-27"><a href="#Tensor.__init__-27"><span class="linenos">27</span></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Tensor(...) expects exactly one argument, e.g. Tensor(1).&quot;</span><span class="p">)</span>
</span><span id="Tensor.__init__-28"><a href="#Tensor.__init__-28"><span class="linenos">28</span></a>        <span class="n">val</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Tensor.__init__-29"><a href="#Tensor.__init__-29"><span class="linenos">29</span></a>
</span><span id="Tensor.__init__-30"><a href="#Tensor.__init__-30"><span class="linenos">30</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Number</span><span class="p">):</span>
</span><span id="Tensor.__init__-31"><a href="#Tensor.__init__-31"><span class="linenos">31</span></a>            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Tensor.__init__-32"><a href="#Tensor.__init__-32"><span class="linenos">32</span></a>                <span class="k">return</span> <span class="n">Zero</span><span class="p">()</span>
</span><span id="Tensor.__init__-33"><a href="#Tensor.__init__-33"><span class="linenos">33</span></a>            <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Tensor.__init__-34"><a href="#Tensor.__init__-34"><span class="linenos">34</span></a>                <span class="k">return</span> <span class="n">Product</span><span class="p">([])</span>
</span><span id="Tensor.__init__-35"><a href="#Tensor.__init__-35"><span class="linenos">35</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Tensor.__init__-36"><a href="#Tensor.__init__-36"><span class="linenos">36</span></a>                <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="n">Product</span><span class="p">([])],</span> <span class="p">[</span><span class="n">val</span><span class="p">])</span>
</span><span id="Tensor.__init__-37"><a href="#Tensor.__init__-37"><span class="linenos">37</span></a>
</span><span id="Tensor.__init__-38"><a href="#Tensor.__init__-38"><span class="linenos">38</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">):</span>
</span><span id="Tensor.__init__-39"><a href="#Tensor.__init__-39"><span class="linenos">39</span></a>            <span class="k">return</span> <span class="n">Delta</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span id="Tensor.__init__-40"><a href="#Tensor.__init__-40"><span class="linenos">40</span></a>
</span><span id="Tensor.__init__-41"><a href="#Tensor.__init__-41"><span class="linenos">41</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="Tensor.__init__-42"><a href="#Tensor.__init__-42"><span class="linenos">42</span></a>            <span class="k">return</span> <span class="n">val</span>
</span><span id="Tensor.__init__-43"><a href="#Tensor.__init__-43"><span class="linenos">43</span></a>
</span><span id="Tensor.__init__-44"><a href="#Tensor.__init__-44"><span class="linenos">44</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid argument </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Calling Tensor(...) is a shortcut to wrapping the argument in a tensor.</p>
</div>


                            </div>
                            <div id="Tensor.edges" class="classattr">
                                        <input id="Tensor.edges-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">edges</span><span class="annotation">: set[str]</span>

                <label class="view-source-button" for="Tensor.edges-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.edges"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.edges-48"><a href="#Tensor.edges-48"><span class="linenos">48</span></a>    <span class="nd">@property</span>
</span><span id="Tensor.edges-49"><a href="#Tensor.edges-49"><span class="linenos">49</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">edges</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span><span id="Tensor.edges-50"><a href="#Tensor.edges-50"><span class="linenos">50</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an _ordered_ set of edge names&quot;&quot;&quot;</span>
</span><span id="Tensor.edges-51"><a href="#Tensor.edges-51"><span class="linenos">51</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Returns an _ordered_ set of edge names</p>
</div>


                            </div>
                            <div id="Tensor.shape" class="classattr">
                                        <input id="Tensor.shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">shape</span><span class="annotation">: dict[str, sympy.core.symbol.Symbol]</span>

                <label class="view-source-button" for="Tensor.shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.shape-53"><a href="#Tensor.shape-53"><span class="linenos">53</span></a>    <span class="nd">@property</span>
</span><span id="Tensor.shape-54"><a href="#Tensor.shape-54"><span class="linenos">54</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">]:</span>
</span><span id="Tensor.shape-55"><a href="#Tensor.shape-55"><span class="linenos">55</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_shape&quot;</span><span class="p">):</span>
</span><span id="Tensor.shape-56"><a href="#Tensor.shape-56"><span class="linenos">56</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span><span id="Tensor.shape-57"><a href="#Tensor.shape-57"><span class="linenos">57</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="Tensor.order" class="classattr">
                                        <input id="Tensor.order-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">order</span><span class="annotation">: int</span>

                <label class="view-source-button" for="Tensor.order-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.order"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.order-59"><a href="#Tensor.order-59"><span class="linenos">59</span></a>    <span class="nd">@property</span>
</span><span id="Tensor.order-60"><a href="#Tensor.order-60"><span class="linenos">60</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Tensor.order-61"><a href="#Tensor.order-61"><span class="linenos">61</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of edges the tensor has. Same as ndim in torch/numpy&quot;&quot;&quot;</span>
</span><span id="Tensor.order-62"><a href="#Tensor.order-62"><span class="linenos">62</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>The number of edges the tensor has. Same as ndim in torch/numpy</p>
</div>


                            </div>
                            <div id="Tensor.grad" class="classattr">
                                        <input id="Tensor.grad-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-final">@final</div>

        <span class="def">def</span>
        <span class="name">grad</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">x</span><span class="p">:</span> <span class="n"><a href="#Variable">Variable</a></span>,</span><span class="param">	<span class="n">new_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#Tensor">Tensor</a></span>:</span></span>

                <label class="view-source-button" for="Tensor.grad-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.grad"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.grad-64"><a href="#Tensor.grad-64"><span class="linenos">64</span></a>    <span class="nd">@final</span>
</span><span id="Tensor.grad-65"><a href="#Tensor.grad-65"><span class="linenos">65</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor.grad-66"><a href="#Tensor.grad-66"><span class="linenos">66</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor.grad-67"><a href="#Tensor.grad-67"><span class="linenos">67</span></a><span class="sd">        Take the derivative of this tensor with respect to the variable x.</span>
</span><span id="Tensor.grad-68"><a href="#Tensor.grad-68"><span class="linenos">68</span></a>
</span><span id="Tensor.grad-69"><a href="#Tensor.grad-69"><span class="linenos">69</span></a><span class="sd">        Args:</span>
</span><span id="Tensor.grad-70"><a href="#Tensor.grad-70"><span class="linenos">70</span></a><span class="sd">            x: The variable to take the derivative with respect to.</span>
</span><span id="Tensor.grad-71"><a href="#Tensor.grad-71"><span class="linenos">71</span></a><span class="sd">            new_names: Optional list of names to use for the new edges created by the derivative.</span>
</span><span id="Tensor.grad-72"><a href="#Tensor.grad-72"><span class="linenos">72</span></a><span class="sd">                If not provided, new names will be generated based on the edges of x.</span>
</span><span id="Tensor.grad-73"><a href="#Tensor.grad-73"><span class="linenos">73</span></a>
</span><span id="Tensor.grad-74"><a href="#Tensor.grad-74"><span class="linenos">74</span></a><span class="sd">        Note:</span>
</span><span id="Tensor.grad-75"><a href="#Tensor.grad-75"><span class="linenos">75</span></a><span class="sd">            Pushes the derivative one step through the tensor.</span>
</span><span id="Tensor.grad-76"><a href="#Tensor.grad-76"><span class="linenos">76</span></a><span class="sd">            If you want to push it all the way through, use .simplify().</span>
</span><span id="Tensor.grad-77"><a href="#Tensor.grad-77"><span class="linenos">77</span></a>
</span><span id="Tensor.grad-78"><a href="#Tensor.grad-78"><span class="linenos">78</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor.grad-79"><a href="#Tensor.grad-79"><span class="linenos">79</span></a><span class="sd">            The tensor representing the derivative.</span>
</span><span id="Tensor.grad-80"><a href="#Tensor.grad-80"><span class="linenos">80</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor.grad-81"><a href="#Tensor.grad-81"><span class="linenos">81</span></a>
</span><span id="Tensor.grad-82"><a href="#Tensor.grad-82"><span class="linenos">82</span></a>        <span class="n">new_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_grad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="Tensor.grad-83"><a href="#Tensor.grad-83"><span class="linenos">83</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="Tensor.grad-84"><a href="#Tensor.grad-84"><span class="linenos">84</span></a>
</span><span id="Tensor.grad-85"><a href="#Tensor.grad-85"><span class="linenos">85</span></a>        <span class="c1"># Check that the shape is preserved</span>
</span><span id="Tensor.grad-86"><a href="#Tensor.grad-86"><span class="linenos">86</span></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">|</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_names</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Tensor.grad-87"><a href="#Tensor.grad-87"><span class="linenos">87</span></a>
</span><span id="Tensor.grad-88"><a href="#Tensor.grad-88"><span class="linenos">88</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Take the derivative of this tensor with respect to the variable x.</p>

<p>Args:
    x: The variable to take the derivative with respect to.
    new_names: Optional list of names to use for the new edges created by the derivative.
        If not provided, new names will be generated based on the edges of x.</p>

<p>Note:
    Pushes the derivative one step through the tensor.
    If you want to push it all the way through, use .simplify().</p>

<p>Returns:
    The tensor representing the derivative.</p>
</div>


                            </div>
                            <div id="Tensor.rename" class="classattr">
                                        <input id="Tensor.rename-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-final">@final</div>

        <span class="def">def</span>
        <span class="name">rename</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n"><a href="#Tensor">Tensor</a></span>:</span></span>

                <label class="view-source-button" for="Tensor.rename-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.rename"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.rename-110"><a href="#Tensor.rename-110"><span class="linenos">110</span></a>    <span class="nd">@final</span>
</span><span id="Tensor.rename-111"><a href="#Tensor.rename-111"><span class="linenos">111</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor.rename-112"><a href="#Tensor.rename-112"><span class="linenos">112</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor.rename-113"><a href="#Tensor.rename-113"><span class="linenos">113</span></a><span class="sd">        Rename free edges of this tensor.</span>
</span><span id="Tensor.rename-114"><a href="#Tensor.rename-114"><span class="linenos">114</span></a>
</span><span id="Tensor.rename-115"><a href="#Tensor.rename-115"><span class="linenos">115</span></a><span class="sd">        Args:</span>
</span><span id="Tensor.rename-116"><a href="#Tensor.rename-116"><span class="linenos">116</span></a><span class="sd">            kwargs: A dictionary mapping old edge names to new edge names.</span>
</span><span id="Tensor.rename-117"><a href="#Tensor.rename-117"><span class="linenos">117</span></a><span class="sd">                Only free edges can be renamed. Inner edges may get renamed</span>
</span><span id="Tensor.rename-118"><a href="#Tensor.rename-118"><span class="linenos">118</span></a><span class="sd">                if necessary to avoid clashes with the new free edge names.</span>
</span><span id="Tensor.rename-119"><a href="#Tensor.rename-119"><span class="linenos">119</span></a>
</span><span id="Tensor.rename-120"><a href="#Tensor.rename-120"><span class="linenos">120</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor.rename-121"><a href="#Tensor.rename-121"><span class="linenos">121</span></a><span class="sd">            A new tensor with the edges renamed according to kwargs.</span>
</span><span id="Tensor.rename-122"><a href="#Tensor.rename-122"><span class="linenos">122</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor.rename-123"><a href="#Tensor.rename-123"><span class="linenos">123</span></a>
</span><span id="Tensor.rename-124"><a href="#Tensor.rename-124"><span class="linenos">124</span></a>        <span class="c1"># Check that the renaming is valid, and return the renaming dictionary.</span>
</span><span id="Tensor.rename-125"><a href="#Tensor.rename-125"><span class="linenos">125</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">({</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">})</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
</span><span id="Tensor.rename-126"><a href="#Tensor.rename-126"><span class="linenos">126</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renamed an edge to an existing edge name. </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">kwargs</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Tensor.rename-127"><a href="#Tensor.rename-127"><span class="linenos">127</span></a>
</span><span id="Tensor.rename-128"><a href="#Tensor.rename-128"><span class="linenos">128</span></a>        <span class="c1"># Restrict renaming to free edges</span>
</span><span id="Tensor.rename-129"><a href="#Tensor.rename-129"><span class="linenos">129</span></a>        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">new</span><span class="p">:</span> <span class="n">old</span> <span class="k">for</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">new</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Tensor.rename-130"><a href="#Tensor.rename-130"><span class="linenos">130</span></a>
</span><span id="Tensor.rename-131"><a href="#Tensor.rename-131"><span class="linenos">131</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rename</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Tensor.rename-132"><a href="#Tensor.rename-132"><span class="linenos">132</span></a>
</span><span id="Tensor.rename-133"><a href="#Tensor.rename-133"><span class="linenos">133</span></a>        <span class="c1"># Check that the shape is preserved</span>
</span><span id="Tensor.rename-134"><a href="#Tensor.rename-134"><span class="linenos">134</span></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span> <span class="n">s</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Tensor.rename-135"><a href="#Tensor.rename-135"><span class="linenos">135</span></a>
</span><span id="Tensor.rename-136"><a href="#Tensor.rename-136"><span class="linenos">136</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Rename free edges of this tensor.</p>

<p>Args:
    kwargs: A dictionary mapping old edge names to new edge names.
        Only free edges can be renamed. Inner edges may get renamed
        if necessary to avoid clashes with the new free edge names.</p>

<p>Returns:
    A new tensor with the edges renamed according to kwargs.</p>
</div>


                            </div>
                            <div id="Tensor.simplify" class="classattr">
                                        <input id="Tensor.simplify-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-final">@final</div>

        <span class="def">def</span>
        <span class="name">simplify</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#Tensor">Tensor</a></span>:</span></span>

                <label class="view-source-button" for="Tensor.simplify-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.simplify"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.simplify-142"><a href="#Tensor.simplify-142"><span class="linenos">142</span></a>    <span class="nd">@final</span>
</span><span id="Tensor.simplify-143"><a href="#Tensor.simplify-143"><span class="linenos">143</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor.simplify-144"><a href="#Tensor.simplify-144"><span class="linenos">144</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor.simplify-145"><a href="#Tensor.simplify-145"><span class="linenos">145</span></a><span class="sd">        Apply simplification rules to this tensor.</span>
</span><span id="Tensor.simplify-146"><a href="#Tensor.simplify-146"><span class="linenos">146</span></a>
</span><span id="Tensor.simplify-147"><a href="#Tensor.simplify-147"><span class="linenos">147</span></a><span class="sd">        This may rename inner edges but should never change the free edges.</span>
</span><span id="Tensor.simplify-148"><a href="#Tensor.simplify-148"><span class="linenos">148</span></a>
</span><span id="Tensor.simplify-149"><a href="#Tensor.simplify-149"><span class="linenos">149</span></a><span class="sd">        Args:</span>
</span><span id="Tensor.simplify-150"><a href="#Tensor.simplify-150"><span class="linenos">150</span></a><span class="sd">            args: Optional dictionary of arguments controlling the simplification.</span>
</span><span id="Tensor.simplify-151"><a href="#Tensor.simplify-151"><span class="linenos">151</span></a>
</span><span id="Tensor.simplify-152"><a href="#Tensor.simplify-152"><span class="linenos">152</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor.simplify-153"><a href="#Tensor.simplify-153"><span class="linenos">153</span></a><span class="sd">            A simplified version of this tensor.</span>
</span><span id="Tensor.simplify-154"><a href="#Tensor.simplify-154"><span class="linenos">154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor.simplify-155"><a href="#Tensor.simplify-155"><span class="linenos">155</span></a>
</span><span id="Tensor.simplify-156"><a href="#Tensor.simplify-156"><span class="linenos">156</span></a>        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Tensor.simplify-157"><a href="#Tensor.simplify-157"><span class="linenos">157</span></a>            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Tensor.simplify-158"><a href="#Tensor.simplify-158"><span class="linenos">158</span></a>        <span class="c1"># args[&quot;grad_steps&quot;] allows us to control how far we propagate the derivative.</span>
</span><span id="Tensor.simplify-159"><a href="#Tensor.simplify-159"><span class="linenos">159</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;grad_steps&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>
</span><span id="Tensor.simplify-160"><a href="#Tensor.simplify-160"><span class="linenos">160</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;associative_products&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor.simplify-161"><a href="#Tensor.simplify-161"><span class="linenos">161</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;associative_sums&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor.simplify-162"><a href="#Tensor.simplify-162"><span class="linenos">162</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;sum_combine_terms&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor.simplify-163"><a href="#Tensor.simplify-163"><span class="linenos">163</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;combine_products&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor.simplify-164"><a href="#Tensor.simplify-164"><span class="linenos">164</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;factor_components&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor.simplify-165"><a href="#Tensor.simplify-165"><span class="linenos">165</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;expand_functions&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor.simplify-166"><a href="#Tensor.simplify-166"><span class="linenos">166</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;expand&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Tensor.simplify-167"><a href="#Tensor.simplify-167"><span class="linenos">167</span></a>
</span><span id="Tensor.simplify-168"><a href="#Tensor.simplify-168"><span class="linenos">168</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simplify</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="Tensor.simplify-169"><a href="#Tensor.simplify-169"><span class="linenos">169</span></a>
</span><span id="Tensor.simplify-170"><a href="#Tensor.simplify-170"><span class="linenos">170</span></a>        <span class="c1"># Check that the shape is preserved</span>
</span><span id="Tensor.simplify-171"><a href="#Tensor.simplify-171"><span class="linenos">171</span></a>        <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Tensor.simplify-172"><a href="#Tensor.simplify-172"><span class="linenos">172</span></a>
</span><span id="Tensor.simplify-173"><a href="#Tensor.simplify-173"><span class="linenos">173</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Apply simplification rules to this tensor.</p>

<p>This may rename inner edges but should never change the free edges.</p>

<p>Args:
    args: Optional dictionary of arguments controlling the simplification.</p>

<p>Returns:
    A simplified version of this tensor.</p>
</div>


                            </div>
                            <div id="Tensor.full_simplify" class="classattr">
                                        <input id="Tensor.full_simplify-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">full_simplify</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">expand</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">) -> <span class="n"><a href="#Tensor">Tensor</a></span>:</span></span>

                <label class="view-source-button" for="Tensor.full_simplify-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.full_simplify"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.full_simplify-179"><a href="#Tensor.full_simplify-179"><span class="linenos">179</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">full_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor.full_simplify-180"><a href="#Tensor.full_simplify-180"><span class="linenos">180</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies multiple simplification rules until the expression no longer changes&quot;&quot;&quot;</span>
</span><span id="Tensor.full_simplify-181"><a href="#Tensor.full_simplify-181"><span class="linenos">181</span></a>        <span class="n">expr</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="Tensor.full_simplify-182"><a href="#Tensor.full_simplify-182"><span class="linenos">182</span></a>        <span class="k">while</span> <span class="p">(</span><span class="n">new</span> <span class="o">:=</span> <span class="n">expr</span><span class="o">.</span><span class="n">simplify</span><span class="p">())</span> <span class="o">!=</span> <span class="n">expr</span><span class="p">:</span>
</span><span id="Tensor.full_simplify-183"><a href="#Tensor.full_simplify-183"><span class="linenos">183</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">new</span>
</span><span id="Tensor.full_simplify-184"><a href="#Tensor.full_simplify-184"><span class="linenos">184</span></a>        <span class="k">if</span> <span class="n">expand</span><span class="p">:</span>
</span><span id="Tensor.full_simplify-185"><a href="#Tensor.full_simplify-185"><span class="linenos">185</span></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">simplify</span><span class="p">({</span><span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
</span><span id="Tensor.full_simplify-186"><a href="#Tensor.full_simplify-186"><span class="linenos">186</span></a>            <span class="k">while</span> <span class="p">(</span><span class="n">new</span> <span class="o">:=</span> <span class="n">expr</span><span class="o">.</span><span class="n">simplify</span><span class="p">({</span><span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}))</span> <span class="o">!=</span> <span class="n">expr</span><span class="p">:</span>
</span><span id="Tensor.full_simplify-187"><a href="#Tensor.full_simplify-187"><span class="linenos">187</span></a>                <span class="n">expr</span> <span class="o">=</span> <span class="n">new</span>
</span><span id="Tensor.full_simplify-188"><a href="#Tensor.full_simplify-188"><span class="linenos">188</span></a>        <span class="k">return</span> <span class="n">expr</span>
</span></pre></div>


            <div class="docstring"><p>Applies multiple simplification rules until the expression no longer changes</p>
</div>


                            </div>
                            <div id="Tensor.substitute" class="classattr">
                                        <input id="Tensor.substitute-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-final">@final</div>

        <span class="def">def</span>
        <span class="name">substitute</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">x</span><span class="p">:</span> <span class="n"><a href="#Variable">Variable</a></span>,</span><span class="param">	<span class="n">y</span><span class="p">:</span> <span class="n"><a href="#Tensor">Tensor</a></span></span><span class="return-annotation">) -> <span class="n"><a href="#Tensor">Tensor</a></span>:</span></span>

                <label class="view-source-button" for="Tensor.substitute-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.substitute"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.substitute-190"><a href="#Tensor.substitute-190"><span class="linenos">190</span></a>    <span class="nd">@final</span>
</span><span id="Tensor.substitute-191"><a href="#Tensor.substitute-191"><span class="linenos">191</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Tensor.substitute-192"><a href="#Tensor.substitute-192"><span class="linenos">192</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Substitute a variable with a tensor&quot;&quot;&quot;</span>
</span><span id="Tensor.substitute-193"><a href="#Tensor.substitute-193"><span class="linenos">193</span></a>        <span class="c1"># Ideally we&#39;d like y to be able to have extra edges that are not in x</span>
</span><span id="Tensor.substitute-194"><a href="#Tensor.substitute-194"><span class="linenos">194</span></a>        <span class="c1"># but which will be broadcasted as new edges of the tensor. This will</span>
</span><span id="Tensor.substitute-195"><a href="#Tensor.substitute-195"><span class="linenos">195</span></a>        <span class="c1"># allow us to implement numerical expectation, and other situations where</span>
</span><span id="Tensor.substitute-196"><a href="#Tensor.substitute-196"><span class="linenos">196</span></a>        <span class="c1"># we originally didn&#39;t have broadcasting, but we want to add it.</span>
</span><span id="Tensor.substitute-197"><a href="#Tensor.substitute-197"><span class="linenos">197</span></a>        <span class="c1"># Maybe we could even remove broadcasted edges of x as well.</span>
</span><span id="Tensor.substitute-198"><a href="#Tensor.substitute-198"><span class="linenos">198</span></a>        <span class="c1"># The tricky thing is to ensure it doesn&#39;t clash with the existing edges.</span>
</span><span id="Tensor.substitute-199"><a href="#Tensor.substitute-199"><span class="linenos">199</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_substitute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Substitute a variable with a tensor</p>
</div>


                            </div>
                            <div id="Tensor.weisfeiler_lehman" class="classattr">
                                        <input id="Tensor.weisfeiler_lehman-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">weisfeiler_lehman</span><span class="annotation">: str</span>

                <label class="view-source-button" for="Tensor.weisfeiler_lehman-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.weisfeiler_lehman"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.weisfeiler_lehman-208"><a href="#Tensor.weisfeiler_lehman-208"><span class="linenos">208</span></a>    <span class="nd">@cached_property</span>
</span><span id="Tensor.weisfeiler_lehman-209"><a href="#Tensor.weisfeiler_lehman-209"><span class="linenos">209</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">weisfeiler_lehman</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Tensor.weisfeiler_lehman-210"><a href="#Tensor.weisfeiler_lehman-210"><span class="linenos">210</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Hexadecimal string for WL-hash of the input graph.&quot;&quot;&quot;</span>
</span><span id="Tensor.weisfeiler_lehman-211"><a href="#Tensor.weisfeiler_lehman-211"><span class="linenos">211</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Tensor.weisfeiler_lehman-212"><a href="#Tensor.weisfeiler_lehman-212"><span class="linenos">212</span></a>        <span class="k">return</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">weisfeiler_lehman_graph_hash</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">node_attr</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Hexadecimal string for WL-hash of the input graph.</p>
</div>


                            </div>
                            <div id="Tensor.depends_on" class="classattr">
                                        <input id="Tensor.depends_on-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">depends_on</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span><span class="p">:</span> <span class="n"><a href="#Variable">Variable</a></span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Tensor.depends_on-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.depends_on"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.depends_on-219"><a href="#Tensor.depends_on-219"><span class="linenos">219</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Tensor.depends_on-220"><a href="#Tensor.depends_on-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this tensor depends on the variable x.&quot;&quot;&quot;</span>
</span><span id="Tensor.depends_on-221"><a href="#Tensor.depends_on-221"><span class="linenos">221</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span></pre></div>


            <div class="docstring"><p>Check if this tensor depends on the variable x.</p>
</div>


                            </div>
                            <div id="Tensor.structural_graph" class="classattr">
                                        <input id="Tensor.structural_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">structural_graph</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">networkx</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">multidigraph</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="Tensor.structural_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.structural_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.structural_graph-223"><a href="#Tensor.structural_graph-223"><span class="linenos">223</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Tensor.structural_graph-224"><a href="#Tensor.structural_graph-224"><span class="linenos">224</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a graph representation of the tensor, which can be used for isomorphism testing.</span>
</span><span id="Tensor.structural_graph-225"><a href="#Tensor.structural_graph-225"><span class="linenos">225</span></a>
</span><span id="Tensor.structural_graph-226"><a href="#Tensor.structural_graph-226"><span class="linenos">226</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor.structural_graph-227"><a href="#Tensor.structural_graph-227"><span class="linenos">227</span></a><span class="sd">            A tuple with the following values:</span>
</span><span id="Tensor.structural_graph-228"><a href="#Tensor.structural_graph-228"><span class="linenos">228</span></a><span class="sd">            - A NetworkX directed graph.</span>
</span><span id="Tensor.structural_graph-229"><a href="#Tensor.structural_graph-229"><span class="linenos">229</span></a><span class="sd">                - Each node in the top tree is labeled with the producing tensor.</span>
</span><span id="Tensor.structural_graph-230"><a href="#Tensor.structural_graph-230"><span class="linenos">230</span></a><span class="sd">                - Use name=hashable to label vertices</span>
</span><span id="Tensor.structural_graph-231"><a href="#Tensor.structural_graph-231"><span class="linenos">231</span></a><span class="sd">            - &quot;edges&quot;, a dict of edge_name -&gt; node id</span>
</span><span id="Tensor.structural_graph-232"><a href="#Tensor.structural_graph-232"><span class="linenos">232</span></a><span class="sd">            - Node 0 should be the root</span>
</span><span id="Tensor.structural_graph-233"><a href="#Tensor.structural_graph-233"><span class="linenos">233</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor.structural_graph-234"><a href="#Tensor.structural_graph-234"><span class="linenos">234</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</span></pre></div>


            <div class="docstring"><p>Create a graph representation of the tensor, which can be used for isomorphism testing.</p>

<p>Returns:
    A tuple with the following values:
    - A NetworkX directed graph.
        - Each node in the top tree is labeled with the producing tensor.
        - Use name=hashable to label vertices
    - "edges", a dict of edge_name -> node id
    - Node 0 should be the root</p>
</div>


                            </div>
                            <div id="Tensor.edge_structural_graph" class="classattr">
                                        <input id="Tensor.edge_structural_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">edge_structural_graph</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">match_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">edge_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">networkx</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">multidigraph</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="Tensor.edge_structural_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.edge_structural_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.edge_structural_graph-236"><a href="#Tensor.edge_structural_graph-236"><span class="linenos">236</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">edge_structural_graph</span><span class="p">(</span>
</span><span id="Tensor.edge_structural_graph-237"><a href="#Tensor.edge_structural_graph-237"><span class="linenos">237</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">match_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">edge_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Tensor.edge_structural_graph-238"><a href="#Tensor.edge_structural_graph-238"><span class="linenos">238</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="Tensor.edge_structural_graph-239"><a href="#Tensor.edge_structural_graph-239"><span class="linenos">239</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor.edge_structural_graph-240"><a href="#Tensor.edge_structural_graph-240"><span class="linenos">240</span></a><span class="sd">        Build a structural graph of the tensor with dummy nodes for outer edges.</span>
</span><span id="Tensor.edge_structural_graph-241"><a href="#Tensor.edge_structural_graph-241"><span class="linenos">241</span></a>
</span><span id="Tensor.edge_structural_graph-242"><a href="#Tensor.edge_structural_graph-242"><span class="linenos">242</span></a><span class="sd">        Args:</span>
</span><span id="Tensor.edge_structural_graph-243"><a href="#Tensor.edge_structural_graph-243"><span class="linenos">243</span></a><span class="sd">            match_edges: If True the names are used to match edges.</span>
</span><span id="Tensor.edge_structural_graph-244"><a href="#Tensor.edge_structural_graph-244"><span class="linenos">244</span></a><span class="sd">            edge_names: An optional mapping of edge names.</span>
</span><span id="Tensor.edge_structural_graph-245"><a href="#Tensor.edge_structural_graph-245"><span class="linenos">245</span></a>
</span><span id="Tensor.edge_structural_graph-246"><a href="#Tensor.edge_structural_graph-246"><span class="linenos">246</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor.edge_structural_graph-247"><a href="#Tensor.edge_structural_graph-247"><span class="linenos">247</span></a><span class="sd">            A tuple (G, edge_list) where G is the graph and edge_list is the list of edge names.</span>
</span><span id="Tensor.edge_structural_graph-248"><a href="#Tensor.edge_structural_graph-248"><span class="linenos">248</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor.edge_structural_graph-249"><a href="#Tensor.edge_structural_graph-249"><span class="linenos">249</span></a>        <span class="k">if</span> <span class="n">edge_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Tensor.edge_structural_graph-250"><a href="#Tensor.edge_structural_graph-250"><span class="linenos">250</span></a>            <span class="n">edge_names</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Tensor.edge_structural_graph-251"><a href="#Tensor.edge_structural_graph-251"><span class="linenos">251</span></a>
</span><span id="Tensor.edge_structural_graph-252"><a href="#Tensor.edge_structural_graph-252"><span class="linenos">252</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structural_graph</span><span class="p">()</span>
</span><span id="Tensor.edge_structural_graph-253"><a href="#Tensor.edge_structural_graph-253"><span class="linenos">253</span></a>
</span><span id="Tensor.edge_structural_graph-254"><a href="#Tensor.edge_structural_graph-254"><span class="linenos">254</span></a>        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="Tensor.edge_structural_graph-255"><a href="#Tensor.edge_structural_graph-255"><span class="linenos">255</span></a>            <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edge_names</span><span class="p">:</span>
</span><span id="Tensor.edge_structural_graph-256"><a href="#Tensor.edge_structural_graph-256"><span class="linenos">256</span></a>                <span class="n">edge_names</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Outer Edge&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">if</span> <span class="n">match_edges</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
</span><span id="Tensor.edge_structural_graph-257"><a href="#Tensor.edge_structural_graph-257"><span class="linenos">257</span></a>
</span><span id="Tensor.edge_structural_graph-258"><a href="#Tensor.edge_structural_graph-258"><span class="linenos">258</span></a>        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Tensor.edge_structural_graph-259"><a href="#Tensor.edge_structural_graph-259"><span class="linenos">259</span></a>            <span class="n">n</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span>
</span><span id="Tensor.edge_structural_graph-260"><a href="#Tensor.edge_structural_graph-260"><span class="linenos">260</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">edge_names</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
</span><span id="Tensor.edge_structural_graph-261"><a href="#Tensor.edge_structural_graph-261"><span class="linenos">261</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="Tensor.edge_structural_graph-262"><a href="#Tensor.edge_structural_graph-262"><span class="linenos">262</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></pre></div>


            <div class="docstring"><p>Build a structural graph of the tensor with dummy nodes for outer edges.</p>

<p>Args:
    match_edges: If True the names are used to match edges.
    edge_names: An optional mapping of edge names.</p>

<p>Returns:
    A tuple (G, edge_list) where G is the graph and edge_list is the list of edge names.</p>
</div>


                            </div>
                            <div id="Tensor.graph_to_string" class="classattr">
                                        <input id="Tensor.graph_to_string-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">graph_to_string</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="Tensor.graph_to_string-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.graph_to_string"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.graph_to_string-264"><a href="#Tensor.graph_to_string-264"><span class="linenos">264</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">graph_to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Tensor.graph_to_string-265"><a href="#Tensor.graph_to_string-265"><span class="linenos">265</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor.graph_to_string-266"><a href="#Tensor.graph_to_string-266"><span class="linenos">266</span></a><span class="sd">        Returns an ASCII tree-like representation of the structural graph.</span>
</span><span id="Tensor.graph_to_string-267"><a href="#Tensor.graph_to_string-267"><span class="linenos">267</span></a>
</span><span id="Tensor.graph_to_string-268"><a href="#Tensor.graph_to_string-268"><span class="linenos">268</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor.graph_to_string-269"><a href="#Tensor.graph_to_string-269"><span class="linenos">269</span></a><span class="sd">            A string showing the graph structure.</span>
</span><span id="Tensor.graph_to_string-270"><a href="#Tensor.graph_to_string-270"><span class="linenos">270</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor.graph_to_string-271"><a href="#Tensor.graph_to_string-271"><span class="linenos">271</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Tensor.graph_to_string-272"><a href="#Tensor.graph_to_string-272"><span class="linenos">272</span></a>        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">generate_network_text</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></pre></div>


            <div class="docstring"><p>Returns an ASCII tree-like representation of the structural graph.</p>

<p>Returns:
    A string showing the graph structure.</p>
</div>


                            </div>
                            <div id="Tensor.is_isomorphic" class="classattr">
                                        <input id="Tensor.is_isomorphic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_isomorphic</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">other</span><span class="p">:</span> <span class="n"><a href="#Tensor">Tensor</a></span>,</span><span class="param">	<span class="n">match_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">edge_names</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Tensor.is_isomorphic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.is_isomorphic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.is_isomorphic-350"><a href="#Tensor.is_isomorphic-350"><span class="linenos">350</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_isomorphic</span><span class="p">(</span>
</span><span id="Tensor.is_isomorphic-351"><a href="#Tensor.is_isomorphic-351"><span class="linenos">351</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">,</span> <span class="n">match_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">edge_names</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Tensor.is_isomorphic-352"><a href="#Tensor.is_isomorphic-352"><span class="linenos">352</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Tensor.is_isomorphic-353"><a href="#Tensor.is_isomorphic-353"><span class="linenos">353</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor.is_isomorphic-354"><a href="#Tensor.is_isomorphic-354"><span class="linenos">354</span></a><span class="sd">        Test whether this tensor is isomorphic to another tensor.</span>
</span><span id="Tensor.is_isomorphic-355"><a href="#Tensor.is_isomorphic-355"><span class="linenos">355</span></a>
</span><span id="Tensor.is_isomorphic-356"><a href="#Tensor.is_isomorphic-356"><span class="linenos">356</span></a><span class="sd">        Args:</span>
</span><span id="Tensor.is_isomorphic-357"><a href="#Tensor.is_isomorphic-357"><span class="linenos">357</span></a><span class="sd">            other: The tensor to compare with.</span>
</span><span id="Tensor.is_isomorphic-358"><a href="#Tensor.is_isomorphic-358"><span class="linenos">358</span></a><span class="sd">            match_edges: Whether to require a matching of edge names.</span>
</span><span id="Tensor.is_isomorphic-359"><a href="#Tensor.is_isomorphic-359"><span class="linenos">359</span></a><span class="sd">            edge_names: Optional mapping to use for edge renaming.</span>
</span><span id="Tensor.is_isomorphic-360"><a href="#Tensor.is_isomorphic-360"><span class="linenos">360</span></a>
</span><span id="Tensor.is_isomorphic-361"><a href="#Tensor.is_isomorphic-361"><span class="linenos">361</span></a><span class="sd">        Returns:</span>
</span><span id="Tensor.is_isomorphic-362"><a href="#Tensor.is_isomorphic-362"><span class="linenos">362</span></a><span class="sd">            True if the tensors are isomorphic; False otherwise.</span>
</span><span id="Tensor.is_isomorphic-363"><a href="#Tensor.is_isomorphic-363"><span class="linenos">363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor.is_isomorphic-364"><a href="#Tensor.is_isomorphic-364"><span class="linenos">364</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weisfeiler_lehman</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">weisfeiler_lehman</span><span class="p">:</span>
</span><span id="Tensor.is_isomorphic-365"><a href="#Tensor.is_isomorphic-365"><span class="linenos">365</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="Tensor.is_isomorphic-366"><a href="#Tensor.is_isomorphic-366"><span class="linenos">366</span></a>        <span class="n">G1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="n">match_edges</span><span class="p">,</span> <span class="n">edge_names</span><span class="o">=</span><span class="n">edge_names</span><span class="p">)</span>
</span><span id="Tensor.is_isomorphic-367"><a href="#Tensor.is_isomorphic-367"><span class="linenos">367</span></a>        <span class="n">G2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="n">match_edges</span><span class="p">,</span> <span class="n">edge_names</span><span class="o">=</span><span class="n">edge_names</span><span class="p">)</span>
</span><span id="Tensor.is_isomorphic-368"><a href="#Tensor.is_isomorphic-368"><span class="linenos">368</span></a>        <span class="k">return</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_isomorphic</span><span class="p">(</span><span class="n">G1</span><span class="p">,</span> <span class="n">G2</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">n2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
</span><span id="Tensor.is_isomorphic-369"><a href="#Tensor.is_isomorphic-369"><span class="linenos">369</span></a>        <span class="c1"># return nx.vf2pp_is_isomorphic(G1, G2, node_label=&quot;name&quot;)</span>
</span></pre></div>


            <div class="docstring"><p>Test whether this tensor is isomorphic to another tensor.</p>

<p>Args:
    other: The tensor to compare with.
    match_edges: Whether to require a matching of edge names.
    edge_names: Optional mapping to use for edge renaming.</p>

<p>Returns:
    True if the tensors are isomorphic; False otherwise.</p>
</div>


                            </div>
                            <div id="Tensor.isomorphisms" class="classattr">
                                        <input id="Tensor.isomorphisms-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">isomorphisms</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">other</span><span class="p">:</span> <span class="n"><a href="#Tensor">Tensor</a></span></span><span class="return-annotation">) -> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Tensor.isomorphisms-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.isomorphisms"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.isomorphisms-371"><a href="#Tensor.isomorphisms-371"><span class="linenos">371</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">isomorphisms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="Tensor.isomorphisms-372"><a href="#Tensor.isomorphisms-372"><span class="linenos">372</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Tensor.isomorphisms-373"><a href="#Tensor.isomorphisms-373"><span class="linenos">373</span></a><span class="sd">        Yield all isomorphisms (edge renamings) between self and other.</span>
</span><span id="Tensor.isomorphisms-374"><a href="#Tensor.isomorphisms-374"><span class="linenos">374</span></a>
</span><span id="Tensor.isomorphisms-375"><a href="#Tensor.isomorphisms-375"><span class="linenos">375</span></a><span class="sd">        Args:</span>
</span><span id="Tensor.isomorphisms-376"><a href="#Tensor.isomorphisms-376"><span class="linenos">376</span></a><span class="sd">            other: The other tensor to compare.</span>
</span><span id="Tensor.isomorphisms-377"><a href="#Tensor.isomorphisms-377"><span class="linenos">377</span></a>
</span><span id="Tensor.isomorphisms-378"><a href="#Tensor.isomorphisms-378"><span class="linenos">378</span></a><span class="sd">        Yields:</span>
</span><span id="Tensor.isomorphisms-379"><a href="#Tensor.isomorphisms-379"><span class="linenos">379</span></a><span class="sd">            Dictionaries mapping edge names in self to edge names in other.</span>
</span><span id="Tensor.isomorphisms-380"><a href="#Tensor.isomorphisms-380"><span class="linenos">380</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Tensor.isomorphisms-381"><a href="#Tensor.isomorphisms-381"><span class="linenos">381</span></a>        <span class="n">G1</span><span class="p">,</span> <span class="n">edges1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Tensor.isomorphisms-382"><a href="#Tensor.isomorphisms-382"><span class="linenos">382</span></a>        <span class="n">G2</span><span class="p">,</span> <span class="n">edges2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">edge_structural_graph</span><span class="p">(</span><span class="n">match_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Tensor.isomorphisms-383"><a href="#Tensor.isomorphisms-383"><span class="linenos">383</span></a>        <span class="k">for</span> <span class="n">matching</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">isomorphism</span><span class="o">.</span><span class="n">MultiDiGraphMatcher</span><span class="p">(</span>
</span><span id="Tensor.isomorphisms-384"><a href="#Tensor.isomorphisms-384"><span class="linenos">384</span></a>            <span class="n">G1</span><span class="p">,</span> <span class="n">G2</span><span class="p">,</span> <span class="n">node_match</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">:</span> <span class="n">n1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">n2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
</span><span id="Tensor.isomorphisms-385"><a href="#Tensor.isomorphisms-385"><span class="linenos">385</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">isomorphisms_iter</span><span class="p">():</span>
</span><span id="Tensor.isomorphisms-386"><a href="#Tensor.isomorphisms-386"><span class="linenos">386</span></a>            <span class="c1"># Matching is a dict {i: j} where i is the node in G1 and j is the node in G2</span>
</span><span id="Tensor.isomorphisms-387"><a href="#Tensor.isomorphisms-387"><span class="linenos">387</span></a>            <span class="c1"># We are only interested in then `len(self.edges)` last nodes, which correspond to the outer edges</span>
</span><span id="Tensor.isomorphisms-388"><a href="#Tensor.isomorphisms-388"><span class="linenos">388</span></a>            <span class="n">start_i</span> <span class="o">=</span> <span class="n">G1</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="Tensor.isomorphisms-389"><a href="#Tensor.isomorphisms-389"><span class="linenos">389</span></a>            <span class="n">start_j</span> <span class="o">=</span> <span class="n">G2</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="Tensor.isomorphisms-390"><a href="#Tensor.isomorphisms-390"><span class="linenos">390</span></a>            <span class="k">yield</span> <span class="p">{</span>
</span><span id="Tensor.isomorphisms-391"><a href="#Tensor.isomorphisms-391"><span class="linenos">391</span></a>                <span class="n">edges1</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">start_i</span><span class="p">]:</span> <span class="n">edges2</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="n">start_j</span><span class="p">]</span>
</span><span id="Tensor.isomorphisms-392"><a href="#Tensor.isomorphisms-392"><span class="linenos">392</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">matching</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Tensor.isomorphisms-393"><a href="#Tensor.isomorphisms-393"><span class="linenos">393</span></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">start_i</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">start_j</span>
</span><span id="Tensor.isomorphisms-394"><a href="#Tensor.isomorphisms-394"><span class="linenos">394</span></a>            <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Yield all isomorphisms (edge renamings) between self and other.</p>

<p>Args:
    other: The other tensor to compare.</p>

<p>Yields:
    Dictionaries mapping edge names in self to edge names in other.</p>
</div>


                            </div>
                            <div id="Tensor.symmetries" class="classattr">
                                        <input id="Tensor.symmetries-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">symmetries</span><span class="annotation">: set[frozenset[str]]</span>

                <label class="view-source-button" for="Tensor.symmetries-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Tensor.symmetries"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Tensor.symmetries-396"><a href="#Tensor.symmetries-396"><span class="linenos">396</span></a>    <span class="nd">@cached_property</span>
</span><span id="Tensor.symmetries-397"><a href="#Tensor.symmetries-397"><span class="linenos">397</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">symmetries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="Tensor.symmetries-398"><a href="#Tensor.symmetries-398"><span class="linenos">398</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the orbits of the automorphism group of the tensor.&quot;&quot;&quot;</span>
</span><span id="Tensor.symmetries-399"><a href="#Tensor.symmetries-399"><span class="linenos">399</span></a>        <span class="c1"># The orbits are the sets of edges that ever get mapped to each other.</span>
</span><span id="Tensor.symmetries-400"><a href="#Tensor.symmetries-400"><span class="linenos">400</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">isomorphisms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
</span><span id="Tensor.symmetries-401"><a href="#Tensor.symmetries-401"><span class="linenos">401</span></a>        <span class="n">symmetries</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">,</span> <span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">)))</span>
</span><span id="Tensor.symmetries-402"><a href="#Tensor.symmetries-402"><span class="linenos">402</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_symmetries&quot;</span><span class="p">):</span>
</span><span id="Tensor.symmetries-403"><a href="#Tensor.symmetries-403"><span class="linenos">403</span></a>            <span class="k">assert</span> <span class="n">symmetries</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">symmetries</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="Tensor.symmetries-404"><a href="#Tensor.symmetries-404"><span class="linenos">404</span></a>        <span class="k">return</span> <span class="n">symmetries</span>
</span></pre></div>


            <div class="docstring"><p>Return the orbits of the automorphism group of the tensor.</p>
</div>


                            </div>
                </section>
                <section id="Variable">
                            <input id="Variable-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Variable</span><wbr>(<span class="base"><a href="#Tensor">Tensor</a></span>):

                <label class="view-source-button" for="Variable-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Variable"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Variable-494"><a href="#Variable-494"><span class="linenos">494</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Variable</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Variable-495"><a href="#Variable-495"><span class="linenos">495</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Variable-496"><a href="#Variable-496"><span class="linenos">496</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Variable-497"><a href="#Variable-497"><span class="linenos">497</span></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Variable-498"><a href="#Variable-498"><span class="linenos">498</span></a>        <span class="o">*</span><span class="n">shape0</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span>
</span><span id="Variable-499"><a href="#Variable-499"><span class="linenos">499</span></a>        <span class="n">_symmetries</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Variable-500"><a href="#Variable-500"><span class="linenos">500</span></a>        <span class="o">**</span><span class="n">shape1</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span>
</span><span id="Variable-501"><a href="#Variable-501"><span class="linenos">501</span></a>    <span class="p">):</span>
</span><span id="Variable-502"><a href="#Variable-502"><span class="linenos">502</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Variable-503"><a href="#Variable-503"><span class="linenos">503</span></a><span class="sd">        A tensor holding a variable.</span>
</span><span id="Variable-504"><a href="#Variable-504"><span class="linenos">504</span></a>
</span><span id="Variable-505"><a href="#Variable-505"><span class="linenos">505</span></a><span class="sd">        Args:</span>
</span><span id="Variable-506"><a href="#Variable-506"><span class="linenos">506</span></a><span class="sd">            name: The name of the variable.</span>
</span><span id="Variable-507"><a href="#Variable-507"><span class="linenos">507</span></a><span class="sd">            shape0: Positional Sympy symbols for dimensions.</span>
</span><span id="Variable-508"><a href="#Variable-508"><span class="linenos">508</span></a><span class="sd">            _symmetries: Optional symmetries (as a string or set of frozensets).</span>
</span><span id="Variable-509"><a href="#Variable-509"><span class="linenos">509</span></a><span class="sd">            shape1: Keyword arguments for dimensions.</span>
</span><span id="Variable-510"><a href="#Variable-510"><span class="linenos">510</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Variable-511"><a href="#Variable-511"><span class="linenos">511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Variable-512"><a href="#Variable-512"><span class="linenos">512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_shape</span><span class="p">(</span><span class="n">shape0</span><span class="p">,</span> <span class="n">shape1</span><span class="p">)</span>
</span><span id="Variable-513"><a href="#Variable-513"><span class="linenos">513</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span> <span class="n">_symmetries</span><span class="p">)</span>
</span><span id="Variable-514"><a href="#Variable-514"><span class="linenos">514</span></a>
</span><span id="Variable-515"><a href="#Variable-515"><span class="linenos">515</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetries</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Variable&quot;</span><span class="p">:</span>
</span><span id="Variable-516"><a href="#Variable-516"><span class="linenos">516</span></a>        <span class="k">return</span> <span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_symmetries</span><span class="o">=</span><span class="n">symmetries</span><span class="p">)</span>
</span><span id="Variable-517"><a href="#Variable-517"><span class="linenos">517</span></a>
</span><span id="Variable-518"><a href="#Variable-518"><span class="linenos">518</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Variable-519"><a href="#Variable-519"><span class="linenos">519</span></a>        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="Variable-520"><a href="#Variable-520"><span class="linenos">520</span></a>            <span class="c1"># TODO: If X has symmetries, the derivative can actually be more complex than this.</span>
</span><span id="Variable-521"><a href="#Variable-521"><span class="linenos">521</span></a>            <span class="c1"># See See 2.8.2 Symmetric in the Cookbook: https://www2.imm.dtu.dk/pubdb/edoc/imm3274.pdf</span>
</span><span id="Variable-522"><a href="#Variable-522"><span class="linenos">522</span></a>            <span class="k">return</span> <span class="n">Product</span><span class="p">(</span><span class="n">Delta</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">new_names</span><span class="p">[</span><span class="n">e</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span><span id="Variable-523"><a href="#Variable-523"><span class="linenos">523</span></a>        <span class="c1"># Note: We don&#39;t need to tell Zero the symmetries, since it&#39;s automatically</span>
</span><span id="Variable-524"><a href="#Variable-524"><span class="linenos">524</span></a>        <span class="c1"># symmetric in all dimensions that have compatible sizes.</span>
</span><span id="Variable-525"><a href="#Variable-525"><span class="linenos">525</span></a>        <span class="k">return</span> <span class="n">Zero</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">|</span> <span class="p">{</span><span class="n">new_names</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()}))</span>
</span><span id="Variable-526"><a href="#Variable-526"><span class="linenos">526</span></a>
</span><span id="Variable-527"><a href="#Variable-527"><span class="linenos">527</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Variable-528"><a href="#Variable-528"><span class="linenos">528</span></a>        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">, </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="Variable-529"><a href="#Variable-529"><span class="linenos">529</span></a>        <span class="n">symmetries</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="Variable-530"><a href="#Variable-530"><span class="linenos">530</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span> <span class="o">!=</span> <span class="p">{</span><span class="nb">frozenset</span><span class="p">({</span><span class="n">e</span><span class="p">})</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">}:</span>
</span><span id="Variable-531"><a href="#Variable-531"><span class="linenos">531</span></a>            <span class="n">groups</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">group</span><span class="p">))</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="p">))</span>
</span><span id="Variable-532"><a href="#Variable-532"><span class="linenos">532</span></a>            <span class="n">symmetries</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;.with_symmetries(&quot;</span><span class="si">{</span><span class="n">groups</span><span class="si">}</span><span class="s1">&quot;)&#39;</span>
</span><span id="Variable-533"><a href="#Variable-533"><span class="linenos">533</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Variable(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">symmetries</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Variable-534"><a href="#Variable-534"><span class="linenos">534</span></a>
</span><span id="Variable-535"><a href="#Variable-535"><span class="linenos">535</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Variable-536"><a href="#Variable-536"><span class="linenos">536</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Variable-537"><a href="#Variable-537"><span class="linenos">537</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Variable-538"><a href="#Variable-538"><span class="linenos">538</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Variable-539"><a href="#Variable-539"><span class="linenos">539</span></a>        <span class="c1"># Symmetries are more fine-grained than shapes, since two dims can have</span>
</span><span id="Variable-540"><a href="#Variable-540"><span class="linenos">540</span></a>        <span class="c1"># the same size, but not be symmetric. E.g. an assymetric square matrix.</span>
</span><span id="Variable-541"><a href="#Variable-541"><span class="linenos">541</span></a>        <span class="c1"># Example of variable with 2 sizes, 3 symmetri orbits and 4 edges:</span>
</span><span id="Variable-542"><a href="#Variable-542"><span class="linenos">542</span></a>        <span class="c1"># +-size 1-sym 1-e 1</span>
</span><span id="Variable-543"><a href="#Variable-543"><span class="linenos">543</span></a>        <span class="c1"># |  +-----sym 2-e 2</span>
</span><span id="Variable-544"><a href="#Variable-544"><span class="linenos">544</span></a>        <span class="c1"># +-size 2-sym 3-e 3</span>
</span><span id="Variable-545"><a href="#Variable-545"><span class="linenos">545</span></a>        <span class="c1">#           +----e 4</span>
</span><span id="Variable-546"><a href="#Variable-546"><span class="linenos">546</span></a>        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="Variable-547"><a href="#Variable-547"><span class="linenos">547</span></a>            <span class="c1"># Symbols are identified by name and assumptions. We might want to have edges</span>
</span><span id="Variable-548"><a href="#Variable-548"><span class="linenos">548</span></a>            <span class="c1"># with the same name but different assumptions, so add the id to the node name.</span>
</span><span id="Variable-549"><a href="#Variable-549"><span class="linenos">549</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">size_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;size=</span><span class="si">{</span><span class="n">size</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">size</span><span class="p">)))</span>
</span><span id="Variable-550"><a href="#Variable-550"><span class="linenos">550</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size_node</span><span class="p">)</span>
</span><span id="Variable-551"><a href="#Variable-551"><span class="linenos">551</span></a>            <span class="c1"># Find each orbit with the given size (see note above about fine-grained-ness)</span>
</span><span id="Variable-552"><a href="#Variable-552"><span class="linenos">552</span></a>            <span class="k">for</span> <span class="n">orbit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="p">:</span>
</span><span id="Variable-553"><a href="#Variable-553"><span class="linenos">553</span></a>                <span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">orbit</span>
</span><span id="Variable-554"><a href="#Variable-554"><span class="linenos">554</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">!=</span> <span class="n">size</span><span class="p">:</span>
</span><span id="Variable-555"><a href="#Variable-555"><span class="linenos">555</span></a>                    <span class="k">continue</span>
</span><span id="Variable-556"><a href="#Variable-556"><span class="linenos">556</span></a>                <span class="c1"># Orbits are named after the variable edges. This ensures that variables are only</span>
</span><span id="Variable-557"><a href="#Variable-557"><span class="linenos">557</span></a>                <span class="c1"># isomoprhic with other variables with the same edge names.</span>
</span><span id="Variable-558"><a href="#Variable-558"><span class="linenos">558</span></a>                <span class="n">orbit_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">orbit</span><span class="p">))</span>
</span><span id="Variable-559"><a href="#Variable-559"><span class="linenos">559</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">orbit_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Orbit Node&quot;</span><span class="p">,</span> <span class="n">orbit_name</span><span class="p">))</span>
</span><span id="Variable-560"><a href="#Variable-560"><span class="linenos">560</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">size_node</span><span class="p">,</span> <span class="n">orbit_node</span><span class="p">)</span>
</span><span id="Variable-561"><a href="#Variable-561"><span class="linenos">561</span></a>                <span class="c1"># All the free edges point to an orbit node</span>
</span><span id="Variable-562"><a href="#Variable-562"><span class="linenos">562</span></a>                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">orbit</span><span class="p">:</span>
</span><span id="Variable-563"><a href="#Variable-563"><span class="linenos">563</span></a>                    <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">orbit_node</span>
</span><span id="Variable-564"><a href="#Variable-564"><span class="linenos">564</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Variable-565"><a href="#Variable-565"><span class="linenos">565</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="Variable-566"><a href="#Variable-566"><span class="linenos">566</span></a>
</span><span id="Variable-567"><a href="#Variable-567"><span class="linenos">567</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Variable-568"><a href="#Variable-568"><span class="linenos">568</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Variable-569"><a href="#Variable-569"><span class="linenos">569</span></a>
</span><span id="Variable-570"><a href="#Variable-570"><span class="linenos">570</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Variable-571"><a href="#Variable-571"><span class="linenos">571</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="Variable-572"><a href="#Variable-572"><span class="linenos">572</span></a>            <span class="k">return</span> <span class="bp">self</span>
</span><span id="Variable-573"><a href="#Variable-573"><span class="linenos">573</span></a>        <span class="k">return</span> <span class="n">Rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</span><span id="Variable-574"><a href="#Variable-574"><span class="linenos">574</span></a>
</span><span id="Variable-575"><a href="#Variable-575"><span class="linenos">575</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Variable-576"><a href="#Variable-576"><span class="linenos">576</span></a>        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="Variable-577"><a href="#Variable-577"><span class="linenos">577</span></a>            <span class="k">return</span> <span class="n">y</span>
</span><span id="Variable-578"><a href="#Variable-578"><span class="linenos">578</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Variable-579"><a href="#Variable-579"><span class="linenos">579</span></a>
</span><span id="Variable-580"><a href="#Variable-580"><span class="linenos">580</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Variable-581"><a href="#Variable-581"><span class="linenos">581</span></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span>
</span></pre></div>


    

                            <div id="Variable.__init__" class="classattr">
                                        <input id="Variable.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Variable</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="o">*</span><span class="n">shape0</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span>,</span><span class="param">	<span class="n">_symmetries</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">shape1</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span></span>)</span>

                <label class="view-source-button" for="Variable.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Variable.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Variable.__init__-495"><a href="#Variable.__init__-495"><span class="linenos">495</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Variable.__init__-496"><a href="#Variable.__init__-496"><span class="linenos">496</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Variable.__init__-497"><a href="#Variable.__init__-497"><span class="linenos">497</span></a>        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Variable.__init__-498"><a href="#Variable.__init__-498"><span class="linenos">498</span></a>        <span class="o">*</span><span class="n">shape0</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span>
</span><span id="Variable.__init__-499"><a href="#Variable.__init__-499"><span class="linenos">499</span></a>        <span class="n">_symmetries</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Variable.__init__-500"><a href="#Variable.__init__-500"><span class="linenos">500</span></a>        <span class="o">**</span><span class="n">shape1</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span>
</span><span id="Variable.__init__-501"><a href="#Variable.__init__-501"><span class="linenos">501</span></a>    <span class="p">):</span>
</span><span id="Variable.__init__-502"><a href="#Variable.__init__-502"><span class="linenos">502</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Variable.__init__-503"><a href="#Variable.__init__-503"><span class="linenos">503</span></a><span class="sd">        A tensor holding a variable.</span>
</span><span id="Variable.__init__-504"><a href="#Variable.__init__-504"><span class="linenos">504</span></a>
</span><span id="Variable.__init__-505"><a href="#Variable.__init__-505"><span class="linenos">505</span></a><span class="sd">        Args:</span>
</span><span id="Variable.__init__-506"><a href="#Variable.__init__-506"><span class="linenos">506</span></a><span class="sd">            name: The name of the variable.</span>
</span><span id="Variable.__init__-507"><a href="#Variable.__init__-507"><span class="linenos">507</span></a><span class="sd">            shape0: Positional Sympy symbols for dimensions.</span>
</span><span id="Variable.__init__-508"><a href="#Variable.__init__-508"><span class="linenos">508</span></a><span class="sd">            _symmetries: Optional symmetries (as a string or set of frozensets).</span>
</span><span id="Variable.__init__-509"><a href="#Variable.__init__-509"><span class="linenos">509</span></a><span class="sd">            shape1: Keyword arguments for dimensions.</span>
</span><span id="Variable.__init__-510"><a href="#Variable.__init__-510"><span class="linenos">510</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Variable.__init__-511"><a href="#Variable.__init__-511"><span class="linenos">511</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span id="Variable.__init__-512"><a href="#Variable.__init__-512"><span class="linenos">512</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_shape</span><span class="p">(</span><span class="n">shape0</span><span class="p">,</span> <span class="n">shape1</span><span class="p">)</span>
</span><span id="Variable.__init__-513"><a href="#Variable.__init__-513"><span class="linenos">513</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span> <span class="n">_symmetries</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A tensor holding a variable.</p>

<p>Args:
    name: The name of the variable.
    shape0: Positional Sympy symbols for dimensions.
    _symmetries: Optional symmetries (as a string or set of frozensets).
    shape1: Keyword arguments for dimensions.</p>
</div>


                            </div>
                            <div id="Variable.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span>

        
    </div>
    <a class="headerlink" href="#Variable.name"></a>
    
    

                            </div>
                            <div id="Variable.with_symmetries" class="classattr">
                                        <input id="Variable.with_symmetries-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">with_symmetries</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">symmetries</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span></span><span class="return-annotation">) -> <span class="n"><a href="#Variable">Variable</a></span>:</span></span>

                <label class="view-source-button" for="Variable.with_symmetries-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Variable.with_symmetries"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Variable.with_symmetries-515"><a href="#Variable.with_symmetries-515"><span class="linenos">515</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetries</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Variable&quot;</span><span class="p">:</span>
</span><span id="Variable.with_symmetries-516"><a href="#Variable.with_symmetries-516"><span class="linenos">516</span></a>        <span class="k">return</span> <span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">_symmetries</span><span class="o">=</span><span class="n">symmetries</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Variable.structural_graph" class="classattr">
                                        <input id="Variable.structural_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">structural_graph</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">networkx</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">multidigraph</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="Variable.structural_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Variable.structural_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Variable.structural_graph-535"><a href="#Variable.structural_graph-535"><span class="linenos">535</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Variable.structural_graph-536"><a href="#Variable.structural_graph-536"><span class="linenos">536</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Variable.structural_graph-537"><a href="#Variable.structural_graph-537"><span class="linenos">537</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Variable.structural_graph-538"><a href="#Variable.structural_graph-538"><span class="linenos">538</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Variable.structural_graph-539"><a href="#Variable.structural_graph-539"><span class="linenos">539</span></a>        <span class="c1"># Symmetries are more fine-grained than shapes, since two dims can have</span>
</span><span id="Variable.structural_graph-540"><a href="#Variable.structural_graph-540"><span class="linenos">540</span></a>        <span class="c1"># the same size, but not be symmetric. E.g. an assymetric square matrix.</span>
</span><span id="Variable.structural_graph-541"><a href="#Variable.structural_graph-541"><span class="linenos">541</span></a>        <span class="c1"># Example of variable with 2 sizes, 3 symmetri orbits and 4 edges:</span>
</span><span id="Variable.structural_graph-542"><a href="#Variable.structural_graph-542"><span class="linenos">542</span></a>        <span class="c1"># +-size 1-sym 1-e 1</span>
</span><span id="Variable.structural_graph-543"><a href="#Variable.structural_graph-543"><span class="linenos">543</span></a>        <span class="c1"># |  +-----sym 2-e 2</span>
</span><span id="Variable.structural_graph-544"><a href="#Variable.structural_graph-544"><span class="linenos">544</span></a>        <span class="c1"># +-size 2-sym 3-e 3</span>
</span><span id="Variable.structural_graph-545"><a href="#Variable.structural_graph-545"><span class="linenos">545</span></a>        <span class="c1">#           +----e 4</span>
</span><span id="Variable.structural_graph-546"><a href="#Variable.structural_graph-546"><span class="linenos">546</span></a>        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="Variable.structural_graph-547"><a href="#Variable.structural_graph-547"><span class="linenos">547</span></a>            <span class="c1"># Symbols are identified by name and assumptions. We might want to have edges</span>
</span><span id="Variable.structural_graph-548"><a href="#Variable.structural_graph-548"><span class="linenos">548</span></a>            <span class="c1"># with the same name but different assumptions, so add the id to the node name.</span>
</span><span id="Variable.structural_graph-549"><a href="#Variable.structural_graph-549"><span class="linenos">549</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">size_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;size=</span><span class="si">{</span><span class="n">size</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">size</span><span class="p">)))</span>
</span><span id="Variable.structural_graph-550"><a href="#Variable.structural_graph-550"><span class="linenos">550</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size_node</span><span class="p">)</span>
</span><span id="Variable.structural_graph-551"><a href="#Variable.structural_graph-551"><span class="linenos">551</span></a>            <span class="c1"># Find each orbit with the given size (see note above about fine-grained-ness)</span>
</span><span id="Variable.structural_graph-552"><a href="#Variable.structural_graph-552"><span class="linenos">552</span></a>            <span class="k">for</span> <span class="n">orbit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="p">:</span>
</span><span id="Variable.structural_graph-553"><a href="#Variable.structural_graph-553"><span class="linenos">553</span></a>                <span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">orbit</span>
</span><span id="Variable.structural_graph-554"><a href="#Variable.structural_graph-554"><span class="linenos">554</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">!=</span> <span class="n">size</span><span class="p">:</span>
</span><span id="Variable.structural_graph-555"><a href="#Variable.structural_graph-555"><span class="linenos">555</span></a>                    <span class="k">continue</span>
</span><span id="Variable.structural_graph-556"><a href="#Variable.structural_graph-556"><span class="linenos">556</span></a>                <span class="c1"># Orbits are named after the variable edges. This ensures that variables are only</span>
</span><span id="Variable.structural_graph-557"><a href="#Variable.structural_graph-557"><span class="linenos">557</span></a>                <span class="c1"># isomoprhic with other variables with the same edge names.</span>
</span><span id="Variable.structural_graph-558"><a href="#Variable.structural_graph-558"><span class="linenos">558</span></a>                <span class="n">orbit_name</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">orbit</span><span class="p">))</span>
</span><span id="Variable.structural_graph-559"><a href="#Variable.structural_graph-559"><span class="linenos">559</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">orbit_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Orbit Node&quot;</span><span class="p">,</span> <span class="n">orbit_name</span><span class="p">))</span>
</span><span id="Variable.structural_graph-560"><a href="#Variable.structural_graph-560"><span class="linenos">560</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">size_node</span><span class="p">,</span> <span class="n">orbit_node</span><span class="p">)</span>
</span><span id="Variable.structural_graph-561"><a href="#Variable.structural_graph-561"><span class="linenos">561</span></a>                <span class="c1"># All the free edges point to an orbit node</span>
</span><span id="Variable.structural_graph-562"><a href="#Variable.structural_graph-562"><span class="linenos">562</span></a>                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">orbit</span><span class="p">:</span>
</span><span id="Variable.structural_graph-563"><a href="#Variable.structural_graph-563"><span class="linenos">563</span></a>                    <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">orbit_node</span>
</span><span id="Variable.structural_graph-564"><a href="#Variable.structural_graph-564"><span class="linenos">564</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Variable.structural_graph-565"><a href="#Variable.structural_graph-565"><span class="linenos">565</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span></pre></div>


            <div class="docstring"><p>Create a graph representation of the tensor, which can be used for isomorphism testing.</p>

<p>Returns:
    A tuple with the following values:
    - A NetworkX directed graph.
        - Each node in the top tree is labeled with the producing tensor.
        - Use name=hashable to label vertices
    - "edges", a dict of edge_name -> node id
    - Node 0 should be the root</p>
</div>


                            </div>
                            <div id="Variable.depends_on" class="classattr">
                                        <input id="Variable.depends_on-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">depends_on</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span><span class="p">:</span> <span class="n"><a href="#Variable">Variable</a></span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Variable.depends_on-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Variable.depends_on"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Variable.depends_on-580"><a href="#Variable.depends_on-580"><span class="linenos">580</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Variable.depends_on-581"><a href="#Variable.depends_on-581"><span class="linenos">581</span></a>        <span class="k">return</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Check if this tensor depends on the variable x.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Tensor">Tensor</a></dt>
                                <dd id="Variable.edges" class="variable"><a href="#Tensor.edges">edges</a></dd>
                <dd id="Variable.shape" class="variable"><a href="#Tensor.shape">shape</a></dd>
                <dd id="Variable.order" class="variable"><a href="#Tensor.order">order</a></dd>
                <dd id="Variable.grad" class="function"><a href="#Tensor.grad">grad</a></dd>
                <dd id="Variable.rename" class="function"><a href="#Tensor.rename">rename</a></dd>
                <dd id="Variable.simplify" class="function"><a href="#Tensor.simplify">simplify</a></dd>
                <dd id="Variable.full_simplify" class="function"><a href="#Tensor.full_simplify">full_simplify</a></dd>
                <dd id="Variable.substitute" class="function"><a href="#Tensor.substitute">substitute</a></dd>
                <dd id="Variable.weisfeiler_lehman" class="variable"><a href="#Tensor.weisfeiler_lehman">weisfeiler_lehman</a></dd>
                <dd id="Variable.edge_structural_graph" class="function"><a href="#Tensor.edge_structural_graph">edge_structural_graph</a></dd>
                <dd id="Variable.graph_to_string" class="function"><a href="#Tensor.graph_to_string">graph_to_string</a></dd>
                <dd id="Variable.is_isomorphic" class="function"><a href="#Tensor.is_isomorphic">is_isomorphic</a></dd>
                <dd id="Variable.isomorphisms" class="function"><a href="#Tensor.isomorphisms">isomorphisms</a></dd>
                <dd id="Variable.symmetries" class="variable"><a href="#Tensor.symmetries">symmetries</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Rename">
                            <input id="Rename-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Rename</span><wbr>(<span class="base"><a href="#Tensor">Tensor</a></span>):

                <label class="view-source-button" for="Rename-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Rename"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Rename-589"><a href="#Rename-589"><span class="linenos">589</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Rename</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Rename-590"><a href="#Rename-590"><span class="linenos">590</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Rename-591"><a href="#Rename-591"><span class="linenos">591</span></a><span class="sd">    A tensor that renames the edges of an inner tensor.</span>
</span><span id="Rename-592"><a href="#Rename-592"><span class="linenos">592</span></a>
</span><span id="Rename-593"><a href="#Rename-593"><span class="linenos">593</span></a><span class="sd">    This is used to change free edge names (and sometimes inner edge names)</span>
</span><span id="Rename-594"><a href="#Rename-594"><span class="linenos">594</span></a><span class="sd">    without modifying the underlying contraction.</span>
</span><span id="Rename-595"><a href="#Rename-595"><span class="linenos">595</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Rename-596"><a href="#Rename-596"><span class="linenos">596</span></a>
</span><span id="Rename-597"><a href="#Rename-597"><span class="linenos">597</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inner</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">rename</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
</span><span id="Rename-598"><a href="#Rename-598"><span class="linenos">598</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Rename-599"><a href="#Rename-599"><span class="linenos">599</span></a><span class="sd">        Initialize a Rename tensor.</span>
</span><span id="Rename-600"><a href="#Rename-600"><span class="linenos">600</span></a>
</span><span id="Rename-601"><a href="#Rename-601"><span class="linenos">601</span></a><span class="sd">        Args:</span>
</span><span id="Rename-602"><a href="#Rename-602"><span class="linenos">602</span></a><span class="sd">            inner: The tensor to be renamed.</span>
</span><span id="Rename-603"><a href="#Rename-603"><span class="linenos">603</span></a><span class="sd">            rename: A dictionary mapping old edge names to new names.</span>
</span><span id="Rename-604"><a href="#Rename-604"><span class="linenos">604</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Rename-605"><a href="#Rename-605"><span class="linenos">605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Rename&quot;</span>
</span><span id="Rename-606"><a href="#Rename-606"><span class="linenos">606</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span> <span class="o">=</span> <span class="n">inner</span>
</span><span id="Rename-607"><a href="#Rename-607"><span class="linenos">607</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rename</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">v</span><span class="p">}</span>
</span><span id="Rename-608"><a href="#Rename-608"><span class="linenos">608</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">{</span><span class="n">rename</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span> <span class="n">s</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">inner</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Rename-609"><a href="#Rename-609"><span class="linenos">609</span></a>
</span><span id="Rename-610"><a href="#Rename-610"><span class="linenos">610</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Rename-611"><a href="#Rename-611"><span class="linenos">611</span></a>        <span class="n">argstring</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span><span id="Rename-612"><a href="#Rename-612"><span class="linenos">612</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="si">}</span><span class="s2">.rename(</span><span class="si">{</span><span class="n">argstring</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Rename-613"><a href="#Rename-613"><span class="linenos">613</span></a>
</span><span id="Rename-614"><a href="#Rename-614"><span class="linenos">614</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Rename-615"><a href="#Rename-615"><span class="linenos">615</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="Rename-616"><a href="#Rename-616"><span class="linenos">616</span></a>
</span><span id="Rename-617"><a href="#Rename-617"><span class="linenos">617</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Rename-618"><a href="#Rename-618"><span class="linenos">618</span></a>        <span class="c1"># If the new names are used in inner, we need to rename them, and then add the</span>
</span><span id="Rename-619"><a href="#Rename-619"><span class="linenos">619</span></a>        <span class="c1"># new names to our own rename dict.</span>
</span><span id="Rename-620"><a href="#Rename-620"><span class="linenos">620</span></a>        <span class="n">middle</span> <span class="o">=</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">new_names</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="Rename-621"><a href="#Rename-621"><span class="linenos">621</span></a>        <span class="n">middle_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">middle</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_names</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Rename-622"><a href="#Rename-622"><span class="linenos">622</span></a>        <span class="n">middle_to_new</span> <span class="o">=</span> <span class="p">{</span><span class="n">middle</span><span class="p">[</span><span class="n">n</span><span class="p">]:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_names</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Rename-623"><a href="#Rename-623"><span class="linenos">623</span></a>        <span class="k">return</span> <span class="n">Rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">middle_names</span><span class="p">),</span> <span class="n">middle_to_new</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>
</span><span id="Rename-624"><a href="#Rename-624"><span class="linenos">624</span></a>
</span><span id="Rename-625"><a href="#Rename-625"><span class="linenos">625</span></a>    <span class="nd">@classmethod</span>
</span><span id="Rename-626"><a href="#Rename-626"><span class="linenos">626</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">merge_renames</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">renames</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="Rename-627"><a href="#Rename-627"><span class="linenos">627</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Rename-628"><a href="#Rename-628"><span class="linenos">628</span></a><span class="sd">        Merge several renaming dictionaries into one.</span>
</span><span id="Rename-629"><a href="#Rename-629"><span class="linenos">629</span></a>
</span><span id="Rename-630"><a href="#Rename-630"><span class="linenos">630</span></a><span class="sd">        Args:</span>
</span><span id="Rename-631"><a href="#Rename-631"><span class="linenos">631</span></a><span class="sd">            *renames: Arbitrary number of renaming dictionaries.</span>
</span><span id="Rename-632"><a href="#Rename-632"><span class="linenos">632</span></a>
</span><span id="Rename-633"><a href="#Rename-633"><span class="linenos">633</span></a><span class="sd">        Returns:</span>
</span><span id="Rename-634"><a href="#Rename-634"><span class="linenos">634</span></a><span class="sd">            A single dictionary representing the merged renaming.</span>
</span><span id="Rename-635"><a href="#Rename-635"><span class="linenos">635</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Rename-636"><a href="#Rename-636"><span class="linenos">636</span></a>        <span class="n">merged</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Rename-637"><a href="#Rename-637"><span class="linenos">637</span></a>        <span class="k">for</span> <span class="n">rename</span> <span class="ow">in</span> <span class="n">renames</span><span class="p">:</span>
</span><span id="Rename-638"><a href="#Rename-638"><span class="linenos">638</span></a>            <span class="n">used</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">|</span> <span class="n">merged</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="Rename-639"><a href="#Rename-639"><span class="linenos">639</span></a>            <span class="c1"># Apply the rename to the existing chains</span>
</span><span id="Rename-640"><a href="#Rename-640"><span class="linenos">640</span></a>            <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Rename-641"><a href="#Rename-641"><span class="linenos">641</span></a>                <span class="n">merged</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">rename</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="Rename-642"><a href="#Rename-642"><span class="linenos">642</span></a>            <span class="c1"># Add new renames</span>
</span><span id="Rename-643"><a href="#Rename-643"><span class="linenos">643</span></a>            <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">rename</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Rename-644"><a href="#Rename-644"><span class="linenos">644</span></a>                <span class="k">if</span> <span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
</span><span id="Rename-645"><a href="#Rename-645"><span class="linenos">645</span></a>                    <span class="n">merged</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
</span><span id="Rename-646"><a href="#Rename-646"><span class="linenos">646</span></a>        <span class="k">return</span> <span class="n">merged</span>
</span><span id="Rename-647"><a href="#Rename-647"><span class="linenos">647</span></a>
</span><span id="Rename-648"><a href="#Rename-648"><span class="linenos">648</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Rename-649"><a href="#Rename-649"><span class="linenos">649</span></a>        <span class="n">inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="Rename-650"><a href="#Rename-650"><span class="linenos">650</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inner</span><span class="p">,</span> <span class="n">Rename</span><span class="p">):</span>
</span><span id="Rename-651"><a href="#Rename-651"><span class="linenos">651</span></a>            <span class="n">merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_renames</span><span class="p">(</span><span class="n">inner</span><span class="o">.</span><span class="n">mapping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>
</span><span id="Rename-652"><a href="#Rename-652"><span class="linenos">652</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">merged</span><span class="p">)</span>
</span><span id="Rename-653"><a href="#Rename-653"><span class="linenos">653</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Rename-654"><a href="#Rename-654"><span class="linenos">654</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>
</span><span id="Rename-655"><a href="#Rename-655"><span class="linenos">655</span></a>        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">Rename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">mapping</span><span class="p">:</span>
</span><span id="Rename-656"><a href="#Rename-656"><span class="linenos">656</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">tensor</span>
</span><span id="Rename-657"><a href="#Rename-657"><span class="linenos">657</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="Rename-658"><a href="#Rename-658"><span class="linenos">658</span></a>
</span><span id="Rename-659"><a href="#Rename-659"><span class="linenos">659</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Rename-660"><a href="#Rename-660"><span class="linenos">660</span></a>        <span class="k">return</span> <span class="n">Rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_renames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
</span><span id="Rename-661"><a href="#Rename-661"><span class="linenos">661</span></a>
</span><span id="Rename-662"><a href="#Rename-662"><span class="linenos">662</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Rename-663"><a href="#Rename-663"><span class="linenos">663</span></a>        <span class="k">return</span> <span class="n">Rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="p">)</span>
</span><span id="Rename-664"><a href="#Rename-664"><span class="linenos">664</span></a>
</span><span id="Rename-665"><a href="#Rename-665"><span class="linenos">665</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Rename-666"><a href="#Rename-666"><span class="linenos">666</span></a>        <span class="c1"># Rename is the only tensor that doesn&#39;t actually create its own node in the graph</span>
</span><span id="Rename-667"><a href="#Rename-667"><span class="linenos">667</span></a>        <span class="c1"># This allows Variable(i, j=i).with_symmetries(&quot;i j&quot;) to be isomorphic to</span>
</span><span id="Rename-668"><a href="#Rename-668"><span class="linenos">668</span></a>        <span class="c1"># Rename(Variable(j, i=j).with_symmetries(&quot;i j&quot;), {&quot;i&quot;: &quot;j&quot;, &quot;j&quot;: &quot;i&quot;})</span>
</span><span id="Rename-669"><a href="#Rename-669"><span class="linenos">669</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">structural_graph</span><span class="p">()</span>
</span><span id="Rename-670"><a href="#Rename-670"><span class="linenos">670</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Rename-671"><a href="#Rename-671"><span class="linenos">671</span></a>        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">t_edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Rename-672"><a href="#Rename-672"><span class="linenos">672</span></a>            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
</span><span id="Rename-673"><a href="#Rename-673"><span class="linenos">673</span></a>            <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
</span><span id="Rename-674"><a href="#Rename-674"><span class="linenos">674</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Rename-675"><a href="#Rename-675"><span class="linenos">675</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span></pre></div>


            <div class="docstring"><p>A tensor that renames the edges of an inner tensor.</p>

<p>This is used to change free edge names (and sometimes inner edge names)
without modifying the underlying contraction.</p>
</div>


                            <div id="Rename.__init__" class="classattr">
                                        <input id="Rename.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Rename</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">inner</span><span class="p">:</span> <span class="n"><a href="#Tensor">Tensor</a></span>, </span><span class="param"><span class="n">rename</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="Rename.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Rename.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Rename.__init__-597"><a href="#Rename.__init__-597"><span class="linenos">597</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inner</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">rename</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
</span><span id="Rename.__init__-598"><a href="#Rename.__init__-598"><span class="linenos">598</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Rename.__init__-599"><a href="#Rename.__init__-599"><span class="linenos">599</span></a><span class="sd">        Initialize a Rename tensor.</span>
</span><span id="Rename.__init__-600"><a href="#Rename.__init__-600"><span class="linenos">600</span></a>
</span><span id="Rename.__init__-601"><a href="#Rename.__init__-601"><span class="linenos">601</span></a><span class="sd">        Args:</span>
</span><span id="Rename.__init__-602"><a href="#Rename.__init__-602"><span class="linenos">602</span></a><span class="sd">            inner: The tensor to be renamed.</span>
</span><span id="Rename.__init__-603"><a href="#Rename.__init__-603"><span class="linenos">603</span></a><span class="sd">            rename: A dictionary mapping old edge names to new names.</span>
</span><span id="Rename.__init__-604"><a href="#Rename.__init__-604"><span class="linenos">604</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Rename.__init__-605"><a href="#Rename.__init__-605"><span class="linenos">605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Rename&quot;</span>
</span><span id="Rename.__init__-606"><a href="#Rename.__init__-606"><span class="linenos">606</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span> <span class="o">=</span> <span class="n">inner</span>
</span><span id="Rename.__init__-607"><a href="#Rename.__init__-607"><span class="linenos">607</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rename</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">v</span><span class="p">}</span>
</span><span id="Rename.__init__-608"><a href="#Rename.__init__-608"><span class="linenos">608</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">{</span><span class="n">rename</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span> <span class="n">s</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">inner</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span></pre></div>


            <div class="docstring"><p>Initialize a Rename tensor.</p>

<p>Args:
    inner: The tensor to be renamed.
    rename: A dictionary mapping old edge names to new names.</p>
</div>


                            </div>
                            <div id="Rename.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span>

        
    </div>
    <a class="headerlink" href="#Rename.name"></a>
    
    

                            </div>
                            <div id="Rename.tensor" class="classattr">
                                <div class="attr variable">
            <span class="name">tensor</span>

        
    </div>
    <a class="headerlink" href="#Rename.tensor"></a>
    
    

                            </div>
                            <div id="Rename.mapping" class="classattr">
                                <div class="attr variable">
            <span class="name">mapping</span>

        
    </div>
    <a class="headerlink" href="#Rename.mapping"></a>
    
    

                            </div>
                            <div id="Rename.depends_on" class="classattr">
                                        <input id="Rename.depends_on-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">depends_on</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span><span class="p">:</span> <span class="n"><a href="#Variable">Variable</a></span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Rename.depends_on-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Rename.depends_on"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Rename.depends_on-614"><a href="#Rename.depends_on-614"><span class="linenos">614</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Rename.depends_on-615"><a href="#Rename.depends_on-615"><span class="linenos">615</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Check if this tensor depends on the variable x.</p>
</div>


                            </div>
                            <div id="Rename.merge_renames" class="classattr">
                                        <input id="Rename.merge_renames-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">merge_renames</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="o">*</span><span class="n">renames</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Rename.merge_renames-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Rename.merge_renames"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Rename.merge_renames-625"><a href="#Rename.merge_renames-625"><span class="linenos">625</span></a>    <span class="nd">@classmethod</span>
</span><span id="Rename.merge_renames-626"><a href="#Rename.merge_renames-626"><span class="linenos">626</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">merge_renames</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">renames</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="Rename.merge_renames-627"><a href="#Rename.merge_renames-627"><span class="linenos">627</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Rename.merge_renames-628"><a href="#Rename.merge_renames-628"><span class="linenos">628</span></a><span class="sd">        Merge several renaming dictionaries into one.</span>
</span><span id="Rename.merge_renames-629"><a href="#Rename.merge_renames-629"><span class="linenos">629</span></a>
</span><span id="Rename.merge_renames-630"><a href="#Rename.merge_renames-630"><span class="linenos">630</span></a><span class="sd">        Args:</span>
</span><span id="Rename.merge_renames-631"><a href="#Rename.merge_renames-631"><span class="linenos">631</span></a><span class="sd">            *renames: Arbitrary number of renaming dictionaries.</span>
</span><span id="Rename.merge_renames-632"><a href="#Rename.merge_renames-632"><span class="linenos">632</span></a>
</span><span id="Rename.merge_renames-633"><a href="#Rename.merge_renames-633"><span class="linenos">633</span></a><span class="sd">        Returns:</span>
</span><span id="Rename.merge_renames-634"><a href="#Rename.merge_renames-634"><span class="linenos">634</span></a><span class="sd">            A single dictionary representing the merged renaming.</span>
</span><span id="Rename.merge_renames-635"><a href="#Rename.merge_renames-635"><span class="linenos">635</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Rename.merge_renames-636"><a href="#Rename.merge_renames-636"><span class="linenos">636</span></a>        <span class="n">merged</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Rename.merge_renames-637"><a href="#Rename.merge_renames-637"><span class="linenos">637</span></a>        <span class="k">for</span> <span class="n">rename</span> <span class="ow">in</span> <span class="n">renames</span><span class="p">:</span>
</span><span id="Rename.merge_renames-638"><a href="#Rename.merge_renames-638"><span class="linenos">638</span></a>            <span class="n">used</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">|</span> <span class="n">merged</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="Rename.merge_renames-639"><a href="#Rename.merge_renames-639"><span class="linenos">639</span></a>            <span class="c1"># Apply the rename to the existing chains</span>
</span><span id="Rename.merge_renames-640"><a href="#Rename.merge_renames-640"><span class="linenos">640</span></a>            <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Rename.merge_renames-641"><a href="#Rename.merge_renames-641"><span class="linenos">641</span></a>                <span class="n">merged</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">rename</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</span><span id="Rename.merge_renames-642"><a href="#Rename.merge_renames-642"><span class="linenos">642</span></a>            <span class="c1"># Add new renames</span>
</span><span id="Rename.merge_renames-643"><a href="#Rename.merge_renames-643"><span class="linenos">643</span></a>            <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">rename</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Rename.merge_renames-644"><a href="#Rename.merge_renames-644"><span class="linenos">644</span></a>                <span class="k">if</span> <span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
</span><span id="Rename.merge_renames-645"><a href="#Rename.merge_renames-645"><span class="linenos">645</span></a>                    <span class="n">merged</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
</span><span id="Rename.merge_renames-646"><a href="#Rename.merge_renames-646"><span class="linenos">646</span></a>        <span class="k">return</span> <span class="n">merged</span>
</span></pre></div>


            <div class="docstring"><p>Merge several renaming dictionaries into one.</p>

<p>Args:
    *renames: Arbitrary number of renaming dictionaries.</p>

<p>Returns:
    A single dictionary representing the merged renaming.</p>
</div>


                            </div>
                            <div id="Rename.structural_graph" class="classattr">
                                        <input id="Rename.structural_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">structural_graph</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">networkx</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">multidigraph</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="Rename.structural_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Rename.structural_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Rename.structural_graph-665"><a href="#Rename.structural_graph-665"><span class="linenos">665</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Rename.structural_graph-666"><a href="#Rename.structural_graph-666"><span class="linenos">666</span></a>        <span class="c1"># Rename is the only tensor that doesn&#39;t actually create its own node in the graph</span>
</span><span id="Rename.structural_graph-667"><a href="#Rename.structural_graph-667"><span class="linenos">667</span></a>        <span class="c1"># This allows Variable(i, j=i).with_symmetries(&quot;i j&quot;) to be isomorphic to</span>
</span><span id="Rename.structural_graph-668"><a href="#Rename.structural_graph-668"><span class="linenos">668</span></a>        <span class="c1"># Rename(Variable(j, i=j).with_symmetries(&quot;i j&quot;), {&quot;i&quot;: &quot;j&quot;, &quot;j&quot;: &quot;i&quot;})</span>
</span><span id="Rename.structural_graph-669"><a href="#Rename.structural_graph-669"><span class="linenos">669</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">structural_graph</span><span class="p">()</span>
</span><span id="Rename.structural_graph-670"><a href="#Rename.structural_graph-670"><span class="linenos">670</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Rename.structural_graph-671"><a href="#Rename.structural_graph-671"><span class="linenos">671</span></a>        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">t_edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Rename.structural_graph-672"><a href="#Rename.structural_graph-672"><span class="linenos">672</span></a>            <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span>
</span><span id="Rename.structural_graph-673"><a href="#Rename.structural_graph-673"><span class="linenos">673</span></a>            <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
</span><span id="Rename.structural_graph-674"><a href="#Rename.structural_graph-674"><span class="linenos">674</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Rename.structural_graph-675"><a href="#Rename.structural_graph-675"><span class="linenos">675</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span></pre></div>


            <div class="docstring"><p>Create a graph representation of the tensor, which can be used for isomorphism testing.</p>

<p>Returns:
    A tuple with the following values:
    - A NetworkX directed graph.
        - Each node in the top tree is labeled with the producing tensor.
        - Use name=hashable to label vertices
    - "edges", a dict of edge_name -> node id
    - Node 0 should be the root</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Tensor">Tensor</a></dt>
                                <dd id="Rename.edges" class="variable"><a href="#Tensor.edges">edges</a></dd>
                <dd id="Rename.shape" class="variable"><a href="#Tensor.shape">shape</a></dd>
                <dd id="Rename.order" class="variable"><a href="#Tensor.order">order</a></dd>
                <dd id="Rename.grad" class="function"><a href="#Tensor.grad">grad</a></dd>
                <dd id="Rename.rename" class="function"><a href="#Tensor.rename">rename</a></dd>
                <dd id="Rename.simplify" class="function"><a href="#Tensor.simplify">simplify</a></dd>
                <dd id="Rename.full_simplify" class="function"><a href="#Tensor.full_simplify">full_simplify</a></dd>
                <dd id="Rename.substitute" class="function"><a href="#Tensor.substitute">substitute</a></dd>
                <dd id="Rename.weisfeiler_lehman" class="variable"><a href="#Tensor.weisfeiler_lehman">weisfeiler_lehman</a></dd>
                <dd id="Rename.edge_structural_graph" class="function"><a href="#Tensor.edge_structural_graph">edge_structural_graph</a></dd>
                <dd id="Rename.graph_to_string" class="function"><a href="#Tensor.graph_to_string">graph_to_string</a></dd>
                <dd id="Rename.is_isomorphic" class="function"><a href="#Tensor.is_isomorphic">is_isomorphic</a></dd>
                <dd id="Rename.isomorphisms" class="function"><a href="#Tensor.isomorphisms">isomorphisms</a></dd>
                <dd id="Rename.symmetries" class="variable"><a href="#Tensor.symmetries">symmetries</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Constant">
                            <input id="Constant-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Constant</span><wbr>(<span class="base"><a href="#Tensor">Tensor</a></span>, <span class="base">abc.ABC</span>):

                <label class="view-source-button" for="Constant-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Constant"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Constant-678"><a href="#Constant-678"><span class="linenos">678</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Constant</span><span class="p">(</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
</span><span id="Constant-679"><a href="#Constant-679"><span class="linenos">679</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Constant-680"><a href="#Constant-680"><span class="linenos">680</span></a><span class="sd">    An abstract tensor that represents a constant (non-variable) tensor.</span>
</span><span id="Constant-681"><a href="#Constant-681"><span class="linenos">681</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Constant-682"><a href="#Constant-682"><span class="linenos">682</span></a>
</span><span id="Constant-683"><a href="#Constant-683"><span class="linenos">683</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">shape0</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span> <span class="n">_symmetries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">shape1</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">):</span>
</span><span id="Constant-684"><a href="#Constant-684"><span class="linenos">684</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Constant-685"><a href="#Constant-685"><span class="linenos">685</span></a><span class="sd">        A constant tensor with the given edges.</span>
</span><span id="Constant-686"><a href="#Constant-686"><span class="linenos">686</span></a>
</span><span id="Constant-687"><a href="#Constant-687"><span class="linenos">687</span></a><span class="sd">        Args:</span>
</span><span id="Constant-688"><a href="#Constant-688"><span class="linenos">688</span></a><span class="sd">            shape0: Positional dimensions (as Sympy symbols).</span>
</span><span id="Constant-689"><a href="#Constant-689"><span class="linenos">689</span></a><span class="sd">            _symmetries: Optional symmetry groups.</span>
</span><span id="Constant-690"><a href="#Constant-690"><span class="linenos">690</span></a><span class="sd">            shape1: Keyword dimensions.</span>
</span><span id="Constant-691"><a href="#Constant-691"><span class="linenos">691</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Constant-692"><a href="#Constant-692"><span class="linenos">692</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;NotImplemented&quot;</span>
</span><span id="Constant-693"><a href="#Constant-693"><span class="linenos">693</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_shape</span><span class="p">(</span><span class="n">shape0</span><span class="p">,</span> <span class="n">shape1</span><span class="p">)</span>
</span><span id="Constant-694"><a href="#Constant-694"><span class="linenos">694</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span> <span class="n">_symmetries</span><span class="p">)</span>
</span><span id="Constant-695"><a href="#Constant-695"><span class="linenos">695</span></a>
</span><span id="Constant-696"><a href="#Constant-696"><span class="linenos">696</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Constant-697"><a href="#Constant-697"><span class="linenos">697</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Constant-698"><a href="#Constant-698"><span class="linenos">698</span></a>
</span><span id="Constant-699"><a href="#Constant-699"><span class="linenos">699</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetries</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Constant&quot;</span><span class="p">:</span>
</span><span id="Constant-700"><a href="#Constant-700"><span class="linenos">700</span></a>        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span> <span class="n">_symmetries</span><span class="o">=</span><span class="n">symmetries</span><span class="p">)</span>
</span><span id="Constant-701"><a href="#Constant-701"><span class="linenos">701</span></a>
</span><span id="Constant-702"><a href="#Constant-702"><span class="linenos">702</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Constant-703"><a href="#Constant-703"><span class="linenos">703</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Constant-704"><a href="#Constant-704"><span class="linenos">704</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Constant-705"><a href="#Constant-705"><span class="linenos">705</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Constant-706"><a href="#Constant-706"><span class="linenos">706</span></a>        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="Constant-707"><a href="#Constant-707"><span class="linenos">707</span></a>            <span class="c1"># All of this is more or less equal to Variable</span>
</span><span id="Constant-708"><a href="#Constant-708"><span class="linenos">708</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">size_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;size=</span><span class="si">{</span><span class="n">size</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Constant-709"><a href="#Constant-709"><span class="linenos">709</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size_node</span><span class="p">)</span>
</span><span id="Constant-710"><a href="#Constant-710"><span class="linenos">710</span></a>            <span class="c1"># Find each orbit with the given size (see note above about fine-grained-ness)</span>
</span><span id="Constant-711"><a href="#Constant-711"><span class="linenos">711</span></a>            <span class="k">for</span> <span class="n">orbit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="p">:</span>
</span><span id="Constant-712"><a href="#Constant-712"><span class="linenos">712</span></a>                <span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">orbit</span>
</span><span id="Constant-713"><a href="#Constant-713"><span class="linenos">713</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">!=</span> <span class="n">size</span><span class="p">:</span>
</span><span id="Constant-714"><a href="#Constant-714"><span class="linenos">714</span></a>                    <span class="k">continue</span>
</span><span id="Constant-715"><a href="#Constant-715"><span class="linenos">715</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">orbit_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Orbit Node&quot;</span><span class="p">)</span>
</span><span id="Constant-716"><a href="#Constant-716"><span class="linenos">716</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">size_node</span><span class="p">,</span> <span class="n">orbit_node</span><span class="p">)</span>
</span><span id="Constant-717"><a href="#Constant-717"><span class="linenos">717</span></a>                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">orbit</span><span class="p">:</span>
</span><span id="Constant-718"><a href="#Constant-718"><span class="linenos">718</span></a>                    <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">orbit_node</span>
</span><span id="Constant-719"><a href="#Constant-719"><span class="linenos">719</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="Constant-720"><a href="#Constant-720"><span class="linenos">720</span></a>
</span><span id="Constant-721"><a href="#Constant-721"><span class="linenos">721</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Constant-722"><a href="#Constant-722"><span class="linenos">722</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Constant-723"><a href="#Constant-723"><span class="linenos">723</span></a>
</span><span id="Constant-724"><a href="#Constant-724"><span class="linenos">724</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Constant-725"><a href="#Constant-725"><span class="linenos">725</span></a>        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="o">**</span><span class="p">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span> <span class="n">s</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</span><span id="Constant-726"><a href="#Constant-726"><span class="linenos">726</span></a>
</span><span id="Constant-727"><a href="#Constant-727"><span class="linenos">727</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Constant-728"><a href="#Constant-728"><span class="linenos">728</span></a>        <span class="k">return</span> <span class="n">Zero</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">|</span> <span class="p">{</span><span class="n">new_names</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()}))</span>
</span><span id="Constant-729"><a href="#Constant-729"><span class="linenos">729</span></a>
</span><span id="Constant-730"><a href="#Constant-730"><span class="linenos">730</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Constant-731"><a href="#Constant-731"><span class="linenos">731</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>An abstract tensor that represents a constant (non-variable) tensor.</p>
</div>


                            <div id="Constant.__init__" class="classattr">
                                        <input id="Constant.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Constant</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="o">*</span><span class="n">shape0</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span>,</span><span class="param">	<span class="n">_symmetries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">shape1</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span></span>)</span>

                <label class="view-source-button" for="Constant.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Constant.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Constant.__init__-683"><a href="#Constant.__init__-683"><span class="linenos">683</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">shape0</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span> <span class="n">_symmetries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">shape1</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">):</span>
</span><span id="Constant.__init__-684"><a href="#Constant.__init__-684"><span class="linenos">684</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Constant.__init__-685"><a href="#Constant.__init__-685"><span class="linenos">685</span></a><span class="sd">        A constant tensor with the given edges.</span>
</span><span id="Constant.__init__-686"><a href="#Constant.__init__-686"><span class="linenos">686</span></a>
</span><span id="Constant.__init__-687"><a href="#Constant.__init__-687"><span class="linenos">687</span></a><span class="sd">        Args:</span>
</span><span id="Constant.__init__-688"><a href="#Constant.__init__-688"><span class="linenos">688</span></a><span class="sd">            shape0: Positional dimensions (as Sympy symbols).</span>
</span><span id="Constant.__init__-689"><a href="#Constant.__init__-689"><span class="linenos">689</span></a><span class="sd">            _symmetries: Optional symmetry groups.</span>
</span><span id="Constant.__init__-690"><a href="#Constant.__init__-690"><span class="linenos">690</span></a><span class="sd">            shape1: Keyword dimensions.</span>
</span><span id="Constant.__init__-691"><a href="#Constant.__init__-691"><span class="linenos">691</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Constant.__init__-692"><a href="#Constant.__init__-692"><span class="linenos">692</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;NotImplemented&quot;</span>
</span><span id="Constant.__init__-693"><a href="#Constant.__init__-693"><span class="linenos">693</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_shape</span><span class="p">(</span><span class="n">shape0</span><span class="p">,</span> <span class="n">shape1</span><span class="p">)</span>
</span><span id="Constant.__init__-694"><a href="#Constant.__init__-694"><span class="linenos">694</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span> <span class="n">_symmetries</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A constant tensor with the given edges.</p>

<p>Args:
    shape0: Positional dimensions (as Sympy symbols).
    _symmetries: Optional symmetry groups.
    shape1: Keyword dimensions.</p>
</div>


                            </div>
                            <div id="Constant.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span>

        
    </div>
    <a class="headerlink" href="#Constant.name"></a>
    
    

                            </div>
                            <div id="Constant.with_symmetries" class="classattr">
                                        <input id="Constant.with_symmetries-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">with_symmetries</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">symmetries</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span></span><span class="return-annotation">) -> <span class="n"><a href="#Constant">Constant</a></span>:</span></span>

                <label class="view-source-button" for="Constant.with_symmetries-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Constant.with_symmetries"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Constant.with_symmetries-699"><a href="#Constant.with_symmetries-699"><span class="linenos">699</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">with_symmetries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetries</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">set</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Constant&quot;</span><span class="p">:</span>
</span><span id="Constant.with_symmetries-700"><a href="#Constant.with_symmetries-700"><span class="linenos">700</span></a>        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">,</span> <span class="n">_symmetries</span><span class="o">=</span><span class="n">symmetries</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Constant.structural_graph" class="classattr">
                                        <input id="Constant.structural_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">structural_graph</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">networkx</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">multidigraph</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="Constant.structural_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Constant.structural_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Constant.structural_graph-702"><a href="#Constant.structural_graph-702"><span class="linenos">702</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Constant.structural_graph-703"><a href="#Constant.structural_graph-703"><span class="linenos">703</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Constant.structural_graph-704"><a href="#Constant.structural_graph-704"><span class="linenos">704</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Constant.structural_graph-705"><a href="#Constant.structural_graph-705"><span class="linenos">705</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Constant.structural_graph-706"><a href="#Constant.structural_graph-706"><span class="linenos">706</span></a>        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="Constant.structural_graph-707"><a href="#Constant.structural_graph-707"><span class="linenos">707</span></a>            <span class="c1"># All of this is more or less equal to Variable</span>
</span><span id="Constant.structural_graph-708"><a href="#Constant.structural_graph-708"><span class="linenos">708</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">size_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;size=</span><span class="si">{</span><span class="n">size</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Constant.structural_graph-709"><a href="#Constant.structural_graph-709"><span class="linenos">709</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size_node</span><span class="p">)</span>
</span><span id="Constant.structural_graph-710"><a href="#Constant.structural_graph-710"><span class="linenos">710</span></a>            <span class="c1"># Find each orbit with the given size (see note above about fine-grained-ness)</span>
</span><span id="Constant.structural_graph-711"><a href="#Constant.structural_graph-711"><span class="linenos">711</span></a>            <span class="k">for</span> <span class="n">orbit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symmetries</span><span class="p">:</span>
</span><span id="Constant.structural_graph-712"><a href="#Constant.structural_graph-712"><span class="linenos">712</span></a>                <span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">orbit</span>
</span><span id="Constant.structural_graph-713"><a href="#Constant.structural_graph-713"><span class="linenos">713</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">!=</span> <span class="n">size</span><span class="p">:</span>
</span><span id="Constant.structural_graph-714"><a href="#Constant.structural_graph-714"><span class="linenos">714</span></a>                    <span class="k">continue</span>
</span><span id="Constant.structural_graph-715"><a href="#Constant.structural_graph-715"><span class="linenos">715</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">orbit_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Orbit Node&quot;</span><span class="p">)</span>
</span><span id="Constant.structural_graph-716"><a href="#Constant.structural_graph-716"><span class="linenos">716</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">size_node</span><span class="p">,</span> <span class="n">orbit_node</span><span class="p">)</span>
</span><span id="Constant.structural_graph-717"><a href="#Constant.structural_graph-717"><span class="linenos">717</span></a>                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">orbit</span><span class="p">:</span>
</span><span id="Constant.structural_graph-718"><a href="#Constant.structural_graph-718"><span class="linenos">718</span></a>                    <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">orbit_node</span>
</span><span id="Constant.structural_graph-719"><a href="#Constant.structural_graph-719"><span class="linenos">719</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span></pre></div>


            <div class="docstring"><p>Create a graph representation of the tensor, which can be used for isomorphism testing.</p>

<p>Returns:
    A tuple with the following values:
    - A NetworkX directed graph.
        - Each node in the top tree is labeled with the producing tensor.
        - Use name=hashable to label vertices
    - "edges", a dict of edge_name -> node id
    - Node 0 should be the root</p>
</div>


                            </div>
                            <div id="Constant.depends_on" class="classattr">
                                        <input id="Constant.depends_on-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">depends_on</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span><span class="p">:</span> <span class="n"><a href="#Variable">Variable</a></span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Constant.depends_on-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Constant.depends_on"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Constant.depends_on-730"><a href="#Constant.depends_on-730"><span class="linenos">730</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Constant.depends_on-731"><a href="#Constant.depends_on-731"><span class="linenos">731</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Check if this tensor depends on the variable x.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Tensor">Tensor</a></dt>
                                <dd id="Constant.edges" class="variable"><a href="#Tensor.edges">edges</a></dd>
                <dd id="Constant.shape" class="variable"><a href="#Tensor.shape">shape</a></dd>
                <dd id="Constant.order" class="variable"><a href="#Tensor.order">order</a></dd>
                <dd id="Constant.grad" class="function"><a href="#Tensor.grad">grad</a></dd>
                <dd id="Constant.rename" class="function"><a href="#Tensor.rename">rename</a></dd>
                <dd id="Constant.simplify" class="function"><a href="#Tensor.simplify">simplify</a></dd>
                <dd id="Constant.full_simplify" class="function"><a href="#Tensor.full_simplify">full_simplify</a></dd>
                <dd id="Constant.substitute" class="function"><a href="#Tensor.substitute">substitute</a></dd>
                <dd id="Constant.weisfeiler_lehman" class="variable"><a href="#Tensor.weisfeiler_lehman">weisfeiler_lehman</a></dd>
                <dd id="Constant.edge_structural_graph" class="function"><a href="#Tensor.edge_structural_graph">edge_structural_graph</a></dd>
                <dd id="Constant.graph_to_string" class="function"><a href="#Tensor.graph_to_string">graph_to_string</a></dd>
                <dd id="Constant.is_isomorphic" class="function"><a href="#Tensor.is_isomorphic">is_isomorphic</a></dd>
                <dd id="Constant.isomorphisms" class="function"><a href="#Tensor.isomorphisms">isomorphisms</a></dd>
                <dd id="Constant.symmetries" class="variable"><a href="#Tensor.symmetries">symmetries</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Delta">
                            <input id="Delta-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Delta</span><wbr>(<span class="base"><a href="#Constant">Constant</a></span>):

                <label class="view-source-button" for="Delta-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Delta"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Delta-734"><a href="#Delta-734"><span class="linenos">734</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Delta</span><span class="p">(</span><span class="n">Constant</span><span class="p">):</span>
</span><span id="Delta-735"><a href="#Delta-735"><span class="linenos">735</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The &quot;Delta&quot; tensor is defined by C_{i,j,k} = 1 if i == j == k, else 0</span>
</span><span id="Delta-736"><a href="#Delta-736"><span class="linenos">736</span></a><span class="sd">    Or alternatively as Δₙ = ∑ₓ (eₓ)⊗ⁿ, where are e_i are basis vectors</span>
</span><span id="Delta-737"><a href="#Delta-737"><span class="linenos">737</span></a><span class="sd">    For order 2, this is the identity matrix.</span>
</span><span id="Delta-738"><a href="#Delta-738"><span class="linenos">738</span></a><span class="sd">        Note: For higher order, the identity tensor is the product of n identity matrices,</span>
</span><span id="Delta-739"><a href="#Delta-739"><span class="linenos">739</span></a><span class="sd">        (order 2 Delta&#39;s), not the order-n Delta tensor.</span>
</span><span id="Delta-740"><a href="#Delta-740"><span class="linenos">740</span></a><span class="sd">    For order 0, the Delta tensor is defined as |n|, where n is the size/dimension of the tensor.</span>
</span><span id="Delta-741"><a href="#Delta-741"><span class="linenos">741</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Delta-742"><a href="#Delta-742"><span class="linenos">742</span></a>
</span><span id="Delta-743"><a href="#Delta-743"><span class="linenos">743</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span> <span class="o">*</span><span class="n">edges</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Delta-744"><a href="#Delta-744"><span class="linenos">744</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Delta-745"><a href="#Delta-745"><span class="linenos">745</span></a><span class="sd">        Initialize a Delta tensor.</span>
</span><span id="Delta-746"><a href="#Delta-746"><span class="linenos">746</span></a>
</span><span id="Delta-747"><a href="#Delta-747"><span class="linenos">747</span></a><span class="sd">        Args:</span>
</span><span id="Delta-748"><a href="#Delta-748"><span class="linenos">748</span></a><span class="sd">            size: The size (dimension) of the tensor.</span>
</span><span id="Delta-749"><a href="#Delta-749"><span class="linenos">749</span></a><span class="sd">            edges: The names of the tensor edges.</span>
</span><span id="Delta-750"><a href="#Delta-750"><span class="linenos">750</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Delta-751"><a href="#Delta-751"><span class="linenos">751</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_edges</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
</span><span id="Delta-752"><a href="#Delta-752"><span class="linenos">752</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">size</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">})</span>
</span><span id="Delta-753"><a href="#Delta-753"><span class="linenos">753</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">Number</span><span class="p">)),</span> <span class="s2">&quot;Size must be a sympy symbol&quot;</span>
</span><span id="Delta-754"><a href="#Delta-754"><span class="linenos">754</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="Delta-755"><a href="#Delta-755"><span class="linenos">755</span></a>
</span><span id="Delta-756"><a href="#Delta-756"><span class="linenos">756</span></a>    <span class="nd">@property</span>
</span><span id="Delta-757"><a href="#Delta-757"><span class="linenos">757</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbol</span><span class="p">:</span>
</span><span id="Delta-758"><a href="#Delta-758"><span class="linenos">758</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span>
</span><span id="Delta-759"><a href="#Delta-759"><span class="linenos">759</span></a>
</span><span id="Delta-760"><a href="#Delta-760"><span class="linenos">760</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Delta-761"><a href="#Delta-761"><span class="linenos">761</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="Delta-762"><a href="#Delta-762"><span class="linenos">762</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Delta(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Delta-763"><a href="#Delta-763"><span class="linenos">763</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Delta(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">, </span><span class="se">\&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">)&quot;</span>
</span><span id="Delta-764"><a href="#Delta-764"><span class="linenos">764</span></a>
</span><span id="Delta-765"><a href="#Delta-765"><span class="linenos">765</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Delta-766"><a href="#Delta-766"><span class="linenos">766</span></a>        <span class="k">return</span> <span class="n">Delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">])</span>
</span><span id="Delta-767"><a href="#Delta-767"><span class="linenos">767</span></a>
</span><span id="Delta-768"><a href="#Delta-768"><span class="linenos">768</span></a>    <span class="nd">@classmethod</span>
</span><span id="Delta-769"><a href="#Delta-769"><span class="linenos">769</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simplify_outer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="Delta-770"><a href="#Delta-770"><span class="linenos">770</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Simplifies a list of tensors assumed to be a product.&quot;&quot;&quot;</span>
</span><span id="Delta-771"><a href="#Delta-771"><span class="linenos">771</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Delta-772"><a href="#Delta-772"><span class="linenos">772</span></a>            <span class="n">tensors</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_simplify_step</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="Delta-773"><a href="#Delta-773"><span class="linenos">773</span></a>            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
</span><span id="Delta-774"><a href="#Delta-774"><span class="linenos">774</span></a>                <span class="k">break</span>
</span><span id="Delta-775"><a href="#Delta-775"><span class="linenos">775</span></a>        <span class="k">return</span> <span class="n">tensors</span>
</span><span id="Delta-776"><a href="#Delta-776"><span class="linenos">776</span></a>
</span><span id="Delta-777"><a href="#Delta-777"><span class="linenos">777</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Delta-778"><a href="#Delta-778"><span class="linenos">778</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Delta-779"><a href="#Delta-779"><span class="linenos">779</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Delta-780"><a href="#Delta-780"><span class="linenos">780</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">size_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Delta-781"><a href="#Delta-781"><span class="linenos">781</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size_node</span><span class="p">)</span>
</span><span id="Delta-782"><a href="#Delta-782"><span class="linenos">782</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">size_node</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Delta-783"><a href="#Delta-783"><span class="linenos">783</span></a>
</span><span id="Delta-784"><a href="#Delta-784"><span class="linenos">784</span></a>    <span class="c1">################################################################################</span>
</span><span id="Delta-785"><a href="#Delta-785"><span class="linenos">785</span></a>    <span class="c1"># There are many simplify rules for Delta. We split them into separate methods for clarity.</span>
</span><span id="Delta-786"><a href="#Delta-786"><span class="linenos">786</span></a>
</span><span id="Delta-787"><a href="#Delta-787"><span class="linenos">787</span></a>    <span class="nd">@classmethod</span>
</span><span id="Delta-788"><a href="#Delta-788"><span class="linenos">788</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify_step</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
</span><span id="Delta-789"><a href="#Delta-789"><span class="linenos">789</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs one step of simplification. Returns a new list if changed, or the original if not.&quot;&quot;&quot;</span>
</span><span id="Delta-790"><a href="#Delta-790"><span class="linenos">790</span></a>        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">_group_edges</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Delta-791"><a href="#Delta-791"><span class="linenos">791</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Delta-792"><a href="#Delta-792"><span class="linenos">792</span></a>                <span class="k">continue</span>
</span><span id="Delta-793"><a href="#Delta-793"><span class="linenos">793</span></a>            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">ts</span>
</span><span id="Delta-794"><a href="#Delta-794"><span class="linenos">794</span></a>            <span class="k">assert</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">==</span> <span class="n">t2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="si">=}</span><span class="s2"> != </span><span class="si">{</span><span class="n">t2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">e</span><span class="si">=}</span><span class="s2">&quot;</span>
</span><span id="Delta-795"><a href="#Delta-795"><span class="linenos">795</span></a>
</span><span id="Delta-796"><a href="#Delta-796"><span class="linenos">796</span></a>            <span class="c1"># Remove t1 and t2 from tensors.  We use the &quot;is&quot; operator, since equality</span>
</span><span id="Delta-797"><a href="#Delta-797"><span class="linenos">797</span></a>            <span class="c1"># means isomorphic, so it might remove too many unintended tensors.</span>
</span><span id="Delta-798"><a href="#Delta-798"><span class="linenos">798</span></a>            <span class="n">other</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">t1</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">t2</span><span class="p">]</span>
</span><span id="Delta-799"><a href="#Delta-799"><span class="linenos">799</span></a>
</span><span id="Delta-800"><a href="#Delta-800"><span class="linenos">800</span></a>            <span class="k">for</span> <span class="n">simplification</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_merge_copy_tensors</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_remove_identity_matrix</span><span class="p">]:</span>
</span><span id="Delta-801"><a href="#Delta-801"><span class="linenos">801</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">:=</span> <span class="n">simplification</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Delta-802"><a href="#Delta-802"><span class="linenos">802</span></a>                    <span class="k">return</span> <span class="n">other</span> <span class="o">+</span> <span class="n">new</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="Delta-803"><a href="#Delta-803"><span class="linenos">803</span></a>
</span><span id="Delta-804"><a href="#Delta-804"><span class="linenos">804</span></a>        <span class="k">return</span> <span class="n">tensors</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="Delta-805"><a href="#Delta-805"><span class="linenos">805</span></a>
</span><span id="Delta-806"><a href="#Delta-806"><span class="linenos">806</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Delta-807"><a href="#Delta-807"><span class="linenos">807</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_copy_tensors</span><span class="p">(</span><span class="n">t1</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]:</span>
</span><span id="Delta-808"><a href="#Delta-808"><span class="linenos">808</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)):</span>
</span><span id="Delta-809"><a href="#Delta-809"><span class="linenos">809</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="Delta-810"><a href="#Delta-810"><span class="linenos">810</span></a>
</span><span id="Delta-811"><a href="#Delta-811"><span class="linenos">811</span></a>        <span class="c1"># We can&#39;t merge order 0 copy tensors, since we now give them a value equal to their size.</span>
</span><span id="Delta-812"><a href="#Delta-812"><span class="linenos">812</span></a>        <span class="c1"># In principle we could create a new Delta(size1 * size2, []) tensor, but then we start having</span>
</span><span id="Delta-813"><a href="#Delta-813"><span class="linenos">813</span></a>        <span class="c1"># arbitrary expressions as sizes, which I&#39;m not sure we want yet.</span>
</span><span id="Delta-814"><a href="#Delta-814"><span class="linenos">814</span></a>        <span class="c1"># Also, merging an order 0 with and order &gt; 0 was never going to work, unless the size of the</span>
</span><span id="Delta-815"><a href="#Delta-815"><span class="linenos">815</span></a>        <span class="c1"># order 0 Delta was 1, which it probably never is.</span>
</span><span id="Delta-816"><a href="#Delta-816"><span class="linenos">816</span></a>        <span class="c1"># In either case, this method should only be called if the tensors share an edge, which they</span>
</span><span id="Delta-817"><a href="#Delta-817"><span class="linenos">817</span></a>        <span class="c1"># can&#39;t if one of them has order 0.</span>
</span><span id="Delta-818"><a href="#Delta-818"><span class="linenos">818</span></a>        <span class="k">assert</span> <span class="n">t1</span><span class="o">.</span><span class="n">order</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t2</span><span class="o">.</span><span class="n">order</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Can&#39;t merge order 0 Delta tensors&quot;</span>
</span><span id="Delta-819"><a href="#Delta-819"><span class="linenos">819</span></a>
</span><span id="Delta-820"><a href="#Delta-820"><span class="linenos">820</span></a>        <span class="c1"># Since the tensors are connected, we can assume they have the same size</span>
</span><span id="Delta-821"><a href="#Delta-821"><span class="linenos">821</span></a>        <span class="k">assert</span> <span class="n">t1</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">t2</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;Contracted Delta tensors must have same size&quot;</span>
</span><span id="Delta-822"><a href="#Delta-822"><span class="linenos">822</span></a>        <span class="n">size</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">size</span>
</span><span id="Delta-823"><a href="#Delta-823"><span class="linenos">823</span></a>
</span><span id="Delta-824"><a href="#Delta-824"><span class="linenos">824</span></a>        <span class="c1"># We don&#39;t just remove e, but remove all shared edges</span>
</span><span id="Delta-825"><a href="#Delta-825"><span class="linenos">825</span></a>        <span class="c1"># The amazing thing is that even in the case where all edges disappear, we</span>
</span><span id="Delta-826"><a href="#Delta-826"><span class="linenos">826</span></a>        <span class="c1"># still get to keep information on the &quot;size&quot; of the Delta tensor.</span>
</span><span id="Delta-827"><a href="#Delta-827"><span class="linenos">827</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">Delta</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">edges</span> <span class="o">^</span> <span class="n">t2</span><span class="o">.</span><span class="n">edges</span><span class="p">))]</span>
</span><span id="Delta-828"><a href="#Delta-828"><span class="linenos">828</span></a>
</span><span id="Delta-829"><a href="#Delta-829"><span class="linenos">829</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Delta-830"><a href="#Delta-830"><span class="linenos">830</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_identity_matrix</span><span class="p">(</span><span class="n">t1</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">t2</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]:</span>
</span><span id="Delta-831"><a href="#Delta-831"><span class="linenos">831</span></a>        <span class="c1"># If both are Delta&#39;s, we use the previous method</span>
</span><span id="Delta-832"><a href="#Delta-832"><span class="linenos">832</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">Delta</span><span class="p">):</span>
</span><span id="Delta-833"><a href="#Delta-833"><span class="linenos">833</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="Delta-834"><a href="#Delta-834"><span class="linenos">834</span></a>
</span><span id="Delta-835"><a href="#Delta-835"><span class="linenos">835</span></a>        <span class="c1"># Make t1 the identity matrix</span>
</span><span id="Delta-836"><a href="#Delta-836"><span class="linenos">836</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t2</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Delta-837"><a href="#Delta-837"><span class="linenos">837</span></a>            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t1</span>
</span><span id="Delta-838"><a href="#Delta-838"><span class="linenos">838</span></a>
</span><span id="Delta-839"><a href="#Delta-839"><span class="linenos">839</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t1</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Delta-840"><a href="#Delta-840"><span class="linenos">840</span></a>            <span class="c1"># Find the edge of t1 that&#39;s not e</span>
</span><span id="Delta-841"><a href="#Delta-841"><span class="linenos">841</span></a>            <span class="n">other_edge</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="n">e</span><span class="p">}))</span>
</span><span id="Delta-842"><a href="#Delta-842"><span class="linenos">842</span></a>            <span class="c1"># Don&#39;t create self loops. We never connect a tensor to itself.</span>
</span><span id="Delta-843"><a href="#Delta-843"><span class="linenos">843</span></a>            <span class="c1"># Unless it&#39;s another Delta, in which case we already handled it above.</span>
</span><span id="Delta-844"><a href="#Delta-844"><span class="linenos">844</span></a>            <span class="k">if</span> <span class="n">other_edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t2</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="Delta-845"><a href="#Delta-845"><span class="linenos">845</span></a>                <span class="k">return</span> <span class="p">[</span><span class="n">t2</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">other_edge</span><span class="p">})]</span>
</span><span id="Delta-846"><a href="#Delta-846"><span class="linenos">846</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>The "Delta" tensor is defined by C_{i,j,k} = 1 if i == j == k, else 0
Or alternatively as Δₙ = ∑ₓ (eₓ)⊗ⁿ, where are e_i are basis vectors
For order 2, this is the identity matrix.
    Note: For higher order, the identity tensor is the product of n identity matrices,
    (order 2 Delta's), not the order-n Delta tensor.
For order 0, the Delta tensor is defined as |n|, where n is the size/dimension of the tensor.</p>
</div>


                            <div id="Delta.__init__" class="classattr">
                                        <input id="Delta.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Delta</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">size</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span>, </span><span class="param"><span class="o">*</span><span class="n">edges</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="Delta.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Delta.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Delta.__init__-743"><a href="#Delta.__init__-743"><span class="linenos">743</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span> <span class="o">*</span><span class="n">edges</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Delta.__init__-744"><a href="#Delta.__init__-744"><span class="linenos">744</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Delta.__init__-745"><a href="#Delta.__init__-745"><span class="linenos">745</span></a><span class="sd">        Initialize a Delta tensor.</span>
</span><span id="Delta.__init__-746"><a href="#Delta.__init__-746"><span class="linenos">746</span></a>
</span><span id="Delta.__init__-747"><a href="#Delta.__init__-747"><span class="linenos">747</span></a><span class="sd">        Args:</span>
</span><span id="Delta.__init__-748"><a href="#Delta.__init__-748"><span class="linenos">748</span></a><span class="sd">            size: The size (dimension) of the tensor.</span>
</span><span id="Delta.__init__-749"><a href="#Delta.__init__-749"><span class="linenos">749</span></a><span class="sd">            edges: The names of the tensor edges.</span>
</span><span id="Delta.__init__-750"><a href="#Delta.__init__-750"><span class="linenos">750</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Delta.__init__-751"><a href="#Delta.__init__-751"><span class="linenos">751</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_edges</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
</span><span id="Delta.__init__-752"><a href="#Delta.__init__-752"><span class="linenos">752</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">size</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">})</span>
</span><span id="Delta.__init__-753"><a href="#Delta.__init__-753"><span class="linenos">753</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">Symbol</span><span class="p">,</span> <span class="n">Number</span><span class="p">)),</span> <span class="s2">&quot;Size must be a sympy symbol&quot;</span>
</span><span id="Delta.__init__-754"><a href="#Delta.__init__-754"><span class="linenos">754</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">size</span>
</span></pre></div>


            <div class="docstring"><p>Initialize a Delta tensor.</p>

<p>Args:
    size: The size (dimension) of the tensor.
    edges: The names of the tensor edges.</p>
</div>


                            </div>
                            <div id="Delta.size" class="classattr">
                                        <input id="Delta.size-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">size</span><span class="annotation">: sympy.core.symbol.Symbol</span>

                <label class="view-source-button" for="Delta.size-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Delta.size"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Delta.size-756"><a href="#Delta.size-756"><span class="linenos">756</span></a>    <span class="nd">@property</span>
</span><span id="Delta.size-757"><a href="#Delta.size-757"><span class="linenos">757</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbol</span><span class="p">:</span>
</span><span id="Delta.size-758"><a href="#Delta.size-758"><span class="linenos">758</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span>
</span></pre></div>


    

                            </div>
                            <div id="Delta.simplify_outer" class="classattr">
                                        <input id="Delta.simplify_outer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">simplify_outer</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">tensors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Tensor">Tensor</a></span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Tensor">Tensor</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Delta.simplify_outer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Delta.simplify_outer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Delta.simplify_outer-768"><a href="#Delta.simplify_outer-768"><span class="linenos">768</span></a>    <span class="nd">@classmethod</span>
</span><span id="Delta.simplify_outer-769"><a href="#Delta.simplify_outer-769"><span class="linenos">769</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simplify_outer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="Delta.simplify_outer-770"><a href="#Delta.simplify_outer-770"><span class="linenos">770</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Simplifies a list of tensors assumed to be a product.&quot;&quot;&quot;</span>
</span><span id="Delta.simplify_outer-771"><a href="#Delta.simplify_outer-771"><span class="linenos">771</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Delta.simplify_outer-772"><a href="#Delta.simplify_outer-772"><span class="linenos">772</span></a>            <span class="n">tensors</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_simplify_step</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="Delta.simplify_outer-773"><a href="#Delta.simplify_outer-773"><span class="linenos">773</span></a>            <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
</span><span id="Delta.simplify_outer-774"><a href="#Delta.simplify_outer-774"><span class="linenos">774</span></a>                <span class="k">break</span>
</span><span id="Delta.simplify_outer-775"><a href="#Delta.simplify_outer-775"><span class="linenos">775</span></a>        <span class="k">return</span> <span class="n">tensors</span>
</span></pre></div>


            <div class="docstring"><p>Simplifies a list of tensors assumed to be a product.</p>
</div>


                            </div>
                            <div id="Delta.structural_graph" class="classattr">
                                        <input id="Delta.structural_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">structural_graph</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">networkx</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">multidigraph</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="Delta.structural_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Delta.structural_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Delta.structural_graph-777"><a href="#Delta.structural_graph-777"><span class="linenos">777</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Delta.structural_graph-778"><a href="#Delta.structural_graph-778"><span class="linenos">778</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Delta.structural_graph-779"><a href="#Delta.structural_graph-779"><span class="linenos">779</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Delta.structural_graph-780"><a href="#Delta.structural_graph-780"><span class="linenos">780</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">size_node</span> <span class="o">:=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="Delta.structural_graph-781"><a href="#Delta.structural_graph-781"><span class="linenos">781</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size_node</span><span class="p">)</span>
</span><span id="Delta.structural_graph-782"><a href="#Delta.structural_graph-782"><span class="linenos">782</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">size_node</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Create a graph representation of the tensor, which can be used for isomorphism testing.</p>

<p>Returns:
    A tuple with the following values:
    - A NetworkX directed graph.
        - Each node in the top tree is labeled with the producing tensor.
        - Use name=hashable to label vertices
    - "edges", a dict of edge_name -> node id
    - Node 0 should be the root</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Constant">Constant</a></dt>
                                <dd id="Delta.name" class="variable"><a href="#Constant.name">name</a></dd>
                <dd id="Delta.with_symmetries" class="function"><a href="#Constant.with_symmetries">with_symmetries</a></dd>
                <dd id="Delta.depends_on" class="function"><a href="#Constant.depends_on">depends_on</a></dd>

            </div>
            <div><dt><a href="#Tensor">Tensor</a></dt>
                                <dd id="Delta.edges" class="variable"><a href="#Tensor.edges">edges</a></dd>
                <dd id="Delta.shape" class="variable"><a href="#Tensor.shape">shape</a></dd>
                <dd id="Delta.order" class="variable"><a href="#Tensor.order">order</a></dd>
                <dd id="Delta.grad" class="function"><a href="#Tensor.grad">grad</a></dd>
                <dd id="Delta.rename" class="function"><a href="#Tensor.rename">rename</a></dd>
                <dd id="Delta.simplify" class="function"><a href="#Tensor.simplify">simplify</a></dd>
                <dd id="Delta.full_simplify" class="function"><a href="#Tensor.full_simplify">full_simplify</a></dd>
                <dd id="Delta.substitute" class="function"><a href="#Tensor.substitute">substitute</a></dd>
                <dd id="Delta.weisfeiler_lehman" class="variable"><a href="#Tensor.weisfeiler_lehman">weisfeiler_lehman</a></dd>
                <dd id="Delta.edge_structural_graph" class="function"><a href="#Tensor.edge_structural_graph">edge_structural_graph</a></dd>
                <dd id="Delta.graph_to_string" class="function"><a href="#Tensor.graph_to_string">graph_to_string</a></dd>
                <dd id="Delta.is_isomorphic" class="function"><a href="#Tensor.is_isomorphic">is_isomorphic</a></dd>
                <dd id="Delta.isomorphisms" class="function"><a href="#Tensor.isomorphisms">isomorphisms</a></dd>
                <dd id="Delta.symmetries" class="variable"><a href="#Tensor.symmetries">symmetries</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Zero">
                            <input id="Zero-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Zero</span><wbr>(<span class="base"><a href="#Constant">Constant</a></span>):

                <label class="view-source-button" for="Zero-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Zero"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Zero-849"><a href="#Zero-849"><span class="linenos">849</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Zero</span><span class="p">(</span><span class="n">Constant</span><span class="p">):</span>
</span><span id="Zero-850"><a href="#Zero-850"><span class="linenos">850</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix such that Z_{i,j,k} = 0 for all i, j, k&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Matrix such that Z_{i,j,k} = 0 for all i, j, k</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Constant">Constant</a></dt>
                                <dd id="Zero.__init__" class="function"><a href="#Constant.__init__">Constant</a></dd>
                <dd id="Zero.name" class="variable"><a href="#Constant.name">name</a></dd>
                <dd id="Zero.with_symmetries" class="function"><a href="#Constant.with_symmetries">with_symmetries</a></dd>
                <dd id="Zero.structural_graph" class="function"><a href="#Constant.structural_graph">structural_graph</a></dd>
                <dd id="Zero.depends_on" class="function"><a href="#Constant.depends_on">depends_on</a></dd>

            </div>
            <div><dt><a href="#Tensor">Tensor</a></dt>
                                <dd id="Zero.edges" class="variable"><a href="#Tensor.edges">edges</a></dd>
                <dd id="Zero.shape" class="variable"><a href="#Tensor.shape">shape</a></dd>
                <dd id="Zero.order" class="variable"><a href="#Tensor.order">order</a></dd>
                <dd id="Zero.grad" class="function"><a href="#Tensor.grad">grad</a></dd>
                <dd id="Zero.rename" class="function"><a href="#Tensor.rename">rename</a></dd>
                <dd id="Zero.simplify" class="function"><a href="#Tensor.simplify">simplify</a></dd>
                <dd id="Zero.full_simplify" class="function"><a href="#Tensor.full_simplify">full_simplify</a></dd>
                <dd id="Zero.substitute" class="function"><a href="#Tensor.substitute">substitute</a></dd>
                <dd id="Zero.weisfeiler_lehman" class="variable"><a href="#Tensor.weisfeiler_lehman">weisfeiler_lehman</a></dd>
                <dd id="Zero.edge_structural_graph" class="function"><a href="#Tensor.edge_structural_graph">edge_structural_graph</a></dd>
                <dd id="Zero.graph_to_string" class="function"><a href="#Tensor.graph_to_string">graph_to_string</a></dd>
                <dd id="Zero.is_isomorphic" class="function"><a href="#Tensor.is_isomorphic">is_isomorphic</a></dd>
                <dd id="Zero.isomorphisms" class="function"><a href="#Tensor.isomorphisms">isomorphisms</a></dd>
                <dd id="Zero.symmetries" class="variable"><a href="#Tensor.symmetries">symmetries</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Ones">
                            <input id="Ones-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Ones</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="o">*</span><span class="n">shape0</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span>,</span><span class="param">	<span class="o">**</span><span class="n">shape1</span><span class="p">:</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span></span><span class="return-annotation">) -> <span class="n"><a href="#Tensor">Tensor</a></span>:</span></span>

                <label class="view-source-button" for="Ones-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Ones"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Ones-853"><a href="#Ones-853"><span class="linenos">853</span></a><span class="k">def</span><span class="w"> </span><span class="nf">Ones</span><span class="p">(</span><span class="o">*</span><span class="n">shape0</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">,</span> <span class="o">**</span><span class="n">shape1</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Ones-854"><a href="#Ones-854"><span class="linenos">854</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Matrix such that O_{i,j,k} = 1 for all i, j, k&quot;&quot;&quot;</span>
</span><span id="Ones-855"><a href="#Ones-855"><span class="linenos">855</span></a>    <span class="c1"># Implemented in practice by a simple outer product of Delta&#39;s</span>
</span><span id="Ones-856"><a href="#Ones-856"><span class="linenos">856</span></a>    <span class="n">shape</span> <span class="o">=</span> <span class="n">Tensor</span><span class="o">.</span><span class="n">_check_shape</span><span class="p">(</span><span class="n">shape0</span><span class="p">,</span> <span class="n">shape1</span><span class="p">)</span>
</span><span id="Ones-857"><a href="#Ones-857"><span class="linenos">857</span></a>    <span class="k">return</span> <span class="n">Product</span><span class="p">([</span><span class="n">Delta</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
</span></pre></div>


            <div class="docstring"><p>Matrix such that O_{i,j,k} = 1 for all i, j, k</p>
</div>


                </section>
                <section id="FunctionSignature">
                            <input id="FunctionSignature-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">FunctionSignature</span><wbr>(<span class="base">abc.ABC</span>):

                <label class="view-source-button" for="FunctionSignature-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FunctionSignature"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FunctionSignature-865"><a href="#FunctionSignature-865"><span class="linenos"> 865</span></a><span class="nd">@dataclass</span>
</span><span id="FunctionSignature-866"><a href="#FunctionSignature-866"><span class="linenos"> 866</span></a><span class="k">class</span><span class="w"> </span><span class="nc">FunctionSignature</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="FunctionSignature-867"><a href="#FunctionSignature-867"><span class="linenos"> 867</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FunctionSignature-868"><a href="#FunctionSignature-868"><span class="linenos"> 868</span></a><span class="sd">    An abstract base class representing a function that takes one or more tensors as input</span>
</span><span id="FunctionSignature-869"><a href="#FunctionSignature-869"><span class="linenos"> 869</span></a><span class="sd">    and produces a new tensor as output.</span>
</span><span id="FunctionSignature-870"><a href="#FunctionSignature-870"><span class="linenos"> 870</span></a>
</span><span id="FunctionSignature-871"><a href="#FunctionSignature-871"><span class="linenos"> 871</span></a><span class="sd">    This class is designed to capture the symbolic structure of a tensor operation by</span>
</span><span id="FunctionSignature-872"><a href="#FunctionSignature-872"><span class="linenos"> 872</span></a><span class="sd">    listing its output edges (`edges`) and the input edges (`inputs`) each of its input</span>
</span><span id="FunctionSignature-873"><a href="#FunctionSignature-873"><span class="linenos"> 873</span></a><span class="sd">    tensors must provide. Subclasses are required to implement the `eval` and `derivative`</span>
</span><span id="FunctionSignature-874"><a href="#FunctionSignature-874"><span class="linenos"> 874</span></a><span class="sd">    methods, while `simplify` has a default no-op implementation that may be overridden.</span>
</span><span id="FunctionSignature-875"><a href="#FunctionSignature-875"><span class="linenos"> 875</span></a>
</span><span id="FunctionSignature-876"><a href="#FunctionSignature-876"><span class="linenos"> 876</span></a><span class="sd">    Parameters</span>
</span><span id="FunctionSignature-877"><a href="#FunctionSignature-877"><span class="linenos"> 877</span></a><span class="sd">    ----------</span>
</span><span id="FunctionSignature-878"><a href="#FunctionSignature-878"><span class="linenos"> 878</span></a><span class="sd">    name : str</span>
</span><span id="FunctionSignature-879"><a href="#FunctionSignature-879"><span class="linenos"> 879</span></a><span class="sd">        A descriptive name for the function (e.g., &quot;matmul&quot;, &quot;unfold&quot;, &quot;ce&quot;, &quot;attention&quot;).</span>
</span><span id="FunctionSignature-880"><a href="#FunctionSignature-880"><span class="linenos"> 880</span></a><span class="sd">    edges : Set[str]</span>
</span><span id="FunctionSignature-881"><a href="#FunctionSignature-881"><span class="linenos"> 881</span></a><span class="sd">        The output edges of this function. These are string identifiers that symbolically</span>
</span><span id="FunctionSignature-882"><a href="#FunctionSignature-882"><span class="linenos"> 882</span></a><span class="sd">        represent the dimensions of the output tensor.</span>
</span><span id="FunctionSignature-883"><a href="#FunctionSignature-883"><span class="linenos"> 883</span></a><span class="sd">    inputs : tuple[Set[str], ...]</span>
</span><span id="FunctionSignature-884"><a href="#FunctionSignature-884"><span class="linenos"> 884</span></a><span class="sd">        A tuple where each element is a set of edges required from one input tensor.</span>
</span><span id="FunctionSignature-885"><a href="#FunctionSignature-885"><span class="linenos"> 885</span></a><span class="sd">        For example, if the first input tensor must share dimension edges {&quot;b&quot;, &quot;i&quot;} and</span>
</span><span id="FunctionSignature-886"><a href="#FunctionSignature-886"><span class="linenos"> 886</span></a><span class="sd">        the second input tensor must share dimension edges {&quot;b&quot;, &quot;j&quot;}, then</span>
</span><span id="FunctionSignature-887"><a href="#FunctionSignature-887"><span class="linenos"> 887</span></a><span class="sd">        `inputs = ({&quot;b&quot;, &quot;i&quot;}, {&quot;b&quot;, &quot;j&quot;})`.</span>
</span><span id="FunctionSignature-888"><a href="#FunctionSignature-888"><span class="linenos"> 888</span></a>
</span><span id="FunctionSignature-889"><a href="#FunctionSignature-889"><span class="linenos"> 889</span></a><span class="sd">    Examples</span>
</span><span id="FunctionSignature-890"><a href="#FunctionSignature-890"><span class="linenos"> 890</span></a><span class="sd">    --------</span>
</span><span id="FunctionSignature-891"><a href="#FunctionSignature-891"><span class="linenos"> 891</span></a><span class="sd">    1) **Matrix multiplication**:</span>
</span><span id="FunctionSignature-892"><a href="#FunctionSignature-892"><span class="linenos"> 892</span></a><span class="sd">       Suppose `x` has shape (b, i, j) and `y` has shape (b, j, k). We might define:</span>
</span><span id="FunctionSignature-893"><a href="#FunctionSignature-893"><span class="linenos"> 893</span></a>
</span><span id="FunctionSignature-894"><a href="#FunctionSignature-894"><span class="linenos"> 894</span></a><span class="sd">       .. code-block:: python</span>
</span><span id="FunctionSignature-895"><a href="#FunctionSignature-895"><span class="linenos"> 895</span></a>
</span><span id="FunctionSignature-896"><a href="#FunctionSignature-896"><span class="linenos"> 896</span></a><span class="sd">          f = MatmulSignature(</span>
</span><span id="FunctionSignature-897"><a href="#FunctionSignature-897"><span class="linenos"> 897</span></a><span class="sd">              name=&quot;matmul&quot;,</span>
</span><span id="FunctionSignature-898"><a href="#FunctionSignature-898"><span class="linenos"> 898</span></a><span class="sd">              edges={&quot;i&quot;, &quot;k&quot;},</span>
</span><span id="FunctionSignature-899"><a href="#FunctionSignature-899"><span class="linenos"> 899</span></a><span class="sd">              inputs=({&quot;i&quot;, &quot;j&quot;}, {&quot;j&quot;, &quot;k&quot;})</span>
</span><span id="FunctionSignature-900"><a href="#FunctionSignature-900"><span class="linenos"> 900</span></a><span class="sd">          )</span>
</span><span id="FunctionSignature-901"><a href="#FunctionSignature-901"><span class="linenos"> 901</span></a>
</span><span id="FunctionSignature-902"><a href="#FunctionSignature-902"><span class="linenos"> 902</span></a><span class="sd">       Here, the function consumes edges `i` and `j` from `x` and edges `j` and `k` from `y`.</span>
</span><span id="FunctionSignature-903"><a href="#FunctionSignature-903"><span class="linenos"> 903</span></a><span class="sd">       The edge `b` is shared between the two inputs and broadcasted. The output tensor</span>
</span><span id="FunctionSignature-904"><a href="#FunctionSignature-904"><span class="linenos"> 904</span></a><span class="sd">       eventually has shape (b, i, k).</span>
</span><span id="FunctionSignature-905"><a href="#FunctionSignature-905"><span class="linenos"> 905</span></a>
</span><span id="FunctionSignature-906"><a href="#FunctionSignature-906"><span class="linenos"> 906</span></a><span class="sd">    2) **Unfold**:</span>
</span><span id="FunctionSignature-907"><a href="#FunctionSignature-907"><span class="linenos"> 907</span></a><span class="sd">       Suppose we have a tensor `x` with shape (b, c, w, h) and we want to produce a series</span>
</span><span id="FunctionSignature-908"><a href="#FunctionSignature-908"><span class="linenos"> 908</span></a><span class="sd">       of patches. We might define:</span>
</span><span id="FunctionSignature-909"><a href="#FunctionSignature-909"><span class="linenos"> 909</span></a>
</span><span id="FunctionSignature-910"><a href="#FunctionSignature-910"><span class="linenos"> 910</span></a><span class="sd">       .. code-block:: python</span>
</span><span id="FunctionSignature-911"><a href="#FunctionSignature-911"><span class="linenos"> 911</span></a>
</span><span id="FunctionSignature-912"><a href="#FunctionSignature-912"><span class="linenos"> 912</span></a><span class="sd">          f = UnfoldSignature(</span>
</span><span id="FunctionSignature-913"><a href="#FunctionSignature-913"><span class="linenos"> 913</span></a><span class="sd">              name=&quot;unfold&quot;,</span>
</span><span id="FunctionSignature-914"><a href="#FunctionSignature-914"><span class="linenos"> 914</span></a><span class="sd">              edges={&quot;patch&quot;, &quot;c_out&quot;, &quot;w_out&quot;, &quot;h_out&quot;},</span>
</span><span id="FunctionSignature-915"><a href="#FunctionSignature-915"><span class="linenos"> 915</span></a><span class="sd">              inputs=({&quot;c_in&quot;, &quot;w_in&quot;, &quot;h_in&quot;},)</span>
</span><span id="FunctionSignature-916"><a href="#FunctionSignature-916"><span class="linenos"> 916</span></a><span class="sd">          )</span>
</span><span id="FunctionSignature-917"><a href="#FunctionSignature-917"><span class="linenos"> 917</span></a>
</span><span id="FunctionSignature-918"><a href="#FunctionSignature-918"><span class="linenos"> 918</span></a><span class="sd">       This function consumes edges ``c, w, h`` from `x` and introduces a new edge</span>
</span><span id="FunctionSignature-919"><a href="#FunctionSignature-919"><span class="linenos"> 919</span></a><span class="sd">       named ``patch`` of size (w_in - w_out + 1)*(h_in - h_out + 1).</span>
</span><span id="FunctionSignature-920"><a href="#FunctionSignature-920"><span class="linenos"> 920</span></a>
</span><span id="FunctionSignature-921"><a href="#FunctionSignature-921"><span class="linenos"> 921</span></a><span class="sd">    3) **Cross-entropy**:</span>
</span><span id="FunctionSignature-922"><a href="#FunctionSignature-922"><span class="linenos"> 922</span></a><span class="sd">       This is an example of a function that takes two inputs, for example logits and</span>
</span><span id="FunctionSignature-923"><a href="#FunctionSignature-923"><span class="linenos"> 923</span></a><span class="sd">       probabilities. Suppose:</span>
</span><span id="FunctionSignature-924"><a href="#FunctionSignature-924"><span class="linenos"> 924</span></a><span class="sd">       - `x` has shape (b, logits)</span>
</span><span id="FunctionSignature-925"><a href="#FunctionSignature-925"><span class="linenos"> 925</span></a><span class="sd">       - `y` has shape (b, probs)</span>
</span><span id="FunctionSignature-926"><a href="#FunctionSignature-926"><span class="linenos"> 926</span></a>
</span><span id="FunctionSignature-927"><a href="#FunctionSignature-927"><span class="linenos"> 927</span></a><span class="sd">       We might define:</span>
</span><span id="FunctionSignature-928"><a href="#FunctionSignature-928"><span class="linenos"> 928</span></a>
</span><span id="FunctionSignature-929"><a href="#FunctionSignature-929"><span class="linenos"> 929</span></a><span class="sd">       .. code-block:: python</span>
</span><span id="FunctionSignature-930"><a href="#FunctionSignature-930"><span class="linenos"> 930</span></a>
</span><span id="FunctionSignature-931"><a href="#FunctionSignature-931"><span class="linenos"> 931</span></a><span class="sd">          f = CrossEntropySignature(</span>
</span><span id="FunctionSignature-932"><a href="#FunctionSignature-932"><span class="linenos"> 932</span></a><span class="sd">              name=&quot;ce&quot;,</span>
</span><span id="FunctionSignature-933"><a href="#FunctionSignature-933"><span class="linenos"> 933</span></a><span class="sd">              edges={&quot;ce&quot;},</span>
</span><span id="FunctionSignature-934"><a href="#FunctionSignature-934"><span class="linenos"> 934</span></a><span class="sd">              inputs=({&quot;logits&quot;}, {&quot;probs&quot;})</span>
</span><span id="FunctionSignature-935"><a href="#FunctionSignature-935"><span class="linenos"> 935</span></a><span class="sd">          )</span>
</span><span id="FunctionSignature-936"><a href="#FunctionSignature-936"><span class="linenos"> 936</span></a>
</span><span id="FunctionSignature-937"><a href="#FunctionSignature-937"><span class="linenos"> 937</span></a><span class="sd">       Both inputs share the batch edge ``b``. The new edge ``ce`` could represent the</span>
</span><span id="FunctionSignature-938"><a href="#FunctionSignature-938"><span class="linenos"> 938</span></a><span class="sd">       cross-entropy output dimension (often scalar per example, so shape (b, ce)).</span>
</span><span id="FunctionSignature-939"><a href="#FunctionSignature-939"><span class="linenos"> 939</span></a>
</span><span id="FunctionSignature-940"><a href="#FunctionSignature-940"><span class="linenos"> 940</span></a><span class="sd">    4) **Multi-query Dot Product Attention**:</span>
</span><span id="FunctionSignature-941"><a href="#FunctionSignature-941"><span class="linenos"> 941</span></a><span class="sd">       Suppose we have tensors:</span>
</span><span id="FunctionSignature-942"><a href="#FunctionSignature-942"><span class="linenos"> 942</span></a><span class="sd">       - `q` with shape (b, n_q, d)</span>
</span><span id="FunctionSignature-943"><a href="#FunctionSignature-943"><span class="linenos"> 943</span></a><span class="sd">       - `k` with shape (b, seq, d)</span>
</span><span id="FunctionSignature-944"><a href="#FunctionSignature-944"><span class="linenos"> 944</span></a><span class="sd">       - `v` with shape (b, seq, d_out)</span>
</span><span id="FunctionSignature-945"><a href="#FunctionSignature-945"><span class="linenos"> 945</span></a>
</span><span id="FunctionSignature-946"><a href="#FunctionSignature-946"><span class="linenos"> 946</span></a><span class="sd">       Conceptually, to compute multi-query attention:</span>
</span><span id="FunctionSignature-947"><a href="#FunctionSignature-947"><span class="linenos"> 947</span></a>
</span><span id="FunctionSignature-948"><a href="#FunctionSignature-948"><span class="linenos"> 948</span></a><span class="sd">       - We form (b, n_q, seq) via a dot product of `q` and `k`.</span>
</span><span id="FunctionSignature-949"><a href="#FunctionSignature-949"><span class="linenos"> 949</span></a><span class="sd">       - We apply a softmax to get (b, n_q, prob).</span>
</span><span id="FunctionSignature-950"><a href="#FunctionSignature-950"><span class="linenos"> 950</span></a><span class="sd">       - We multiply by `v` to get (b, n_q, d_out).</span>
</span><span id="FunctionSignature-951"><a href="#FunctionSignature-951"><span class="linenos"> 951</span></a>
</span><span id="FunctionSignature-952"><a href="#FunctionSignature-952"><span class="linenos"> 952</span></a><span class="sd">       A possible signature might be:</span>
</span><span id="FunctionSignature-953"><a href="#FunctionSignature-953"><span class="linenos"> 953</span></a>
</span><span id="FunctionSignature-954"><a href="#FunctionSignature-954"><span class="linenos"> 954</span></a><span class="sd">       .. code-block:: python</span>
</span><span id="FunctionSignature-955"><a href="#FunctionSignature-955"><span class="linenos"> 955</span></a>
</span><span id="FunctionSignature-956"><a href="#FunctionSignature-956"><span class="linenos"> 956</span></a><span class="sd">          f = AttentionSignature(</span>
</span><span id="FunctionSignature-957"><a href="#FunctionSignature-957"><span class="linenos"> 957</span></a><span class="sd">              name=&quot;attention&quot;,</span>
</span><span id="FunctionSignature-958"><a href="#FunctionSignature-958"><span class="linenos"> 958</span></a><span class="sd">              edges={&quot;n_q&quot;, &quot;d_out&quot;},</span>
</span><span id="FunctionSignature-959"><a href="#FunctionSignature-959"><span class="linenos"> 959</span></a><span class="sd">              inputs=(</span>
</span><span id="FunctionSignature-960"><a href="#FunctionSignature-960"><span class="linenos"> 960</span></a><span class="sd">                  {&quot;n_q&quot;, &quot;d&quot;},</span>
</span><span id="FunctionSignature-961"><a href="#FunctionSignature-961"><span class="linenos"> 961</span></a><span class="sd">                  {&quot;seq&quot;, &quot;d&quot;},</span>
</span><span id="FunctionSignature-962"><a href="#FunctionSignature-962"><span class="linenos"> 962</span></a><span class="sd">                  {&quot;seq&quot;, &quot;d_out&quot;},</span>
</span><span id="FunctionSignature-963"><a href="#FunctionSignature-963"><span class="linenos"> 963</span></a><span class="sd">              )</span>
</span><span id="FunctionSignature-964"><a href="#FunctionSignature-964"><span class="linenos"> 964</span></a><span class="sd">          )</span>
</span><span id="FunctionSignature-965"><a href="#FunctionSignature-965"><span class="linenos"> 965</span></a>
</span><span id="FunctionSignature-966"><a href="#FunctionSignature-966"><span class="linenos"> 966</span></a><span class="sd">       The edge ``b`` is shared among all inputs (broadcast). The final output</span>
</span><span id="FunctionSignature-967"><a href="#FunctionSignature-967"><span class="linenos"> 967</span></a><span class="sd">       has shape (b, n_q, d_out).</span>
</span><span id="FunctionSignature-968"><a href="#FunctionSignature-968"><span class="linenos"> 968</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FunctionSignature-969"><a href="#FunctionSignature-969"><span class="linenos"> 969</span></a>
</span><span id="FunctionSignature-970"><a href="#FunctionSignature-970"><span class="linenos"> 970</span></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="FunctionSignature-971"><a href="#FunctionSignature-971"><span class="linenos"> 971</span></a>    <span class="c1"># The output edges of the function. Note no Symbols here, since we don&#39;t know the sizes yet.</span>
</span><span id="FunctionSignature-972"><a href="#FunctionSignature-972"><span class="linenos"> 972</span></a>    <span class="n">edges</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="FunctionSignature-973"><a href="#FunctionSignature-973"><span class="linenos"> 973</span></a>    <span class="c1"># Defines the number of input tensors the function takes, and what edges it needs from each</span>
</span><span id="FunctionSignature-974"><a href="#FunctionSignature-974"><span class="linenos"> 974</span></a>    <span class="n">inputs</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
</span><span id="FunctionSignature-975"><a href="#FunctionSignature-975"><span class="linenos"> 975</span></a>
</span><span id="FunctionSignature-976"><a href="#FunctionSignature-976"><span class="linenos"> 976</span></a>    <span class="c1"># TODO: Functions should support symmetric outputs, just like Constant and Variable.</span>
</span><span id="FunctionSignature-977"><a href="#FunctionSignature-977"><span class="linenos"> 977</span></a>    <span class="c1"># Actually we could define symmetries for the inputs too, since the order doesn&#39;t always matter.</span>
</span><span id="FunctionSignature-978"><a href="#FunctionSignature-978"><span class="linenos"> 978</span></a>
</span><span id="FunctionSignature-979"><a href="#FunctionSignature-979"><span class="linenos"> 979</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">new_edges</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FunctionSignature&quot;</span><span class="p">:</span>
</span><span id="FunctionSignature-980"><a href="#FunctionSignature-980"><span class="linenos"> 980</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FunctionSignature-981"><a href="#FunctionSignature-981"><span class="linenos"> 981</span></a><span class="sd">        Returns a new FunctionSignature that represents the derivative</span>
</span><span id="FunctionSignature-982"><a href="#FunctionSignature-982"><span class="linenos"> 982</span></a><span class="sd">        with respect to the i-th input, and where edges are created</span>
</span><span id="FunctionSignature-983"><a href="#FunctionSignature-983"><span class="linenos"> 983</span></a><span class="sd">        according to `new_edges` a dict {old_name : new_name}.</span>
</span><span id="FunctionSignature-984"><a href="#FunctionSignature-984"><span class="linenos"> 984</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FunctionSignature-985"><a href="#FunctionSignature-985"><span class="linenos"> 985</span></a>        <span class="k">if</span> <span class="n">new_edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FunctionSignature-986"><a href="#FunctionSignature-986"><span class="linenos"> 986</span></a>            <span class="n">new_edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="FunctionSignature-987"><a href="#FunctionSignature-987"><span class="linenos"> 987</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="FunctionSignature-988"><a href="#FunctionSignature-988"><span class="linenos"> 988</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> but got </span><span class="si">{</span><span class="n">new_edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FunctionSignature-989"><a href="#FunctionSignature-989"><span class="linenos"> 989</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_edges</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="FunctionSignature-990"><a href="#FunctionSignature-990"><span class="linenos"> 990</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New edges </span><span class="si">{</span><span class="n">new_edges</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="si">}</span><span class="s2"> clash with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FunctionSignature-991"><a href="#FunctionSignature-991"><span class="linenos"> 991</span></a>        <span class="k">return</span> <span class="n">FunctionSignature</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;D_</span><span class="si">{</span><span class="n">i</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_edges</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="FunctionSignature-992"><a href="#FunctionSignature-992"><span class="linenos"> 992</span></a>
</span><span id="FunctionSignature-993"><a href="#FunctionSignature-993"><span class="linenos"> 993</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="s2">&quot;Function&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="FunctionSignature-994"><a href="#FunctionSignature-994"><span class="linenos"> 994</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FunctionSignature-995"><a href="#FunctionSignature-995"><span class="linenos"> 995</span></a><span class="sd">        Simplifies the Function tensor that uses this signature.</span>
</span><span id="FunctionSignature-996"><a href="#FunctionSignature-996"><span class="linenos"> 996</span></a><span class="sd">        Default implementation returns `t` unchanged.</span>
</span><span id="FunctionSignature-997"><a href="#FunctionSignature-997"><span class="linenos"> 997</span></a><span class="sd">        Subclasses can override this method for custom simplifications.</span>
</span><span id="FunctionSignature-998"><a href="#FunctionSignature-998"><span class="linenos"> 998</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FunctionSignature-999"><a href="#FunctionSignature-999"><span class="linenos"> 999</span></a>        <span class="k">return</span> <span class="n">t</span>
</span><span id="FunctionSignature-1000"><a href="#FunctionSignature-1000"><span class="linenos">1000</span></a>
</span><span id="FunctionSignature-1001"><a href="#FunctionSignature-1001"><span class="linenos">1001</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="FunctionSignature-1002"><a href="#FunctionSignature-1002"><span class="linenos">1002</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;FunctionSignature(&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;, </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
</span></pre></div>


            <div class="docstring"><p>An abstract base class representing a function that takes one or more tensors as input
and produces a new tensor as output.</p>

<p>This class is designed to capture the symbolic structure of a tensor operation by
listing its output edges (<code><a href="#FunctionSignature.edges">edges</a></code>) and the input edges (<code><a href="#FunctionSignature.inputs">inputs</a></code>) each of its input
tensors must provide. Subclasses are required to implement the <code>eval</code> and <code><a href="#FunctionSignature.derivative">derivative</a></code>
methods, while <code><a href="#FunctionSignature.simplify">simplify</a></code> has a default no-op implementation that may be overridden.</p>

<h2 id="parameters">Parameters</h2>

<p>name : str
    A descriptive name for the function (e.g., "matmul", "unfold", "ce", "attention").
edges : Set[str]
    The output edges of this function. These are string identifiers that symbolically
    represent the dimensions of the output tensor.
inputs : tuple[Set[str], ...]
    A tuple where each element is a set of edges required from one input tensor.
    For example, if the first input tensor must share dimension edges {"b", "i"} and
    the second input tensor must share dimension edges {"b", "j"}, then
    <code>inputs = ({"b", "i"}, {"b", "j"})</code>.</p>

<h2 id="examples">Examples</h2>

<p>1) <strong>Matrix multiplication</strong>:
   Suppose <code>x</code> has shape (b, i, j) and <code>y</code> has shape (b, j, k). We might define:</p>

<p>```python
f = MatmulSignature(
    name="matmul",
    edges={"i", "k"},
    inputs=({"i", "j"}, {"j", "k"})
)</p>

<pre><code>
   Here, the function consumes edges `i` and `j` from `x` and edges `j` and `k` from `y`.
   The edge `b` is shared between the two inputs and broadcasted. The output tensor
   eventually has shape (b, i, k).

2) **Unfold**:
   Suppose we have a tensor `x` with shape (b, c, w, h) and we want to produce a series
   of patches. We might define:

   ```python
f = UnfoldSignature(
    name="unfold",
    edges={"patch", "c_out", "w_out", "h_out"},
    inputs=({"c_in", "w_in", "h_in"},)
)
</code></pre>

<p>This function consumes edges <code>c, w, h</code> from <code>x</code> and introduces a new edge
   named <code>patch</code> of size (w_in - w_out + 1)*(h_in - h_out + 1).</p>

<p>3) <strong>Cross-entropy</strong>:
   This is an example of a function that takes two inputs, for example logits and
   probabilities. Suppose:</p>

<ul>
<li><code>x</code> has shape (b, logits)</li>
<li><code>y</code> has shape (b, probs)</li>
</ul>

<p>We might define:</p>

<p>```python
f = CrossEntropySignature(
    name="ce",
    edges={"ce"},
    inputs=({"logits"}, {"probs"})
)</p>

<pre><code>
   Both inputs share the batch edge ``b``. The new edge ``ce`` could represent the
   cross-entropy output dimension (often scalar per example, so shape (b, ce)).

4) **Multi-query Dot Product Attention**:
   Suppose we have tensors:
   - `q` with shape (b, n_q, d)
   - `k` with shape (b, seq, d)
   - `v` with shape (b, seq, d_out)

   Conceptually, to compute multi-query attention:

   - We form (b, n_q, seq) via a dot product of `q` and `k`.
   - We apply a softmax to get (b, n_q, prob).
   - We multiply by `v` to get (b, n_q, d_out).

   A possible signature might be:

   ```python
f = AttentionSignature(
    name="attention",
    edges={"n_q", "d_out"},
    inputs=(
        {"n_q", "d"},
        {"seq", "d"},
        {"seq", "d_out"},
    )
)
</code></pre>

<p>The edge <code>b</code> is shared among all inputs (broadcast). The final output
   has shape (b, n_q, d_out).</p>
</div>


                            <div id="FunctionSignature.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">FunctionSignature</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">edges</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>, </span><span class="param"><span class="n">inputs</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#FunctionSignature.__init__"></a>
    
    

                            </div>
                            <div id="FunctionSignature.name" class="classattr">
                                <div class="attr variable">
            <span class="name">name</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#FunctionSignature.name"></a>
    
    

                            </div>
                            <div id="FunctionSignature.edges" class="classattr">
                                <div class="attr variable">
            <span class="name">edges</span><span class="annotation">: set[str]</span>

        
    </div>
    <a class="headerlink" href="#FunctionSignature.edges"></a>
    
    

                            </div>
                            <div id="FunctionSignature.inputs" class="classattr">
                                <div class="attr variable">
            <span class="name">inputs</span><span class="annotation">: tuple[set[str], ...]</span>

        
    </div>
    <a class="headerlink" href="#FunctionSignature.inputs"></a>
    
    

                            </div>
                            <div id="FunctionSignature.derivative" class="classattr">
                                        <input id="FunctionSignature.derivative-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">derivative</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">i</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">new_edges</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#FunctionSignature">FunctionSignature</a></span>:</span></span>

                <label class="view-source-button" for="FunctionSignature.derivative-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FunctionSignature.derivative"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FunctionSignature.derivative-979"><a href="#FunctionSignature.derivative-979"><span class="linenos">979</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">derivative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">new_edges</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FunctionSignature&quot;</span><span class="p">:</span>
</span><span id="FunctionSignature.derivative-980"><a href="#FunctionSignature.derivative-980"><span class="linenos">980</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FunctionSignature.derivative-981"><a href="#FunctionSignature.derivative-981"><span class="linenos">981</span></a><span class="sd">        Returns a new FunctionSignature that represents the derivative</span>
</span><span id="FunctionSignature.derivative-982"><a href="#FunctionSignature.derivative-982"><span class="linenos">982</span></a><span class="sd">        with respect to the i-th input, and where edges are created</span>
</span><span id="FunctionSignature.derivative-983"><a href="#FunctionSignature.derivative-983"><span class="linenos">983</span></a><span class="sd">        according to `new_edges` a dict {old_name : new_name}.</span>
</span><span id="FunctionSignature.derivative-984"><a href="#FunctionSignature.derivative-984"><span class="linenos">984</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FunctionSignature.derivative-985"><a href="#FunctionSignature.derivative-985"><span class="linenos">985</span></a>        <span class="k">if</span> <span class="n">new_edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FunctionSignature.derivative-986"><a href="#FunctionSignature.derivative-986"><span class="linenos">986</span></a>            <span class="n">new_edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="FunctionSignature.derivative-987"><a href="#FunctionSignature.derivative-987"><span class="linenos">987</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_edges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="FunctionSignature.derivative-988"><a href="#FunctionSignature.derivative-988"><span class="linenos">988</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> but got </span><span class="si">{</span><span class="n">new_edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FunctionSignature.derivative-989"><a href="#FunctionSignature.derivative-989"><span class="linenos">989</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_edges</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="FunctionSignature.derivative-990"><a href="#FunctionSignature.derivative-990"><span class="linenos">990</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New edges </span><span class="si">{</span><span class="n">new_edges</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="si">}</span><span class="s2"> clash with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="FunctionSignature.derivative-991"><a href="#FunctionSignature.derivative-991"><span class="linenos">991</span></a>        <span class="k">return</span> <span class="n">FunctionSignature</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;D_</span><span class="si">{</span><span class="n">i</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_edges</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Returns a new FunctionSignature that represents the derivative
with respect to the i-th input, and where edges are created
according to <code>new_edges</code> a dict {old_name : new_name}.</p>
</div>


                            </div>
                            <div id="FunctionSignature.simplify" class="classattr">
                                        <input id="FunctionSignature.simplify-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">simplify</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">t</span><span class="p">:</span> <span class="n"><a href="#Function">Function</a></span>,</span><span class="param">	<span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#Tensor">Tensor</a></span>:</span></span>

                <label class="view-source-button" for="FunctionSignature.simplify-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FunctionSignature.simplify"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FunctionSignature.simplify-993"><a href="#FunctionSignature.simplify-993"><span class="linenos">993</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="s2">&quot;Function&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="FunctionSignature.simplify-994"><a href="#FunctionSignature.simplify-994"><span class="linenos">994</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FunctionSignature.simplify-995"><a href="#FunctionSignature.simplify-995"><span class="linenos">995</span></a><span class="sd">        Simplifies the Function tensor that uses this signature.</span>
</span><span id="FunctionSignature.simplify-996"><a href="#FunctionSignature.simplify-996"><span class="linenos">996</span></a><span class="sd">        Default implementation returns `t` unchanged.</span>
</span><span id="FunctionSignature.simplify-997"><a href="#FunctionSignature.simplify-997"><span class="linenos">997</span></a><span class="sd">        Subclasses can override this method for custom simplifications.</span>
</span><span id="FunctionSignature.simplify-998"><a href="#FunctionSignature.simplify-998"><span class="linenos">998</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FunctionSignature.simplify-999"><a href="#FunctionSignature.simplify-999"><span class="linenos">999</span></a>        <span class="k">return</span> <span class="n">t</span>
</span></pre></div>


            <div class="docstring"><p>Simplifies the Function tensor that uses this signature.
Default implementation returns <code>t</code> unchanged.
Subclasses can override this method for custom simplifications.</p>
</div>


                            </div>
                </section>
                <section id="function">
                            <input id="function-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">function</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">output_shape</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span><span class="p">]</span>,</span><span class="param">	<span class="o">*</span><span class="n">inputs</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n"><a href="#Tensor">Tensor</a></span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#Function">Function</a></span>:</span></span>

                <label class="view-source-button" for="function-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#function"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="function-1005"><a href="#function-1005"><span class="linenos">1005</span></a><span class="k">def</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span>
</span><span id="function-1006"><a href="#function-1006"><span class="linenos">1006</span></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="function-1007"><a href="#function-1007"><span class="linenos">1007</span></a>    <span class="n">output_shape</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">],</span>
</span><span id="function-1008"><a href="#function-1008"><span class="linenos">1008</span></a>    <span class="o">*</span><span class="n">inputs</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Tensor</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
</span><span id="function-1009"><a href="#function-1009"><span class="linenos">1009</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Function&quot;</span><span class="p">:</span>
</span><span id="function-1010"><a href="#function-1010"><span class="linenos">1010</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="function-1011"><a href="#function-1011"><span class="linenos">1011</span></a><span class="sd">    Create a Function tensor from a name, output shape and inputs.</span>
</span><span id="function-1012"><a href="#function-1012"><span class="linenos">1012</span></a>
</span><span id="function-1013"><a href="#function-1013"><span class="linenos">1013</span></a><span class="sd">    Args:</span>
</span><span id="function-1014"><a href="#function-1014"><span class="linenos">1014</span></a><span class="sd">        name: The function name.</span>
</span><span id="function-1015"><a href="#function-1015"><span class="linenos">1015</span></a><span class="sd">        output_shape: A dictionary mapping output edge names to sizes.</span>
</span><span id="function-1016"><a href="#function-1016"><span class="linenos">1016</span></a><span class="sd">        inputs: A sequence of tuples where each tuple starts with a tensor (or string)</span>
</span><span id="function-1017"><a href="#function-1017"><span class="linenos">1017</span></a><span class="sd">                followed by the required edge names.</span>
</span><span id="function-1018"><a href="#function-1018"><span class="linenos">1018</span></a>
</span><span id="function-1019"><a href="#function-1019"><span class="linenos">1019</span></a><span class="sd">    Returns:</span>
</span><span id="function-1020"><a href="#function-1020"><span class="linenos">1020</span></a><span class="sd">        A Function tensor.</span>
</span><span id="function-1021"><a href="#function-1021"><span class="linenos">1021</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="function-1022"><a href="#function-1022"><span class="linenos">1022</span></a>    <span class="k">return</span> <span class="n">Function</span><span class="p">(</span>
</span><span id="function-1023"><a href="#function-1023"><span class="linenos">1023</span></a>        <span class="n">FunctionSignature</span><span class="p">(</span>
</span><span id="function-1024"><a href="#function-1024"><span class="linenos">1024</span></a>            <span class="n">name</span><span class="p">,</span>
</span><span id="function-1025"><a href="#function-1025"><span class="linenos">1025</span></a>            <span class="n">output_shape</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
</span><span id="function-1026"><a href="#function-1026"><span class="linenos">1026</span></a>            <span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">es</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">],</span>
</span><span id="function-1027"><a href="#function-1027"><span class="linenos">1027</span></a>        <span class="p">),</span>
</span><span id="function-1028"><a href="#function-1028"><span class="linenos">1028</span></a>        <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">],</span>
</span><span id="function-1029"><a href="#function-1029"><span class="linenos">1029</span></a>        <span class="n">output_shape</span><span class="p">,</span>
</span><span id="function-1030"><a href="#function-1030"><span class="linenos">1030</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a Function tensor from a name, output shape and inputs.</p>

<p>Args:
    name: The function name.
    output_shape: A dictionary mapping output edge names to sizes.
    inputs: A sequence of tuples where each tuple starts with a tensor (or string)
            followed by the required edge names.</p>

<p>Returns:
    A Function tensor.</p>
</div>


                </section>
                <section id="Function">
                            <input id="Function-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Function</span><wbr>(<span class="base"><a href="#Tensor">Tensor</a></span>):

                <label class="view-source-button" for="Function-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Function"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Function-1033"><a href="#Function-1033"><span class="linenos">1033</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Function</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Function-1034"><a href="#Function-1034"><span class="linenos">1034</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Function-1035"><a href="#Function-1035"><span class="linenos">1035</span></a><span class="sd">    A tensor that represents a function applied to one or more input tensors.</span>
</span><span id="Function-1036"><a href="#Function-1036"><span class="linenos">1036</span></a>
</span><span id="Function-1037"><a href="#Function-1037"><span class="linenos">1037</span></a><span class="sd">    Attributes:</span>
</span><span id="Function-1038"><a href="#Function-1038"><span class="linenos">1038</span></a><span class="sd">        signature: The FunctionSignature for this function.</span>
</span><span id="Function-1039"><a href="#Function-1039"><span class="linenos">1039</span></a><span class="sd">        inputs: A list of input tensors.</span>
</span><span id="Function-1040"><a href="#Function-1040"><span class="linenos">1040</span></a><span class="sd">        shape_out: A dictionary mapping output edge names to sizes.</span>
</span><span id="Function-1041"><a href="#Function-1041"><span class="linenos">1041</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Function-1042"><a href="#Function-1042"><span class="linenos">1042</span></a>
</span><span id="Function-1043"><a href="#Function-1043"><span class="linenos">1043</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Function-1044"><a href="#Function-1044"><span class="linenos">1044</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Function-1045"><a href="#Function-1045"><span class="linenos">1045</span></a>        <span class="n">signature</span><span class="p">:</span> <span class="n">FunctionSignature</span><span class="p">,</span>
</span><span id="Function-1046"><a href="#Function-1046"><span class="linenos">1046</span></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span>
</span><span id="Function-1047"><a href="#Function-1047"><span class="linenos">1047</span></a>        <span class="n">shape_out</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">],</span>
</span><span id="Function-1048"><a href="#Function-1048"><span class="linenos">1048</span></a>    <span class="p">):</span>
</span><span id="Function-1049"><a href="#Function-1049"><span class="linenos">1049</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Function-1050"><a href="#Function-1050"><span class="linenos">1050</span></a><span class="sd">        A function tensor that takes one or more input tensors and produces an output tensor.</span>
</span><span id="Function-1051"><a href="#Function-1051"><span class="linenos">1051</span></a>
</span><span id="Function-1052"><a href="#Function-1052"><span class="linenos">1052</span></a><span class="sd">        Args:</span>
</span><span id="Function-1053"><a href="#Function-1053"><span class="linenos">1053</span></a><span class="sd">            signature: The FunctionSignature defining this function, or a string giving the function name.</span>
</span><span id="Function-1054"><a href="#Function-1054"><span class="linenos">1054</span></a><span class="sd">            inputs: The input tensors and their input edge names. [(t0, e00, e01, ...), (t1, e10, ...), ...]</span>
</span><span id="Function-1055"><a href="#Function-1055"><span class="linenos">1055</span></a><span class="sd">            shape_out: The names of the output edges of this function.</span>
</span><span id="Function-1056"><a href="#Function-1056"><span class="linenos">1056</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Function-1057"><a href="#Function-1057"><span class="linenos">1057</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_shape</span><span class="p">([],</span> <span class="n">shape_out</span><span class="p">)</span>
</span><span id="Function-1058"><a href="#Function-1058"><span class="linenos">1058</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="Function-1059"><a href="#Function-1059"><span class="linenos">1059</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span>
</span><span id="Function-1060"><a href="#Function-1060"><span class="linenos">1060</span></a>
</span><span id="Function-1061"><a href="#Function-1061"><span class="linenos">1061</span></a>        <span class="c1"># Validation</span>
</span><span id="Function-1062"><a href="#Function-1062"><span class="linenos">1062</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">!=</span> <span class="n">signature</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="Function-1063"><a href="#Function-1063"><span class="linenos">1063</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signature doesn&#39;t match shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">=}</span><span class="s2"> != </span><span class="si">{</span><span class="n">signature</span><span class="o">.</span><span class="n">edges</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Function-1064"><a href="#Function-1064"><span class="linenos">1064</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="Function-1065"><a href="#Function-1065"><span class="linenos">1065</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2"> inputs, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Function-1066"><a href="#Function-1066"><span class="linenos">1066</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">es</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="Function-1067"><a href="#Function-1067"><span class="linenos">1067</span></a>            <span class="k">if</span> <span class="n">es</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="Function-1068"><a href="#Function-1068"><span class="linenos">1068</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input edges </span><span class="si">{</span><span class="n">es</span><span class="si">}</span><span class="s2"> not subset of </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Function-1069"><a href="#Function-1069"><span class="linenos">1069</span></a>
</span><span id="Function-1070"><a href="#Function-1070"><span class="linenos">1070</span></a>        <span class="c1"># Build final shape = union of output edges + broadcast edges from each input</span>
</span><span id="Function-1071"><a href="#Function-1071"><span class="linenos">1071</span></a>        <span class="c1"># Note that this approach pushes all the broadcasted edges to the end of the shape.</span>
</span><span id="Function-1072"><a href="#Function-1072"><span class="linenos">1072</span></a>        <span class="c1"># But we don&#39;t care about the order of the edges, so it&#39;s fine.</span>
</span><span id="Function-1073"><a href="#Function-1073"><span class="linenos">1073</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">)</span>
</span><span id="Function-1074"><a href="#Function-1074"><span class="linenos">1074</span></a>        <span class="c1"># We allow &quot;broadcasting&quot; for edges that are not in fn_sig.inputs[i].</span>
</span><span id="Function-1075"><a href="#Function-1075"><span class="linenos">1075</span></a>        <span class="c1"># So if an input has edges that are not used, they&#39;re broadcasted.</span>
</span><span id="Function-1076"><a href="#Function-1076"><span class="linenos">1076</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">es</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="Function-1077"><a href="#Function-1077"><span class="linenos">1077</span></a>            <span class="c1"># any edges in t.edges - es are &quot;broadcast&quot;</span>
</span><span id="Function-1078"><a href="#Function-1078"><span class="linenos">1078</span></a>            <span class="n">broadcast_edges</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span> <span class="o">-</span> <span class="n">es</span>
</span><span id="Function-1079"><a href="#Function-1079"><span class="linenos">1079</span></a>            <span class="k">if</span> <span class="n">broadcast_edges</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="Function-1080"><a href="#Function-1080"><span class="linenos">1080</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Broadcast edges must not be shared between inputs&quot;</span><span class="p">)</span>
</span><span id="Function-1081"><a href="#Function-1081"><span class="linenos">1081</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">broadcast_edges</span><span class="p">:</span>
</span><span id="Function-1082"><a href="#Function-1082"><span class="linenos">1082</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
</span><span id="Function-1083"><a href="#Function-1083"><span class="linenos">1083</span></a>
</span><span id="Function-1084"><a href="#Function-1084"><span class="linenos">1084</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Function-1085"><a href="#Function-1085"><span class="linenos">1085</span></a>        <span class="n">renamed_inputs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Function-1086"><a href="#Function-1086"><span class="linenos">1086</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">es</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="Function-1087"><a href="#Function-1087"><span class="linenos">1087</span></a>            <span class="c1"># Only rename external edges of input tensors.</span>
</span><span id="Function-1088"><a href="#Function-1088"><span class="linenos">1088</span></a>            <span class="n">rename</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">es</span><span class="p">}</span>
</span><span id="Function-1089"><a href="#Function-1089"><span class="linenos">1089</span></a>            <span class="n">renamed_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">rename</span><span class="p">))</span>
</span><span id="Function-1090"><a href="#Function-1090"><span class="linenos">1090</span></a>        <span class="n">output_rename</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">}</span>
</span><span id="Function-1091"><a href="#Function-1091"><span class="linenos">1091</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span>
</span><span id="Function-1092"><a href="#Function-1092"><span class="linenos">1092</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span>
</span><span id="Function-1093"><a href="#Function-1093"><span class="linenos">1093</span></a>            <span class="n">renamed_inputs</span><span class="p">,</span>
</span><span id="Function-1094"><a href="#Function-1094"><span class="linenos">1094</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">,</span>
</span><span id="Function-1095"><a href="#Function-1095"><span class="linenos">1095</span></a>        <span class="p">)</span>
</span><span id="Function-1096"><a href="#Function-1096"><span class="linenos">1096</span></a>        <span class="k">if</span> <span class="n">output_rename</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">output_rename</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="Function-1097"><a href="#Function-1097"><span class="linenos">1097</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">Rename</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">output_rename</span><span class="p">)</span>
</span><span id="Function-1098"><a href="#Function-1098"><span class="linenos">1098</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="Function-1099"><a href="#Function-1099"><span class="linenos">1099</span></a>
</span><span id="Function-1100"><a href="#Function-1100"><span class="linenos">1100</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Function-1101"><a href="#Function-1101"><span class="linenos">1101</span></a>        <span class="n">new_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>
</span><span id="Function-1102"><a href="#Function-1102"><span class="linenos">1102</span></a>
</span><span id="Function-1103"><a href="#Function-1103"><span class="linenos">1103</span></a>        <span class="c1"># Broadcasting can be pulled out of the function.</span>
</span><span id="Function-1104"><a href="#Function-1104"><span class="linenos">1104</span></a>        <span class="n">pulled_out</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Function-1105"><a href="#Function-1105"><span class="linenos">1105</span></a>        <span class="n">new_inputs2</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Function-1106"><a href="#Function-1106"><span class="linenos">1106</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">es</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="Function-1107"><a href="#Function-1107"><span class="linenos">1107</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Product</span><span class="p">):</span>
</span><span id="Function-1108"><a href="#Function-1108"><span class="linenos">1108</span></a>                <span class="n">new_prod</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Function-1109"><a href="#Function-1109"><span class="linenos">1109</span></a>                <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
</span><span id="Function-1110"><a href="#Function-1110"><span class="linenos">1110</span></a>                    <span class="k">if</span> <span class="p">(</span>
</span><span id="Function-1111"><a href="#Function-1111"><span class="linenos">1111</span></a>                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)</span>
</span><span id="Function-1112"><a href="#Function-1112"><span class="linenos">1112</span></a>                        <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="Function-1113"><a href="#Function-1113"><span class="linenos">1113</span></a>                        <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">edges</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Function-1114"><a href="#Function-1114"><span class="linenos">1114</span></a>                        <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">edges</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">es</span>
</span><span id="Function-1115"><a href="#Function-1115"><span class="linenos">1115</span></a>                    <span class="p">):</span>
</span><span id="Function-1116"><a href="#Function-1116"><span class="linenos">1116</span></a>                        <span class="n">pulled_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="Function-1117"><a href="#Function-1117"><span class="linenos">1117</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Function-1118"><a href="#Function-1118"><span class="linenos">1118</span></a>                        <span class="n">new_prod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="Function-1119"><a href="#Function-1119"><span class="linenos">1119</span></a>                <span class="n">new_inputs2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Product</span><span class="p">(</span><span class="n">new_prod</span><span class="p">))</span>
</span><span id="Function-1120"><a href="#Function-1120"><span class="linenos">1120</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Function-1121"><a href="#Function-1121"><span class="linenos">1121</span></a>                <span class="n">new_inputs2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span id="Function-1122"><a href="#Function-1122"><span class="linenos">1122</span></a>        <span class="n">new_inputs</span> <span class="o">=</span> <span class="n">new_inputs2</span>
</span><span id="Function-1123"><a href="#Function-1123"><span class="linenos">1123</span></a>
</span><span id="Function-1124"><a href="#Function-1124"><span class="linenos">1124</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="n">new_inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">)</span>
</span><span id="Function-1125"><a href="#Function-1125"><span class="linenos">1125</span></a>
</span><span id="Function-1126"><a href="#Function-1126"><span class="linenos">1126</span></a>        <span class="c1"># This results in an extra simplify call to all the children of the function.</span>
</span><span id="Function-1127"><a href="#Function-1127"><span class="linenos">1127</span></a>        <span class="c1"># Maybe we can avoid this somehow?</span>
</span><span id="Function-1128"><a href="#Function-1128"><span class="linenos">1128</span></a>        <span class="n">old_shape</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span>
</span><span id="Function-1129"><a href="#Function-1129"><span class="linenos">1129</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span><span id="Function-1130"><a href="#Function-1130"><span class="linenos">1130</span></a>        <span class="k">assert</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">old_shape</span><span class="p">,</span> <span class="s2">&quot;Function signature simplify should not change shape&quot;</span>
</span><span id="Function-1131"><a href="#Function-1131"><span class="linenos">1131</span></a>
</span><span id="Function-1132"><a href="#Function-1132"><span class="linenos">1132</span></a>        <span class="k">if</span> <span class="n">pulled_out</span><span class="p">:</span>
</span><span id="Function-1133"><a href="#Function-1133"><span class="linenos">1133</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">Product</span><span class="p">([</span><span class="n">res</span><span class="p">]</span> <span class="o">+</span> <span class="n">pulled_out</span><span class="p">)</span>
</span><span id="Function-1134"><a href="#Function-1134"><span class="linenos">1134</span></a>
</span><span id="Function-1135"><a href="#Function-1135"><span class="linenos">1135</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="Function-1136"><a href="#Function-1136"><span class="linenos">1136</span></a>
</span><span id="Function-1137"><a href="#Function-1137"><span class="linenos">1137</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Function-1138"><a href="#Function-1138"><span class="linenos">1138</span></a>        <span class="c1"># We sum over each input function, just like the normal chain rule:</span>
</span><span id="Function-1139"><a href="#Function-1139"><span class="linenos">1139</span></a>        <span class="c1"># d/dx f(g₁(x), …, gₖ(x)) = Σᵢ₌₁ᵏ (d/dx gᵢ(x)) Dᵢf(g₁(x), …, gₖ(x))</span>
</span><span id="Function-1140"><a href="#Function-1140"><span class="linenos">1140</span></a>
</span><span id="Function-1141"><a href="#Function-1141"><span class="linenos">1141</span></a>        <span class="c1"># D_i adds a new output edge to the function, which is contracted with</span>
</span><span id="Function-1142"><a href="#Function-1142"><span class="linenos">1142</span></a>        <span class="c1"># the normal output edge of the tensor. So we need to make sure this doesn&#39;t</span>
</span><span id="Function-1143"><a href="#Function-1143"><span class="linenos">1143</span></a>        <span class="c1"># clash with an existing output edge of f.</span>
</span><span id="Function-1144"><a href="#Function-1144"><span class="linenos">1144</span></a>        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Function-1145"><a href="#Function-1145"><span class="linenos">1145</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">input_edges</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>
</span><span id="Function-1146"><a href="#Function-1146"><span class="linenos">1146</span></a>            <span class="c1"># Take the derivative of the outer function</span>
</span><span id="Function-1147"><a href="#Function-1147"><span class="linenos">1147</span></a>            <span class="c1"># We need &quot;connection&quot; edges for each edge in input_edges. Mostly we could just use the same name</span>
</span><span id="Function-1148"><a href="#Function-1148"><span class="linenos">1148</span></a>            <span class="c1"># but they need to avoid clashing with &quot;new_names&quot; and the output edges of the tensor.</span>
</span><span id="Function-1149"><a href="#Function-1149"><span class="linenos">1149</span></a>            <span class="n">connection_names</span> <span class="o">=</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">input_edges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">|</span> <span class="n">new_names</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="Function-1150"><a href="#Function-1150"><span class="linenos">1150</span></a>            <span class="c1"># Just like simple calculus, we need the derivative of the outside times the derivative of the inside</span>
</span><span id="Function-1151"><a href="#Function-1151"><span class="linenos">1151</span></a>            <span class="n">outside</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span>
</span><span id="Function-1152"><a href="#Function-1152"><span class="linenos">1152</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">connection_names</span><span class="p">),</span>
</span><span id="Function-1153"><a href="#Function-1153"><span class="linenos">1153</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span>
</span><span id="Function-1154"><a href="#Function-1154"><span class="linenos">1154</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span> <span class="o">|</span> <span class="p">{</span><span class="n">connection_names</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">input_edges</span><span class="p">},</span>
</span><span id="Function-1155"><a href="#Function-1155"><span class="linenos">1155</span></a>            <span class="p">)</span>
</span><span id="Function-1156"><a href="#Function-1156"><span class="linenos">1156</span></a>            <span class="k">assert</span> <span class="n">outside</span><span class="o">.</span><span class="n">edges</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">|</span> <span class="n">connection_names</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="Function-1157"><a href="#Function-1157"><span class="linenos">1157</span></a>
</span><span id="Function-1158"><a href="#Function-1158"><span class="linenos">1158</span></a>            <span class="c1"># The the derivative of the inner function</span>
</span><span id="Function-1159"><a href="#Function-1159"><span class="linenos">1159</span></a>            <span class="c1"># We rename the (former) input edges to the connection edges, but keep the remaining edges</span>
</span><span id="Function-1160"><a href="#Function-1160"><span class="linenos">1160</span></a>            <span class="c1"># (which are part of self.edges) untouched.</span>
</span><span id="Function-1161"><a href="#Function-1161"><span class="linenos">1161</span></a>            <span class="n">inner</span> <span class="o">=</span> <span class="n">Derivative</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">connection_names</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="Function-1162"><a href="#Function-1162"><span class="linenos">1162</span></a>
</span><span id="Function-1163"><a href="#Function-1163"><span class="linenos">1163</span></a>            <span class="c1"># The two parts are then multiplied together on the connection names,</span>
</span><span id="Function-1164"><a href="#Function-1164"><span class="linenos">1164</span></a>            <span class="c1"># while broadcasted on their remaining shared edges.</span>
</span><span id="Function-1165"><a href="#Function-1165"><span class="linenos">1165</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">tensorgrad.functions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>  <span class="c1"># Import here to avoid circular import</span>
</span><span id="Function-1166"><a href="#Function-1166"><span class="linenos">1166</span></a>
</span><span id="Function-1167"><a href="#Function-1167"><span class="linenos">1167</span></a>            <span class="n">part</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">outside</span> <span class="o">*</span> <span class="n">inner</span><span class="p">,</span> <span class="n">connection_names</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="Function-1168"><a href="#Function-1168"><span class="linenos">1168</span></a>            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
</span><span id="Function-1169"><a href="#Function-1169"><span class="linenos">1169</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span><span id="Function-1170"><a href="#Function-1170"><span class="linenos">1170</span></a>
</span><span id="Function-1171"><a href="#Function-1171"><span class="linenos">1171</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Function-1172"><a href="#Function-1172"><span class="linenos">1172</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Function-1173"><a href="#Function-1173"><span class="linenos">1173</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Function-1174"><a href="#Function-1174"><span class="linenos">1174</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Function-1175"><a href="#Function-1175"><span class="linenos">1175</span></a>        <span class="c1"># (1) We add a node for the &quot;function&quot; tensor itself</span>
</span><span id="Function-1176"><a href="#Function-1176"><span class="linenos">1176</span></a>        <span class="c1"># TODO: Why is this needed?</span>
</span><span id="Function-1177"><a href="#Function-1177"><span class="linenos">1177</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Function-1178"><a href="#Function-1178"><span class="linenos">1178</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Function-1179"><a href="#Function-1179"><span class="linenos">1179</span></a>        <span class="c1"># (2) We add a node for each output edge</span>
</span><span id="Function-1180"><a href="#Function-1180"><span class="linenos">1180</span></a>        <span class="c1"># TODO: We should group out-edges by the size-type, similarly to Variable/Constant</span>
</span><span id="Function-1181"><a href="#Function-1181"><span class="linenos">1181</span></a>        <span class="c1"># And of course when we add symmetries to outputs, we need to add that too.</span>
</span><span id="Function-1182"><a href="#Function-1182"><span class="linenos">1182</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">):</span>
</span><span id="Function-1183"><a href="#Function-1183"><span class="linenos">1183</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Edge Out&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span><span id="Function-1184"><a href="#Function-1184"><span class="linenos">1184</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Function-1185"><a href="#Function-1185"><span class="linenos">1185</span></a>            <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="Function-1186"><a href="#Function-1186"><span class="linenos">1186</span></a>        <span class="c1"># (3) And we add nodes for all the input tensors</span>
</span><span id="Function-1187"><a href="#Function-1187"><span class="linenos">1187</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">input_edges</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>
</span><span id="Function-1188"><a href="#Function-1188"><span class="linenos">1188</span></a>            <span class="c1"># Compute graph from input tensor, and ensure it uses distinct node numbers</span>
</span><span id="Function-1189"><a href="#Function-1189"><span class="linenos">1189</span></a>            <span class="c1"># Tag the inputs with {i} since order matters for function inputs.</span>
</span><span id="Function-1190"><a href="#Function-1190"><span class="linenos">1190</span></a>            <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Function-1191"><a href="#Function-1191"><span class="linenos">1191</span></a>            <span class="c1"># Connect tensor to function. We don&#39;t need to label here, since</span>
</span><span id="Function-1192"><a href="#Function-1192"><span class="linenos">1192</span></a>            <span class="c1"># the input tensor already has labeled its own edges as much as it needs to.</span>
</span><span id="Function-1193"><a href="#Function-1193"><span class="linenos">1193</span></a>            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">input_edges</span><span class="p">:</span>
</span><span id="Function-1194"><a href="#Function-1194"><span class="linenos">1194</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">t_edges</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Function-1195"><a href="#Function-1195"><span class="linenos">1195</span></a>            <span class="c1"># Finally register free edges</span>
</span><span id="Function-1196"><a href="#Function-1196"><span class="linenos">1196</span></a>            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="Function-1197"><a href="#Function-1197"><span class="linenos">1197</span></a>                <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_edges</span><span class="p">:</span>
</span><span id="Function-1198"><a href="#Function-1198"><span class="linenos">1198</span></a>                    <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
</span><span id="Function-1199"><a href="#Function-1199"><span class="linenos">1199</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="Function-1200"><a href="#Function-1200"><span class="linenos">1200</span></a>
</span><span id="Function-1201"><a href="#Function-1201"><span class="linenos">1201</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Function-1202"><a href="#Function-1202"><span class="linenos">1202</span></a>        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Function-1203"><a href="#Function-1203"><span class="linenos">1203</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">))</span>
</span><span id="Function-1204"><a href="#Function-1204"><span class="linenos">1204</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inputs=[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">))</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</span><span id="Function-1205"><a href="#Function-1205"><span class="linenos">1205</span></a>        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;shape_out=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Function-1206"><a href="#Function-1206"><span class="linenos">1206</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Function(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Function-1207"><a href="#Function-1207"><span class="linenos">1207</span></a>
</span><span id="Function-1208"><a href="#Function-1208"><span class="linenos">1208</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Function-1209"><a href="#Function-1209"><span class="linenos">1209</span></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="Function-1210"><a href="#Function-1210"><span class="linenos">1210</span></a>
</span><span id="Function-1211"><a href="#Function-1211"><span class="linenos">1211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Function-1212"><a href="#Function-1212"><span class="linenos">1212</span></a>        <span class="k">return</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A tensor that represents a function applied to one or more input tensors.</p>

<p>Attributes:
    signature: The FunctionSignature for this function.
    inputs: A list of input tensors.
    shape_out: A dictionary mapping output edge names to sizes.</p>
</div>


                            <div id="Function.__init__" class="classattr">
                                        <input id="Function.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Function</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">signature</span><span class="p">:</span> <span class="n"><a href="#FunctionSignature">FunctionSignature</a></span>,</span><span class="param">	<span class="n">inputs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n"><a href="#Tensor">Tensor</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">shape_out</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sympy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">Symbol</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="Function.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Function.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Function.__init__-1043"><a href="#Function.__init__-1043"><span class="linenos">1043</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="Function.__init__-1044"><a href="#Function.__init__-1044"><span class="linenos">1044</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Function.__init__-1045"><a href="#Function.__init__-1045"><span class="linenos">1045</span></a>        <span class="n">signature</span><span class="p">:</span> <span class="n">FunctionSignature</span><span class="p">,</span>
</span><span id="Function.__init__-1046"><a href="#Function.__init__-1046"><span class="linenos">1046</span></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span>
</span><span id="Function.__init__-1047"><a href="#Function.__init__-1047"><span class="linenos">1047</span></a>        <span class="n">shape_out</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Symbol</span><span class="p">],</span>
</span><span id="Function.__init__-1048"><a href="#Function.__init__-1048"><span class="linenos">1048</span></a>    <span class="p">):</span>
</span><span id="Function.__init__-1049"><a href="#Function.__init__-1049"><span class="linenos">1049</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Function.__init__-1050"><a href="#Function.__init__-1050"><span class="linenos">1050</span></a><span class="sd">        A function tensor that takes one or more input tensors and produces an output tensor.</span>
</span><span id="Function.__init__-1051"><a href="#Function.__init__-1051"><span class="linenos">1051</span></a>
</span><span id="Function.__init__-1052"><a href="#Function.__init__-1052"><span class="linenos">1052</span></a><span class="sd">        Args:</span>
</span><span id="Function.__init__-1053"><a href="#Function.__init__-1053"><span class="linenos">1053</span></a><span class="sd">            signature: The FunctionSignature defining this function, or a string giving the function name.</span>
</span><span id="Function.__init__-1054"><a href="#Function.__init__-1054"><span class="linenos">1054</span></a><span class="sd">            inputs: The input tensors and their input edge names. [(t0, e00, e01, ...), (t1, e10, ...), ...]</span>
</span><span id="Function.__init__-1055"><a href="#Function.__init__-1055"><span class="linenos">1055</span></a><span class="sd">            shape_out: The names of the output edges of this function.</span>
</span><span id="Function.__init__-1056"><a href="#Function.__init__-1056"><span class="linenos">1056</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Function.__init__-1057"><a href="#Function.__init__-1057"><span class="linenos">1057</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_shape</span><span class="p">([],</span> <span class="n">shape_out</span><span class="p">)</span>
</span><span id="Function.__init__-1058"><a href="#Function.__init__-1058"><span class="linenos">1058</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="Function.__init__-1059"><a href="#Function.__init__-1059"><span class="linenos">1059</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">signature</span>
</span><span id="Function.__init__-1060"><a href="#Function.__init__-1060"><span class="linenos">1060</span></a>
</span><span id="Function.__init__-1061"><a href="#Function.__init__-1061"><span class="linenos">1061</span></a>        <span class="c1"># Validation</span>
</span><span id="Function.__init__-1062"><a href="#Function.__init__-1062"><span class="linenos">1062</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">!=</span> <span class="n">signature</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="Function.__init__-1063"><a href="#Function.__init__-1063"><span class="linenos">1063</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signature doesn&#39;t match shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">=}</span><span class="s2"> != </span><span class="si">{</span><span class="n">signature</span><span class="o">.</span><span class="n">edges</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Function.__init__-1064"><a href="#Function.__init__-1064"><span class="linenos">1064</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="Function.__init__-1065"><a href="#Function.__init__-1065"><span class="linenos">1065</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2"> inputs, got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Function.__init__-1066"><a href="#Function.__init__-1066"><span class="linenos">1066</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">es</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="Function.__init__-1067"><a href="#Function.__init__-1067"><span class="linenos">1067</span></a>            <span class="k">if</span> <span class="n">es</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="Function.__init__-1068"><a href="#Function.__init__-1068"><span class="linenos">1068</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input edges </span><span class="si">{</span><span class="n">es</span><span class="si">}</span><span class="s2"> not subset of </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Function.__init__-1069"><a href="#Function.__init__-1069"><span class="linenos">1069</span></a>
</span><span id="Function.__init__-1070"><a href="#Function.__init__-1070"><span class="linenos">1070</span></a>        <span class="c1"># Build final shape = union of output edges + broadcast edges from each input</span>
</span><span id="Function.__init__-1071"><a href="#Function.__init__-1071"><span class="linenos">1071</span></a>        <span class="c1"># Note that this approach pushes all the broadcasted edges to the end of the shape.</span>
</span><span id="Function.__init__-1072"><a href="#Function.__init__-1072"><span class="linenos">1072</span></a>        <span class="c1"># But we don&#39;t care about the order of the edges, so it&#39;s fine.</span>
</span><span id="Function.__init__-1073"><a href="#Function.__init__-1073"><span class="linenos">1073</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">)</span>
</span><span id="Function.__init__-1074"><a href="#Function.__init__-1074"><span class="linenos">1074</span></a>        <span class="c1"># We allow &quot;broadcasting&quot; for edges that are not in fn_sig.inputs[i].</span>
</span><span id="Function.__init__-1075"><a href="#Function.__init__-1075"><span class="linenos">1075</span></a>        <span class="c1"># So if an input has edges that are not used, they&#39;re broadcasted.</span>
</span><span id="Function.__init__-1076"><a href="#Function.__init__-1076"><span class="linenos">1076</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">es</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">):</span>
</span><span id="Function.__init__-1077"><a href="#Function.__init__-1077"><span class="linenos">1077</span></a>            <span class="c1"># any edges in t.edges - es are &quot;broadcast&quot;</span>
</span><span id="Function.__init__-1078"><a href="#Function.__init__-1078"><span class="linenos">1078</span></a>            <span class="n">broadcast_edges</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span> <span class="o">-</span> <span class="n">es</span>
</span><span id="Function.__init__-1079"><a href="#Function.__init__-1079"><span class="linenos">1079</span></a>            <span class="k">if</span> <span class="n">broadcast_edges</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="Function.__init__-1080"><a href="#Function.__init__-1080"><span class="linenos">1080</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Broadcast edges must not be shared between inputs&quot;</span><span class="p">)</span>
</span><span id="Function.__init__-1081"><a href="#Function.__init__-1081"><span class="linenos">1081</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">broadcast_edges</span><span class="p">:</span>
</span><span id="Function.__init__-1082"><a href="#Function.__init__-1082"><span class="linenos">1082</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>A function tensor that takes one or more input tensors and produces an output tensor.</p>

<p>Args:
    signature: The FunctionSignature defining this function, or a string giving the function name.
    inputs: The input tensors and their input edge names. [(t0, e00, e01, ...), (t1, e10, ...), ...]
    shape_out: The names of the output edges of this function.</p>
</div>


                            </div>
                            <div id="Function.shape_out" class="classattr">
                                <div class="attr variable">
            <span class="name">shape_out</span>

        
    </div>
    <a class="headerlink" href="#Function.shape_out"></a>
    
    

                            </div>
                            <div id="Function.inputs" class="classattr">
                                <div class="attr variable">
            <span class="name">inputs</span>

        
    </div>
    <a class="headerlink" href="#Function.inputs"></a>
    
    

                            </div>
                            <div id="Function.signature" class="classattr">
                                <div class="attr variable">
            <span class="name">signature</span>

        
    </div>
    <a class="headerlink" href="#Function.signature"></a>
    
    

                            </div>
                            <div id="Function.structural_graph" class="classattr">
                                        <input id="Function.structural_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">structural_graph</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">networkx</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">multidigraph</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="Function.structural_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Function.structural_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Function.structural_graph-1171"><a href="#Function.structural_graph-1171"><span class="linenos">1171</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Function.structural_graph-1172"><a href="#Function.structural_graph-1172"><span class="linenos">1172</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Function.structural_graph-1173"><a href="#Function.structural_graph-1173"><span class="linenos">1173</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Function.structural_graph-1174"><a href="#Function.structural_graph-1174"><span class="linenos">1174</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Function.structural_graph-1175"><a href="#Function.structural_graph-1175"><span class="linenos">1175</span></a>        <span class="c1"># (1) We add a node for the &quot;function&quot; tensor itself</span>
</span><span id="Function.structural_graph-1176"><a href="#Function.structural_graph-1176"><span class="linenos">1176</span></a>        <span class="c1"># TODO: Why is this needed?</span>
</span><span id="Function.structural_graph-1177"><a href="#Function.structural_graph-1177"><span class="linenos">1177</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Function.structural_graph-1178"><a href="#Function.structural_graph-1178"><span class="linenos">1178</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Function.structural_graph-1179"><a href="#Function.structural_graph-1179"><span class="linenos">1179</span></a>        <span class="c1"># (2) We add a node for each output edge</span>
</span><span id="Function.structural_graph-1180"><a href="#Function.structural_graph-1180"><span class="linenos">1180</span></a>        <span class="c1"># TODO: We should group out-edges by the size-type, similarly to Variable/Constant</span>
</span><span id="Function.structural_graph-1181"><a href="#Function.structural_graph-1181"><span class="linenos">1181</span></a>        <span class="c1"># And of course when we add symmetries to outputs, we need to add that too.</span>
</span><span id="Function.structural_graph-1182"><a href="#Function.structural_graph-1182"><span class="linenos">1182</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_out</span><span class="p">):</span>
</span><span id="Function.structural_graph-1183"><a href="#Function.structural_graph-1183"><span class="linenos">1183</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Edge Out&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span><span id="Function.structural_graph-1184"><a href="#Function.structural_graph-1184"><span class="linenos">1184</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="Function.structural_graph-1185"><a href="#Function.structural_graph-1185"><span class="linenos">1185</span></a>            <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="Function.structural_graph-1186"><a href="#Function.structural_graph-1186"><span class="linenos">1186</span></a>        <span class="c1"># (3) And we add nodes for all the input tensors</span>
</span><span id="Function.structural_graph-1187"><a href="#Function.structural_graph-1187"><span class="linenos">1187</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">input_edges</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>
</span><span id="Function.structural_graph-1188"><a href="#Function.structural_graph-1188"><span class="linenos">1188</span></a>            <span class="c1"># Compute graph from input tensor, and ensure it uses distinct node numbers</span>
</span><span id="Function.structural_graph-1189"><a href="#Function.structural_graph-1189"><span class="linenos">1189</span></a>            <span class="c1"># Tag the inputs with {i} since order matters for function inputs.</span>
</span><span id="Function.structural_graph-1190"><a href="#Function.structural_graph-1190"><span class="linenos">1190</span></a>            <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Function.structural_graph-1191"><a href="#Function.structural_graph-1191"><span class="linenos">1191</span></a>            <span class="c1"># Connect tensor to function. We don&#39;t need to label here, since</span>
</span><span id="Function.structural_graph-1192"><a href="#Function.structural_graph-1192"><span class="linenos">1192</span></a>            <span class="c1"># the input tensor already has labeled its own edges as much as it needs to.</span>
</span><span id="Function.structural_graph-1193"><a href="#Function.structural_graph-1193"><span class="linenos">1193</span></a>            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">input_edges</span><span class="p">:</span>
</span><span id="Function.structural_graph-1194"><a href="#Function.structural_graph-1194"><span class="linenos">1194</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">t_edges</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Function.structural_graph-1195"><a href="#Function.structural_graph-1195"><span class="linenos">1195</span></a>            <span class="c1"># Finally register free edges</span>
</span><span id="Function.structural_graph-1196"><a href="#Function.structural_graph-1196"><span class="linenos">1196</span></a>            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="Function.structural_graph-1197"><a href="#Function.structural_graph-1197"><span class="linenos">1197</span></a>                <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_edges</span><span class="p">:</span>
</span><span id="Function.structural_graph-1198"><a href="#Function.structural_graph-1198"><span class="linenos">1198</span></a>                    <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
</span><span id="Function.structural_graph-1199"><a href="#Function.structural_graph-1199"><span class="linenos">1199</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span></pre></div>


            <div class="docstring"><p>Create a graph representation of the tensor, which can be used for isomorphism testing.</p>

<p>Returns:
    A tuple with the following values:
    - A NetworkX directed graph.
        - Each node in the top tree is labeled with the producing tensor.
        - Use name=hashable to label vertices
    - "edges", a dict of edge_name -> node id
    - Node 0 should be the root</p>
</div>


                            </div>
                            <div id="Function.depends_on" class="classattr">
                                        <input id="Function.depends_on-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">depends_on</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span><span class="p">:</span> <span class="n"><a href="#Variable">Variable</a></span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Function.depends_on-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Function.depends_on"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Function.depends_on-1208"><a href="#Function.depends_on-1208"><span class="linenos">1208</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Function.depends_on-1209"><a href="#Function.depends_on-1209"><span class="linenos">1209</span></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Check if this tensor depends on the variable x.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Tensor">Tensor</a></dt>
                                <dd id="Function.edges" class="variable"><a href="#Tensor.edges">edges</a></dd>
                <dd id="Function.shape" class="variable"><a href="#Tensor.shape">shape</a></dd>
                <dd id="Function.order" class="variable"><a href="#Tensor.order">order</a></dd>
                <dd id="Function.grad" class="function"><a href="#Tensor.grad">grad</a></dd>
                <dd id="Function.rename" class="function"><a href="#Tensor.rename">rename</a></dd>
                <dd id="Function.simplify" class="function"><a href="#Tensor.simplify">simplify</a></dd>
                <dd id="Function.full_simplify" class="function"><a href="#Tensor.full_simplify">full_simplify</a></dd>
                <dd id="Function.substitute" class="function"><a href="#Tensor.substitute">substitute</a></dd>
                <dd id="Function.weisfeiler_lehman" class="variable"><a href="#Tensor.weisfeiler_lehman">weisfeiler_lehman</a></dd>
                <dd id="Function.edge_structural_graph" class="function"><a href="#Tensor.edge_structural_graph">edge_structural_graph</a></dd>
                <dd id="Function.graph_to_string" class="function"><a href="#Tensor.graph_to_string">graph_to_string</a></dd>
                <dd id="Function.is_isomorphic" class="function"><a href="#Tensor.is_isomorphic">is_isomorphic</a></dd>
                <dd id="Function.isomorphisms" class="function"><a href="#Tensor.isomorphisms">isomorphisms</a></dd>
                <dd id="Function.symmetries" class="variable"><a href="#Tensor.symmetries">symmetries</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Derivative">
                            <input id="Derivative-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Derivative</span><wbr>(<span class="base"><a href="#Tensor">Tensor</a></span>):

                <label class="view-source-button" for="Derivative-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Derivative"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Derivative-1215"><a href="#Derivative-1215"><span class="linenos">1215</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Derivative</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Derivative-1216"><a href="#Derivative-1216"><span class="linenos">1216</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Derivative-1217"><a href="#Derivative-1217"><span class="linenos">1217</span></a><span class="sd">    A tensor representing the derivative of another tensor with respect to a variable.</span>
</span><span id="Derivative-1218"><a href="#Derivative-1218"><span class="linenos">1218</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Derivative-1219"><a href="#Derivative-1219"><span class="linenos">1219</span></a>
</span><span id="Derivative-1220"><a href="#Derivative-1220"><span class="linenos">1220</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">wrt</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Derivative-1221"><a href="#Derivative-1221"><span class="linenos">1221</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Derivative-1222"><a href="#Derivative-1222"><span class="linenos">1222</span></a><span class="sd">        A tensor representing the derivative of another tensor.</span>
</span><span id="Derivative-1223"><a href="#Derivative-1223"><span class="linenos">1223</span></a>
</span><span id="Derivative-1224"><a href="#Derivative-1224"><span class="linenos">1224</span></a><span class="sd">        Args:</span>
</span><span id="Derivative-1225"><a href="#Derivative-1225"><span class="linenos">1225</span></a><span class="sd">            tensor: The tensor to differentiate.</span>
</span><span id="Derivative-1226"><a href="#Derivative-1226"><span class="linenos">1226</span></a><span class="sd">            x: The variable with respect to which to differentiate.</span>
</span><span id="Derivative-1227"><a href="#Derivative-1227"><span class="linenos">1227</span></a><span class="sd">            new_names: A mapping for renaming edges (if not provided, it will be generated).</span>
</span><span id="Derivative-1228"><a href="#Derivative-1228"><span class="linenos">1228</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Derivative-1229"><a href="#Derivative-1229"><span class="linenos">1229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span> <span class="o">=</span> <span class="n">tensor</span>
</span><span id="Derivative-1230"><a href="#Derivative-1230"><span class="linenos">1230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">wrt</span>
</span><span id="Derivative-1231"><a href="#Derivative-1231"><span class="linenos">1231</span></a>        <span class="c1"># If no edges were given, pick some names based on x, but avoid clashes with tensor.</span>
</span><span id="Derivative-1232"><a href="#Derivative-1232"><span class="linenos">1232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">_check_grad</span><span class="p">(</span><span class="n">wrt</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="Derivative-1233"><a href="#Derivative-1233"><span class="linenos">1233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span> <span class="o">|</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span> <span class="n">wrt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">wrt</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Derivative-1234"><a href="#Derivative-1234"><span class="linenos">1234</span></a>
</span><span id="Derivative-1235"><a href="#Derivative-1235"><span class="linenos">1235</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Derivative-1236"><a href="#Derivative-1236"><span class="linenos">1236</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
</span><span id="Derivative-1237"><a href="#Derivative-1237"><span class="linenos">1237</span></a>            <span class="k">return</span> <span class="n">Zero</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Derivative-1238"><a href="#Derivative-1238"><span class="linenos">1238</span></a>        <span class="n">inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="Derivative-1239"><a href="#Derivative-1239"><span class="linenos">1239</span></a>        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;grad_steps&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Derivative-1240"><a href="#Derivative-1240"><span class="linenos">1240</span></a>            <span class="c1"># If grad_steps is 0, we pass the simplify through the derivative.</span>
</span><span id="Derivative-1241"><a href="#Derivative-1241"><span class="linenos">1241</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">Derivative</span><span class="p">(</span><span class="n">inner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="p">)</span>
</span><span id="Derivative-1242"><a href="#Derivative-1242"><span class="linenos">1242</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Derivative-1243"><a href="#Derivative-1243"><span class="linenos">1243</span></a>            <span class="n">args</span><span class="p">[</span><span class="s2">&quot;grad_steps&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="Derivative-1244"><a href="#Derivative-1244"><span class="linenos">1244</span></a>            <span class="c1"># Have to call simplify twice to avoid an infinite loop when stacking multiple derivatives.</span>
</span><span id="Derivative-1245"><a href="#Derivative-1245"><span class="linenos">1245</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">inner</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="p">)</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="Derivative-1246"><a href="#Derivative-1246"><span class="linenos">1246</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="Derivative-1247"><a href="#Derivative-1247"><span class="linenos">1247</span></a>
</span><span id="Derivative-1248"><a href="#Derivative-1248"><span class="linenos">1248</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Derivative-1249"><a href="#Derivative-1249"><span class="linenos">1249</span></a>        <span class="c1"># To avoid an infinite loop, we let the grad pass through us, rather than creating a double derivative.</span>
</span><span id="Derivative-1250"><a href="#Derivative-1250"><span class="linenos">1250</span></a>        <span class="k">return</span> <span class="n">Derivative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="p">)</span>
</span><span id="Derivative-1251"><a href="#Derivative-1251"><span class="linenos">1251</span></a>
</span><span id="Derivative-1252"><a href="#Derivative-1252"><span class="linenos">1252</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Derivative-1253"><a href="#Derivative-1253"><span class="linenos">1253</span></a>        <span class="c1"># The free edges of Derivative are both the free edges of self.tensor and the new_names.</span>
</span><span id="Derivative-1254"><a href="#Derivative-1254"><span class="linenos">1254</span></a>        <span class="c1"># This is the only place where we need to rename the &quot;internal edges&quot; of the tensor.</span>
</span><span id="Derivative-1255"><a href="#Derivative-1255"><span class="linenos">1255</span></a>        <span class="k">return</span> <span class="n">Derivative</span><span class="p">(</span>
</span><span id="Derivative-1256"><a href="#Derivative-1256"><span class="linenos">1256</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span>
</span><span id="Derivative-1257"><a href="#Derivative-1257"><span class="linenos">1257</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
</span><span id="Derivative-1258"><a href="#Derivative-1258"><span class="linenos">1258</span></a>            <span class="p">{</span><span class="n">o</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
</span><span id="Derivative-1259"><a href="#Derivative-1259"><span class="linenos">1259</span></a>        <span class="p">)</span>
</span><span id="Derivative-1260"><a href="#Derivative-1260"><span class="linenos">1260</span></a>
</span><span id="Derivative-1261"><a href="#Derivative-1261"><span class="linenos">1261</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Derivative-1262"><a href="#Derivative-1262"><span class="linenos">1262</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Derivative-1263"><a href="#Derivative-1263"><span class="linenos">1263</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Derivative&quot;</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Derivative-1264"><a href="#Derivative-1264"><span class="linenos">1264</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Derivative-1265"><a href="#Derivative-1265"><span class="linenos">1265</span></a>        <span class="c1"># We add a node for the &quot;wrt&quot; tensor</span>
</span><span id="Derivative-1266"><a href="#Derivative-1266"><span class="linenos">1266</span></a>        <span class="c1"># and connect new_edges to point to the respective edges in self.x</span>
</span><span id="Derivative-1267"><a href="#Derivative-1267"><span class="linenos">1267</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">x_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="o">=</span><span class="s2">&quot;self.x&quot;</span><span class="p">)</span>
</span><span id="Derivative-1268"><a href="#Derivative-1268"><span class="linenos">1268</span></a>        <span class="n">edges</span> <span class="o">|=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">oe</span><span class="p">]</span> <span class="k">for</span> <span class="n">oe</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Derivative-1269"><a href="#Derivative-1269"><span class="linenos">1269</span></a>        <span class="c1"># Then we add the differentiated tensor</span>
</span><span id="Derivative-1270"><a href="#Derivative-1270"><span class="linenos">1270</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="o">=</span><span class="s2">&quot;self.tensor&quot;</span><span class="p">)</span>
</span><span id="Derivative-1271"><a href="#Derivative-1271"><span class="linenos">1271</span></a>        <span class="n">edges</span> <span class="o">|=</span> <span class="n">t_edges</span>
</span><span id="Derivative-1272"><a href="#Derivative-1272"><span class="linenos">1272</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Derivative-1273"><a href="#Derivative-1273"><span class="linenos">1273</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="Derivative-1274"><a href="#Derivative-1274"><span class="linenos">1274</span></a>
</span><span id="Derivative-1275"><a href="#Derivative-1275"><span class="linenos">1275</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Derivative-1276"><a href="#Derivative-1276"><span class="linenos">1276</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Derivative(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Derivative-1277"><a href="#Derivative-1277"><span class="linenos">1277</span></a>
</span><span id="Derivative-1278"><a href="#Derivative-1278"><span class="linenos">1278</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Derivative-1279"><a href="#Derivative-1279"><span class="linenos">1279</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A tensor representing the derivative of another tensor with respect to a variable.</p>
</div>


                            <div id="Derivative.__init__" class="classattr">
                                        <input id="Derivative.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Derivative</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">tensor</span><span class="p">:</span> <span class="n"><a href="#Tensor">Tensor</a></span>,</span><span class="param">	<span class="n">wrt</span><span class="p">:</span> <span class="n"><a href="#Variable">Variable</a></span>,</span><span class="param">	<span class="n">new_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Derivative.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Derivative.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Derivative.__init__-1220"><a href="#Derivative.__init__-1220"><span class="linenos">1220</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">wrt</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Derivative.__init__-1221"><a href="#Derivative.__init__-1221"><span class="linenos">1221</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Derivative.__init__-1222"><a href="#Derivative.__init__-1222"><span class="linenos">1222</span></a><span class="sd">        A tensor representing the derivative of another tensor.</span>
</span><span id="Derivative.__init__-1223"><a href="#Derivative.__init__-1223"><span class="linenos">1223</span></a>
</span><span id="Derivative.__init__-1224"><a href="#Derivative.__init__-1224"><span class="linenos">1224</span></a><span class="sd">        Args:</span>
</span><span id="Derivative.__init__-1225"><a href="#Derivative.__init__-1225"><span class="linenos">1225</span></a><span class="sd">            tensor: The tensor to differentiate.</span>
</span><span id="Derivative.__init__-1226"><a href="#Derivative.__init__-1226"><span class="linenos">1226</span></a><span class="sd">            x: The variable with respect to which to differentiate.</span>
</span><span id="Derivative.__init__-1227"><a href="#Derivative.__init__-1227"><span class="linenos">1227</span></a><span class="sd">            new_names: A mapping for renaming edges (if not provided, it will be generated).</span>
</span><span id="Derivative.__init__-1228"><a href="#Derivative.__init__-1228"><span class="linenos">1228</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Derivative.__init__-1229"><a href="#Derivative.__init__-1229"><span class="linenos">1229</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span> <span class="o">=</span> <span class="n">tensor</span>
</span><span id="Derivative.__init__-1230"><a href="#Derivative.__init__-1230"><span class="linenos">1230</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">wrt</span>
</span><span id="Derivative.__init__-1231"><a href="#Derivative.__init__-1231"><span class="linenos">1231</span></a>        <span class="c1"># If no edges were given, pick some names based on x, but avoid clashes with tensor.</span>
</span><span id="Derivative.__init__-1232"><a href="#Derivative.__init__-1232"><span class="linenos">1232</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">_check_grad</span><span class="p">(</span><span class="n">wrt</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="Derivative.__init__-1233"><a href="#Derivative.__init__-1233"><span class="linenos">1233</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span> <span class="o">|</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span> <span class="n">wrt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">wrt</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>A tensor representing the derivative of another tensor.</p>

<p>Args:
    tensor: The tensor to differentiate.
    x: The variable with respect to which to differentiate.
    new_names: A mapping for renaming edges (if not provided, it will be generated).</p>
</div>


                            </div>
                            <div id="Derivative.tensor" class="classattr">
                                <div class="attr variable">
            <span class="name">tensor</span>

        
    </div>
    <a class="headerlink" href="#Derivative.tensor"></a>
    
    

                            </div>
                            <div id="Derivative.x" class="classattr">
                                <div class="attr variable">
            <span class="name">x</span>

        
    </div>
    <a class="headerlink" href="#Derivative.x"></a>
    
    

                            </div>
                            <div id="Derivative.new_names" class="classattr">
                                <div class="attr variable">
            <span class="name">new_names</span>

        
    </div>
    <a class="headerlink" href="#Derivative.new_names"></a>
    
    

                            </div>
                            <div id="Derivative.structural_graph" class="classattr">
                                        <input id="Derivative.structural_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">structural_graph</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">networkx</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">multidigraph</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="Derivative.structural_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Derivative.structural_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Derivative.structural_graph-1261"><a href="#Derivative.structural_graph-1261"><span class="linenos">1261</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Derivative.structural_graph-1262"><a href="#Derivative.structural_graph-1262"><span class="linenos">1262</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Derivative.structural_graph-1263"><a href="#Derivative.structural_graph-1263"><span class="linenos">1263</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Derivative&quot;</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Derivative.structural_graph-1264"><a href="#Derivative.structural_graph-1264"><span class="linenos">1264</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Derivative.structural_graph-1265"><a href="#Derivative.structural_graph-1265"><span class="linenos">1265</span></a>        <span class="c1"># We add a node for the &quot;wrt&quot; tensor</span>
</span><span id="Derivative.structural_graph-1266"><a href="#Derivative.structural_graph-1266"><span class="linenos">1266</span></a>        <span class="c1"># and connect new_edges to point to the respective edges in self.x</span>
</span><span id="Derivative.structural_graph-1267"><a href="#Derivative.structural_graph-1267"><span class="linenos">1267</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">x_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="o">=</span><span class="s2">&quot;self.x&quot;</span><span class="p">)</span>
</span><span id="Derivative.structural_graph-1268"><a href="#Derivative.structural_graph-1268"><span class="linenos">1268</span></a>        <span class="n">edges</span> <span class="o">|=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">oe</span><span class="p">]</span> <span class="k">for</span> <span class="n">oe</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_names</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="Derivative.structural_graph-1269"><a href="#Derivative.structural_graph-1269"><span class="linenos">1269</span></a>        <span class="c1"># Then we add the differentiated tensor</span>
</span><span id="Derivative.structural_graph-1270"><a href="#Derivative.structural_graph-1270"><span class="linenos">1270</span></a>        <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="o">=</span><span class="s2">&quot;self.tensor&quot;</span><span class="p">)</span>
</span><span id="Derivative.structural_graph-1271"><a href="#Derivative.structural_graph-1271"><span class="linenos">1271</span></a>        <span class="n">edges</span> <span class="o">|=</span> <span class="n">t_edges</span>
</span><span id="Derivative.structural_graph-1272"><a href="#Derivative.structural_graph-1272"><span class="linenos">1272</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Derivative.structural_graph-1273"><a href="#Derivative.structural_graph-1273"><span class="linenos">1273</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span></pre></div>


            <div class="docstring"><p>Create a graph representation of the tensor, which can be used for isomorphism testing.</p>

<p>Returns:
    A tuple with the following values:
    - A NetworkX directed graph.
        - Each node in the top tree is labeled with the producing tensor.
        - Use name=hashable to label vertices
    - "edges", a dict of edge_name -> node id
    - Node 0 should be the root</p>
</div>


                            </div>
                            <div id="Derivative.depends_on" class="classattr">
                                        <input id="Derivative.depends_on-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">depends_on</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span><span class="p">:</span> <span class="n"><a href="#Variable">Variable</a></span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Derivative.depends_on-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Derivative.depends_on"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Derivative.depends_on-1278"><a href="#Derivative.depends_on-1278"><span class="linenos">1278</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Derivative.depends_on-1279"><a href="#Derivative.depends_on-1279"><span class="linenos">1279</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Check if this tensor depends on the variable x.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Tensor">Tensor</a></dt>
                                <dd id="Derivative.edges" class="variable"><a href="#Tensor.edges">edges</a></dd>
                <dd id="Derivative.shape" class="variable"><a href="#Tensor.shape">shape</a></dd>
                <dd id="Derivative.order" class="variable"><a href="#Tensor.order">order</a></dd>
                <dd id="Derivative.grad" class="function"><a href="#Tensor.grad">grad</a></dd>
                <dd id="Derivative.rename" class="function"><a href="#Tensor.rename">rename</a></dd>
                <dd id="Derivative.simplify" class="function"><a href="#Tensor.simplify">simplify</a></dd>
                <dd id="Derivative.full_simplify" class="function"><a href="#Tensor.full_simplify">full_simplify</a></dd>
                <dd id="Derivative.substitute" class="function"><a href="#Tensor.substitute">substitute</a></dd>
                <dd id="Derivative.weisfeiler_lehman" class="variable"><a href="#Tensor.weisfeiler_lehman">weisfeiler_lehman</a></dd>
                <dd id="Derivative.edge_structural_graph" class="function"><a href="#Tensor.edge_structural_graph">edge_structural_graph</a></dd>
                <dd id="Derivative.graph_to_string" class="function"><a href="#Tensor.graph_to_string">graph_to_string</a></dd>
                <dd id="Derivative.is_isomorphic" class="function"><a href="#Tensor.is_isomorphic">is_isomorphic</a></dd>
                <dd id="Derivative.isomorphisms" class="function"><a href="#Tensor.isomorphisms">isomorphisms</a></dd>
                <dd id="Derivative.symmetries" class="variable"><a href="#Tensor.symmetries">symmetries</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Product">
                            <input id="Product-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Product</span><wbr>(<span class="base"><a href="#Tensor">Tensor</a></span>):

                <label class="view-source-button" for="Product-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Product"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Product-1287"><a href="#Product-1287"><span class="linenos">1287</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Product-1288"><a href="#Product-1288"><span class="linenos">1288</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Product-1289"><a href="#Product-1289"><span class="linenos">1289</span></a><span class="sd">    A tensor representing the product (contraction) of several tensors.</span>
</span><span id="Product-1290"><a href="#Product-1290"><span class="linenos">1290</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Product-1291"><a href="#Product-1291"><span class="linenos">1291</span></a>
</span><span id="Product-1292"><a href="#Product-1292"><span class="linenos">1292</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factors</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]):</span>
</span><span id="Product-1293"><a href="#Product-1293"><span class="linenos">1293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Product-1294"><a href="#Product-1294"><span class="linenos">1294</span></a><span class="sd">        Initialize a Product tensor.</span>
</span><span id="Product-1295"><a href="#Product-1295"><span class="linenos">1295</span></a>
</span><span id="Product-1296"><a href="#Product-1296"><span class="linenos">1296</span></a><span class="sd">        Args:</span>
</span><span id="Product-1297"><a href="#Product-1297"><span class="linenos">1297</span></a><span class="sd">            factors: An iterable of tensors to be multiplied/contracted.</span>
</span><span id="Product-1298"><a href="#Product-1298"><span class="linenos">1298</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Product-1299"><a href="#Product-1299"><span class="linenos">1299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>
</span><span id="Product-1300"><a href="#Product-1300"><span class="linenos">1300</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Product-1301"><a href="#Product-1301"><span class="linenos">1301</span></a>        <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">_group_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Product-1302"><a href="#Product-1302"><span class="linenos">1302</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Product-1303"><a href="#Product-1303"><span class="linenos">1303</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span>
</span><span id="Product-1304"><a href="#Product-1304"><span class="linenos">1304</span></a>            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Product-1305"><a href="#Product-1305"><span class="linenos">1305</span></a>                <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">]</span>
</span><span id="Product-1306"><a href="#Product-1306"><span class="linenos">1306</span></a>                <span class="k">if</span> <span class="n">s1</span> <span class="o">!=</span> <span class="n">s2</span><span class="p">:</span>
</span><span id="Product-1307"><a href="#Product-1307"><span class="linenos">1307</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edge </span><span class="si">{</span><span class="n">edge</span><span class="si">}</span><span class="s2"> has different sizes, </span><span class="si">{</span><span class="n">s1</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">s2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Product-1308"><a href="#Product-1308"><span class="linenos">1308</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Product-1309"><a href="#Product-1309"><span class="linenos">1309</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Product-1310"><a href="#Product-1310"><span class="linenos">1310</span></a>                    <span class="sa">f</span><span class="s2">&quot;edge </span><span class="si">{</span><span class="n">edge</span><span class="si">}</span><span class="s2"> had multiplicity </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="si">}</span><span class="s2">. Use an identity tensor to combine multiple edges.&quot;</span>
</span><span id="Product-1311"><a href="#Product-1311"><span class="linenos">1311</span></a>                <span class="p">)</span>
</span><span id="Product-1312"><a href="#Product-1312"><span class="linenos">1312</span></a>
</span><span id="Product-1313"><a href="#Product-1313"><span class="linenos">1313</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Product-1314"><a href="#Product-1314"><span class="linenos">1314</span></a>        <span class="c1"># Rename the inner edges (contractions) to avoid the new names introduced</span>
</span><span id="Product-1315"><a href="#Product-1315"><span class="linenos">1315</span></a>        <span class="c1"># by the renaming of the free edges.</span>
</span><span id="Product-1316"><a href="#Product-1316"><span class="linenos">1316</span></a>        <span class="n">new_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Product-1317"><a href="#Product-1317"><span class="linenos">1317</span></a>        <span class="n">contractions</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Product-1318"><a href="#Product-1318"><span class="linenos">1318</span></a>        <span class="c1"># Note the `unused_edge_names` function avoids introducing new clashes</span>
</span><span id="Product-1319"><a href="#Product-1319"><span class="linenos">1319</span></a>        <span class="c1"># between the edges being renamed.</span>
</span><span id="Product-1320"><a href="#Product-1320"><span class="linenos">1320</span></a>        <span class="n">rename</span> <span class="o">=</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">contractions</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span>
</span><span id="Product-1321"><a href="#Product-1321"><span class="linenos">1321</span></a>        <span class="c1"># It&#39;s safe to add the kwargs to rename, since self._check_rename restricts kwargs to only</span>
</span><span id="Product-1322"><a href="#Product-1322"><span class="linenos">1322</span></a>        <span class="c1"># contain keys that are in self.edges.</span>
</span><span id="Product-1323"><a href="#Product-1323"><span class="linenos">1323</span></a>        <span class="n">rename</span> <span class="o">|=</span> <span class="n">kwargs</span>
</span><span id="Product-1324"><a href="#Product-1324"><span class="linenos">1324</span></a>        <span class="k">return</span> <span class="n">Product</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">rename</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">])</span>
</span><span id="Product-1325"><a href="#Product-1325"><span class="linenos">1325</span></a>
</span><span id="Product-1326"><a href="#Product-1326"><span class="linenos">1326</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Product-1327"><a href="#Product-1327"><span class="linenos">1327</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="n">products</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Product&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Product&quot;</span><span class="p">:</span>
</span><span id="Product-1328"><a href="#Product-1328"><span class="linenos">1328</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Product-1329"><a href="#Product-1329"><span class="linenos">1329</span></a><span class="sd">        Merge several Product tensors into one, renaming inner edges so they are distinct.</span>
</span><span id="Product-1330"><a href="#Product-1330"><span class="linenos">1330</span></a>
</span><span id="Product-1331"><a href="#Product-1331"><span class="linenos">1331</span></a><span class="sd">        Args:</span>
</span><span id="Product-1332"><a href="#Product-1332"><span class="linenos">1332</span></a><span class="sd">            products: A list of Product tensors.</span>
</span><span id="Product-1333"><a href="#Product-1333"><span class="linenos">1333</span></a>
</span><span id="Product-1334"><a href="#Product-1334"><span class="linenos">1334</span></a><span class="sd">        Returns:</span>
</span><span id="Product-1335"><a href="#Product-1335"><span class="linenos">1335</span></a><span class="sd">            A new Product tensor merging the inputs.</span>
</span><span id="Product-1336"><a href="#Product-1336"><span class="linenos">1336</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Product-1337"><a href="#Product-1337"><span class="linenos">1337</span></a>        <span class="n">used_edges</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Product-1338"><a href="#Product-1338"><span class="linenos">1338</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Product-1339"><a href="#Product-1339"><span class="linenos">1339</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
</span><span id="Product-1340"><a href="#Product-1340"><span class="linenos">1340</span></a>            <span class="c1"># Maybe this could also be expressed in terms of avoid_internal_edges</span>
</span><span id="Product-1341"><a href="#Product-1341"><span class="linenos">1341</span></a>            <span class="n">inner_edges</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">factors</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Product-1342"><a href="#Product-1342"><span class="linenos">1342</span></a>            <span class="n">rename</span> <span class="o">=</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">inner_edges</span><span class="p">,</span> <span class="n">used_edges</span><span class="p">)</span>
</span><span id="Product-1343"><a href="#Product-1343"><span class="linenos">1343</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
</span><span id="Product-1344"><a href="#Product-1344"><span class="linenos">1344</span></a>                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">rename</span><span class="p">))</span>
</span><span id="Product-1345"><a href="#Product-1345"><span class="linenos">1345</span></a>            <span class="n">used_edges</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rename</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>  <span class="c1"># Later renames should not clash with this one</span>
</span><span id="Product-1346"><a href="#Product-1346"><span class="linenos">1346</span></a>        <span class="k">return</span> <span class="n">Product</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="Product-1347"><a href="#Product-1347"><span class="linenos">1347</span></a>
</span><span id="Product-1348"><a href="#Product-1348"><span class="linenos">1348</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Product-1349"><a href="#Product-1349"><span class="linenos">1349</span></a>        <span class="c1"># Since we are adding new edges to an internal tensor in the product, we need to make sure</span>
</span><span id="Product-1350"><a href="#Product-1350"><span class="linenos">1350</span></a>        <span class="c1"># none of the other tensors in the product have edges that clash with these new edges.</span>
</span><span id="Product-1351"><a href="#Product-1351"><span class="linenos">1351</span></a>        <span class="n">inner_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Product-1352"><a href="#Product-1352"><span class="linenos">1352</span></a>        <span class="n">new_edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_names</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Product-1353"><a href="#Product-1353"><span class="linenos">1353</span></a>        <span class="n">rename</span> <span class="o">=</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">inner_names</span><span class="p">,</span> <span class="n">new_edges</span><span class="p">)</span>
</span><span id="Product-1354"><a href="#Product-1354"><span class="linenos">1354</span></a>        <span class="n">new_prod</span> <span class="o">=</span> <span class="n">Product</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">rename</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">])</span>
</span><span id="Product-1355"><a href="#Product-1355"><span class="linenos">1355</span></a>        <span class="k">assert</span> <span class="n">new_prod</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;Renaming should not change the product&quot;</span>
</span><span id="Product-1356"><a href="#Product-1356"><span class="linenos">1356</span></a>
</span><span id="Product-1357"><a href="#Product-1357"><span class="linenos">1357</span></a>        <span class="c1"># The classic product rule of Calculus: d/dx (f * g) = f&#39; * g + f * g&#39;</span>
</span><span id="Product-1358"><a href="#Product-1358"><span class="linenos">1358</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">(</span>
</span><span id="Product-1359"><a href="#Product-1359"><span class="linenos">1359</span></a>            <span class="p">[</span>
</span><span id="Product-1360"><a href="#Product-1360"><span class="linenos">1360</span></a>                <span class="n">Product</span><span class="p">(</span><span class="n">new_prod</span><span class="o">.</span><span class="n">factors</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">Derivative</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)]</span> <span class="o">+</span> <span class="n">new_prod</span><span class="o">.</span><span class="n">factors</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:])</span>
</span><span id="Product-1361"><a href="#Product-1361"><span class="linenos">1361</span></a>                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_prod</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span>
</span><span id="Product-1362"><a href="#Product-1362"><span class="linenos">1362</span></a>            <span class="p">]</span>
</span><span id="Product-1363"><a href="#Product-1363"><span class="linenos">1363</span></a>        <span class="p">)</span>
</span><span id="Product-1364"><a href="#Product-1364"><span class="linenos">1364</span></a>
</span><span id="Product-1365"><a href="#Product-1365"><span class="linenos">1365</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Product-1366"><a href="#Product-1366"><span class="linenos">1366</span></a>        <span class="k">return</span> <span class="n">Product</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">])</span>
</span><span id="Product-1367"><a href="#Product-1367"><span class="linenos">1367</span></a>
</span><span id="Product-1368"><a href="#Product-1368"><span class="linenos">1368</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Product-1369"><a href="#Product-1369"><span class="linenos">1369</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Product-1370"><a href="#Product-1370"><span class="linenos">1370</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Product(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Product-1371"><a href="#Product-1371"><span class="linenos">1371</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Product-1372"><a href="#Product-1372"><span class="linenos">1372</span></a>            <span class="n">inner</span> <span class="o">=</span> <span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span>
</span><span id="Product-1373"><a href="#Product-1373"><span class="linenos">1373</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Product([</span><span class="se">\n</span><span class="si">{</span><span class="n">inner</span><span class="si">}</span><span class="se">\n</span><span class="s2">])&quot;</span>
</span><span id="Product-1374"><a href="#Product-1374"><span class="linenos">1374</span></a>
</span><span id="Product-1375"><a href="#Product-1375"><span class="linenos">1375</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Product-1376"><a href="#Product-1376"><span class="linenos">1376</span></a>        <span class="n">tensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">]</span>
</span><span id="Product-1377"><a href="#Product-1377"><span class="linenos">1377</span></a>
</span><span id="Product-1378"><a href="#Product-1378"><span class="linenos">1378</span></a>        <span class="c1"># If any tensor in a product is 0, so is the whole product</span>
</span><span id="Product-1379"><a href="#Product-1379"><span class="linenos">1379</span></a>        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Zero</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">):</span>
</span><span id="Product-1380"><a href="#Product-1380"><span class="linenos">1380</span></a>            <span class="k">return</span> <span class="n">Zero</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Product-1381"><a href="#Product-1381"><span class="linenos">1381</span></a>
</span><span id="Product-1382"><a href="#Product-1382"><span class="linenos">1382</span></a>        <span class="c1"># Decide whether to push products through sums. This can be useful to simplify networks for</span>
</span><span id="Product-1383"><a href="#Product-1383"><span class="linenos">1383</span></a>        <span class="c1"># presentation, but it can also blow up the number of terms. So we make it optional.</span>
</span><span id="Product-1384"><a href="#Product-1384"><span class="linenos">1384</span></a>        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distributed_products&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="Product-1385"><a href="#Product-1385"><span class="linenos">1385</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Not implemented yet&quot;</span><span class="p">)</span>
</span><span id="Product-1386"><a href="#Product-1386"><span class="linenos">1386</span></a>
</span><span id="Product-1387"><a href="#Product-1387"><span class="linenos">1387</span></a>        <span class="c1"># Combine nested products. Note that not combining products may be useful to keep the</span>
</span><span id="Product-1388"><a href="#Product-1388"><span class="linenos">1388</span></a>        <span class="c1"># &quot;natural&quot; contraction order. This can speed up evaluation, since sub-tensors can be reused.</span>
</span><span id="Product-1389"><a href="#Product-1389"><span class="linenos">1389</span></a>        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;associative_products&quot;</span><span class="p">]:</span>
</span><span id="Product-1390"><a href="#Product-1390"><span class="linenos">1390</span></a>            <span class="n">sub_products</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Product</span><span class="p">)</span> <span class="k">else</span> <span class="n">Product</span><span class="p">([</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">]</span>
</span><span id="Product-1391"><a href="#Product-1391"><span class="linenos">1391</span></a>            <span class="n">tensors</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sub_products</span><span class="p">)</span><span class="o">.</span><span class="n">factors</span>
</span><span id="Product-1392"><a href="#Product-1392"><span class="linenos">1392</span></a>
</span><span id="Product-1393"><a href="#Product-1393"><span class="linenos">1393</span></a>        <span class="c1"># We can do a &quot;small&quot; kind of distributed products, which is handling children that are single sums</span>
</span><span id="Product-1394"><a href="#Product-1394"><span class="linenos">1394</span></a>        <span class="c1"># Also, if a child is a sum with a single element, we can pull the weight up.</span>
</span><span id="Product-1395"><a href="#Product-1395"><span class="linenos">1395</span></a>        <span class="c1"># In general, we can pull out the least common multiple of the weights of the children.</span>
</span><span id="Product-1396"><a href="#Product-1396"><span class="linenos">1396</span></a>        <span class="k">if</span> <span class="n">single_sums</span> <span class="o">:=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Sum</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">terms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="Product-1397"><a href="#Product-1397"><span class="linenos">1397</span></a>            <span class="n">tensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">single_sums</span> <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">]</span>
</span><span id="Product-1398"><a href="#Product-1398"><span class="linenos">1398</span></a>            <span class="n">res_weight</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">single_sums</span><span class="p">)</span>
</span><span id="Product-1399"><a href="#Product-1399"><span class="linenos">1399</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Product-1400"><a href="#Product-1400"><span class="linenos">1400</span></a>            <span class="n">res_weight</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Product-1401"><a href="#Product-1401"><span class="linenos">1401</span></a>
</span><span id="Product-1402"><a href="#Product-1402"><span class="linenos">1402</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">verify_edges</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Product-1403"><a href="#Product-1403"><span class="linenos">1403</span></a>            <span class="n">cnt</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">e</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="Product-1404"><a href="#Product-1404"><span class="linenos">1404</span></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="n">cnt</span> <span class="ow">or</span> <span class="n">cnt</span><span class="o">.</span><span class="n">most_common</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">msg</span>
</span><span id="Product-1405"><a href="#Product-1405"><span class="linenos">1405</span></a>
</span><span id="Product-1406"><a href="#Product-1406"><span class="linenos">1406</span></a>        <span class="c1"># Simplify Delta Tensors</span>
</span><span id="Product-1407"><a href="#Product-1407"><span class="linenos">1407</span></a>        <span class="n">verify_edges</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="Product-1408"><a href="#Product-1408"><span class="linenos">1408</span></a>        <span class="n">tensors</span> <span class="o">=</span> <span class="n">Delta</span><span class="o">.</span><span class="n">simplify_outer</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="Product-1409"><a href="#Product-1409"><span class="linenos">1409</span></a>        <span class="n">verify_edges</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="Product-1410"><a href="#Product-1410"><span class="linenos">1410</span></a>
</span><span id="Product-1411"><a href="#Product-1411"><span class="linenos">1411</span></a>        <span class="c1"># Combine / Cancel Product Functions</span>
</span><span id="Product-1412"><a href="#Product-1412"><span class="linenos">1412</span></a>        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;combine_products&quot;</span><span class="p">]:</span>
</span><span id="Product-1413"><a href="#Product-1413"><span class="linenos">1413</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">tensorgrad.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">_PowerFunction</span>
</span><span id="Product-1414"><a href="#Product-1414"><span class="linenos">1414</span></a>
</span><span id="Product-1415"><a href="#Product-1415"><span class="linenos">1415</span></a>            <span class="n">verify_edges</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="Product-1416"><a href="#Product-1416"><span class="linenos">1416</span></a>            <span class="n">before</span> <span class="o">=</span> <span class="n">tensors</span>
</span><span id="Product-1417"><a href="#Product-1417"><span class="linenos">1417</span></a>            <span class="n">tensors</span> <span class="o">=</span> <span class="n">_PowerFunction</span><span class="o">.</span><span class="n">simplify_outer</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span><span id="Product-1418"><a href="#Product-1418"><span class="linenos">1418</span></a>            <span class="n">verify_edges</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">tensors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Product-1419"><a href="#Product-1419"><span class="linenos">1419</span></a>
</span><span id="Product-1420"><a href="#Product-1420"><span class="linenos">1420</span></a>        <span class="c1"># Base cases</span>
</span><span id="Product-1421"><a href="#Product-1421"><span class="linenos">1421</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Product-1422"><a href="#Product-1422"><span class="linenos">1422</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Product-1423"><a href="#Product-1423"><span class="linenos">1423</span></a>        <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;expand&quot;</span><span class="p">]:</span>
</span><span id="Product-1424"><a href="#Product-1424"><span class="linenos">1424</span></a>            <span class="n">terms</span> <span class="o">=</span> <span class="p">[[]]</span>
</span><span id="Product-1425"><a href="#Product-1425"><span class="linenos">1425</span></a>            <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Product-1426"><a href="#Product-1426"><span class="linenos">1426</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">:</span>
</span><span id="Product-1427"><a href="#Product-1427"><span class="linenos">1427</span></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Sum</span><span class="p">):</span>
</span><span id="Product-1428"><a href="#Product-1428"><span class="linenos">1428</span></a>                    <span class="c1"># Create cartesian product</span>
</span><span id="Product-1429"><a href="#Product-1429"><span class="linenos">1429</span></a>                    <span class="n">terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">term</span> <span class="o">+</span> <span class="p">[</span><span class="n">t0</span><span class="p">]</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span> <span class="k">for</span> <span class="n">t0</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">terms</span><span class="p">]</span>
</span><span id="Product-1430"><a href="#Product-1430"><span class="linenos">1430</span></a>                    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">*</span> <span class="n">w0</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span> <span class="k">for</span> <span class="n">w0</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">weights</span><span class="p">]</span>
</span><span id="Product-1431"><a href="#Product-1431"><span class="linenos">1431</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Product-1432"><a href="#Product-1432"><span class="linenos">1432</span></a>                    <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
</span><span id="Product-1433"><a href="#Product-1433"><span class="linenos">1433</span></a>                        <span class="n">term</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span id="Product-1434"><a href="#Product-1434"><span class="linenos">1434</span></a>            <span class="c1"># Recurse with expand=False to avoid infinite descent</span>
</span><span id="Product-1435"><a href="#Product-1435"><span class="linenos">1435</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">Sum</span><span class="p">([</span><span class="n">Product</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">],</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;expand&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
</span><span id="Product-1436"><a href="#Product-1436"><span class="linenos">1436</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Product-1437"><a href="#Product-1437"><span class="linenos">1437</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">Product</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
</span><span id="Product-1438"><a href="#Product-1438"><span class="linenos">1438</span></a>
</span><span id="Product-1439"><a href="#Product-1439"><span class="linenos">1439</span></a>        <span class="k">if</span> <span class="n">res_weight</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Product-1440"><a href="#Product-1440"><span class="linenos">1440</span></a>            <span class="n">res</span> <span class="o">=</span> <span class="n">res_weight</span> <span class="o">*</span> <span class="n">res</span>
</span><span id="Product-1441"><a href="#Product-1441"><span class="linenos">1441</span></a>
</span><span id="Product-1442"><a href="#Product-1442"><span class="linenos">1442</span></a>        <span class="k">return</span> <span class="n">res</span>
</span><span id="Product-1443"><a href="#Product-1443"><span class="linenos">1443</span></a>
</span><span id="Product-1444"><a href="#Product-1444"><span class="linenos">1444</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">components</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Product&quot;</span><span class="p">]:</span>
</span><span id="Product-1445"><a href="#Product-1445"><span class="linenos">1445</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Product-1446"><a href="#Product-1446"><span class="linenos">1446</span></a><span class="sd">        Decompose the product into disjoint components (subgraphs).</span>
</span><span id="Product-1447"><a href="#Product-1447"><span class="linenos">1447</span></a>
</span><span id="Product-1448"><a href="#Product-1448"><span class="linenos">1448</span></a><span class="sd">        Returns:</span>
</span><span id="Product-1449"><a href="#Product-1449"><span class="linenos">1449</span></a><span class="sd">            A list of Product tensors representing disjoint components.</span>
</span><span id="Product-1450"><a href="#Product-1450"><span class="linenos">1450</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Product-1451"><a href="#Product-1451"><span class="linenos">1451</span></a>        <span class="c1"># Create graph of tensor connections</span>
</span><span id="Product-1452"><a href="#Product-1452"><span class="linenos">1452</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
</span><span id="Product-1453"><a href="#Product-1453"><span class="linenos">1453</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)))</span>
</span><span id="Product-1454"><a href="#Product-1454"><span class="linenos">1454</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">):</span>
</span><span id="Product-1455"><a href="#Product-1455"><span class="linenos">1455</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="Product-1456"><a href="#Product-1456"><span class="linenos">1456</span></a>                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
</span><span id="Product-1457"><a href="#Product-1457"><span class="linenos">1457</span></a>                    <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
</span><span id="Product-1458"><a href="#Product-1458"><span class="linenos">1458</span></a>
</span><span id="Product-1459"><a href="#Product-1459"><span class="linenos">1459</span></a>        <span class="c1"># Find connected components</span>
</span><span id="Product-1460"><a href="#Product-1460"><span class="linenos">1460</span></a>        <span class="n">component_sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
</span><span id="Product-1461"><a href="#Product-1461"><span class="linenos">1461</span></a>        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="n">Product</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">component_sets</span><span class="p">]</span>
</span><span id="Product-1462"><a href="#Product-1462"><span class="linenos">1462</span></a>        <span class="k">assert</span> <span class="n">Product</span><span class="p">(</span><span class="n">components</span><span class="p">)</span><span class="o">.</span><span class="n">edges</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Product-1463"><a href="#Product-1463"><span class="linenos">1463</span></a>        <span class="k">return</span> <span class="n">components</span>
</span><span id="Product-1464"><a href="#Product-1464"><span class="linenos">1464</span></a>
</span><span id="Product-1465"><a href="#Product-1465"><span class="linenos">1465</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Product-1466"><a href="#Product-1466"><span class="linenos">1466</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Product-1467"><a href="#Product-1467"><span class="linenos">1467</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Product-1468"><a href="#Product-1468"><span class="linenos">1468</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Product-1469"><a href="#Product-1469"><span class="linenos">1469</span></a>        <span class="n">inner_edges</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="Product-1470"><a href="#Product-1470"><span class="linenos">1470</span></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
</span><span id="Product-1471"><a href="#Product-1471"><span class="linenos">1471</span></a>            <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="Product-1472"><a href="#Product-1472"><span class="linenos">1472</span></a>            <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">t_edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Product-1473"><a href="#Product-1473"><span class="linenos">1473</span></a>                <span class="n">inner_edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span><span id="Product-1474"><a href="#Product-1474"><span class="linenos">1474</span></a>        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">inner_edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Product-1475"><a href="#Product-1475"><span class="linenos">1475</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Product-1476"><a href="#Product-1476"><span class="linenos">1476</span></a>                <span class="c1"># Note that inner edges are bidirectional, since tensor products</span>
</span><span id="Product-1477"><a href="#Product-1477"><span class="linenos">1477</span></a>                <span class="c1"># are associative.</span>
</span><span id="Product-1478"><a href="#Product-1478"><span class="linenos">1478</span></a>                <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">nodes</span>
</span><span id="Product-1479"><a href="#Product-1479"><span class="linenos">1479</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span>
</span><span id="Product-1480"><a href="#Product-1480"><span class="linenos">1480</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">n1</span><span class="p">)</span>
</span><span id="Product-1481"><a href="#Product-1481"><span class="linenos">1481</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Product-1482"><a href="#Product-1482"><span class="linenos">1482</span></a>                <span class="c1"># If the edge is only present once, it&#39;s an outer edge</span>
</span><span id="Product-1483"><a href="#Product-1483"><span class="linenos">1483</span></a>                <span class="k">assert</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Product-1484"><a href="#Product-1484"><span class="linenos">1484</span></a>                <span class="p">(</span><span class="n">n1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">nodes</span>
</span><span id="Product-1485"><a href="#Product-1485"><span class="linenos">1485</span></a>                <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">n1</span>
</span><span id="Product-1486"><a href="#Product-1486"><span class="linenos">1486</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Product-1487"><a href="#Product-1487"><span class="linenos">1487</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="Product-1488"><a href="#Product-1488"><span class="linenos">1488</span></a>
</span><span id="Product-1489"><a href="#Product-1489"><span class="linenos">1489</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Product-1490"><a href="#Product-1490"><span class="linenos">1490</span></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span>
</span><span id="Product-1491"><a href="#Product-1491"><span class="linenos">1491</span></a>
</span><span id="Product-1492"><a href="#Product-1492"><span class="linenos">1492</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_to_einsum_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="Product-1493"><a href="#Product-1493"><span class="linenos">1493</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Product-1494"><a href="#Product-1494"><span class="linenos">1494</span></a><span class="sd">        Convert the product to an einsum equation.</span>
</span><span id="Product-1495"><a href="#Product-1495"><span class="linenos">1495</span></a>
</span><span id="Product-1496"><a href="#Product-1496"><span class="linenos">1496</span></a><span class="sd">        The main utility is that Delta tensors are mostly removed in favor of hyper edges, which are more efficient to compute.</span>
</span><span id="Product-1497"><a href="#Product-1497"><span class="linenos">1497</span></a><span class="sd">        However, some Deltas are still needed, so we return the list of tensors that should be</span>
</span><span id="Product-1498"><a href="#Product-1498"><span class="linenos">1498</span></a><span class="sd">        used with the einsum equation.</span>
</span><span id="Product-1499"><a href="#Product-1499"><span class="linenos">1499</span></a>
</span><span id="Product-1500"><a href="#Product-1500"><span class="linenos">1500</span></a><span class="sd">        Returns:</span>
</span><span id="Product-1501"><a href="#Product-1501"><span class="linenos">1501</span></a><span class="sd">            A tuple (factors, equation) where factors is a list of tensors and</span>
</span><span id="Product-1502"><a href="#Product-1502"><span class="linenos">1502</span></a><span class="sd">            equation is the corresponding einsum string.</span>
</span><span id="Product-1503"><a href="#Product-1503"><span class="linenos">1503</span></a>
</span><span id="Product-1504"><a href="#Product-1504"><span class="linenos">1504</span></a><span class="sd">        Raises:</span>
</span><span id="Product-1505"><a href="#Product-1505"><span class="linenos">1505</span></a><span class="sd">            ValueError: If there are too many unique edges.</span>
</span><span id="Product-1506"><a href="#Product-1506"><span class="linenos">1506</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Product-1507"><a href="#Product-1507"><span class="linenos">1507</span></a>        <span class="n">unique_edges</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Product-1508"><a href="#Product-1508"><span class="linenos">1508</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_edges</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">52</span><span class="p">:</span>
</span><span id="Product-1509"><a href="#Product-1509"><span class="linenos">1509</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Too many unique edges (</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> &gt; 52) to convert to einsum equation&quot;</span><span class="p">)</span>
</span><span id="Product-1510"><a href="#Product-1510"><span class="linenos">1510</span></a>        <span class="n">name_to_idx</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">ascii_letters</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">name_to_idx</span><span class="p">)])</span>
</span><span id="Product-1511"><a href="#Product-1511"><span class="linenos">1511</span></a>
</span><span id="Product-1512"><a href="#Product-1512"><span class="linenos">1512</span></a>        <span class="c1"># The main challenge is to convert Delta tensors to hyper edges</span>
</span><span id="Product-1513"><a href="#Product-1513"><span class="linenos">1513</span></a>        <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Product-1514"><a href="#Product-1514"><span class="linenos">1514</span></a>        <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
</span><span id="Product-1515"><a href="#Product-1515"><span class="linenos">1515</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ft</span><span class="p">,</span> <span class="n">Delta</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ft</span><span class="o">.</span><span class="n">order</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Product-1516"><a href="#Product-1516"><span class="linenos">1516</span></a>                <span class="n">output_edges</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">edges</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Product-1517"><a href="#Product-1517"><span class="linenos">1517</span></a>                <span class="n">input_edges</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">edges</span> <span class="o">-</span> <span class="n">output_edges</span>
</span><span id="Product-1518"><a href="#Product-1518"><span class="linenos">1518</span></a>                <span class="c1"># However, einsum doesn&#39;t support duplicated indices in the output, like i-&gt;ii,</span>
</span><span id="Product-1519"><a href="#Product-1519"><span class="linenos">1519</span></a>                <span class="c1"># So we need to recreate some Delta tensors manually</span>
</span><span id="Product-1520"><a href="#Product-1520"><span class="linenos">1520</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_edges</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Product-1521"><a href="#Product-1521"><span class="linenos">1521</span></a>                    <span class="n">e0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_edges</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Product-1522"><a href="#Product-1522"><span class="linenos">1522</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_edges</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Product-1523"><a href="#Product-1523"><span class="linenos">1523</span></a>                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ft</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
</span><span id="Product-1524"><a href="#Product-1524"><span class="linenos">1524</span></a>                            <span class="n">name_to_idx</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_to_idx</span><span class="p">[</span><span class="n">e0</span><span class="p">]</span>
</span><span id="Product-1525"><a href="#Product-1525"><span class="linenos">1525</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_edges</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Product-1526"><a href="#Product-1526"><span class="linenos">1526</span></a>                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">input_edges</span><span class="p">:</span>
</span><span id="Product-1527"><a href="#Product-1527"><span class="linenos">1527</span></a>                            <span class="n">name_to_idx</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_to_idx</span><span class="p">[</span><span class="n">e0</span><span class="p">]</span>
</span><span id="Product-1528"><a href="#Product-1528"><span class="linenos">1528</span></a>                        <span class="n">compressed_delta</span> <span class="o">=</span> <span class="n">Delta</span><span class="p">(</span><span class="n">ft</span><span class="o">.</span><span class="n">_size</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="o">*</span><span class="n">output_edges</span><span class="p">)</span>
</span><span id="Product-1529"><a href="#Product-1529"><span class="linenos">1529</span></a>                        <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compressed_delta</span><span class="p">)</span>
</span><span id="Product-1530"><a href="#Product-1530"><span class="linenos">1530</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Product-1531"><a href="#Product-1531"><span class="linenos">1531</span></a>                    <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
</span><span id="Product-1532"><a href="#Product-1532"><span class="linenos">1532</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Product-1533"><a href="#Product-1533"><span class="linenos">1533</span></a>                <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ft</span><span class="p">)</span>
</span><span id="Product-1534"><a href="#Product-1534"><span class="linenos">1534</span></a>
</span><span id="Product-1535"><a href="#Product-1535"><span class="linenos">1535</span></a>        <span class="n">equation</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_to_idx</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ft</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span> <span class="k">for</span> <span class="n">ft</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">)</span>
</span><span id="Product-1536"><a href="#Product-1536"><span class="linenos">1536</span></a>        <span class="n">equation</span> <span class="o">+=</span> <span class="s2">&quot;-&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name_to_idx</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span>
</span><span id="Product-1537"><a href="#Product-1537"><span class="linenos">1537</span></a>        <span class="k">return</span> <span class="n">factors</span><span class="p">,</span> <span class="n">equation</span>
</span></pre></div>


            <div class="docstring"><p>A tensor representing the product (contraction) of several tensors.</p>
</div>


                            <div id="Product.__init__" class="classattr">
                                        <input id="Product.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Product</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">factors</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n"><a href="#Tensor">Tensor</a></span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="Product.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Product.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Product.__init__-1292"><a href="#Product.__init__-1292"><span class="linenos">1292</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factors</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]):</span>
</span><span id="Product.__init__-1293"><a href="#Product.__init__-1293"><span class="linenos">1293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Product.__init__-1294"><a href="#Product.__init__-1294"><span class="linenos">1294</span></a><span class="sd">        Initialize a Product tensor.</span>
</span><span id="Product.__init__-1295"><a href="#Product.__init__-1295"><span class="linenos">1295</span></a>
</span><span id="Product.__init__-1296"><a href="#Product.__init__-1296"><span class="linenos">1296</span></a><span class="sd">        Args:</span>
</span><span id="Product.__init__-1297"><a href="#Product.__init__-1297"><span class="linenos">1297</span></a><span class="sd">            factors: An iterable of tensors to be multiplied/contracted.</span>
</span><span id="Product.__init__-1298"><a href="#Product.__init__-1298"><span class="linenos">1298</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Product.__init__-1299"><a href="#Product.__init__-1299"><span class="linenos">1299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">factors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">factors</span><span class="p">)</span>
</span><span id="Product.__init__-1300"><a href="#Product.__init__-1300"><span class="linenos">1300</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Product.__init__-1301"><a href="#Product.__init__-1301"><span class="linenos">1301</span></a>        <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">_group_edges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Product.__init__-1302"><a href="#Product.__init__-1302"><span class="linenos">1302</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Product.__init__-1303"><a href="#Product.__init__-1303"><span class="linenos">1303</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span>
</span><span id="Product.__init__-1304"><a href="#Product.__init__-1304"><span class="linenos">1304</span></a>            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Product.__init__-1305"><a href="#Product.__init__-1305"><span class="linenos">1305</span></a>                <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">]</span>
</span><span id="Product.__init__-1306"><a href="#Product.__init__-1306"><span class="linenos">1306</span></a>                <span class="k">if</span> <span class="n">s1</span> <span class="o">!=</span> <span class="n">s2</span><span class="p">:</span>
</span><span id="Product.__init__-1307"><a href="#Product.__init__-1307"><span class="linenos">1307</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edge </span><span class="si">{</span><span class="n">edge</span><span class="si">}</span><span class="s2"> has different sizes, </span><span class="si">{</span><span class="n">s1</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">s2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Product.__init__-1308"><a href="#Product.__init__-1308"><span class="linenos">1308</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Product.__init__-1309"><a href="#Product.__init__-1309"><span class="linenos">1309</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Product.__init__-1310"><a href="#Product.__init__-1310"><span class="linenos">1310</span></a>                    <span class="sa">f</span><span class="s2">&quot;edge </span><span class="si">{</span><span class="n">edge</span><span class="si">}</span><span class="s2"> had multiplicity </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span><span class="si">}</span><span class="s2">. Use an identity tensor to combine multiple edges.&quot;</span>
</span><span id="Product.__init__-1311"><a href="#Product.__init__-1311"><span class="linenos">1311</span></a>                <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize a Product tensor.</p>

<p>Args:
    factors: An iterable of tensors to be multiplied/contracted.</p>
</div>


                            </div>
                            <div id="Product.factors" class="classattr">
                                <div class="attr variable">
            <span class="name">factors</span>

        
    </div>
    <a class="headerlink" href="#Product.factors"></a>
    
    

                            </div>
                            <div id="Product.merge" class="classattr">
                                        <input id="Product.merge-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">merge</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">products</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Product">Product</a></span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#Product">Product</a></span>:</span></span>

                <label class="view-source-button" for="Product.merge-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Product.merge"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Product.merge-1326"><a href="#Product.merge-1326"><span class="linenos">1326</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Product.merge-1327"><a href="#Product.merge-1327"><span class="linenos">1327</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">merge</span><span class="p">(</span><span class="n">products</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Product&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Product&quot;</span><span class="p">:</span>
</span><span id="Product.merge-1328"><a href="#Product.merge-1328"><span class="linenos">1328</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Product.merge-1329"><a href="#Product.merge-1329"><span class="linenos">1329</span></a><span class="sd">        Merge several Product tensors into one, renaming inner edges so they are distinct.</span>
</span><span id="Product.merge-1330"><a href="#Product.merge-1330"><span class="linenos">1330</span></a>
</span><span id="Product.merge-1331"><a href="#Product.merge-1331"><span class="linenos">1331</span></a><span class="sd">        Args:</span>
</span><span id="Product.merge-1332"><a href="#Product.merge-1332"><span class="linenos">1332</span></a><span class="sd">            products: A list of Product tensors.</span>
</span><span id="Product.merge-1333"><a href="#Product.merge-1333"><span class="linenos">1333</span></a>
</span><span id="Product.merge-1334"><a href="#Product.merge-1334"><span class="linenos">1334</span></a><span class="sd">        Returns:</span>
</span><span id="Product.merge-1335"><a href="#Product.merge-1335"><span class="linenos">1335</span></a><span class="sd">            A new Product tensor merging the inputs.</span>
</span><span id="Product.merge-1336"><a href="#Product.merge-1336"><span class="linenos">1336</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Product.merge-1337"><a href="#Product.merge-1337"><span class="linenos">1337</span></a>        <span class="n">used_edges</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Product.merge-1338"><a href="#Product.merge-1338"><span class="linenos">1338</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Product.merge-1339"><a href="#Product.merge-1339"><span class="linenos">1339</span></a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
</span><span id="Product.merge-1340"><a href="#Product.merge-1340"><span class="linenos">1340</span></a>            <span class="c1"># Maybe this could also be expressed in terms of avoid_internal_edges</span>
</span><span id="Product.merge-1341"><a href="#Product.merge-1341"><span class="linenos">1341</span></a>            <span class="n">inner_edges</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">factors</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Product.merge-1342"><a href="#Product.merge-1342"><span class="linenos">1342</span></a>            <span class="n">rename</span> <span class="o">=</span> <span class="n">_unused_edge_names</span><span class="p">(</span><span class="n">inner_edges</span><span class="p">,</span> <span class="n">used_edges</span><span class="p">)</span>
</span><span id="Product.merge-1343"><a href="#Product.merge-1343"><span class="linenos">1343</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
</span><span id="Product.merge-1344"><a href="#Product.merge-1344"><span class="linenos">1344</span></a>                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">rename</span><span class="p">))</span>
</span><span id="Product.merge-1345"><a href="#Product.merge-1345"><span class="linenos">1345</span></a>            <span class="n">used_edges</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rename</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>  <span class="c1"># Later renames should not clash with this one</span>
</span><span id="Product.merge-1346"><a href="#Product.merge-1346"><span class="linenos">1346</span></a>        <span class="k">return</span> <span class="n">Product</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Merge several Product tensors into one, renaming inner edges so they are distinct.</p>

<p>Args:
    products: A list of Product tensors.</p>

<p>Returns:
    A new Product tensor merging the inputs.</p>
</div>


                            </div>
                            <div id="Product.components" class="classattr">
                                        <input id="Product.components-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">components</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">list</span><span class="p">[</span><span class="n"><a href="#Product">Product</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Product.components-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Product.components"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Product.components-1444"><a href="#Product.components-1444"><span class="linenos">1444</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">components</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="s2">&quot;Product&quot;</span><span class="p">]:</span>
</span><span id="Product.components-1445"><a href="#Product.components-1445"><span class="linenos">1445</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Product.components-1446"><a href="#Product.components-1446"><span class="linenos">1446</span></a><span class="sd">        Decompose the product into disjoint components (subgraphs).</span>
</span><span id="Product.components-1447"><a href="#Product.components-1447"><span class="linenos">1447</span></a>
</span><span id="Product.components-1448"><a href="#Product.components-1448"><span class="linenos">1448</span></a><span class="sd">        Returns:</span>
</span><span id="Product.components-1449"><a href="#Product.components-1449"><span class="linenos">1449</span></a><span class="sd">            A list of Product tensors representing disjoint components.</span>
</span><span id="Product.components-1450"><a href="#Product.components-1450"><span class="linenos">1450</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Product.components-1451"><a href="#Product.components-1451"><span class="linenos">1451</span></a>        <span class="c1"># Create graph of tensor connections</span>
</span><span id="Product.components-1452"><a href="#Product.components-1452"><span class="linenos">1452</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
</span><span id="Product.components-1453"><a href="#Product.components-1453"><span class="linenos">1453</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)))</span>
</span><span id="Product.components-1454"><a href="#Product.components-1454"><span class="linenos">1454</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">):</span>
</span><span id="Product.components-1455"><a href="#Product.components-1455"><span class="linenos">1455</span></a>            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">t2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:],</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="Product.components-1456"><a href="#Product.components-1456"><span class="linenos">1456</span></a>                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">edges</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
</span><span id="Product.components-1457"><a href="#Product.components-1457"><span class="linenos">1457</span></a>                    <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
</span><span id="Product.components-1458"><a href="#Product.components-1458"><span class="linenos">1458</span></a>
</span><span id="Product.components-1459"><a href="#Product.components-1459"><span class="linenos">1459</span></a>        <span class="c1"># Find connected components</span>
</span><span id="Product.components-1460"><a href="#Product.components-1460"><span class="linenos">1460</span></a>        <span class="n">component_sets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
</span><span id="Product.components-1461"><a href="#Product.components-1461"><span class="linenos">1461</span></a>        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="n">Product</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">])</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">component_sets</span><span class="p">]</span>
</span><span id="Product.components-1462"><a href="#Product.components-1462"><span class="linenos">1462</span></a>        <span class="k">assert</span> <span class="n">Product</span><span class="p">(</span><span class="n">components</span><span class="p">)</span><span class="o">.</span><span class="n">edges</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Product.components-1463"><a href="#Product.components-1463"><span class="linenos">1463</span></a>        <span class="k">return</span> <span class="n">components</span>
</span></pre></div>


            <div class="docstring"><p>Decompose the product into disjoint components (subgraphs).</p>

<p>Returns:
    A list of Product tensors representing disjoint components.</p>
</div>


                            </div>
                            <div id="Product.structural_graph" class="classattr">
                                        <input id="Product.structural_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">structural_graph</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">networkx</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">multidigraph</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="Product.structural_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Product.structural_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Product.structural_graph-1465"><a href="#Product.structural_graph-1465"><span class="linenos">1465</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Product.structural_graph-1466"><a href="#Product.structural_graph-1466"><span class="linenos">1466</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Product.structural_graph-1467"><a href="#Product.structural_graph-1467"><span class="linenos">1467</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Product.structural_graph-1468"><a href="#Product.structural_graph-1468"><span class="linenos">1468</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Product.structural_graph-1469"><a href="#Product.structural_graph-1469"><span class="linenos">1469</span></a>        <span class="n">inner_edges</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="Product.structural_graph-1470"><a href="#Product.structural_graph-1470"><span class="linenos">1470</span></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
</span><span id="Product.structural_graph-1471"><a href="#Product.structural_graph-1471"><span class="linenos">1471</span></a>            <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span id="Product.structural_graph-1472"><a href="#Product.structural_graph-1472"><span class="linenos">1472</span></a>            <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">t_edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Product.structural_graph-1473"><a href="#Product.structural_graph-1473"><span class="linenos">1473</span></a>                <span class="n">inner_edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span><span id="Product.structural_graph-1474"><a href="#Product.structural_graph-1474"><span class="linenos">1474</span></a>        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">inner_edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Product.structural_graph-1475"><a href="#Product.structural_graph-1475"><span class="linenos">1475</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Product.structural_graph-1476"><a href="#Product.structural_graph-1476"><span class="linenos">1476</span></a>                <span class="c1"># Note that inner edges are bidirectional, since tensor products</span>
</span><span id="Product.structural_graph-1477"><a href="#Product.structural_graph-1477"><span class="linenos">1477</span></a>                <span class="c1"># are associative.</span>
</span><span id="Product.structural_graph-1478"><a href="#Product.structural_graph-1478"><span class="linenos">1478</span></a>                <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">nodes</span>
</span><span id="Product.structural_graph-1479"><a href="#Product.structural_graph-1479"><span class="linenos">1479</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span>
</span><span id="Product.structural_graph-1480"><a href="#Product.structural_graph-1480"><span class="linenos">1480</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">n1</span><span class="p">)</span>
</span><span id="Product.structural_graph-1481"><a href="#Product.structural_graph-1481"><span class="linenos">1481</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Product.structural_graph-1482"><a href="#Product.structural_graph-1482"><span class="linenos">1482</span></a>                <span class="c1"># If the edge is only present once, it&#39;s an outer edge</span>
</span><span id="Product.structural_graph-1483"><a href="#Product.structural_graph-1483"><span class="linenos">1483</span></a>                <span class="k">assert</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Product.structural_graph-1484"><a href="#Product.structural_graph-1484"><span class="linenos">1484</span></a>                <span class="p">(</span><span class="n">n1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">nodes</span>
</span><span id="Product.structural_graph-1485"><a href="#Product.structural_graph-1485"><span class="linenos">1485</span></a>                <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">n1</span>
</span><span id="Product.structural_graph-1486"><a href="#Product.structural_graph-1486"><span class="linenos">1486</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Product.structural_graph-1487"><a href="#Product.structural_graph-1487"><span class="linenos">1487</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span></pre></div>


            <div class="docstring"><p>Create a graph representation of the tensor, which can be used for isomorphism testing.</p>

<p>Returns:
    A tuple with the following values:
    - A NetworkX directed graph.
        - Each node in the top tree is labeled with the producing tensor.
        - Use name=hashable to label vertices
    - "edges", a dict of edge_name -> node id
    - Node 0 should be the root</p>
</div>


                            </div>
                            <div id="Product.depends_on" class="classattr">
                                        <input id="Product.depends_on-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">depends_on</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span><span class="p">:</span> <span class="n"><a href="#Variable">Variable</a></span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Product.depends_on-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Product.depends_on"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Product.depends_on-1489"><a href="#Product.depends_on-1489"><span class="linenos">1489</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Product.depends_on-1490"><a href="#Product.depends_on-1490"><span class="linenos">1490</span></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">factors</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Check if this tensor depends on the variable x.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Tensor">Tensor</a></dt>
                                <dd id="Product.edges" class="variable"><a href="#Tensor.edges">edges</a></dd>
                <dd id="Product.shape" class="variable"><a href="#Tensor.shape">shape</a></dd>
                <dd id="Product.order" class="variable"><a href="#Tensor.order">order</a></dd>
                <dd id="Product.grad" class="function"><a href="#Tensor.grad">grad</a></dd>
                <dd id="Product.rename" class="function"><a href="#Tensor.rename">rename</a></dd>
                <dd id="Product.simplify" class="function"><a href="#Tensor.simplify">simplify</a></dd>
                <dd id="Product.full_simplify" class="function"><a href="#Tensor.full_simplify">full_simplify</a></dd>
                <dd id="Product.substitute" class="function"><a href="#Tensor.substitute">substitute</a></dd>
                <dd id="Product.weisfeiler_lehman" class="variable"><a href="#Tensor.weisfeiler_lehman">weisfeiler_lehman</a></dd>
                <dd id="Product.edge_structural_graph" class="function"><a href="#Tensor.edge_structural_graph">edge_structural_graph</a></dd>
                <dd id="Product.graph_to_string" class="function"><a href="#Tensor.graph_to_string">graph_to_string</a></dd>
                <dd id="Product.is_isomorphic" class="function"><a href="#Tensor.is_isomorphic">is_isomorphic</a></dd>
                <dd id="Product.isomorphisms" class="function"><a href="#Tensor.isomorphisms">isomorphisms</a></dd>
                <dd id="Product.symmetries" class="variable"><a href="#Tensor.symmetries">symmetries</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Sum">
                            <input id="Sum-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Sum</span><wbr>(<span class="base"><a href="#Tensor">Tensor</a></span>):

                <label class="view-source-button" for="Sum-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sum"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sum-1545"><a href="#Sum-1545"><span class="linenos">1545</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Sum</span><span class="p">(</span><span class="n">Tensor</span><span class="p">):</span>
</span><span id="Sum-1546"><a href="#Sum-1546"><span class="linenos">1546</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Sum-1547"><a href="#Sum-1547"><span class="linenos">1547</span></a><span class="sd">    A weighted sum of several tensors.</span>
</span><span id="Sum-1548"><a href="#Sum-1548"><span class="linenos">1548</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Sum-1549"><a href="#Sum-1549"><span class="linenos">1549</span></a>
</span><span id="Sum-1550"><a href="#Sum-1550"><span class="linenos">1550</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Sum-1551"><a href="#Sum-1551"><span class="linenos">1551</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Sum-1552"><a href="#Sum-1552"><span class="linenos">1552</span></a><span class="sd">        A weighted sum of multiple tensors.</span>
</span><span id="Sum-1553"><a href="#Sum-1553"><span class="linenos">1553</span></a>
</span><span id="Sum-1554"><a href="#Sum-1554"><span class="linenos">1554</span></a><span class="sd">        Args:</span>
</span><span id="Sum-1555"><a href="#Sum-1555"><span class="linenos">1555</span></a><span class="sd">            terms: The tensors to add together.</span>
</span><span id="Sum-1556"><a href="#Sum-1556"><span class="linenos">1556</span></a><span class="sd">            weights: The weights of each tensor in the sum. If not provided, all weights are 1.</span>
</span><span id="Sum-1557"><a href="#Sum-1557"><span class="linenos">1557</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Sum-1558"><a href="#Sum-1558"><span class="linenos">1558</span></a>        <span class="n">terms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>
</span><span id="Sum-1559"><a href="#Sum-1559"><span class="linenos">1559</span></a>
</span><span id="Sum-1560"><a href="#Sum-1560"><span class="linenos">1560</span></a>        <span class="c1"># Broadcasting means we always upgrade to the super set of edges</span>
</span><span id="Sum-1561"><a href="#Sum-1561"><span class="linenos">1561</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Sum-1562"><a href="#Sum-1562"><span class="linenos">1562</span></a>        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">_group_edges</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Sum-1563"><a href="#Sum-1563"><span class="linenos">1563</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
</span><span id="Sum-1564"><a href="#Sum-1564"><span class="linenos">1564</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">):</span>
</span><span id="Sum-1565"><a href="#Sum-1565"><span class="linenos">1565</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edge </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> had different sizes in tensors: </span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Sum-1566"><a href="#Sum-1566"><span class="linenos">1566</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
</span><span id="Sum-1567"><a href="#Sum-1567"><span class="linenos">1567</span></a>
</span><span id="Sum-1568"><a href="#Sum-1568"><span class="linenos">1568</span></a>        <span class="c1"># Any tensors that lacks an edge will be broadcasted to have that edge.</span>
</span><span id="Sum-1569"><a href="#Sum-1569"><span class="linenos">1569</span></a>        <span class="n">all_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="Sum-1570"><a href="#Sum-1570"><span class="linenos">1570</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Sum-1571"><a href="#Sum-1571"><span class="linenos">1571</span></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
</span><span id="Sum-1572"><a href="#Sum-1572"><span class="linenos">1572</span></a>            <span class="n">missing</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">all_edges</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Sum-1573"><a href="#Sum-1573"><span class="linenos">1573</span></a>            <span class="c1"># Note: don&#39;t broadcast if the tensor is already full, since that would create new</span>
</span><span id="Sum-1574"><a href="#Sum-1574"><span class="linenos">1574</span></a>            <span class="c1"># Ones([]) objects after simplification is supposed to have completed.</span>
</span><span id="Sum-1575"><a href="#Sum-1575"><span class="linenos">1575</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span> <span class="o">@</span> <span class="n">Ones</span><span class="p">(</span><span class="o">**</span><span class="n">missing</span><span class="p">)</span> <span class="k">if</span> <span class="n">missing</span> <span class="k">else</span> <span class="n">t</span><span class="p">)</span>
</span><span id="Sum-1576"><a href="#Sum-1576"><span class="linenos">1576</span></a>
</span><span id="Sum-1577"><a href="#Sum-1577"><span class="linenos">1577</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span><span id="Sum-1578"><a href="#Sum-1578"><span class="linenos">1578</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="Sum-1579"><a href="#Sum-1579"><span class="linenos">1579</span></a>
</span><span id="Sum-1580"><a href="#Sum-1580"><span class="linenos">1580</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Sum-1581"><a href="#Sum-1581"><span class="linenos">1581</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="Sum-1582"><a href="#Sum-1582"><span class="linenos">1582</span></a>
</span><span id="Sum-1583"><a href="#Sum-1583"><span class="linenos">1583</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">new_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Sum-1584"><a href="#Sum-1584"><span class="linenos">1584</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="n">Derivative</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">new_names</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="Sum-1585"><a href="#Sum-1585"><span class="linenos">1585</span></a>
</span><span id="Sum-1586"><a href="#Sum-1586"><span class="linenos">1586</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Tensor&quot;</span><span class="p">:</span>
</span><span id="Sum-1587"><a href="#Sum-1587"><span class="linenos">1587</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="Sum-1588"><a href="#Sum-1588"><span class="linenos">1588</span></a>
</span><span id="Sum-1589"><a href="#Sum-1589"><span class="linenos">1589</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_simplify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="Sum-1590"><a href="#Sum-1590"><span class="linenos">1590</span></a>        <span class="n">terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">]</span>
</span><span id="Sum-1591"><a href="#Sum-1591"><span class="linenos">1591</span></a>
</span><span id="Sum-1592"><a href="#Sum-1592"><span class="linenos">1592</span></a>        <span class="n">term_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
</span><span id="Sum-1593"><a href="#Sum-1593"><span class="linenos">1593</span></a>        <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">terms</span><span class="p">):</span>
</span><span id="Sum-1594"><a href="#Sum-1594"><span class="linenos">1594</span></a>            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;associative_sums&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Sum</span><span class="p">):</span>
</span><span id="Sum-1595"><a href="#Sum-1595"><span class="linenos">1595</span></a>                <span class="k">for</span> <span class="n">w1</span><span class="p">,</span> <span class="n">t1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">terms</span><span class="p">):</span>
</span><span id="Sum-1596"><a href="#Sum-1596"><span class="linenos">1596</span></a>                    <span class="n">term_counter</span><span class="p">[</span><span class="n">_MatchEdgesKey</span><span class="p">(</span><span class="n">t1</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">w1</span>
</span><span id="Sum-1597"><a href="#Sum-1597"><span class="linenos">1597</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Sum-1598"><a href="#Sum-1598"><span class="linenos">1598</span></a>                <span class="n">term_counter</span><span class="p">[</span><span class="n">_MatchEdgesKey</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">w</span>
</span><span id="Sum-1599"><a href="#Sum-1599"><span class="linenos">1599</span></a>
</span><span id="Sum-1600"><a href="#Sum-1600"><span class="linenos">1600</span></a>        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;sum_combine_terms&quot;</span><span class="p">]:</span>
</span><span id="Sum-1601"><a href="#Sum-1601"><span class="linenos">1601</span></a>            <span class="c1"># Identify tensors with multiplicity and combine them. We use tensor.canon_with_edges to identify tensors.</span>
</span><span id="Sum-1602"><a href="#Sum-1602"><span class="linenos">1602</span></a>            <span class="c1"># It is important that isomorphic tensors with different outer edge labels don&#39;t get matched. For example</span>
</span><span id="Sum-1603"><a href="#Sum-1603"><span class="linenos">1603</span></a>            <span class="c1"># (o-i o-&lt;jk) is isomorphic with (o-j o-&lt;ik), but they shouldn&#39;t be combined. This example comes up in the</span>
</span><span id="Sum-1604"><a href="#Sum-1604"><span class="linenos">1604</span></a>            <span class="c1"># Hessian of softmax.</span>
</span><span id="Sum-1605"><a href="#Sum-1605"><span class="linenos">1605</span></a>            <span class="n">ws_tensors</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="Sum-1606"><a href="#Sum-1606"><span class="linenos">1606</span></a>                <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span id="Sum-1607"><a href="#Sum-1607"><span class="linenos">1607</span></a>                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">term_counter</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="Sum-1608"><a href="#Sum-1608"><span class="linenos">1608</span></a>                <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">Zero</span><span class="p">)</span>
</span><span id="Sum-1609"><a href="#Sum-1609"><span class="linenos">1609</span></a>            <span class="p">]</span>
</span><span id="Sum-1610"><a href="#Sum-1610"><span class="linenos">1610</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Sum-1611"><a href="#Sum-1611"><span class="linenos">1611</span></a>            <span class="n">ws_tensors</span> <span class="o">=</span> <span class="p">[(</span><span class="n">w</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">term_counter</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="Sum-1612"><a href="#Sum-1612"><span class="linenos">1612</span></a>
</span><span id="Sum-1613"><a href="#Sum-1613"><span class="linenos">1613</span></a>        <span class="c1"># Remove zero tensors or zero weights.</span>
</span><span id="Sum-1614"><a href="#Sum-1614"><span class="linenos">1614</span></a>        <span class="c1"># Note: This won&#39;t change the shape of the tensor, since all summands have been broadcasted.</span>
</span><span id="Sum-1615"><a href="#Sum-1615"><span class="linenos">1615</span></a>        <span class="n">ws_tensors</span> <span class="o">=</span> <span class="p">[(</span><span class="n">w</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ws_tensors</span> <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Zero</span><span class="p">)]</span>
</span><span id="Sum-1616"><a href="#Sum-1616"><span class="linenos">1616</span></a>        <span class="c1"># Base case. Here we can&#39;t just return Zero([]), since that would change the signature of the tensor.</span>
</span><span id="Sum-1617"><a href="#Sum-1617"><span class="linenos">1617</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ws_tensors</span><span class="p">:</span>
</span><span id="Sum-1618"><a href="#Sum-1618"><span class="linenos">1618</span></a>            <span class="k">return</span> <span class="n">Zero</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Sum-1619"><a href="#Sum-1619"><span class="linenos">1619</span></a>        <span class="n">weights</span><span class="p">,</span> <span class="n">tensors</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ws_tensors</span><span class="p">)</span>
</span><span id="Sum-1620"><a href="#Sum-1620"><span class="linenos">1620</span></a>        <span class="c1"># If there is just one tensor with weight 1, we don&#39;t need LinearComb</span>
</span><span id="Sum-1621"><a href="#Sum-1621"><span class="linenos">1621</span></a>        <span class="k">if</span> <span class="n">weights</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,):</span>
</span><span id="Sum-1622"><a href="#Sum-1622"><span class="linenos">1622</span></a>            <span class="k">return</span> <span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Sum-1623"><a href="#Sum-1623"><span class="linenos">1623</span></a>        <span class="k">return</span> <span class="n">Sum</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="Sum-1624"><a href="#Sum-1624"><span class="linenos">1624</span></a>
</span><span id="Sum-1625"><a href="#Sum-1625"><span class="linenos">1625</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Sum-1626"><a href="#Sum-1626"><span class="linenos">1626</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Sum(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Sum-1627"><a href="#Sum-1627"><span class="linenos">1627</span></a>
</span><span id="Sum-1628"><a href="#Sum-1628"><span class="linenos">1628</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Sum-1629"><a href="#Sum-1629"><span class="linenos">1629</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Sum-1630"><a href="#Sum-1630"><span class="linenos">1630</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Sum-1631"><a href="#Sum-1631"><span class="linenos">1631</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Sum-1632"><a href="#Sum-1632"><span class="linenos">1632</span></a>        <span class="c1"># Create special &quot;Plus nodes&quot; to collect common edges</span>
</span><span id="Sum-1633"><a href="#Sum-1633"><span class="linenos">1633</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
</span><span id="Sum-1634"><a href="#Sum-1634"><span class="linenos">1634</span></a>            <span class="c1"># Note: No need to add the shape here. It&#39;s already in the sub-tensors</span>
</span><span id="Sum-1635"><a href="#Sum-1635"><span class="linenos">1635</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Plus Node&quot;</span><span class="p">)</span>
</span><span id="Sum-1636"><a href="#Sum-1636"><span class="linenos">1636</span></a>            <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Sum-1637"><a href="#Sum-1637"><span class="linenos">1637</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">):</span>
</span><span id="Sum-1638"><a href="#Sum-1638"><span class="linenos">1638</span></a>            <span class="c1"># The weights are a little akward. There a lot of options for how to handle them.</span>
</span><span id="Sum-1639"><a href="#Sum-1639"><span class="linenos">1639</span></a>            <span class="c1"># E.g. the idea of just using a weighted Delta([]) somehow. But this works.</span>
</span><span id="Sum-1640"><a href="#Sum-1640"><span class="linenos">1640</span></a>            <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Weight </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Sum-1641"><a href="#Sum-1641"><span class="linenos">1641</span></a>            <span class="c1"># Connect tensor edges to the plus nodes</span>
</span><span id="Sum-1642"><a href="#Sum-1642"><span class="linenos">1642</span></a>            <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">t_edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Sum-1643"><a href="#Sum-1643"><span class="linenos">1643</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
</span><span id="Sum-1644"><a href="#Sum-1644"><span class="linenos">1644</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Sum-1645"><a href="#Sum-1645"><span class="linenos">1645</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span><span id="Sum-1646"><a href="#Sum-1646"><span class="linenos">1646</span></a>
</span><span id="Sum-1647"><a href="#Sum-1647"><span class="linenos">1647</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Sum-1648"><a href="#Sum-1648"><span class="linenos">1648</span></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A weighted sum of several tensors.</p>
</div>


                            <div id="Sum.__init__" class="classattr">
                                        <input id="Sum.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Sum</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">terms</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n"><a href="#Tensor">Tensor</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Sum.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sum.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sum.__init__-1550"><a href="#Sum.__init__-1550"><span class="linenos">1550</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Sum.__init__-1551"><a href="#Sum.__init__-1551"><span class="linenos">1551</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Sum.__init__-1552"><a href="#Sum.__init__-1552"><span class="linenos">1552</span></a><span class="sd">        A weighted sum of multiple tensors.</span>
</span><span id="Sum.__init__-1553"><a href="#Sum.__init__-1553"><span class="linenos">1553</span></a>
</span><span id="Sum.__init__-1554"><a href="#Sum.__init__-1554"><span class="linenos">1554</span></a><span class="sd">        Args:</span>
</span><span id="Sum.__init__-1555"><a href="#Sum.__init__-1555"><span class="linenos">1555</span></a><span class="sd">            terms: The tensors to add together.</span>
</span><span id="Sum.__init__-1556"><a href="#Sum.__init__-1556"><span class="linenos">1556</span></a><span class="sd">            weights: The weights of each tensor in the sum. If not provided, all weights are 1.</span>
</span><span id="Sum.__init__-1557"><a href="#Sum.__init__-1557"><span class="linenos">1557</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Sum.__init__-1558"><a href="#Sum.__init__-1558"><span class="linenos">1558</span></a>        <span class="n">terms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>
</span><span id="Sum.__init__-1559"><a href="#Sum.__init__-1559"><span class="linenos">1559</span></a>
</span><span id="Sum.__init__-1560"><a href="#Sum.__init__-1560"><span class="linenos">1560</span></a>        <span class="c1"># Broadcasting means we always upgrade to the super set of edges</span>
</span><span id="Sum.__init__-1561"><a href="#Sum.__init__-1561"><span class="linenos">1561</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Sum.__init__-1562"><a href="#Sum.__init__-1562"><span class="linenos">1562</span></a>        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">_group_edges</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Sum.__init__-1563"><a href="#Sum.__init__-1563"><span class="linenos">1563</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
</span><span id="Sum.__init__-1564"><a href="#Sum.__init__-1564"><span class="linenos">1564</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ts</span><span class="p">):</span>
</span><span id="Sum.__init__-1565"><a href="#Sum.__init__-1565"><span class="linenos">1565</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Edge </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> had different sizes in tensors: </span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Sum.__init__-1566"><a href="#Sum.__init__-1566"><span class="linenos">1566</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
</span><span id="Sum.__init__-1567"><a href="#Sum.__init__-1567"><span class="linenos">1567</span></a>
</span><span id="Sum.__init__-1568"><a href="#Sum.__init__-1568"><span class="linenos">1568</span></a>        <span class="c1"># Any tensors that lacks an edge will be broadcasted to have that edge.</span>
</span><span id="Sum.__init__-1569"><a href="#Sum.__init__-1569"><span class="linenos">1569</span></a>        <span class="n">all_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="Sum.__init__-1570"><a href="#Sum.__init__-1570"><span class="linenos">1570</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Sum.__init__-1571"><a href="#Sum.__init__-1571"><span class="linenos">1571</span></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
</span><span id="Sum.__init__-1572"><a href="#Sum.__init__-1572"><span class="linenos">1572</span></a>            <span class="n">missing</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">all_edges</span> <span class="o">-</span> <span class="n">t</span><span class="o">.</span><span class="n">edges</span><span class="p">}</span>
</span><span id="Sum.__init__-1573"><a href="#Sum.__init__-1573"><span class="linenos">1573</span></a>            <span class="c1"># Note: don&#39;t broadcast if the tensor is already full, since that would create new</span>
</span><span id="Sum.__init__-1574"><a href="#Sum.__init__-1574"><span class="linenos">1574</span></a>            <span class="c1"># Ones([]) objects after simplification is supposed to have completed.</span>
</span><span id="Sum.__init__-1575"><a href="#Sum.__init__-1575"><span class="linenos">1575</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span> <span class="o">@</span> <span class="n">Ones</span><span class="p">(</span><span class="o">**</span><span class="n">missing</span><span class="p">)</span> <span class="k">if</span> <span class="n">missing</span> <span class="k">else</span> <span class="n">t</span><span class="p">)</span>
</span><span id="Sum.__init__-1576"><a href="#Sum.__init__-1576"><span class="linenos">1576</span></a>
</span><span id="Sum.__init__-1577"><a href="#Sum.__init__-1577"><span class="linenos">1577</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</span><span id="Sum.__init__-1578"><a href="#Sum.__init__-1578"><span class="linenos">1578</span></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A weighted sum of multiple tensors.</p>

<p>Args:
    terms: The tensors to add together.
    weights: The weights of each tensor in the sum. If not provided, all weights are 1.</p>
</div>


                            </div>
                            <div id="Sum.terms" class="classattr">
                                <div class="attr variable">
            <span class="name">terms</span>

        
    </div>
    <a class="headerlink" href="#Sum.terms"></a>
    
    

                            </div>
                            <div id="Sum.weights" class="classattr">
                                <div class="attr variable">
            <span class="name">weights</span>

        
    </div>
    <a class="headerlink" href="#Sum.weights"></a>
    
    

                            </div>
                            <div id="Sum.structural_graph" class="classattr">
                                        <input id="Sum.structural_graph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">structural_graph</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">networkx</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">multidigraph</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="Sum.structural_graph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sum.structural_graph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sum.structural_graph-1628"><a href="#Sum.structural_graph-1628"><span class="linenos">1628</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">structural_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
</span><span id="Sum.structural_graph-1629"><a href="#Sum.structural_graph-1629"><span class="linenos">1629</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">MultiDiGraph</span><span class="p">()</span>
</span><span id="Sum.structural_graph-1630"><a href="#Sum.structural_graph-1630"><span class="linenos">1630</span></a>        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">tensor</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Sum.structural_graph-1631"><a href="#Sum.structural_graph-1631"><span class="linenos">1631</span></a>        <span class="n">edges</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Sum.structural_graph-1632"><a href="#Sum.structural_graph-1632"><span class="linenos">1632</span></a>        <span class="c1"># Create special &quot;Plus nodes&quot; to collect common edges</span>
</span><span id="Sum.structural_graph-1633"><a href="#Sum.structural_graph-1633"><span class="linenos">1633</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
</span><span id="Sum.structural_graph-1634"><a href="#Sum.structural_graph-1634"><span class="linenos">1634</span></a>            <span class="c1"># Note: No need to add the shape here. It&#39;s already in the sub-tensors</span>
</span><span id="Sum.structural_graph-1635"><a href="#Sum.structural_graph-1635"><span class="linenos">1635</span></a>            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Plus Node&quot;</span><span class="p">)</span>
</span><span id="Sum.structural_graph-1636"><a href="#Sum.structural_graph-1636"><span class="linenos">1636</span></a>            <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Sum.structural_graph-1637"><a href="#Sum.structural_graph-1637"><span class="linenos">1637</span></a>        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">):</span>
</span><span id="Sum.structural_graph-1638"><a href="#Sum.structural_graph-1638"><span class="linenos">1638</span></a>            <span class="c1"># The weights are a little akward. There a lot of options for how to handle them.</span>
</span><span id="Sum.structural_graph-1639"><a href="#Sum.structural_graph-1639"><span class="linenos">1639</span></a>            <span class="c1"># E.g. the idea of just using a weighted Delta([]) somehow. But this works.</span>
</span><span id="Sum.structural_graph-1640"><a href="#Sum.structural_graph-1640"><span class="linenos">1640</span></a>            <span class="n">G</span><span class="p">,</span> <span class="n">t_edges</span> <span class="o">=</span> <span class="n">_add_structural_graph</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">root_edge_label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Weight </span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Sum.structural_graph-1641"><a href="#Sum.structural_graph-1641"><span class="linenos">1641</span></a>            <span class="c1"># Connect tensor edges to the plus nodes</span>
</span><span id="Sum.structural_graph-1642"><a href="#Sum.structural_graph-1642"><span class="linenos">1642</span></a>            <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">t_edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Sum.structural_graph-1643"><a href="#Sum.structural_graph-1643"><span class="linenos">1643</span></a>                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">edges</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>
</span><span id="Sum.structural_graph-1644"><a href="#Sum.structural_graph-1644"><span class="linenos">1644</span></a>        <span class="k">assert</span> <span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
</span><span id="Sum.structural_graph-1645"><a href="#Sum.structural_graph-1645"><span class="linenos">1645</span></a>        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">edges</span>
</span></pre></div>


            <div class="docstring"><p>Create a graph representation of the tensor, which can be used for isomorphism testing.</p>

<p>Returns:
    A tuple with the following values:
    - A NetworkX directed graph.
        - Each node in the top tree is labeled with the producing tensor.
        - Use name=hashable to label vertices
    - "edges", a dict of edge_name -> node id
    - Node 0 should be the root</p>
</div>


                            </div>
                            <div id="Sum.depends_on" class="classattr">
                                        <input id="Sum.depends_on-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">depends_on</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span><span class="p">:</span> <span class="n"><a href="#Variable">Variable</a></span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="Sum.depends_on-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Sum.depends_on"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Sum.depends_on-1647"><a href="#Sum.depends_on-1647"><span class="linenos">1647</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;Variable&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Sum.depends_on-1648"><a href="#Sum.depends_on-1648"><span class="linenos">1648</span></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">terms</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Check if this tensor depends on the variable x.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Tensor">Tensor</a></dt>
                                <dd id="Sum.edges" class="variable"><a href="#Tensor.edges">edges</a></dd>
                <dd id="Sum.shape" class="variable"><a href="#Tensor.shape">shape</a></dd>
                <dd id="Sum.order" class="variable"><a href="#Tensor.order">order</a></dd>
                <dd id="Sum.grad" class="function"><a href="#Tensor.grad">grad</a></dd>
                <dd id="Sum.rename" class="function"><a href="#Tensor.rename">rename</a></dd>
                <dd id="Sum.simplify" class="function"><a href="#Tensor.simplify">simplify</a></dd>
                <dd id="Sum.full_simplify" class="function"><a href="#Tensor.full_simplify">full_simplify</a></dd>
                <dd id="Sum.substitute" class="function"><a href="#Tensor.substitute">substitute</a></dd>
                <dd id="Sum.weisfeiler_lehman" class="variable"><a href="#Tensor.weisfeiler_lehman">weisfeiler_lehman</a></dd>
                <dd id="Sum.edge_structural_graph" class="function"><a href="#Tensor.edge_structural_graph">edge_structural_graph</a></dd>
                <dd id="Sum.graph_to_string" class="function"><a href="#Tensor.graph_to_string">graph_to_string</a></dd>
                <dd id="Sum.is_isomorphic" class="function"><a href="#Tensor.is_isomorphic">is_isomorphic</a></dd>
                <dd id="Sum.isomorphisms" class="function"><a href="#Tensor.isomorphisms">isomorphisms</a></dd>
                <dd id="Sum.symmetries" class="variable"><a href="#Tensor.symmetries">symmetries</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>