\newcounter{csvcounter}
\newcommand{\CountCSV}[2]{%
   \setcounter{csvcounter}{0}%
   \foreach \x in #2 {%
      \stepcounter{csvcounter}%
   }%
   \pgfmathsetmacro{#1}{\value{csvcounter}}%
}
\newcommand{\drawPartitionAtAngle}[4]{%
  \def\globaln{#2}%
  \begin{scope}[shift={#1}]%
    \node[label, anchor=east] at (-.3,0) {#3};%
    \CountCSV{\blockCount}{#4}%
    
    % First optimize the assignment of blocks to hub positions
    \def\bestTotalDist{1000}%
    \def\bestOffset{0}%
    
    % Try different rotational offsets for the hub arrangement
    %\foreach \offset in {0,15,...,345} {%
    %\foreach \offset in {61, 209, 19, 88, 79} {%
    \foreach \offset in {42, 62, 82} {%
        \pgfmathsetmacro{\totalDist}{0}%
        % For each block in the partition:
        \foreach [count=\blockIndex from 0] \block in #4 {%
            \pgfmathsetmacro{\angleStep}{30+360/\blockCount}%
            \pgfmathsetmacro{\hubAngle}{mod(\blockIndex * \angleStep + \offset, 360)}%
            % For each element in this block:
            \foreach \elem in \block {%
                \pgfmathsetmacro{\elemAngle}{mod((\elem - 1)*360/\globaln, 360)}%
                \pgfmathsetmacro{\dist}{min(abs(mod(\elemAngle - \hubAngle,360)),360 - abs(mod(\elemAngle - \hubAngle,360)))}%
                % Update the accumulator globally:
                \pgfmathparse{\totalDist + \dist/360}%
                \global\edef\totalDist{\pgfmathresult}%
            }%
        }%
        \ifdim\totalDist pt < \bestTotalDist pt%
            \xdef\bestTotalDist{\totalDist}%
            \xdef\bestOffset{\offset}%
        \fi%
    }%

    % Now draw each block using the optimized hub positions:
    \pgfmathsetmacro{\angleStep}{360/\blockCount}%
    \pgfmathsetmacro{\hubRadius}{.1}%
    \ifnum\blockCount=1
      \def\hubRadius{0}%
    \else
      \def\hubRadius{0.1}%
    \fi
    \foreach [count=\i from 0] \block in #4 {%
      \pgfmathsetmacro{\currentAngle}{\i * \angleStep + \bestOffset}%
      \drawBlock{\currentAngle:\hubRadius}{\block}%
    }%
  \end{scope}%
}
\newcommand{\drawBlock}[2]{%
    \coordinate (hub) at (#1);%
    % For each element in this block, draw a spoke:
    \foreach \elem in #2 {%
        \pgfmathsetmacro{\thisAngle}{30+(\elem - 1)*360/\globaln}%
        \path (hub) (\thisAngle:0.3) coordinate (node\elem);%
        \draw[thin] (hub) -- (node\elem);%
    }%
    \node[inner sep=1pt] at (hub) {};%
}
